<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Linux 系统运维基础指南</title>
    <url>/2026/02/28/01-Linux%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4%E5%9F%BA%E7%A1%80%E6%8C%87%E5%8D%97/</url>
    <content><![CDATA[<h1 id="Linux-系统运维基础指南"><a href="#Linux-系统运维基础指南" class="headerlink" title="Linux 系统运维基础指南"></a>Linux 系统运维基础指南</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF%E6%9F%A5%E7%9C%8B">系统信息查看</a></li>
<li><a href="#2-%E7%94%A8%E6%88%B7%E4%B8%8E%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86">用户与权限管理</a></li>
<li><a href="#3-%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86">进程管理</a></li>
<li><a href="#4-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86">磁盘管理</a></li>
<li><a href="#5-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">网络配置</a></li>
<li><a href="#6-%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97">系统日志</a></li>
<li><a href="#7-%E5%B8%B8%E7%94%A8%E8%BF%90%E7%BB%B4%E5%91%BD%E4%BB%A4">常用运维命令</a></li>
</ol>
<hr>
<h2 id="1-系统信息查看"><a href="#1-系统信息查看" class="headerlink" title="1. 系统信息查看"></a>1. 系统信息查看</h2><h3 id="1-1-查看系统版本"><a href="#1-1-查看系统版本" class="headerlink" title="1.1 查看系统版本"></a>1.1 查看系统版本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看操作系统版本</span></span><br><span class="line"><span class="built_in">cat</span> /etc/os-release</span><br><span class="line"><span class="built_in">cat</span> /etc/redhat-release    <span class="comment"># CentOS/RHEL</span></span><br><span class="line"><span class="built_in">cat</span> /etc/debian_version    <span class="comment"># Debian/Ubuntu</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内核版本</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="built_in">uname</span> -a</span><br></pre></td></tr></table></figure>

<h3 id="1-2-查看硬件信息"><a href="#1-2-查看硬件信息" class="headerlink" title="1.2 查看硬件信息"></a>1.2 查看硬件信息</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CPU 信息</span></span><br><span class="line">lscpu</span><br><span class="line"><span class="built_in">cat</span> /proc/cpuinfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存信息</span></span><br><span class="line">free -h</span><br><span class="line"><span class="built_in">cat</span> /proc/meminfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 磁盘信息</span></span><br><span class="line">lsblk</span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># PCI 设备</span></span><br><span class="line">lspci</span><br><span class="line"></span><br><span class="line"><span class="comment"># USB 设备</span></span><br><span class="line">lsusb</span><br></pre></td></tr></table></figure>

<h3 id="1-3-查看系统运行状态"><a href="#1-3-查看系统运行状态" class="headerlink" title="1.3 查看系统运行状态"></a>1.3 查看系统运行状态</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统运行时间</span></span><br><span class="line"><span class="built_in">uptime</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统负载</span></span><br><span class="line">top</span><br><span class="line">htop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看系统服务</span></span><br><span class="line">systemctl list-units --<span class="built_in">type</span>=service</span><br><span class="line">systemctl list-unit-files --state=enabled</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-用户与权限管理"><a href="#2-用户与权限管理" class="headerlink" title="2. 用户与权限管理"></a>2. 用户与权限管理</h2><h3 id="2-1-用户管理"><a href="#2-1-用户管理" class="headerlink" title="2.1 用户管理"></a>2.1 用户管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">useradd -m -s /bin/bash username</span><br><span class="line">passwd username</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改用户信息</span></span><br><span class="line">usermod -aG <span class="built_in">sudo</span> username    <span class="comment"># 添加用户到 sudo 组</span></span><br><span class="line">usermod -L username          <span class="comment"># 锁定用户</span></span><br><span class="line">usermod -U username          <span class="comment"># 解锁用户</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除用户</span></span><br><span class="line">userdel -r username          <span class="comment"># -r 同时删除家目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户信息</span></span><br><span class="line"><span class="built_in">id</span> username</span><br><span class="line"><span class="built_in">cat</span> /etc/passwd</span><br><span class="line"><span class="built_in">cat</span> /etc/shadow</span><br></pre></td></tr></table></figure>

<h3 id="2-2-组管理"><a href="#2-2-组管理" class="headerlink" title="2.2 组管理"></a>2.2 组管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建组</span></span><br><span class="line">groupadd groupname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加用户到组</span></span><br><span class="line">usermod -aG groupname username</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看组信息</span></span><br><span class="line">getent group groupname</span><br><span class="line"><span class="built_in">cat</span> /etc/group</span><br></pre></td></tr></table></figure>

<h3 id="2-3-权限管理"><a href="#2-3-权限管理" class="headerlink" title="2.3 权限管理"></a>2.3 权限管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改文件权限</span></span><br><span class="line"><span class="built_in">chmod</span> 755 filename</span><br><span class="line"><span class="built_in">chmod</span> u+x filename</span><br><span class="line"><span class="built_in">chmod</span> -R 755 directory/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改文件所有者</span></span><br><span class="line"><span class="built_in">chown</span> user:group filename</span><br><span class="line"><span class="built_in">chown</span> -R user:group directory/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看权限</span></span><br><span class="line"><span class="built_in">ls</span> -l</span><br><span class="line"><span class="built_in">stat</span> filename</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Sudo-配置"><a href="#2-4-Sudo-配置" class="headerlink" title="2.4 Sudo 配置"></a>2.4 Sudo 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编辑 sudo 配置</span></span><br><span class="line">visudo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加用户 sudo 权限</span></span><br><span class="line">username ALL=(ALL:ALL) ALL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 免密码 sudo</span></span><br><span class="line">username ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-进程管理"><a href="#3-进程管理" class="headerlink" title="3. 进程管理"></a>3. 进程管理</h2><h3 id="3-1-查看进程"><a href="#3-1-查看进程" class="headerlink" title="3.1 查看进程"></a>3.1 查看进程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有进程</span></span><br><span class="line">ps aux</span><br><span class="line">ps -ef</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看特定进程</span></span><br><span class="line">ps aux | grep nginx</span><br><span class="line">pgrep nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时查看进程</span></span><br><span class="line">top</span><br><span class="line">htop</span><br></pre></td></tr></table></figure>

<h3 id="3-2-进程控制"><a href="#3-2-进程控制" class="headerlink" title="3.2 进程控制"></a>3.2 进程控制</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 终止进程</span></span><br><span class="line"><span class="built_in">kill</span> PID</span><br><span class="line"><span class="built_in">kill</span> -9 PID          <span class="comment"># 强制终止</span></span><br><span class="line">killall processname</span><br><span class="line">pkill processname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整进程优先级</span></span><br><span class="line"><span class="built_in">nice</span> -n 10 <span class="built_in">command</span></span><br><span class="line">renice -n 10 -p PID</span><br></pre></td></tr></table></figure>

<h3 id="3-3-后台任务管理"><a href="#3-3-后台任务管理" class="headerlink" title="3.3 后台任务管理"></a>3.3 后台任务管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 后台运行</span></span><br><span class="line"><span class="built_in">command</span> &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看后台任务</span></span><br><span class="line"><span class="built_in">jobs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到后台/前台</span></span><br><span class="line">Ctrl+Z              <span class="comment"># 挂起</span></span><br><span class="line"><span class="built_in">bg</span>                  <span class="comment"># 后台运行</span></span><br><span class="line"><span class="built_in">fg</span>                  <span class="comment"># 前台运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nohup 运行</span></span><br><span class="line"><span class="built_in">nohup</span> <span class="built_in">command</span> &amp;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-磁盘管理"><a href="#4-磁盘管理" class="headerlink" title="4. 磁盘管理"></a>4. 磁盘管理</h2><h3 id="4-1-磁盘分区"><a href="#4-1-磁盘分区" class="headerlink" title="4.1 磁盘分区"></a>4.1 磁盘分区</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘分区</span></span><br><span class="line">fdisk -l</span><br><span class="line">lsblk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分区操作</span></span><br><span class="line">fdisk /dev/sdb</span><br><span class="line">parted /dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式化分区</span></span><br><span class="line">mkfs.ext4 /dev/sdb1</span><br><span class="line">mkfs.xfs /dev/sdb1</span><br></pre></td></tr></table></figure>

<h3 id="4-2-挂载管理"><a href="#4-2-挂载管理" class="headerlink" title="4.2 挂载管理"></a>4.2 挂载管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 挂载</span></span><br><span class="line">mount /dev/sdb1 /mnt/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">umount /mnt/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看挂载</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line">mount | grep sdb1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久挂载（/etc/fstab）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/dev/sdb1 /mnt/data ext4 defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br></pre></td></tr></table></figure>

<h3 id="4-3-LVM-管理"><a href="#4-3-LVM-管理" class="headerlink" title="4.3 LVM 管理"></a>4.3 LVM 管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建物理卷</span></span><br><span class="line">pvcreate /dev/sdb1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建卷组</span></span><br><span class="line">vgcreate vg_data /dev/sdb1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建逻辑卷</span></span><br><span class="line">lvcreate -L 100G -n lv_data vg_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩展逻辑卷</span></span><br><span class="line">lvextend -L +50G /dev/vg_data/lv_data</span><br><span class="line">resize2fs /dev/vg_data/lv_data</span><br></pre></td></tr></table></figure>

<h3 id="4-4-磁盘空间分析"><a href="#4-4-磁盘空间分析" class="headerlink" title="4.4 磁盘空间分析"></a>4.4 磁盘空间分析</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘使用</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line"><span class="built_in">df</span> -i               <span class="comment"># inode 使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看目录大小</span></span><br><span class="line"><span class="built_in">du</span> -sh /path</span><br><span class="line"><span class="built_in">du</span> -h --max-depth=1 /path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找大文件</span></span><br><span class="line">find / -<span class="built_in">type</span> f -size +100M</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-网络配置"><a href="#5-网络配置" class="headerlink" title="5. 网络配置"></a>5. 网络配置</h2><h3 id="5-1-网络接口配置"><a href="#5-1-网络接口配置" class="headerlink" title="5.1 网络接口配置"></a>5.1 网络接口配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看网络接口</span></span><br><span class="line">ip addr</span><br><span class="line">ifconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 IP 地址</span></span><br><span class="line">ip addr add 192.168.1.100/24 dev eth0</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久配置（CentOS/RHEL）</span></span><br><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久配置（Ubuntu/Debian）</span></span><br><span class="line">vi /etc/netplan/01-netcfg.yaml</span><br></pre></td></tr></table></figure>

<h3 id="5-2-路由配置"><a href="#5-2-路由配置" class="headerlink" title="5.2 路由配置"></a>5.2 路由配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看路由表</span></span><br><span class="line">ip route</span><br><span class="line">route -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加默认网关</span></span><br><span class="line">ip route add default via 192.168.1.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加静态路由</span></span><br><span class="line">ip route add 10.0.0.0/8 via 192.168.1.254</span><br></pre></td></tr></table></figure>

<h3 id="5-3-DNS-配置"><a href="#5-3-DNS-配置" class="headerlink" title="5.3 DNS 配置"></a>5.3 DNS 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 DNS</span></span><br><span class="line"><span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 DNS</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> &gt;&gt; /etc/resolv.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.4.4&quot;</span> &gt;&gt; /etc/resolv.conf</span><br></pre></td></tr></table></figure>

<h3 id="5-4-防火墙配置"><a href="#5-4-防火墙配置" class="headerlink" title="5.4 防火墙配置"></a>5.4 防火墙配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># firewalld（CentOS/RHEL）</span></span><br><span class="line">systemctl start firewalld</span><br><span class="line">firewall-cmd --add-port=80/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># ufw（Ubuntu/Debian）</span></span><br><span class="line">ufw <span class="built_in">enable</span></span><br><span class="line">ufw allow 80/tcp</span><br><span class="line">ufw status</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">iptables-save &gt; /etc/iptables/rules.v4</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-系统日志"><a href="#6-系统日志" class="headerlink" title="6. 系统日志"></a>6. 系统日志</h2><h3 id="6-1-日志文件位置"><a href="#6-1-日志文件位置" class="headerlink" title="6.1 日志文件位置"></a>6.1 日志文件位置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统日志</span></span><br><span class="line">/var/log/messages          <span class="comment"># CentOS/RHEL</span></span><br><span class="line">/var/log/syslog            <span class="comment"># Ubuntu/Debian</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安全日志</span></span><br><span class="line">/var/log/secure            <span class="comment"># CentOS/RHEL</span></span><br><span class="line">/var/log/auth.log          <span class="comment"># Ubuntu/Debian</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用日志</span></span><br><span class="line">/var/log/nginx/</span><br><span class="line">/var/log/apache2/</span><br><span class="line">/var/log/mysql/</span><br></pre></td></tr></table></figure>

<h3 id="6-2-日志查看命令"><a href="#6-2-日志查看命令" class="headerlink" title="6.2 日志查看命令"></a>6.2 日志查看命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/messages</span><br><span class="line"><span class="built_in">tail</span> -100 /var/log/messages</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索日志</span></span><br><span class="line">grep <span class="string">&quot;error&quot;</span> /var/log/messages</span><br><span class="line">journalctl -u nginx -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志轮转</span></span><br><span class="line">logrotate -f /etc/logrotate.conf</span><br></pre></td></tr></table></figure>

<h3 id="6-3-systemd-日志"><a href="#6-3-systemd-日志" class="headerlink" title="6.3 systemd 日志"></a>6.3 systemd 日志</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看系统日志</span></span><br><span class="line">journalctl</span><br><span class="line">journalctl -f              <span class="comment"># 实时查看</span></span><br><span class="line">journalctl -xe             <span class="comment"># 查看详细错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按服务查看</span></span><br><span class="line">journalctl -u nginx</span><br><span class="line">journalctl -u sshd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按时间查看</span></span><br><span class="line">journalctl --since <span class="string">&quot;2024-01-01&quot;</span></span><br><span class="line">journalctl --since <span class="string">&quot;1 hour ago&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-常用运维命令"><a href="#7-常用运维命令" class="headerlink" title="7. 常用运维命令"></a>7. 常用运维命令</h2><h3 id="7-1-系统维护"><a href="#7-1-系统维护" class="headerlink" title="7.1 系统维护"></a>7.1 系统维护</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 更新系统</span></span><br><span class="line">yum update -y              <span class="comment"># CentOS/RHEL</span></span><br><span class="line">apt update &amp;&amp; apt upgrade -y   <span class="comment"># Ubuntu/Debian</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理缓存</span></span><br><span class="line">yum clean all</span><br><span class="line">apt clean</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">systemctl restart service</span><br><span class="line">systemctl reload service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务状态</span></span><br><span class="line">systemctl status service</span><br></pre></td></tr></table></figure>

<h3 id="7-2-性能监控"><a href="#7-2-性能监控" class="headerlink" title="7.2 性能监控"></a>7.2 性能监控</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CPU 监控</span></span><br><span class="line">top</span><br><span class="line">mpstat 1 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存监控</span></span><br><span class="line">free -h</span><br><span class="line">vmstat 1 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 磁盘 I/O</span></span><br><span class="line">iostat -x 1 5</span><br><span class="line">iotop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络监控</span></span><br><span class="line">iftop</span><br><span class="line">nethogs</span><br></pre></td></tr></table></figure>

<h3 id="7-3-故障排查"><a href="#7-3-故障排查" class="headerlink" title="7.3 故障排查"></a>7.3 故障排查</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 网络连接测试</span></span><br><span class="line">ping host</span><br><span class="line">traceroute host</span><br><span class="line">telnet host port</span><br><span class="line">nc -zv host port</span><br><span class="line"></span><br><span class="line"><span class="comment"># 端口占用</span></span><br><span class="line">netstat -tulpn</span><br><span class="line">ss -tulpn</span><br><span class="line">lsof -i :80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统调用追踪</span></span><br><span class="line">strace -p PID</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="附录：常用快捷键"><a href="#附录：常用快捷键" class="headerlink" title="附录：常用快捷键"></a>附录：常用快捷键</h2><table>
<thead>
<tr>
<th>快捷键</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>Ctrl+C</td>
<td>终止当前命令</td>
</tr>
<tr>
<td>Ctrl+Z</td>
<td>挂起当前命令</td>
</tr>
<tr>
<td>Ctrl+D</td>
<td>退出终端</td>
</tr>
<tr>
<td>Ctrl+L</td>
<td>清屏</td>
</tr>
<tr>
<td>Ctrl+R</td>
<td>搜索历史命令</td>
</tr>
<tr>
<td>Tab</td>
<td>自动补全</td>
</tr>
<tr>
<td>Ctrl+A</td>
<td>移动到行首</td>
</tr>
<tr>
<td>Ctrl+E</td>
<td>移动到行尾</td>
</tr>
</tbody></table>
<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用系统</strong>: CentOS&#x2F;RHEL, Ubuntu&#x2F;Debian</p>
]]></content>
      <categories>
        <category>系统部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>Docker 容器化运维实践</title>
    <url>/2026/02/28/03-Docker%E5%AE%B9%E5%99%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<h1 id="Docker-容器化运维实践"><a href="#Docker-容器化运维实践" class="headerlink" title="Docker 容器化运维实践"></a>Docker 容器化运维实践</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-docker-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE">Docker 安装与配置</a></li>
<li><a href="#2-%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86">镜像管理</a></li>
<li><a href="#3-%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86">容器管理</a></li>
<li><a href="#4-dockerfile-%E7%BC%96%E5%86%99">Dockerfile 编写</a></li>
<li><a href="#5-%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%AE%A1%E7%90%86">数据卷管理</a></li>
<li><a href="#6-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86">网络管理</a></li>
<li><a href="#7-docker-compose">Docker Compose</a></li>
<li><a href="#8-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%97%A5%E5%BF%97">容器监控与日志</a></li>
<li><a href="#9-%E5%AE%89%E5%85%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">安全最佳实践</a></li>
</ol>
<hr>
<h2 id="1-Docker-安装与配置"><a href="#1-Docker-安装与配置" class="headerlink" title="1. Docker 安装与配置"></a>1. Docker 安装与配置</h2><h3 id="1-1-CentOS-RHEL-安装"><a href="#1-1-CentOS-RHEL-安装" class="headerlink" title="1.1 CentOS&#x2F;RHEL 安装"></a>1.1 CentOS&#x2F;RHEL 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 卸载旧版本</span></span><br><span class="line">yum remove -y docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 yum 工具包</span></span><br><span class="line">yum install -y yum-utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 Docker 仓库</span></span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Docker</span></span><br><span class="line">yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">docker --version</span><br><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Ubuntu-Debian-安装"><a href="#1-2-Ubuntu-Debian-安装" class="headerlink" title="1.2 Ubuntu&#x2F;Debian 安装"></a>1.2 Ubuntu&#x2F;Debian 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 卸载旧版本</span></span><br><span class="line">apt-get remove -y docker docker-engine docker.io containerd runc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y ca-certificates curl gnupg lsb-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 GPG 密钥</span></span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加仓库</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Docker</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>

<h3 id="1-3-配置镜像加速器"><a href="#1-3-配置镜像加速器" class="headerlink" title="1.3 配置镜像加速器"></a>1.3 配置镜像加速器</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建/编辑配置文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [</span></span><br><span class="line"><span class="string">    &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span></span><br><span class="line"><span class="string">    &quot;https://registry.docker-cn.com&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line"><span class="string">  &quot;log-driver&quot;: &quot;json-file&quot;,</span></span><br><span class="line"><span class="string">  &quot;log-opts&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;max-size&quot;: &quot;100m&quot;,</span></span><br><span class="line"><span class="string">    &quot;max-file&quot;: &quot;3&quot;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 Docker</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="1-4-配置非-root-用户使用-Docker"><a href="#1-4-配置非-root-用户使用-Docker" class="headerlink" title="1.4 配置非 root 用户使用 Docker"></a>1.4 配置非 root 用户使用 Docker</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 docker 组</span></span><br><span class="line">groupadd docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加用户到 docker 组</span></span><br><span class="line">usermod -aG docker <span class="variable">$USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用组变更</span></span><br><span class="line">newgrp docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-镜像管理"><a href="#2-镜像管理" class="headerlink" title="2. 镜像管理"></a>2. 镜像管理</h2><h3 id="2-1-镜像操作"><a href="#2-1-镜像操作" class="headerlink" title="2.1 镜像操作"></a>2.1 镜像操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 搜索镜像</span></span><br><span class="line">docker search nginx</span><br><span class="line">docker search --filter is-official=<span class="literal">true</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取镜像</span></span><br><span class="line">docker pull nginx:latest</span><br><span class="line">docker pull nginx:1.21</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看本地镜像</span></span><br><span class="line">docker images</span><br><span class="line">docker image <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像详情</span></span><br><span class="line">docker inspect nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像历史</span></span><br><span class="line">docker <span class="built_in">history</span> nginx</span><br></pre></td></tr></table></figure>

<h3 id="2-2-镜像管理"><a href="#2-2-镜像管理" class="headerlink" title="2.2 镜像管理"></a>2.2 镜像管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除镜像</span></span><br><span class="line">docker rmi nginx:latest</span><br><span class="line">docker image <span class="built_in">rm</span> nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除所有悬空镜像</span></span><br><span class="line">docker image prune</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除所有未使用镜像</span></span><br><span class="line">docker image prune -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像标签</span></span><br><span class="line">docker tag nginx:latest myrepo/nginx:v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存镜像</span></span><br><span class="line">docker save -o nginx.tar nginx:latest</span><br><span class="line">docker save nginx:latest | gzip &gt; nginx.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载镜像</span></span><br><span class="line">docker load -i nginx.tar</span><br><span class="line">docker load &lt; nginx.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="2-3-构建镜像"><a href="#2-3-构建镜像" class="headerlink" title="2.3 构建镜像"></a>2.3 构建镜像</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基于 Dockerfile 构建</span></span><br><span class="line">docker build -t myapp:v1.0 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 Dockerfile</span></span><br><span class="line">docker build -f Dockerfile.prod -t myapp:prod .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建参数</span></span><br><span class="line">docker build --build-arg VERSION=1.0 -t myapp:v1.0 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无缓存构建</span></span><br><span class="line">docker build --no-cache -t myapp:v1.0 .</span><br></pre></td></tr></table></figure>

<h3 id="2-4-推送镜像"><a href="#2-4-推送镜像" class="headerlink" title="2.4 推送镜像"></a>2.4 推送镜像</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 登录 Docker Hub</span></span><br><span class="line">docker login</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送镜像</span></span><br><span class="line">docker push myrepo/myapp:v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送所有标签</span></span><br><span class="line">docker push myrepo/myapp --all-tags</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-容器管理"><a href="#3-容器管理" class="headerlink" title="3. 容器管理"></a>3. 容器管理</h2><h3 id="3-1-创建与启动"><a href="#3-1-创建与启动" class="headerlink" title="3.1 创建与启动"></a>3.1 创建与启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 运行容器</span></span><br><span class="line">docker run -d --name my-nginx -p 80:80 nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 交互式运行</span></span><br><span class="line">docker run -it --name my-container ubuntu:20.04 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定资源限制</span></span><br><span class="line">docker run -d --name myapp --memory=<span class="string">&quot;512m&quot;</span> --cpus=<span class="string">&quot;1.0&quot;</span> myapp:v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line">docker run -d --name myapp -e ENV=production -e DB_HOST=localhost myapp:v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载卷</span></span><br><span class="line">docker run -d --name myapp -v /host/data:/container/data myapp:v1.0</span><br></pre></td></tr></table></figure>

<h3 id="3-2-容器操作"><a href="#3-2-容器操作" class="headerlink" title="3.2 容器操作"></a>3.2 容器操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看运行中的容器</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有容器</span></span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器详情</span></span><br><span class="line">docker inspect container_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it container_name /bin/bash</span><br><span class="line">docker <span class="built_in">exec</span> -it container_name /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器日志</span></span><br><span class="line">docker logs container_name</span><br><span class="line">docker logs -f container_name</span><br><span class="line">docker logs --<span class="built_in">tail</span> 100 container_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器资源使用</span></span><br><span class="line">docker stats</span><br><span class="line">docker stats container_name</span><br></pre></td></tr></table></figure>

<h3 id="3-3-容器控制"><a href="#3-3-容器控制" class="headerlink" title="3.3 容器控制"></a>3.3 容器控制</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 停止容器</span></span><br><span class="line">docker stop container_name</span><br><span class="line">docker stop $(docker ps -q)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动容器</span></span><br><span class="line">docker start container_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启容器</span></span><br><span class="line">docker restart container_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂停/恢复容器</span></span><br><span class="line">docker pause container_name</span><br><span class="line">docker unpause container_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除容器</span></span><br><span class="line">docker <span class="built_in">rm</span> container_name</span><br><span class="line">docker <span class="built_in">rm</span> -f container_name  <span class="comment"># 强制删除运行中的容器</span></span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -a -q)  <span class="comment"># 删除所有容器</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-容器文件操作"><a href="#3-4-容器文件操作" class="headerlink" title="3.4 容器文件操作"></a>3.4 容器文件操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从容器复制文件到主机</span></span><br><span class="line">docker <span class="built_in">cp</span> container_name:/path/to/file /host/path/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从主机复制文件到容器</span></span><br><span class="line">docker <span class="built_in">cp</span> /host/path/file container_name:/container/path/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器文件系统变更</span></span><br><span class="line">docker diff container_name</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-Dockerfile-编写"><a href="#4-Dockerfile-编写" class="headerlink" title="4. Dockerfile 编写"></a>4. Dockerfile 编写</h2><h3 id="4-1-基础结构"><a href="#4-1-基础结构" class="headerlink" title="4.1 基础结构"></a>4.1 基础结构</h3><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 维护者信息</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;your@email.com&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> APP_HOME=/app</span><br><span class="line"><span class="keyword">ENV</span> NODE_ENV=production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$APP_HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;server.js&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用 ENTRYPOINT</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;node&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;server.js&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-多阶段构建"><a href="#4-2-多阶段构建" class="headerlink" title="4.2 多阶段构建"></a>4.2 多阶段构建</h3><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构建阶段</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16</span> AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm ci</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产阶段</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16</span>-alpine</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/dist ./dist</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/node_modules ./node_modules</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;dist/server.js&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-最佳实践"><a href="#4-3-最佳实践" class="headerlink" title="4.3 最佳实践"></a>4.3 最佳实践</h3><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用具体版本的基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16.13</span>.<span class="number">0</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并 RUN 指令减少层数</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    git \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/cache/apk/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 .dockerignore</span></span><br><span class="line"><span class="comment"># .git</span></span><br><span class="line"><span class="comment"># node_modules</span></span><br><span class="line"><span class="comment"># *.log</span></span><br><span class="line"><span class="comment"># .env</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 非 root 用户运行</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> addgroup -g 1001 -S nodejs &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    adduser -S nodejs -u 1001</span></span><br><span class="line"><span class="keyword">USER</span> nodejs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 健康检查</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=3s --start-period=5s --retries=3 \</span></span><br><span class="line"><span class="language-bash">    CMD curl -f http://localhost:8080/health || <span class="built_in">exit</span> 1</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-数据卷管理"><a href="#5-数据卷管理" class="headerlink" title="5. 数据卷管理"></a>5. 数据卷管理</h2><h3 id="5-1-数据卷类型"><a href="#5-1-数据卷类型" class="headerlink" title="5.1 数据卷类型"></a>5.1 数据卷类型</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 绑定挂载</span></span><br><span class="line">docker run -v /host/path:/container/path nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命名卷</span></span><br><span class="line">docker volume create mydata</span><br><span class="line">docker run -v mydata:/container/data nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只读挂载</span></span><br><span class="line">docker run -v /host/path:/container/path:ro nginx</span><br></pre></td></tr></table></figure>

<h3 id="5-2-卷操作"><a href="#5-2-卷操作" class="headerlink" title="5.2 卷操作"></a>5.2 卷操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建卷</span></span><br><span class="line">docker volume create myvolume</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看卷</span></span><br><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line">docker volume inspect myvolume</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除卷</span></span><br><span class="line">docker volume <span class="built_in">rm</span> myvolume</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除未使用卷</span></span><br><span class="line">docker volume prune</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份卷</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -v myvolume:/data -v $(<span class="built_in">pwd</span>):/backup alpine tar cvf /backup/backup.tar /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复卷</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -v myvolume:/data -v $(<span class="built_in">pwd</span>):/backup alpine tar xvf /backup/backup.tar -C /</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-网络管理"><a href="#6-网络管理" class="headerlink" title="6. 网络管理"></a>6. 网络管理</h2><h3 id="6-1-网络类型"><a href="#6-1-网络类型" class="headerlink" title="6.1 网络类型"></a>6.1 网络类型</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看网络</span></span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建网络</span></span><br><span class="line">docker network create mynetwork</span><br><span class="line">docker network create --driver bridge --subnet 172.20.0.0/16 mynetwork</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网络详情</span></span><br><span class="line">docker network inspect mynetwork</span><br></pre></td></tr></table></figure>

<h3 id="6-2-容器网络连接"><a href="#6-2-容器网络连接" class="headerlink" title="6.2 容器网络连接"></a>6.2 容器网络连接</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 运行时连接网络</span></span><br><span class="line">docker run -d --network mynetwork --name web nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行中连接网络</span></span><br><span class="line">docker network connect mynetwork container_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 断开网络</span></span><br><span class="line">docker network disconnect mynetwork container_name</span><br></pre></td></tr></table></figure>

<h3 id="6-3-容器间通信"><a href="#6-3-容器间通信" class="headerlink" title="6.3 容器间通信"></a>6.3 容器间通信</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 同一网络内的容器可以通过名称通信</span></span><br><span class="line">docker run -d --network mynetwork --name db postgres</span><br><span class="line">docker run -d --network mynetwork --name web -e DB_HOST=db myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 link（已废弃，不推荐）</span></span><br><span class="line">docker run -d --name web --<span class="built_in">link</span> db:database myapp</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-Docker-Compose"><a href="#7-Docker-Compose" class="headerlink" title="7. Docker Compose"></a>7. Docker Compose</h2><h3 id="7-1-安装"><a href="#7-1-安装" class="headerlink" title="7.1 安装"></a>7.1 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Docker Compose V2（作为 Docker 插件）</span></span><br><span class="line"><span class="comment"># 已随 Docker 一起安装</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">docker compose version</span><br></pre></td></tr></table></figure>

<h3 id="7-2-docker-compose-yml-示例"><a href="#7-2-docker-compose-yml-示例" class="headerlink" title="7.2 docker-compose.yml 示例"></a>7.2 docker-compose.yml 示例</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NODE_ENV=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_HOST=db</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app-network</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_USER=myuser</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_PASSWORD=mypassword</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_DB=mydb</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres-data:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app-network</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6-alpine</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app-network</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">app-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">postgres-data:</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-Compose-常用命令"><a href="#7-3-Compose-常用命令" class="headerlink" title="7.3 Compose 常用命令"></a>7.3 Compose 常用命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">docker compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">docker compose down</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">docker compose logs -f</span><br><span class="line">docker compose logs -f web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">docker compose ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">docker compose restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重建服务</span></span><br><span class="line">docker compose up -d --build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行命令</span></span><br><span class="line">docker compose <span class="built_in">exec</span> web /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看资源使用</span></span><br><span class="line">docker compose top</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-容器监控与日志"><a href="#8-容器监控与日志" class="headerlink" title="8. 容器监控与日志"></a>8. 容器监控与日志</h2><h3 id="8-1-资源监控"><a href="#8-1-资源监控" class="headerlink" title="8.1 资源监控"></a>8.1 资源监控</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 实时资源使用</span></span><br><span class="line">docker stats</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性快照</span></span><br><span class="line">docker stats --no-stream</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器进程</span></span><br><span class="line">docker top container_name</span><br></pre></td></tr></table></figure>

<h3 id="8-2-日志管理"><a href="#8-2-日志管理" class="headerlink" title="8.2 日志管理"></a>8.2 日志管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">docker logs container_name</span><br><span class="line">docker logs -f container_name</span><br><span class="line">docker logs --<span class="built_in">tail</span> 100 container_name</span><br><span class="line">docker logs --since 1h container_name</span><br><span class="line">docker logs --<span class="keyword">until</span> 10m container_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志驱动配置</span></span><br><span class="line"><span class="comment"># 在 daemon.json 中配置</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">  <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;10m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-监控方案"><a href="#8-3-监控方案" class="headerlink" title="8.3 监控方案"></a>8.3 监控方案</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 cAdvisor</span></span><br><span class="line">docker run -d \</span><br><span class="line">  --name=cadvisor \</span><br><span class="line">  --volume=/:/rootfs:ro \</span><br><span class="line">  --volume=/var/run:/var/run:ro \</span><br><span class="line">  --volume=/sys:/sys:ro \</span><br><span class="line">  --volume=/var/lib/docker/:/var/lib/docker:ro \</span><br><span class="line">  --publish=8080:8080 \</span><br><span class="line">  google/cadvisor:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Prometheus + Grafana</span></span><br><span class="line"><span class="comment"># 参考 Prometheus 官方文档配置</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-安全最佳实践"><a href="#9-安全最佳实践" class="headerlink" title="9. 安全最佳实践"></a>9. 安全最佳实践</h2><h3 id="9-1-镜像安全"><a href="#9-1-镜像安全" class="headerlink" title="9.1 镜像安全"></a>9.1 镜像安全</h3><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用官方镜像</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扫描镜像漏洞</span></span><br><span class="line">docker scan myapp:v1.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用固定版本</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16.13</span>.<span class="number">0</span>-alpine</span><br></pre></td></tr></table></figure>

<h3 id="9-2-容器安全"><a href="#9-2-容器安全" class="headerlink" title="9.2 容器安全"></a>9.2 容器安全</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 非 root 用户运行</span></span><br><span class="line">docker run -u 1000:1000 myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只读文件系统</span></span><br><span class="line">docker run --read-only myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制能力</span></span><br><span class="line">docker run --cap-drop=ALL --cap-add=NET_BIND_SERVICE myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用网络</span></span><br><span class="line">docker run --network none myapp</span><br></pre></td></tr></table></figure>

<h3 id="9-3-网络安全"><a href="#9-3-网络安全" class="headerlink" title="9.3 网络安全"></a>9.3 网络安全</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 仅暴露必要端口</span></span><br><span class="line">docker run -p 127.0.0.1:8080:8080 myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用内部网络</span></span><br><span class="line">docker network create --internal internal-net</span><br></pre></td></tr></table></figure>

<h3 id="9-4-密钥管理"><a href="#9-4-密钥管理" class="headerlink" title="9.4 密钥管理"></a>9.4 密钥管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 Docker Secrets（Swarm 模式）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mypassword&quot;</span> | docker secret create db_password -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用环境变量（不推荐敏感信息）</span></span><br><span class="line">docker run -e DB_PASSWORD=mypassword myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用密钥管理工具</span></span><br><span class="line"><span class="comment"># Docker Secrets, HashiCorp Vault 等</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用版本</strong>: Docker 20.10+, Docker Compose V2</p>
]]></content>
      <categories>
        <category>软件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>Nginx 服务器配置与运维手册</title>
    <url>/2026/02/28/02-Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E4%B8%8E%E8%BF%90%E7%BB%B4%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h1 id="Nginx-服务器配置与运维手册"><a href="#Nginx-服务器配置与运维手册" class="headerlink" title="Nginx 服务器配置与运维手册"></a>Nginx 服务器配置与运维手册</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-nginx-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%83%A8%E7%BD%B2">Nginx 安装与部署</a></li>
<li><a href="#2-%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3">核心配置详解</a></li>
<li><a href="#3-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE">虚拟主机配置</a></li>
<li><a href="#4-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE">反向代理配置</a></li>
<li><a href="#5-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE">负载均衡配置</a></li>
<li><a href="#6-sslhttps%E9%85%8D%E7%BD%AE">SSL&#x2F;HTTPS配置</a></li>
<li><a href="#7-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化</a></li>
<li><a href="#8-%E6%97%A5%E5%B8%B8%E8%BF%90%E7%BB%B4">日常运维</a></li>
<li><a href="#9-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5">故障排查</a></li>
</ol>
<hr>
<h2 id="1-Nginx-安装与部署"><a href="#1-Nginx-安装与部署" class="headerlink" title="1. Nginx 安装与部署"></a>1. Nginx 安装与部署</h2><h3 id="1-1-CentOS-RHEL-安装"><a href="#1-1-CentOS-RHEL-安装" class="headerlink" title="1.1 CentOS&#x2F;RHEL 安装"></a>1.1 CentOS&#x2F;RHEL 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加 Nginx 仓库</span></span><br><span class="line">yum install -y yum-utils</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[nginx-stable]</span></span><br><span class="line"><span class="string">name=nginx stable repo</span></span><br><span class="line"><span class="string">baseurl=http://nginx.org/packages/centos/\$releasever/\$basearch/</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Nginx</span></span><br><span class="line">yum install -y nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动并设置开机自启</span></span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Ubuntu-Debian-安装"><a href="#1-2-Ubuntu-Debian-安装" class="headerlink" title="1.2 Ubuntu&#x2F;Debian 安装"></a>1.2 Ubuntu&#x2F;Debian 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加 Nginx 仓库</span></span><br><span class="line">apt install -y curl gnupg2 ca-certificates lsb-release</span><br><span class="line">curl -fsSL https://nginx.org/keys/nginx_signing.key | gpg --dearmor -o /usr/share/keyrings/nginx-archive-keyring.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] http://nginx.org/packages/debian `lsb_release -cs` nginx&quot;</span> | <span class="built_in">tee</span> /etc/apt/sources.list.d/nginx.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Nginx</span></span><br><span class="line">apt update</span><br><span class="line">apt install -y nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动并设置开机自启</span></span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>

<h3 id="1-3-验证安装"><a href="#1-3-验证安装" class="headerlink" title="1.3 验证安装"></a>1.3 验证安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">nginx -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试配置文件</span></span><br><span class="line">nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查运行状态</span></span><br><span class="line">systemctl status nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看监听端口</span></span><br><span class="line">ss -tulpn | grep nginx</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-核心配置详解"><a href="#2-核心配置详解" class="headerlink" title="2. 核心配置详解"></a>2. 核心配置详解</h2><h3 id="2-1-配置文件结构"><a href="#2-1-配置文件结构" class="headerlink" title="2.1 配置文件结构"></a>2.1 配置文件结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主配置文件</span></span><br><span class="line">/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置目录</span></span><br><span class="line">/etc/nginx/conf.d/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志目录</span></span><br><span class="line">/var/log/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网站根目录</span></span><br><span class="line">/usr/share/nginx/html/</span><br></pre></td></tr></table></figure>

<h3 id="2-2-nginx-conf-核心配置"><a href="#2-2-nginx-conf-核心配置" class="headerlink" title="2.2 nginx.conf 核心配置"></a>2.2 nginx.conf 核心配置</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 运行用户和组</span></span><br><span class="line"><span class="attribute">user</span> nginx;</span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log <span class="literal">warn</span>;</span><br><span class="line"><span class="attribute">pid</span> /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 事件模块</span></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">10240</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP 模块</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志格式</span></span><br><span class="line">    <span class="attribute">log_format</span> main <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/access.log main;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 性能优化</span></span><br><span class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">types_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Gzip 压缩</span></span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_proxied</span> any;</span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line">    <span class="attribute">gzip_types</span> text/plain text/css text/xml application/json application/javascript application/xml;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 包含其他配置</span></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-虚拟主机配置"><a href="#3-虚拟主机配置" class="headerlink" title="3. 虚拟主机配置"></a>3. 虚拟主机配置</h2><h3 id="3-1-基于域名的虚拟主机"><a href="#3-1-基于域名的虚拟主机" class="headerlink" title="3.1 基于域名的虚拟主机"></a>3.1 基于域名的虚拟主机</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> example.com www.example.com;</span><br><span class="line">    <span class="attribute">root</span> /var/www/example;</span><br><span class="line">    <span class="attribute">index</span> index.html index.htm;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ =<span class="number">404</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 错误页面</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-基于端口的虚拟主机"><a href="#3-2-基于端口的虚拟主机" class="headerlink" title="3.2 基于端口的虚拟主机"></a>3.2 基于端口的虚拟主机</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> _;</span><br><span class="line">    <span class="attribute">root</span> /var/www/app1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line">    <span class="attribute">server_name</span> _;</span><br><span class="line">    <span class="attribute">root</span> /var/www/app2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-基于-IP-的虚拟主机"><a href="#3-3-基于-IP-的虚拟主机" class="headerlink" title="3.3 基于 IP 的虚拟主机"></a>3.3 基于 IP 的虚拟主机</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">192.168.1.10:80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> _;</span><br><span class="line">    <span class="attribute">root</span> /var/www/site1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">192.168.1.11:80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> _;</span><br><span class="line">    <span class="attribute">root</span> /var/www/site2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-反向代理配置"><a href="#4-反向代理配置" class="headerlink" title="4. 反向代理配置"></a>4. 反向代理配置</h2><h3 id="4-1-基础反向代理"><a href="#4-1-基础反向代理" class="headerlink" title="4.1 基础反向代理"></a>4.1 基础反向代理</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> proxy.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-带缓存的反向代理"><a href="#4-2-带缓存的反向代理" class="headerlink" title="4.2 带缓存的反向代理"></a>4.2 带缓存的反向代理</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_path</span> /var/cache/nginx levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=my_cache:<span class="number">100m</span> max_size=<span class="number">10g</span> inactive=<span class="number">60m</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">        <span class="attribute">proxy_cache</span> my_cache;</span><br><span class="line">        <span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">10m</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_valid</span> <span class="number">404</span> <span class="number">1m</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_key</span> <span class="variable">$scheme</span><span class="variable">$request_method</span><span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">        <span class="attribute">add_header</span> X-Cache-Status <span class="variable">$upstream_cache_status</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-WebSocket-代理"><a href="#4-3-WebSocket-代理" class="headerlink" title="4.3 WebSocket 代理"></a>4.3 WebSocket 代理</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> /ws/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">    <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">86400</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-负载均衡配置"><a href="#5-负载均衡配置" class="headerlink" title="5. 负载均衡配置"></a>5. 负载均衡配置</h2><h3 id="5-1-轮询（默认）"><a href="#5-1-轮询（默认）" class="headerlink" title="5.1 轮询（默认）"></a>5.1 轮询（默认）</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.10:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.11:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.12:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-权重分配"><a href="#5-2-权重分配" class="headerlink" title="5.2 权重分配"></a>5.2 权重分配</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.10:8080</span> weight=<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.11:8080</span> weight=<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.12:8080</span> weight=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-IP-Hash"><a href="#5-3-IP-Hash" class="headerlink" title="5.3 IP Hash"></a>5.3 IP Hash</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.10:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.11:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.12:8080</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-最少连接"><a href="#5-4-最少连接" class="headerlink" title="5.4 最少连接"></a>5.4 最少连接</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.10:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.11:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.12:8080</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-健康检查"><a href="#5-5-健康检查" class="headerlink" title="5.5 健康检查"></a>5.5 健康检查</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.10:8080</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.11:8080</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.12:8080</span> backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-SSL-HTTPS-配置"><a href="#6-SSL-HTTPS-配置" class="headerlink" title="6. SSL&#x2F;HTTPS 配置"></a>6. SSL&#x2F;HTTPS 配置</h2><h3 id="6-1-自签名证书"><a href="#6-1-自签名证书" class="headerlink" title="6.1 自签名证书"></a>6.1 自签名证书</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">openssl genrsa -out server.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 CSR</span></span><br><span class="line">openssl req -new -key server.key -out server.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书</span></span><br><span class="line">openssl x509 -req -days 365 -<span class="keyword">in</span> server.csr -signkey server.key -out server.crt</span><br></pre></td></tr></table></figure>

<h3 id="6-2-HTTPS-配置"><a href="#6-2-HTTPS-配置" class="headerlink" title="6.2 HTTPS 配置"></a>6.2 HTTPS 配置</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/server.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/server.key;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /var/www/example;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP 重定向到 HTTPS</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-Let’s-Encrypt-证书"><a href="#6-3-Let’s-Encrypt-证书" class="headerlink" title="6.3 Let’s Encrypt 证书"></a>6.3 Let’s Encrypt 证书</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 certbot</span></span><br><span class="line">yum install -y certbot python3-certbot-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取证书</span></span><br><span class="line">certbot --nginx -d example.com -d www.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动续期</span></span><br><span class="line">certbot renew --dry-run</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-性能优化"><a href="#7-性能优化" class="headerlink" title="7. 性能优化"></a>7. 性能优化</h2><h3 id="7-1-Worker-进程优化"><a href="#7-1-Worker-进程优化" class="headerlink" title="7.1 Worker 进程优化"></a>7.1 Worker 进程优化</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65535</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">65535</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-缓存优化"><a href="#7-2-缓存优化" class="headerlink" title="7.2 缓存优化"></a>7.2 缓存优化</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 静态文件缓存</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* \.(jpg|jpeg|png|gif|ico|css|js)$</span> &#123;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Cache-Control <span class="string">&quot;public, immutable&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启缓存</span></span><br><span class="line"><span class="attribute">proxy_cache_path</span> /var/cache/nginx levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=STATIC:<span class="number">100m</span> max_size=<span class="number">10g</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-Gzip-压缩"><a href="#7-3-Gzip-压缩" class="headerlink" title="7.3 Gzip 压缩"></a>7.3 Gzip 压缩</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">1024</span>;</span><br><span class="line"><span class="attribute">gzip_proxied</span> expired <span class="literal">no</span>-cache <span class="literal">no</span>-store private auth;</span><br><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line"><span class="attribute">gzip_types</span> text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-连接优化"><a href="#7-4-连接优化" class="headerlink" title="7.4 连接优化"></a>7.4 连接优化</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line"><span class="attribute">keepalive_requests</span> <span class="number">100</span>;</span><br><span class="line"><span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-日常运维"><a href="#8-日常运维" class="headerlink" title="8. 日常运维"></a>8. 日常运维</h2><h3 id="8-1-服务管理"><a href="#8-1-服务管理" class="headerlink" title="8.1 服务管理"></a>8.1 服务管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动/停止/重启</span></span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl stop nginx</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重载配置（不中断服务）</span></span><br><span class="line">systemctl reload nginx</span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure>

<h3 id="8-2-配置测试"><a href="#8-2-配置测试" class="headerlink" title="8.2 配置测试"></a>8.2 配置测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 测试配置文件语法</span></span><br><span class="line">nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示配置信息</span></span><br><span class="line">nginx -T</span><br></pre></td></tr></table></figure>

<h3 id="8-3-日志管理"><a href="#8-3-日志管理" class="headerlink" title="8.3 日志管理"></a>8.3 日志管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看访问日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/nginx/access.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看错误日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/nginx/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志轮转</span></span><br><span class="line">logrotate -f /etc/logrotate.d/nginx</span><br></pre></td></tr></table></figure>

<h3 id="8-4-性能监控"><a href="#8-4-性能监控" class="headerlink" title="8.4 性能监控"></a>8.4 性能监控</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看连接数</span></span><br><span class="line">ss -s | grep nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看活动连接</span></span><br><span class="line">curl http://localhost/nginx_status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控请求数</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> /var/log/nginx/access.log | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-故障排查"><a href="#9-故障排查" class="headerlink" title="9. 故障排查"></a>9. 故障排查</h2><h3 id="9-1-常见问题"><a href="#9-1-常见问题" class="headerlink" title="9.1 常见问题"></a>9.1 常见问题</h3><p><strong>Nginx 无法启动</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查端口占用</span></span><br><span class="line">ss -tulpn | grep :80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查配置文件</span></span><br><span class="line">nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看错误日志</span></span><br><span class="line"><span class="built_in">tail</span> -50 /var/log/nginx/error.log</span><br></pre></td></tr></table></figure>

<p><strong>502 Bad Gateway</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查后端服务</span></span><br><span class="line">systemctl status backend-service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 upstream 配置</span></span><br><span class="line"><span class="comment"># 确认后端服务器可访问</span></span><br><span class="line">curl -I http://backend-server:port</span><br></pre></td></tr></table></figure>

<p><strong>403 Forbidden</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查文件权限</span></span><br><span class="line"><span class="built_in">ls</span> -la /var/www/html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 SELinux</span></span><br><span class="line">getenforce</span><br><span class="line">setenforce 0  <span class="comment"># 临时禁用测试</span></span><br></pre></td></tr></table></figure>

<p><strong>404 Not Found</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 root 路径配置</span></span><br><span class="line"><span class="comment"># 检查文件是否存在</span></span><br><span class="line"><span class="built_in">ls</span> -la /var/www/html/filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 try_files 配置</span></span><br></pre></td></tr></table></figure>

<h3 id="9-2-调试模式"><a href="#9-2-调试模式" class="headerlink" title="9.2 调试模式"></a>9.2 调试模式</h3><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 增加日志详细程度</span></span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log <span class="literal">debug</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启调试日志后重启</span></span><br><span class="line"><span class="attribute">systemctl</span> restart nginx</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用版本</strong>: Nginx 1.20+</p>
]]></content>
      <categories>
        <category>软件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>Kubernetes 集群运维指南</title>
    <url>/2026/02/28/04-Kubernetes%E9%9B%86%E7%BE%A4%E8%BF%90%E7%BB%B4%E6%8C%87%E5%8D%97/</url>
    <content><![CDATA[<h1 id="Kubernetes-集群运维指南"><a href="#Kubernetes-集群运维指南" class="headerlink" title="Kubernetes 集群运维指南"></a>Kubernetes 集群运维指南</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-kubernetes-%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0">Kubernetes 架构概述</a></li>
<li><a href="#2-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">集群部署</a></li>
<li><a href="#3-kubectl-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97">kubectl 使用指南</a></li>
<li><a href="#4-%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD%E7%AE%A1%E7%90%86">工作负载管理</a></li>
<li><a href="#5-%E6%9C%8D%E5%8A%A1%E4%B8%8E%E7%BD%91%E7%BB%9C">服务与网络</a></li>
<li><a href="#6-%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86">存储管理</a></li>
<li><a href="#7-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86">配置管理</a></li>
<li><a href="#8-%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7">集群监控</a></li>
<li><a href="#9-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5">故障排查</a></li>
<li><a href="#10-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D">备份与恢复</a></li>
</ol>
<hr>
<h2 id="1-Kubernetes-架构概述"><a href="#1-Kubernetes-架构概述" class="headerlink" title="1. Kubernetes 架构概述"></a>1. Kubernetes 架构概述</h2><h3 id="1-1-核心组件"><a href="#1-1-核心组件" class="headerlink" title="1.1 核心组件"></a>1.1 核心组件</h3><p><strong>控制平面（Control Plane）</strong></p>
<ul>
<li><strong>kube-apiserver</strong>: API 服务器，集群的统一入口</li>
<li><strong>etcd</strong>: 分布式键值存储，保存集群状态</li>
<li><strong>kube-scheduler</strong>: 负责 Pod 调度</li>
<li><strong>kube-controller-manager</strong>: 运行各种控制器</li>
<li><strong>cloud-controller-manager</strong>: 与云提供商交互</li>
</ul>
<p><strong>节点组件（Node Components）</strong></p>
<ul>
<li><strong>kubelet</strong>: 节点代理，管理 Pod 生命周期</li>
<li><strong>kube-proxy</strong>: 网络代理，维护网络规则</li>
<li><strong>容器运行时</strong>: Docker, containerd, CRI-O</li>
</ul>
<h3 id="1-2-核心概念"><a href="#1-2-核心概念" class="headerlink" title="1.2 核心概念"></a>1.2 核心概念</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Cluster（集群）</span><br><span class="line">├── Node（节点）</span><br><span class="line">│   ├── Pod（最小调度单元）</span><br><span class="line">│   │   └── Container（容器）</span><br><span class="line">├── Namespace（命名空间）</span><br><span class="line">└── Resource（资源）</span><br><span class="line">    ├── Deployment</span><br><span class="line">    ├── StatefulSet</span><br><span class="line">    ├── DaemonSet</span><br><span class="line">    ├── Service</span><br><span class="line">    ├── ConfigMap</span><br><span class="line">    └── Secret</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-集群部署"><a href="#2-集群部署" class="headerlink" title="2. 集群部署"></a>2. 集群部署</h2><h3 id="2-1-kubeadm-部署"><a href="#2-1-kubeadm-部署" class="headerlink" title="2.1 kubeadm 部署"></a>2.1 kubeadm 部署</h3><p><strong>Master 节点配置</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 禁用 swap</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;/ swap / s/^\(.*\)$/#\1/g&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置内核参数</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 containerd</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">&#x27;s/SystemdCgroup = false/SystemdCgroup = true/&#x27;</span> /etc/containerd/config.toml</span><br><span class="line">systemctl restart containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 kubeadm, kubelet, kubectl</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y apt-transport-https ca-certificates curl</span><br><span class="line">curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span> | <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubelet kubeadm kubectl</span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>

<p><strong>初始化集群</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 初始化 master 节点</span></span><br><span class="line">kubeadm init --pod-network-cidr=10.244.0.0/16</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 kubectl</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装网络插件（Flannel）</span></span><br><span class="line">kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 join 命令</span></span><br><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<p><strong>Worker 节点加入</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在 worker 节点执行 join 命令</span></span><br><span class="line">kubeadm <span class="built_in">join</span> &lt;master-ip&gt;:&lt;master-port&gt; --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;<span class="built_in">hash</span>&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-验证集群"><a href="#2-2-验证集群" class="headerlink" title="2.2 验证集群"></a>2.2 验证集群</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看节点</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看组件状态</span></span><br><span class="line">kubectl get componentstatuses</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看系统 Pod</span></span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-kubectl-使用指南"><a href="#3-kubectl-使用指南" class="headerlink" title="3. kubectl 使用指南"></a>3. kubectl 使用指南</h2><h3 id="3-1-基本命令"><a href="#3-1-基本命令" class="headerlink" title="3.1 基本命令"></a>3.1 基本命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line">kubectl config view</span><br><span class="line">kubectl config get-contexts</span><br><span class="line">kubectl config use-context &lt;context-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看资源</span></span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl get pods -n &lt;namespace&gt;</span><br><span class="line">kubectl get pods -o wide</span><br><span class="line">kubectl get pods -o yaml</span><br><span class="line">kubectl get pods -o json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细描述</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br><span class="line">kubectl describe pod &lt;pod-name&gt; -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志</span></span><br><span class="line">kubectl logs &lt;pod-name&gt;</span><br><span class="line">kubectl logs -f &lt;pod-name&gt;</span><br><span class="line">kubectl logs &lt;pod-name&gt; -c &lt;container-name&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-资源操作"><a href="#3-2-资源操作" class="headerlink" title="3.2 资源操作"></a>3.2 资源操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建资源</span></span><br><span class="line">kubectl create -f manifest.yaml</span><br><span class="line">kubectl apply -f manifest.yaml</span><br><span class="line">kubectl apply -f ./directory/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除资源</span></span><br><span class="line">kubectl delete -f manifest.yaml</span><br><span class="line">kubectl delete pod &lt;pod-name&gt;</span><br><span class="line">kubectl delete namespace &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑资源</span></span><br><span class="line">kubectl edit pod &lt;pod-name&gt;</span><br><span class="line">kubectl edit deployment &lt;deployment-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩缩容</span></span><br><span class="line">kubectl scale deployment &lt;deployment-name&gt; --replicas=3</span><br></pre></td></tr></table></figure>

<h3 id="3-3-进入容器"><a href="#3-3-进入容器" class="headerlink" title="3.3 进入容器"></a>3.3 进入容器</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入 Pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- /bin/bash</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -c &lt;container-name&gt; -- /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在容器中执行命令</span></span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod-name&gt; -- <span class="built_in">ls</span> -la</span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod-name&gt; -- <span class="built_in">cat</span> /etc/hosts</span><br></pre></td></tr></table></figure>

<h3 id="3-4-端口转发"><a href="#3-4-端口转发" class="headerlink" title="3.4 端口转发"></a>3.4 端口转发</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 本地端口转发</span></span><br><span class="line">kubectl port-forward &lt;pod-name&gt; 8080:80</span><br><span class="line">kubectl port-forward deployment/&lt;deployment-name&gt; 8080:80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端口转发</span></span><br><span class="line">kubectl port-forward svc/&lt;service-name&gt; 8080:80</span><br></pre></td></tr></table></figure>

<h3 id="3-5-常用别名"><a href="#3-5-常用别名" class="headerlink" title="3.5 常用别名"></a>3.5 常用别名</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加别名</span></span><br><span class="line"><span class="built_in">alias</span> k=kubectl</span><br><span class="line">complete -o default -F __start_kubectl k</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用别名</span></span><br><span class="line"><span class="built_in">alias</span> kgp=<span class="string">&#x27;kubectl get pods&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kgd=<span class="string">&#x27;kubectl get deployments&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kgs=<span class="string">&#x27;kubectl get services&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kgn=<span class="string">&#x27;kubectl get nodes&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kgl=<span class="string">&#x27;kubectl get pods -o wide&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kdp=<span class="string">&#x27;kubectl describe pod&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kdd=<span class="string">&#x27;kubectl describe deployment&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kaf=<span class="string">&#x27;kubectl apply -f&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kdf=<span class="string">&#x27;kubectl delete -f&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kl=<span class="string">&#x27;kubectl logs&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> klf=<span class="string">&#x27;kubectl logs -f&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> ke=<span class="string">&#x27;kubectl edit&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> kx=<span class="string">&#x27;kubectl delete pod&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-工作负载管理"><a href="#4-工作负载管理" class="headerlink" title="4. 工作负载管理"></a>4. 工作负载管理</h2><h3 id="4-1-Deployment"><a href="#4-1-Deployment" class="headerlink" title="4.1 Deployment"></a>4.1 Deployment</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.21</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-StatefulSet"><a href="#4-2-StatefulSet" class="headerlink" title="4.2 StatefulSet"></a>4.2 StatefulSet</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">10Gi</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-DaemonSet"><a href="#4-3-DaemonSet" class="headerlink" title="4.3 DaemonSet"></a>4.3 DaemonSet</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/node-exporter:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">9100</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-Job-CronJob"><a href="#4-4-Job-CronJob" class="headerlink" title="4.4 Job &amp; CronJob"></a>4.4 Job &amp; CronJob</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Job</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backup-job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backup</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">backup-tool:latest</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;./backup.sh&quot;</span>]</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># CronJob</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backup-cronjob</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;0 2 * * *&quot;</span>  <span class="comment"># 每天凌晨 2 点</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backup</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">backup-tool:latest</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-服务与网络"><a href="#5-服务与网络" class="headerlink" title="5. 服务与网络"></a>5. 服务与网络</h2><h3 id="5-1-Service-类型"><a href="#5-1-Service-类型" class="headerlink" title="5.1 Service 类型"></a>5.1 Service 类型</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ClusterIP（默认）</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># NodePort</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># LoadBalancer</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Headless Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">headless-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-Ingress"><a href="#5-2-Ingress" class="headerlink" title="5.2 Ingress"></a>5.2 Ingress</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">web-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/api</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">tls-secret</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-Network-Policy"><a href="#5-3-Network-Policy" class="headerlink" title="5.3 Network Policy"></a>5.3 Network Policy</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deny-all</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-web</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-存储管理"><a href="#6-存储管理" class="headerlink" title="6. 存储管理"></a>6. 存储管理</h2><h3 id="6-1-Volume-类型"><a href="#6-1-Volume-类型" class="headerlink" title="6.1 Volume 类型"></a>6.1 Volume 类型</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># emptyDir</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache</span></span><br><span class="line">  <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># hostPath</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log-volume</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data-volume</span></span><br><span class="line">  <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">    <span class="attr">claimName:</span> <span class="string">my-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ConfigMap</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">configMap:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">my-config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Secret</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret</span></span><br><span class="line">  <span class="attr">secret:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">my-secret</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-PersistentVolume"><a href="#6-2-PersistentVolume" class="headerlink" title="6.2 PersistentVolume"></a>6.2 PersistentVolume</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv-data</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/mnt/data</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-data</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-StorageClass"><a href="#6-3-StorageClass" class="headerlink" title="6.3 StorageClass"></a>6.3 StorageClass</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fast</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/aws-ebs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">gp2</span></span><br><span class="line">  <span class="attr">fsType:</span> <span class="string">ext4</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-配置管理"><a href="#7-配置管理" class="headerlink" title="7. 配置管理"></a>7. 配置管理</h2><h3 id="7-1-ConfigMap"><a href="#7-1-ConfigMap" class="headerlink" title="7.1 ConfigMap"></a>7.1 ConfigMap</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">app.properties:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    server.port=8080</span></span><br><span class="line"><span class="string">    database.host=mysql</span></span><br><span class="line"><span class="string"></span>  <span class="attr">LOG_LEVEL:</span> <span class="string">INFO</span></span><br><span class="line">  <span class="attr">ENVIRONMENT:</span> <span class="string">production</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 使用 ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">app-config</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-Secret"><a href="#7-2-Secret" class="headerlink" title="7.2 Secret"></a>7.2 Secret</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4=</span>  <span class="comment"># base64 encoded</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">cGFzc3dvcmQxMjM=</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 使用 Secret</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USERNAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">secretKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">secretKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-集群监控"><a href="#8-集群监控" class="headerlink" title="8. 集群监控"></a>8. 集群监控</h2><h3 id="8-1-Metrics-Server"><a href="#8-1-Metrics-Server" class="headerlink" title="8.1 Metrics Server"></a>8.1 Metrics Server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 Metrics Server</span></span><br><span class="line">kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看资源使用</span></span><br><span class="line">kubectl top nodes</span><br><span class="line">kubectl top pods</span><br></pre></td></tr></table></figure>

<h3 id="8-2-Prometheus-Grafana"><a href="#8-2-Prometheus-Grafana" class="headerlink" title="8.2 Prometheus + Grafana"></a>8.2 Prometheus + Grafana</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 Helm 安装</span></span><br><span class="line">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span><br><span class="line">helm install monitoring prometheus-community/kube-prometheus-stack -n monitoring --create-namespace</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问 Grafana</span></span><br><span class="line">kubectl port-forward svc/monitoring-grafana -n monitoring 3000:80</span><br></pre></td></tr></table></figure>

<h3 id="8-3-日志收集"><a href="#8-3-日志收集" class="headerlink" title="8.3 日志收集"></a>8.3 日志收集</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 EFK Stack</span></span><br><span class="line"><span class="comment"># Elasticsearch + Fluentd + Kibana</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 Loki + Promtail</span></span><br><span class="line">helm repo add grafana https://grafana.github.io/helm-charts</span><br><span class="line">helm install loki grafana/loki-stack -n logging --create-namespace</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-故障排查"><a href="#9-故障排查" class="headerlink" title="9. 故障排查"></a>9. 故障排查</h2><h3 id="9-1-常见问题"><a href="#9-1-常见问题" class="headerlink" title="9.1 常见问题"></a>9.1 常见问题</h3><p><strong>Pod 无法启动</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 Pod 状态</span></span><br><span class="line">kubectl get pods -o wide</span><br><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">kubectl logs &lt;pod-name&gt;</span><br><span class="line">kubectl logs &lt;pod-name&gt; --previous</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查事件</span></span><br><span class="line">kubectl get events --sort-by=<span class="string">&#x27;.lastTimestamp&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Pod 处于 Pending 状态</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查资源</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br><span class="line">kubectl top nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查调度</span></span><br><span class="line">kubectl get events | grep &lt;pod-name&gt;</span><br></pre></td></tr></table></figure>

<p><strong>节点 NotReady</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查节点状态</span></span><br><span class="line">kubectl describe node &lt;node-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 kubelet</span></span><br><span class="line">systemctl status kubelet</span><br><span class="line">journalctl -u kubelet -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查网络</span></span><br><span class="line">kubectl get pods -n kube-system -o wide</span><br></pre></td></tr></table></figure>

<h3 id="9-2-调试工具"><a href="#9-2-调试工具" class="headerlink" title="9.2 调试工具"></a>9.2 调试工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 临时调试容器</span></span><br><span class="line">kubectl debug -it &lt;pod-name&gt; --image=busybox</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建调试 Pod</span></span><br><span class="line">kubectl run -it --<span class="built_in">rm</span> debug --image=busybox --restart=Never</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络调试</span></span><br><span class="line">kubectl run -it --<span class="built_in">rm</span> netshoot --image=nicolaka/netshoot --restart=Never</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-备份与恢复"><a href="#10-备份与恢复" class="headerlink" title="10. 备份与恢复"></a>10. 备份与恢复</h2><h3 id="10-1-etcd-备份"><a href="#10-1-etcd-备份" class="headerlink" title="10.1 etcd 备份"></a>10.1 etcd 备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备份 etcd</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot save snapshot.db \</span><br><span class="line">  --endpoints=https://127.0.0.1:2379 \</span><br><span class="line">  --cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">  --cert=/etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">  --key=/etc/kubernetes/pki/etcd/server.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复 etcd</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore snapshot.db \</span><br><span class="line">  --data-dir=/var/lib/etcd-restore</span><br></pre></td></tr></table></figure>

<h3 id="10-2-资源备份"><a href="#10-2-资源备份" class="headerlink" title="10.2 资源备份"></a>10.2 资源备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备份所有资源</span></span><br><span class="line">kubectl get all --all-namespaces -o yaml &gt; all-resources.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份特定命名空间</span></span><br><span class="line">kubectl get all -n &lt;namespace&gt; -o yaml &gt; namespace-resources.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 velero</span></span><br><span class="line">velero backup create daily-backup --include-namespaces default,production</span><br><span class="line">velero backup get</span><br><span class="line">velero restore create --from-backup daily-backup</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用版本</strong>: Kubernetes 1.23+</p>
]]></content>
      <categories>
        <category>软件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>Redis 缓存运维指南</title>
    <url>/2026/02/28/06-Redis%E7%BC%93%E5%AD%98%E8%BF%90%E7%BB%B4%E6%8C%87%E5%8D%97/</url>
    <content><![CDATA[<h1 id="Redis-缓存运维指南"><a href="#Redis-缓存运维指南" class="headerlink" title="Redis 缓存运维指南"></a>Redis 缓存运维指南</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-redis-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE">Redis 安装与配置</a></li>
<li><a href="#2-%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3">核心配置详解</a></li>
<li><a href="#3-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96">数据持久化</a></li>
<li><a href="#4-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">主从复制</a></li>
<li><a href="#5-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F">哨兵模式</a></li>
<li><a href="#6-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F">集群模式</a></li>
<li><a href="#7-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化</a></li>
<li><a href="#8-%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%AF%8A%E6%96%AD">监控与诊断</a></li>
<li><a href="#9-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA">安全加固</a></li>
</ol>
<hr>
<h2 id="1-Redis-安装与配置"><a href="#1-Redis-安装与配置" class="headerlink" title="1. Redis 安装与配置"></a>1. Redis 安装与配置</h2><h3 id="1-1-源码安装"><a href="#1-1-源码安装" class="headerlink" title="1.1 源码安装"></a>1.1 源码安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载 Redis</span></span><br><span class="line">wget https://download.redis.io/releases/redis-7.0.5.tar.gz</span><br><span class="line">tar xzf redis-7.0.5.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-7.0.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译安装</span></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">redis-server --version</span><br><span class="line">redis-cli --version</span><br></pre></td></tr></table></figure>

<h3 id="1-2-系统配置"><a href="#1-2-系统配置" class="headerlink" title="1.2 系统配置"></a>1.2 系统配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改内核参数</span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/sysctl.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 1</span></span><br><span class="line"><span class="string">net.core.somaxconn = 65535</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用透明大页</span></span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 redis 用户</span></span><br><span class="line">useradd -r -s /sbin/nologin redis</span><br><span class="line"><span class="built_in">mkdir</span> -p /var/lib/redis /var/log/redis</span><br><span class="line"><span class="built_in">chown</span> -R redis:redis /var/lib/redis /var/log/redis</span><br></pre></td></tr></table></figure>

<h3 id="1-3-配置文件"><a href="#1-3-配置文件" class="headerlink" title="1.3 配置文件"></a>1.3 配置文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 复制配置文件</span></span><br><span class="line"><span class="built_in">cp</span> redis.conf /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关键配置修改</span></span><br><span class="line">sed -i <span class="string">&#x27;s/daemonize no/daemonize yes/&#x27;</span> /etc/redis/redis.conf</span><br><span class="line">sed -i <span class="string">&#x27;s/# bind 127.0.0.1/bind 0.0.0.0/&#x27;</span> /etc/redis/redis.conf</span><br><span class="line">sed -i <span class="string">&#x27;s/protected-mode yes/protected-mode no/&#x27;</span> /etc/redis/redis.conf</span><br><span class="line">sed -i <span class="string">&#x27;s|dir ./|dir /var/lib/redis|&#x27;</span> /etc/redis/redis.conf</span><br><span class="line">sed -i <span class="string">&#x27;s|logfile &quot;&quot;|logfile /var/log/redis/redis.log|&#x27;</span> /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>

<h3 id="1-4-Systemd-配置"><a href="#1-4-Systemd-配置" class="headerlink" title="1.4 Systemd 配置"></a>1.4 Systemd 配置</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/systemd/system/redis.service</span></span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Redis In-Memory Data Store</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">User</span>=redis</span><br><span class="line"><span class="attr">Group</span>=redis</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/redis-server /etc/redis/redis.conf</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/local/bin/redis-cli shutdown</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 Redis</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start redis</span><br><span class="line">systemctl <span class="built_in">enable</span> redis</span><br><span class="line">systemctl status redis</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-核心配置详解"><a href="#2-核心配置详解" class="headerlink" title="2. 核心配置详解"></a>2. 核心配置详解</h2><h3 id="2-1-网络配置"><a href="#2-1-网络配置" class="headerlink" title="2.1 网络配置"></a>2.1 网络配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 绑定地址</span><br><span class="line">bind 127.0.0.1 ::1</span><br><span class="line"></span><br><span class="line"># 端口</span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line"># 超时时间（0 表示永不超时）</span><br><span class="line">timeout 0</span><br><span class="line"></span><br><span class="line"># TCP keepalive</span><br><span class="line">tcp-keepalive 300</span><br><span class="line"></span><br><span class="line"># 保护模式</span><br><span class="line">protected-mode yes</span><br></pre></td></tr></table></figure>

<h3 id="2-2-内存配置"><a href="#2-2-内存配置" class="headerlink" title="2.2 内存配置"></a>2.2 内存配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 最大内存</span><br><span class="line">maxmemory 2gb</span><br><span class="line"></span><br><span class="line"># 内存淘汰策略</span><br><span class="line"># volatile-lru: 对设置了过期时间的 key 使用 LRU 算法</span><br><span class="line"># allkeys-lru: 对所有 key 使用 LRU 算法</span><br><span class="line"># volatile-ttl: 对设置了过期时间的 key 使用 TTL 算法</span><br><span class="line"># noeviction: 不淘汰任何 key（默认）</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"># LRU 采样数量</span><br><span class="line">maxmemory-samples 5</span><br></pre></td></tr></table></figure>

<h3 id="2-3-连接配置"><a href="#2-3-连接配置" class="headerlink" title="2.3 连接配置"></a>2.3 连接配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 最大客户端连接数</span><br><span class="line">maxclients 10000</span><br><span class="line"></span><br><span class="line"># 密码认证</span><br><span class="line">requirepass your_password</span><br><span class="line"></span><br><span class="line"># 重命名危险命令</span><br><span class="line">rename-command FLUSHALL &quot;&quot;</span><br><span class="line">rename-command FLUSHDB &quot;&quot;</span><br><span class="line">rename-command CONFIG &quot;&quot;</span><br><span class="line">rename-command DEBUG &quot;&quot;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-数据持久化"><a href="#3-数据持久化" class="headerlink" title="3. 数据持久化"></a>3. 数据持久化</h2><h3 id="3-1-RDB-快照"><a href="#3-1-RDB-快照" class="headerlink" title="3.1 RDB 快照"></a>3.1 RDB 快照</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># RDB 配置</span><br><span class="line">save 900 1        # 900 秒内至少 1 个 key 变化</span><br><span class="line">save 300 10       # 300 秒内至少 10 个 key 变化</span><br><span class="line">save 60 10000     # 60 秒内至少 10000 个 key 变化</span><br><span class="line"></span><br><span class="line"># RDB 文件名</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"># RDB 压缩</span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line"># RDB 校验和</span><br><span class="line">rdbchecksum yes</span><br><span class="line"></span><br><span class="line"># 持久化目录</span><br><span class="line">dir /var/lib/redis</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 手动触发 RDB 快照</span></span><br><span class="line">redis-cli BGSAVE</span><br><span class="line">redis-cli SAVE  <span class="comment"># 阻塞式，不推荐生产使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 RDB 信息</span></span><br><span class="line">redis-cli INFO persistence</span><br></pre></td></tr></table></figure>

<h3 id="3-2-AOF-日志"><a href="#3-2-AOF-日志" class="headerlink" title="3.2 AOF 日志"></a>3.2 AOF 日志</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># AOF 配置</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line"></span><br><span class="line"># AOF 同步策略</span><br><span class="line"># always: 每次写入都同步（最安全，性能最差）</span><br><span class="line"># everysec: 每秒同步一次（推荐）</span><br><span class="line"># no: 由操作系统决定何时同步（性能最好，安全性最差）</span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"># AOF 重写</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 手动触发 AOF 重写</span></span><br><span class="line">redis-cli BGREWRITEAOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 AOF 信息</span></span><br><span class="line">redis-cli INFO persistence</span><br></pre></td></tr></table></figure>

<h3 id="3-3-混合持久化（Redis-4-0-）"><a href="#3-3-混合持久化（Redis-4-0-）" class="headerlink" title="3.3 混合持久化（Redis 4.0+）"></a>3.3 混合持久化（Redis 4.0+）</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 启用 RDB-AOF 混合持久化</span><br><span class="line">aof-use-rdb-preamble yes</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-主从复制"><a href="#4-主从复制" class="headerlink" title="4. 主从复制"></a>4. 主从复制</h2><h3 id="4-1-配置从节点"><a href="#4-1-配置从节点" class="headerlink" title="4.1 配置从节点"></a>4.1 配置从节点</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 从节点配置</span><br><span class="line">replicaof 192.168.1.100 6379</span><br><span class="line">masterauth your_master_password</span><br><span class="line"></span><br><span class="line"># 从节点只读</span><br><span class="line">replica-read-only yes</span><br><span class="line"></span><br><span class="line"># 复制超时</span><br><span class="line">repl-timeout 60</span><br><span class="line"></span><br><span class="line"># 复制 ping 间隔</span><br><span class="line">repl-ping-replica-period 10</span><br></pre></td></tr></table></figure>

<h3 id="4-2-动态配置"><a href="#4-2-动态配置" class="headerlink" title="4.2 动态配置"></a>4.2 动态配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在从节点上执行</span></span><br><span class="line">redis-cli SLAVEOF 192.168.1.100 6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 断开主从关系</span></span><br><span class="line">redis-cli SLAVEOF NO ONE</span><br></pre></td></tr></table></figure>

<h3 id="4-3-监控复制"><a href="#4-3-监控复制" class="headerlink" title="4.3 监控复制"></a>4.3 监控复制</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看复制信息</span></span><br><span class="line">redis-cli INFO replication</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主节点查看</span></span><br><span class="line">role</span><br><span class="line"><span class="comment"># 输出：master,connected_slaves:2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从节点查看</span></span><br><span class="line">role</span><br><span class="line"><span class="comment"># 输出：slave,master_host:192.168.1.100,master_port:6379</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-哨兵模式"><a href="#5-哨兵模式" class="headerlink" title="5. 哨兵模式"></a>5. 哨兵模式</h2><h3 id="5-1-哨兵配置"><a href="#5-1-哨兵配置" class="headerlink" title="5.1 哨兵配置"></a>5.1 哨兵配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># sentinel.conf</span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis/redis-sentinel.pid</span><br><span class="line">logfile /var/log/redis/sentinel.log</span><br><span class="line"></span><br><span class="line"># 监控主节点</span><br><span class="line">sentinel monitor mymaster 192.168.1.100 6379 2</span><br><span class="line"></span><br><span class="line"># 认证</span><br><span class="line">sentinel auth-pass mymaster your_password</span><br><span class="line"></span><br><span class="line"># 故障判定时间（毫秒）</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line"></span><br><span class="line"># 并行同步数</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"></span><br><span class="line"># 故障转移超时（毫秒）</span><br><span class="line">sentinel failover-timeout mymaster 10000</span><br><span class="line"></span><br><span class="line"># 通知脚本</span><br><span class="line">sentinel notification-script mymaster /var/redis/notify.sh</span><br></pre></td></tr></table></figure>

<h3 id="5-2-启动哨兵"><a href="#5-2-启动哨兵" class="headerlink" title="5.2 启动哨兵"></a>5.2 启动哨兵</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动哨兵</span></span><br><span class="line">redis-sentinel /etc/redis/sentinel.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 systemd</span></span><br><span class="line">systemctl start redis-sentinel</span><br></pre></td></tr></table></figure>

<h3 id="5-3-哨兵命令"><a href="#5-3-哨兵命令" class="headerlink" title="5.3 哨兵命令"></a>5.3 哨兵命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看主节点信息</span></span><br><span class="line">redis-cli -p 26379 SENTINEL masters</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看从节点信息</span></span><br><span class="line">redis-cli -p 26379 SENTINEL slaves mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看主节点地址</span></span><br><span class="line">redis-cli -p 26379 SENTINEL get-master-addr-by-name mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 故障转移</span></span><br><span class="line">redis-cli -p 26379 SENTINEL failover mymaster</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-集群模式"><a href="#6-集群模式" class="headerlink" title="6. 集群模式"></a>6. 集群模式</h2><h3 id="6-1-创建集群"><a href="#6-1-创建集群" class="headerlink" title="6.1 创建集群"></a>6.1 创建集群</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 redis-cli 创建集群</span></span><br><span class="line">redis-cli --cluster create \</span><br><span class="line">  192.168.1.100:6379 192.168.1.101:6379 192.168.1.102:6379 \</span><br><span class="line">  192.168.1.103:6379 192.168.1.104:6379 192.168.1.105:6379 \</span><br><span class="line">  --cluster-replicas 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建空集群</span></span><br><span class="line">redis-cli --cluster create 192.168.1.100:6379 --cluster-empty</span><br></pre></td></tr></table></figure>

<h3 id="6-2-节点配置"><a href="#6-2-节点配置" class="headerlink" title="6.2 节点配置"></a>6.2 节点配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 启用集群模式</span><br><span class="line">cluster-enabled yes</span><br><span class="line"></span><br><span class="line"># 集群配置文件</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line"></span><br><span class="line"># 节点超时时间（毫秒）</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line"></span><br><span class="line"># 集群密码</span><br><span class="line">masterauth your_password</span><br><span class="line">requirepass your_password</span><br></pre></td></tr></table></figure>

<h3 id="6-3-集群管理"><a href="#6-3-集群管理" class="headerlink" title="6.3 集群管理"></a>6.3 集群管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">redis-cli -c -p 6379 CLUSTER INFO</span><br><span class="line">redis-cli -c -p 6379 CLUSTER NODES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看槽位分布</span></span><br><span class="line">redis-cli --cluster check 192.168.1.100:6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加节点</span></span><br><span class="line">redis-cli --cluster add-node 192.168.1.106:6379 192.168.1.100:6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除节点</span></span><br><span class="line">redis-cli --cluster del-node 192.168.1.100:6379 &lt;node-id&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新分片</span></span><br><span class="line">redis-cli --cluster reshard 192.168.1.100:6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 故障转移</span></span><br><span class="line">redis-cli --cluster failover 192.168.1.100:6379</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-性能优化"><a href="#7-性能优化" class="headerlink" title="7. 性能优化"></a>7. 性能优化</h2><h3 id="7-1-内存优化"><a href="#7-1-内存优化" class="headerlink" title="7.1 内存优化"></a>7.1 内存优化</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 使用更高效的数据结构</span><br><span class="line"># 例如：hash-max-ziplist-entries, hash-max-ziplist-value</span><br><span class="line"></span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br></pre></td></tr></table></figure>

<h3 id="7-2-网络优化"><a href="#7-2-网络优化" class="headerlink" title="7.2 网络优化"></a>7.2 网络优化</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># TCP  backlog</span><br><span class="line">tcp-backlog 65535</span><br><span class="line"></span><br><span class="line"># 禁用 THP</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"></span><br><span class="line"># 增加文件描述符限制</span><br><span class="line">ulimit -n 65535</span><br></pre></td></tr></table></figure>

<h3 id="7-3-批量操作"><a href="#7-3-批量操作" class="headerlink" title="7.3 批量操作"></a>7.3 批量操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用管道</span></span><br><span class="line">redis-cli --pipe &lt; commands.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 MSET/MGET</span></span><br><span class="line">redis-cli MSET key1 value1 key2 value2 key3 value3</span><br><span class="line">redis-cli MGET key1 key2 key3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Lua 脚本</span></span><br><span class="line">redis-cli EVAL <span class="string">&quot;return redis.call(&#x27;SET&#x27;, KEYS[1], ARGV[1])&quot;</span> 1 key1 value1</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-监控与诊断"><a href="#8-监控与诊断" class="headerlink" title="8. 监控与诊断"></a>8. 监控与诊断</h2><h3 id="8-1-INFO-命令"><a href="#8-1-INFO-命令" class="headerlink" title="8.1 INFO 命令"></a>8.1 INFO 命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有信息</span></span><br><span class="line">redis-cli INFO</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看特定部分</span></span><br><span class="line">redis-cli INFO memory</span><br><span class="line">redis-cli INFO persistence</span><br><span class="line">redis-cli INFO replication</span><br><span class="line">redis-cli INFO stats</span><br><span class="line">redis-cli INFO keyspace</span><br></pre></td></tr></table></figure>

<h3 id="8-2-慢查询日志"><a href="#8-2-慢查询日志" class="headerlink" title="8.2 慢查询日志"></a>8.2 慢查询日志</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 慢查询阈值（微秒）</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line"></span><br><span class="line"># 慢查询记录数</span><br><span class="line">slowlog-max-len 128</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看慢查询</span></span><br><span class="line">redis-cli SLOWLOG GET 10</span><br><span class="line">redis-cli SLOWLOG LEN</span><br><span class="line">redis-cli SLOWLOG RESET</span><br></pre></td></tr></table></figure>

<h3 id="8-3-实时监控"><a href="#8-3-实时监控" class="headerlink" title="8.3 实时监控"></a>8.3 实时监控</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 实时监控命令</span></span><br><span class="line">redis-cli --<span class="built_in">stat</span></span><br><span class="line">redis-cli --bigkeys</span><br><span class="line">redis-cli --hotkeys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控延迟</span></span><br><span class="line">redis-cli --intrinsic-latency 100</span><br></pre></td></tr></table></figure>

<h3 id="8-4-监控工具"><a href="#8-4-监控工具" class="headerlink" title="8.4 监控工具"></a>8.4 监控工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Redis Monitor</span></span><br><span class="line">redis-monitor</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prometheus Exporter</span></span><br><span class="line">redis_exporter --redis.addr=localhost:6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># Grafana 仪表盘</span></span><br><span class="line"><span class="comment"># 导入 Redis 官方仪表盘 ID: 11835</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-安全加固"><a href="#9-安全加固" class="headerlink" title="9. 安全加固"></a>9. 安全加固</h2><h3 id="9-1-访问控制"><a href="#9-1-访问控制" class="headerlink" title="9.1 访问控制"></a>9.1 访问控制</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 设置密码</span><br><span class="line">requirepass StrongP@ssw0rd123</span><br><span class="line"></span><br><span class="line"># 绑定内网 IP</span><br><span class="line">bind 192.168.1.100</span><br><span class="line"></span><br><span class="line"># 禁用危险命令</span><br><span class="line">rename-command FLUSHALL &quot;&quot;</span><br><span class="line">rename-command FLUSHDB &quot;&quot;</span><br><span class="line">rename-command CONFIG &quot;&quot;</span><br><span class="line">rename-command DEBUG &quot;&quot;</span><br><span class="line">rename-command SHUTDOWN SHUTDOWN_SECRET</span><br></pre></td></tr></table></figure>

<h3 id="9-2-网络安全"><a href="#9-2-网络安全" class="headerlink" title="9.2 网络安全"></a>9.2 网络安全</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 防火墙配置</span></span><br><span class="line">firewall-cmd --add-port=6379/tcp --permanent</span><br><span class="line">firewall-cmd --add-rich-rule=<span class="string">&#x27;rule family=&quot;ipv4&quot; source address=&quot;192.168.1.0/24&quot; port port=&quot;6379&quot; protocol=&quot;tcp&quot; accept&#x27;</span> --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 iptables</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 6379 -s 192.168.1.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure>

<h3 id="9-3-SSL-TLS（Redis-6-0-）"><a href="#9-3-SSL-TLS（Redis-6-0-）" class="headerlink" title="9.3 SSL&#x2F;TLS（Redis 6.0+）"></a>9.3 SSL&#x2F;TLS（Redis 6.0+）</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 启用 TLS</span><br><span class="line">tls-port 6379</span><br><span class="line">port 0</span><br><span class="line"></span><br><span class="line">tls-cert-file /etc/redis/tls/redis.crt</span><br><span class="line">tls-key-file /etc/redis/tls/redis.key</span><br><span class="line">tls-ca-cert-file /etc/redis/tls/ca.crt</span><br><span class="line"></span><br><span class="line">tls-auth-clients yes</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用版本</strong>: Redis 6.0+, 7.0+</p>
]]></content>
      <categories>
        <category>软件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>MySQL 数据库运维手册</title>
    <url>/2026/02/28/05-MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%90%E7%BB%B4%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h1 id="MySQL-数据库运维手册"><a href="#MySQL-数据库运维手册" class="headerlink" title="MySQL 数据库运维手册"></a>MySQL 数据库运维手册</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-mysql-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE">MySQL 安装与配置</a></li>
<li><a href="#2-%E7%94%A8%E6%88%B7%E4%B8%8E%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86">用户与权限管理</a></li>
<li><a href="#3-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C">数据库操作</a></li>
<li><a href="#4-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D">备份与恢复</a></li>
<li><a href="#5-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化</a></li>
<li><a href="#6-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">主从复制</a></li>
<li><a href="#7-%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%AF%8A%E6%96%AD">监控与诊断</a></li>
<li><a href="#8-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA">安全加固</a></li>
<li><a href="#9-%E6%97%A5%E5%B8%B8%E7%BB%B4%E6%8A%A4">日常维护</a></li>
</ol>
<hr>
<h2 id="1-MySQL-安装与配置"><a href="#1-MySQL-安装与配置" class="headerlink" title="1. MySQL 安装与配置"></a>1. MySQL 安装与配置</h2><h3 id="1-1-CentOS-RHEL-安装"><a href="#1-1-CentOS-RHEL-安装" class="headerlink" title="1.1 CentOS&#x2F;RHEL 安装"></a>1.1 CentOS&#x2F;RHEL 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载 MySQL YUM 仓库</span></span><br><span class="line">wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">yum localinstall -y mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 MySQL</span></span><br><span class="line">yum install -y mysql-community-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 MySQL</span></span><br><span class="line">systemctl start mysqld</span><br><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看临时密码</span></span><br><span class="line">grep <span class="string">&#x27;temporary password&#x27;</span> /var/log/mysqld.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安全初始化</span></span><br><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Ubuntu-Debian-安装"><a href="#1-2-Ubuntu-Debian-安装" class="headerlink" title="1.2 Ubuntu&#x2F;Debian 安装"></a>1.2 Ubuntu&#x2F;Debian 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载 MySQL APT 仓库</span></span><br><span class="line">wget https://dev.mysql.com/get/mysql-apt-config_0.8.22-1_all.deb</span><br><span class="line">dpkg -i mysql-apt-config_0.8.22-1_all.deb</span><br><span class="line">apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 MySQL</span></span><br><span class="line">apt-get install -y mysql-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 MySQL</span></span><br><span class="line">systemctl start mysql</span><br><span class="line">systemctl <span class="built_in">enable</span> mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安全初始化</span></span><br><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>

<h3 id="1-3-配置文件"><a href="#1-3-配置文件" class="headerlink" title="1.3 配置文件"></a>1.3 配置文件</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/my.cnf 或 /etc/mysql/mysql.conf.d/mysqld.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 基础配置</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line"><span class="attr">socket</span> = /var/lib/mysql/mysql.sock</span><br><span class="line"><span class="attr">datadir</span> = /var/lib/mysql</span><br><span class="line"><span class="attr">pid-file</span> = /var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line"><span class="attr">character-set-server</span> = utf8mb4</span><br><span class="line"><span class="attr">collation-server</span> = utf8mb4_unicode_ci</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接配置</span></span><br><span class="line"><span class="attr">max_connections</span> = <span class="number">500</span></span><br><span class="line"><span class="attr">max_connect_errors</span> = <span class="number">10000</span></span><br><span class="line"><span class="attr">wait_timeout</span> = <span class="number">28800</span></span><br><span class="line"><span class="attr">interactive_timeout</span> = <span class="number">28800</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># InnoDB 配置</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">1</span>G</span><br><span class="line"><span class="attr">innodb_log_file_size</span> = <span class="number">256</span>M</span><br><span class="line"><span class="attr">innodb_log_buffer_size</span> = <span class="number">16</span>M</span><br><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">innodb_flush_method</span> = O_DIRECT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line"><span class="attr">log_error</span> = /var/log/mysql/error.log</span><br><span class="line"><span class="attr">slow_query_log</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">slow_query_log_file</span> = /var/log/mysql/slow.log</span><br><span class="line"><span class="attr">long_query_time</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">log_queries_not_using_indexes</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 二进制日志</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin</span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"><span class="attr">expire_logs_days</span> = <span class="number">7</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="number">100</span>M</span><br><span class="line"></span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-用户与权限管理"><a href="#2-用户与权限管理" class="headerlink" title="2. 用户与权限管理"></a>2. 用户与权限管理</h2><h3 id="2-1-用户管理"><a href="#2-1-用户管理" class="headerlink" title="2.1 用户管理"></a>2.1 用户管理</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password123&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改密码</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;newpassword&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> PASSWORD <span class="keyword">FOR</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="operator">=</span> PASSWORD(<span class="string">&#x27;newpassword&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除用户</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看用户</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span>, host <span class="keyword">FROM</span> mysql.user;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-权限管理"><a href="#2-2-权限管理" class="headerlink" title="2.2 权限管理"></a>2.2 权限管理</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 授予权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> database.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span> <span class="keyword">ON</span> database.table <span class="keyword">TO</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 撤销权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> database.<span class="operator">*</span> <span class="keyword">FROM</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新权限</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-角色管理（MySQL-8-0-）"><a href="#2-3-角色管理（MySQL-8-0-）" class="headerlink" title="2.3 角色管理（MySQL 8.0+）"></a>2.3 角色管理（MySQL 8.0+）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建角色</span></span><br><span class="line"><span class="keyword">CREATE</span> ROLE <span class="string">&#x27;read_only&#x27;</span>, <span class="string">&#x27;read_write&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予角色权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;read_only&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;read_write&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予用户角色</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="string">&#x27;read_write&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置默认角色</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">DEFAULT</span> ROLE <span class="string">&#x27;read_write&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-数据库操作"><a href="#3-数据库操作" class="headerlink" title="3. 数据库操作"></a>3. 数据库操作</h2><h3 id="3-1-数据库管理"><a href="#3-1-数据库管理" class="headerlink" title="3.1 数据库管理"></a>3.1 数据库管理</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE mydb <span class="keyword">CHARACTER SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看数据库</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> DATABASE mydb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 选择数据库</span></span><br><span class="line">USE mydb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除数据库</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE mydb;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-表管理"><a href="#3-2-表管理" class="headerlink" title="3.2 表管理"></a>3.2 表管理</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_email (email)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="keyword">DESCRIBE</span> users;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE TABLE</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改表</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> phone <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> users MODIFY <span class="keyword">COLUMN</span> email <span class="type">VARCHAR</span>(<span class="number">200</span>);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ADD</span> INDEX idx_phone (phone);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> users;</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> users;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-数据操作"><a href="#3-3-数据操作" class="headerlink" title="3.3 数据操作"></a>3.3 数据操作</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (username, email) <span class="keyword">VALUES</span> (<span class="string">&#x27;john&#x27;</span>, <span class="string">&#x27;john@example.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> users (username, email) <span class="keyword">VALUES</span> (<span class="string">&#x27;jane&#x27;</span>, <span class="string">&#x27;jane@example.com&#x27;</span>), (<span class="string">&#x27;bob&#x27;</span>, <span class="string">&#x27;bob@example.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users;</span><br><span class="line"><span class="keyword">SELECT</span> id, username <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新数据</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> email <span class="operator">=</span> <span class="string">&#x27;new@example.com&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除数据</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-备份与恢复"><a href="#4-备份与恢复" class="headerlink" title="4. 备份与恢复"></a>4. 备份与恢复</h2><h3 id="4-1-mysqldump-备份"><a href="#4-1-mysqldump-备份" class="headerlink" title="4.1 mysqldump 备份"></a>4.1 mysqldump 备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备份单个数据库</span></span><br><span class="line">mysqldump -u root -p mydb &gt; mydb_backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份所有数据库</span></span><br><span class="line">mysqldump -u root -p --all-databases &gt; all_databases.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份特定表</span></span><br><span class="line">mysqldump -u root -p mydb <span class="built_in">users</span> orders &gt; tables_backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 压缩备份</span></span><br><span class="line">mysqldump -u root -p mydb | gzip &gt; mydb_backup.sql.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带时间戳备份</span></span><br><span class="line">mysqldump -u root -p mydb &gt; mydb_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 仅备份结构</span></span><br><span class="line">mysqldump -u root -p --no-data mydb &gt; mydb_structure.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 仅备份数据</span></span><br><span class="line">mysqldump -u root -p --no-create-info mydb &gt; mydb_data.sql</span><br></pre></td></tr></table></figure>

<h3 id="4-2-恢复备份"><a href="#4-2-恢复备份" class="headerlink" title="4.2 恢复备份"></a>4.2 恢复备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 恢复数据库</span></span><br><span class="line">mysql -u root -p mydb &lt; mydb_backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复压缩备份</span></span><br><span class="line">gunzip &lt; mydb_backup.sql.gz | mysql -u root -p mydb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复所有数据库</span></span><br><span class="line">mysql -u root -p &lt; all_databases.sql</span><br></pre></td></tr></table></figure>

<h3 id="4-3-物理备份"><a href="#4-3-物理备份" class="headerlink" title="4.3 物理备份"></a>4.3 物理备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 停止 MySQL</span></span><br><span class="line">systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制数据目录</span></span><br><span class="line"><span class="built_in">cp</span> -r /var/lib/mysql /backup/mysql_backup_$(<span class="built_in">date</span> +%Y%m%d)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 MySQL</span></span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>

<h3 id="4-4-增量备份"><a href="#4-4-增量备份" class="headerlink" title="4.4 增量备份"></a>4.4 增量备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用二进制日志</span></span><br><span class="line"><span class="comment"># 在 my.cnf 中配置</span></span><br><span class="line">log_bin = /var/log/mysql/mysql-bin</span><br><span class="line">binlog_format = ROW</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新二进制日志</span></span><br><span class="line">mysql -u root -p -e <span class="string">&quot;FLUSH LOGS;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看二进制日志</span></span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用二进制日志恢复</span></span><br><span class="line">mysqlbinlog mysql-bin.000001 | mysql -u root -p</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-性能优化"><a href="#5-性能优化" class="headerlink" title="5. 性能优化"></a>5. 性能优化</h2><h3 id="5-1-索引优化"><a href="#5-1-索引优化" class="headerlink" title="5.1 索引优化"></a>5.1 索引优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看索引使用情况</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;test@example.com&#x27;</span>;</span><br><span class="line">EXPLAIN FORMAT<span class="operator">=</span>JSON <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;test@example.com&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_email <span class="keyword">ON</span> users(email);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name_age <span class="keyword">ON</span> users(name, age);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看索引</span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除索引</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_email <span class="keyword">ON</span> users;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-查询优化"><a href="#5-2-查询优化" class="headerlink" title="5.2 查询优化"></a>5.2 查询优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 避免 SELECT *</span></span><br><span class="line"><span class="keyword">SELECT</span> id, username, email <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 LIMIT</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users LIMIT <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 避免在索引列上使用函数</span></span><br><span class="line"><span class="comment">-- 不推荐</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> <span class="type">DATE</span>(created_at) <span class="operator">=</span> <span class="string">&#x27;2024-01-01&#x27;</span>;</span><br><span class="line"><span class="comment">-- 推荐</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-01&#x27;</span> <span class="keyword">AND</span> created_at <span class="operator">&lt;</span> <span class="string">&#x27;2024-01-02&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 JOIN 代替子查询</span></span><br><span class="line"><span class="keyword">SELECT</span> u.<span class="operator">*</span>, o.<span class="operator">*</span> <span class="keyword">FROM</span> users u <span class="keyword">JOIN</span> orders o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-配置优化"><a href="#5-3-配置优化" class="headerlink" title="5.3 配置优化"></a>5.3 配置优化</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 关键性能参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 缓冲池（建议设置为物理内存的 50-70%）</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">4</span>G</span><br><span class="line"><span class="attr">innodb_buffer_pool_instances</span> = <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line"><span class="attr">innodb_log_file_size</span> = <span class="number">512</span>M</span><br><span class="line"><span class="attr">innodb_log_buffer_size</span> = <span class="number">32</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接配置</span></span><br><span class="line"><span class="attr">max_connections</span> = <span class="number">1000</span></span><br><span class="line"><span class="attr">thread_cache_size</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表缓存</span></span><br><span class="line"><span class="attr">table_open_cache</span> = <span class="number">4000</span></span><br><span class="line"><span class="attr">table_definition_cache</span> = <span class="number">2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序和临时表</span></span><br><span class="line"><span class="attr">sort_buffer_size</span> = <span class="number">4</span>M</span><br><span class="line"><span class="attr">read_buffer_size</span> = <span class="number">2</span>M</span><br><span class="line"><span class="attr">read_rnd_buffer_size</span> = <span class="number">4</span>M</span><br><span class="line"><span class="attr">tmp_table_size</span> = <span class="number">256</span>M</span><br><span class="line"><span class="attr">max_heap_table_size</span> = <span class="number">256</span>M</span><br></pre></td></tr></table></figure>

<h3 id="5-4-慢查询分析"><a href="#5-4-慢查询分析" class="headerlink" title="5.4 慢查询分析"></a>5.4 慢查询分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看慢查询日志</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query_log%&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;long_query_time&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢查询统计</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.slow_log;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 pt-query-digest 分析</span></span><br><span class="line">pt<span class="operator">-</span>query<span class="operator">-</span>digest <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mysql<span class="operator">/</span>slow.log <span class="operator">&gt;</span> slow_query_analysis.txt</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-主从复制"><a href="#6-主从复制" class="headerlink" title="6. 主从复制"></a>6. 主从复制</h2><h3 id="6-1-配置主服务器"><a href="#6-1-配置主服务器" class="headerlink" title="6.1 配置主服务器"></a>6.1 配置主服务器</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># my.cnf</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin</span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"><span class="attr">binlog_do_db</span> = mydb</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建复制用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看主服务器状态</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br><span class="line"><span class="comment">-- 记录 File 和 Position</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-配置从服务器"><a href="#6-2-配置从服务器" class="headerlink" title="6.2 配置从服务器"></a>6.2 配置从服务器</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># my.cnf</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">relay_log</span> = /var/log/mysql/mysql-relay-bin</span><br><span class="line"><span class="attr">read_only</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 配置主从关系</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">    MASTER_HOST<span class="operator">=</span><span class="string">&#x27;master_ip&#x27;</span>,</span><br><span class="line">    MASTER_USER<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">    MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">    MASTER_LOG_FILE<span class="operator">=</span><span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">    MASTER_LOG_POS<span class="operator">=</span><span class="number">154</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 启动复制</span></span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看复制状态</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="comment">-- 检查 Slave_IO_Running 和 Slave_SQL_Running 是否为 Yes</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-主从切换"><a href="#6-3-主从切换" class="headerlink" title="6.3 主从切换"></a>6.3 主从切换</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 停止主服务器写入</span></span><br><span class="line">FLUSH TABLES <span class="keyword">WITH</span> READ LOCK;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等待从服务器同步</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="comment">-- 检查 Seconds_Behind_Master 为 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提升从服务器为主</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line">RESET SLAVE <span class="keyword">ALL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在新主服务器上创建复制用户</span></span><br><span class="line"><span class="comment">-- 配置其他从服务器指向新主</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-监控与诊断"><a href="#7-监控与诊断" class="headerlink" title="7. 监控与诊断"></a>7. 监控与诊断</h2><h3 id="7-1-状态监控"><a href="#7-1-状态监控" class="headerlink" title="7.1 状态监控"></a>7.1 状态监控</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看服务器状态</span></span><br><span class="line"><span class="keyword">SHOW</span> STATUS;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> STATUS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看变量</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看进程</span></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> PROCESSLIST;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看引擎状态</span></span><br><span class="line"><span class="keyword">SHOW</span> ENGINE INNODB STATUS\G</span><br></pre></td></tr></table></figure>

<h3 id="7-2-性能监控"><a href="#7-2-性能监控" class="headerlink" title="7.2 性能监控"></a>7.2 性能监控</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看连接数</span></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Threads_connected&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Max_used_connections&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看缓存命中率</span></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Qcache_hits&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Qcache_inserts&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表锁</span></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Table_locks_waited&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Table_locks_immediate&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 InnoDB 状态</span></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Innodb_row_lock%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-监控工具"><a href="#7-3-监控工具" class="headerlink" title="7.3 监控工具"></a>7.3 监控工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># MySQL Enterprise Monitor</span></span><br><span class="line"><span class="comment"># Percona Monitoring and Management (PMM)</span></span><br><span class="line">pmmd-server start</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prometheus + mysqld_exporter</span></span><br><span class="line">mysqld_exporter --config.my-cnf=/etc/mysql/debian.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Grafana 仪表盘</span></span><br><span class="line"><span class="comment"># 导入 MySQL 官方仪表盘 ID: 7362</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-安全加固"><a href="#8-安全加固" class="headerlink" title="8. 安全加固"></a>8. 安全加固</h2><h3 id="8-1-基础安全"><a href="#8-1-基础安全" class="headerlink" title="8.1 基础安全"></a>8.1 基础安全</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除匿名用户</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> mysql.user <span class="keyword">WHERE</span> <span class="keyword">User</span><span class="operator">=</span><span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除测试数据库</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE IF <span class="keyword">EXISTS</span> test;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改 root 密码</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;strong_password&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 限制 root 远程登录</span></span><br><span class="line"><span class="keyword">UPDATE</span> mysql.user <span class="keyword">SET</span> Host<span class="operator">=</span><span class="string">&#x27;localhost&#x27;</span> <span class="keyword">WHERE</span> <span class="keyword">User</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-网络安全"><a href="#8-2-网络安全" class="headerlink" title="8.2 网络安全"></a>8.2 网络安全</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># my.cnf</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 绑定到特定 IP</span></span><br><span class="line"><span class="attr">bind-address</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用本地文件导入</span></span><br><span class="line"><span class="attr">local_infile</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过符号链接</span></span><br><span class="line"><span class="attr">symbolic-links</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 防火墙配置</span></span><br><span class="line">firewall-cmd --add-port=3306/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 iptables</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 3306 -s 192.168.1.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure>

<h3 id="8-3-审计日志"><a href="#8-3-审计日志" class="headerlink" title="8.3 审计日志"></a>8.3 审计日志</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用审计插件（MySQL Enterprise）</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">plugin_load_add</span>=audit_log</span><br><span class="line"><span class="attr">audit_log_policy</span>=ALL</span><br><span class="line"><span class="attr">audit_log_format</span>=JSON</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-日常维护"><a href="#9-日常维护" class="headerlink" title="9. 日常维护"></a>9. 日常维护</h2><h3 id="9-1-定期任务"><a href="#9-1-定期任务" class="headerlink" title="9.1 定期任务"></a>9.1 定期任务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># daily_maintenance.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份数据库</span></span><br><span class="line">mysqldump -u root -p<span class="string">&#x27;password&#x27;</span> --all-databases | gzip &gt; /backup/all_$(<span class="built_in">date</span> +%Y%m%d).sql.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理旧备份</span></span><br><span class="line">find /backup -name <span class="string">&quot;*.sql.gz&quot;</span> -mtime +7 -delete</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优化表</span></span><br><span class="line">mysql -u root -p<span class="string">&#x27;password&#x27;</span> -e <span class="string">&quot;OPTIMIZE TABLE mydb.users; OPTIMIZE TABLE mydb.orders;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理二进制日志</span></span><br><span class="line">mysql -u root -p<span class="string">&#x27;password&#x27;</span> -e <span class="string">&quot;PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析表</span></span><br><span class="line">mysqlcheck -u root -p<span class="string">&#x27;password&#x27;</span> --analyze --all-databases</span><br></pre></td></tr></table></figure>

<h3 id="9-2-表维护"><a href="#9-2-表维护" class="headerlink" title="9.2 表维护"></a>9.2 表维护</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 优化表</span></span><br><span class="line">OPTIMIZE <span class="keyword">TABLE</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分析表</span></span><br><span class="line">ANALYZE <span class="keyword">TABLE</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查表</span></span><br><span class="line"><span class="keyword">CHECK</span> <span class="keyword">TABLE</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修复表</span></span><br><span class="line">REPAIR <span class="keyword">TABLE</span> users;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-日志轮转"><a href="#9-3-日志轮转" class="headerlink" title="9.3 日志轮转"></a>9.3 日志轮转</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/logrotate.d/mysql</span></span><br><span class="line">/var/log/mysql/*.<span class="built_in">log</span> &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 7</span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    create 640 mysql adm</span><br><span class="line">    postrotate</span><br><span class="line">        mysqladmin flush-logs</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用版本</strong>: MySQL 8.0+</p>
]]></content>
      <categories>
        <category>软件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>Prometheus 监控告警配置</title>
    <url>/2026/02/28/07-Prometheus%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="Prometheus-监控告警配置"><a href="#Prometheus-监控告警配置" class="headerlink" title="Prometheus 监控告警配置"></a>Prometheus 监控告警配置</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-prometheus-%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0">Prometheus 架构概述</a></li>
<li><a href="#2-prometheus-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE">Prometheus 安装与配置</a></li>
<li><a href="#3-%E6%95%B0%E6%8D%AE%E6%8A%93%E5%8F%96%E9%85%8D%E7%BD%AE">数据抓取配置</a></li>
<li><a href="#4-alertmanager-%E9%85%8D%E7%BD%AE">Alertmanager 配置</a></li>
<li><a href="#5-%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E7%BC%96%E5%86%99">告警规则编写</a></li>
<li><a href="#6-grafana-%E5%8F%AF%E8%A7%86%E5%8C%96">Grafana 可视化</a></li>
<li><a href="#7-%E5%B8%B8%E7%94%A8-exporter">常用 Exporter</a></li>
<li><a href="#8-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">服务发现</a></li>
<li><a href="#9-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE">高可用配置</a></li>
</ol>
<hr>
<h2 id="1-Prometheus-架构概述"><a href="#1-Prometheus-架构概述" class="headerlink" title="1. Prometheus 架构概述"></a>1. Prometheus 架构概述</h2><h3 id="1-1-核心组件"><a href="#1-1-核心组件" class="headerlink" title="1.1 核心组件"></a>1.1 核心组件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Prometheus Server          # 数据采集、存储、查询</span><br><span class="line">├── TSDB                  # 时序数据库</span><br><span class="line">├── Retrieval             # 数据抓取</span><br><span class="line">└── HTTP Server           # API 服务</span><br><span class="line"></span><br><span class="line">Exporters                 # 数据导出器</span><br><span class="line">├── Node Exporter         # 主机指标</span><br><span class="line">├── MySQL Exporter        # 数据库指标</span><br><span class="line">├── Redis Exporter        # 缓存指标</span><br><span class="line">└── ...</span><br><span class="line"></span><br><span class="line">Alertmanager              # 告警管理</span><br><span class="line">├── 去重</span><br><span class="line">├── 分组</span><br><span class="line">└── 路由</span><br><span class="line"></span><br><span class="line">Pushgateway               # 推送网关（用于短期任务）</span><br><span class="line"></span><br><span class="line">Grafana                   # 可视化展示</span><br></pre></td></tr></table></figure>

<h3 id="1-2-数据模型"><a href="#1-2-数据模型" class="headerlink" title="1.2 数据模型"></a>1.2 数据模型</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">指标名称&#123;标签名=标签值, ...&#125;</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">http_requests_total&#123;method=&quot;POST&quot;, handler=&quot;/api/users&quot;, status=&quot;200&quot;&#125;</span><br><span class="line">node_cpu_seconds_total&#123;cpu=&quot;0&quot;, mode=&quot;idle&quot;&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-Prometheus-安装与配置"><a href="#2-Prometheus-安装与配置" class="headerlink" title="2. Prometheus 安装与配置"></a>2. Prometheus 安装与配置</h2><h3 id="2-1-二进制安装"><a href="#2-1-二进制安装" class="headerlink" title="2.1 二进制安装"></a>2.1 二进制安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载 Prometheus</span></span><br><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz</span><br><span class="line">tar xzf prometheus-2.40.0.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> prometheus-2.40.0.linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">useradd -r -s /sbin/nologin prometheus</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/prometheus /var/lib/prometheus</span><br><span class="line"><span class="built_in">chown</span> -R prometheus:prometheus /var/lib/prometheus</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件</span></span><br><span class="line"><span class="built_in">cp</span> prometheus promtool /usr/local/bin/</span><br><span class="line"><span class="built_in">cp</span> -r consoles/ console_libraries/ /etc/prometheus/</span><br><span class="line"><span class="built_in">cp</span> prometheus.yml /etc/prometheus/</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Systemd-配置"><a href="#2-2-Systemd-配置" class="headerlink" title="2.2 Systemd 配置"></a>2.2 Systemd 配置</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/systemd/system/prometheus.service</span></span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Prometheus</span><br><span class="line"><span class="attr">Wants</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">User</span>=prometheus</span><br><span class="line"><span class="attr">Group</span>=prometheus</span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/prometheus \</span><br><span class="line">  <span class="attr">--config.file</span>=/etc/prometheus/prometheus.yml \</span><br><span class="line">  <span class="attr">--storage.tsdb.path</span>=/var/lib/prometheus/ \</span><br><span class="line">  <span class="attr">--storage.tsdb.retention.time</span>=<span class="number">15</span>d \</span><br><span class="line">  <span class="attr">--web.console.templates</span>=/etc/prometheus/consoles \</span><br><span class="line">  <span class="attr">--web.console.libraries</span>=/etc/prometheus/console_libraries \</span><br><span class="line">  <span class="attr">--web.listen-address</span>=<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9090</span> \</span><br><span class="line">  --web.enable-lifecycle</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 Prometheus</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start prometheus</span><br><span class="line">systemctl <span class="built_in">enable</span> prometheus</span><br><span class="line">systemctl status prometheus</span><br></pre></td></tr></table></figure>

<h3 id="2-3-基础配置"><a href="#2-3-基础配置" class="headerlink" title="2.3 基础配置"></a>2.3 基础配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/prometheus/prometheus.yml</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span>      <span class="comment"># 抓取间隔</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span>  <span class="comment"># 规则评估间隔</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">monitor:</span> <span class="string">&#x27;prometheus-monitor&#x27;</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="string">&#x27;production&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 告警管理器</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规则文件</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/etc/prometheus/rules/*.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取配置</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9100&#x27;</span>]</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-数据抓取配置"><a href="#3-数据抓取配置" class="headerlink" title="3. 数据抓取配置"></a>3. 数据抓取配置</h2><h3 id="3-1-静态配置"><a href="#3-1-静态配置" class="headerlink" title="3.1 静态配置"></a>3.1 静态配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;web-servers&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.1.10:9100&#x27;</span>, <span class="string">&#x27;192.168.1.11:9100&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">env:</span> <span class="string">&#x27;production&#x27;</span></span><br><span class="line">          <span class="attr">team:</span> <span class="string">&#x27;infra&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.1.20:9100&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">env:</span> <span class="string">&#x27;staging&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-动态配置"><a href="#3-2-动态配置" class="headerlink" title="3.2 动态配置"></a>3.2 动态配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-nodes&#x27;</span></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&#x27;(.*):10250&#x27;</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-抓取参数"><a href="#3-3-抓取参数" class="headerlink" title="3.3 抓取参数"></a>3.3 抓取参数</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;slow-service&#x27;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">30s</span>      <span class="comment"># 覆盖全局配置</span></span><br><span class="line">    <span class="attr">scrape_timeout:</span> <span class="string">10s</span>       <span class="comment"># 抓取超时</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span>    <span class="comment"># 指标路径</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">https</span>             <span class="comment"># HTTP/HTTPS</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;service:8080&#x27;</span>]</span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">ca_file:</span> <span class="string">/etc/ssl/certs/ca.crt</span></span><br><span class="line">      <span class="attr">cert_file:</span> <span class="string">/etc/ssl/certs/client.crt</span></span><br><span class="line">      <span class="attr">key_file:</span> <span class="string">/etc/ssl/certs/client.key</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-重标签配置"><a href="#3-4-重标签配置" class="headerlink" title="3.4 重标签配置"></a>3.4 重标签配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;webapp&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;webapp:8080&#x27;</span>]</span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="comment"># 保留特定标签</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_label_app</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">webapp</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># 替换标签</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">namespace</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># 添加标签</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">monitored_by</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">prometheus</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># 删除标签</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_.+</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">labeldrop</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-Alertmanager-配置"><a href="#4-Alertmanager-配置" class="headerlink" title="4. Alertmanager 配置"></a>4. Alertmanager 配置</h2><h3 id="4-1-安装-Alertmanager"><a href="#4-1-安装-Alertmanager" class="headerlink" title="4.1 安装 Alertmanager"></a>4.1 安装 Alertmanager</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载 Alertmanager</span></span><br><span class="line">wget https://github.com/prometheus/alertmanager/releases/download/v0.25.0/alertmanager-0.25.0.linux-amd64.tar.gz</span><br><span class="line">tar xzf alertmanager-0.25.0.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> alertmanager-0.25.0.linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">cp</span> alertmanager amtool /usr/local/bin/</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/alertmanager /var/lib/alertmanager</span><br><span class="line"></span><br><span class="line"><span class="comment"># Systemd 配置</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/alertmanager.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Alertmanager</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">User=prometheus</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/alertmanager \</span></span><br><span class="line"><span class="string">  --config.file=/etc/alertmanager/alertmanager.yml \</span></span><br><span class="line"><span class="string">  --storage.path=/var/lib/alertmanager \</span></span><br><span class="line"><span class="string">  --web.listen-address=0.0.0.0:9093</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl start alertmanager</span><br><span class="line">systemctl <span class="built_in">enable</span> alertmanager</span><br></pre></td></tr></table></figure>

<h3 id="4-2-基础配置"><a href="#4-2-基础配置" class="headerlink" title="4.2 基础配置"></a>4.2 基础配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/alertmanager/alertmanager.yml</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">smtp_smarthost:</span> <span class="string">&#x27;smtp.example.com:587&#x27;</span></span><br><span class="line">  <span class="attr">smtp_from:</span> <span class="string">&#x27;alertmanager@example.com&#x27;</span></span><br><span class="line">  <span class="attr">smtp_auth_username:</span> <span class="string">&#x27;alertmanager@example.com&#x27;</span></span><br><span class="line">  <span class="attr">smtp_auth_password:</span> <span class="string">&#x27;password&#x27;</span></span><br><span class="line">  <span class="attr">smtp_require_tls:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 默认通知模板</span></span><br><span class="line">  <span class="attr">resolve_timeout:</span> <span class="string">5m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模板文件</span></span><br><span class="line"><span class="attr">templates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;/etc/alertmanager/templates/*.tmpl&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 路由配置</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">&#x27;default-receiver&#x27;</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;cluster&#x27;</span>, <span class="string">&#x27;service&#x27;</span>]</span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">4h</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">      <span class="attr">receiver:</span> <span class="string">&#x27;critical-receiver&#x27;</span></span><br><span class="line">      <span class="attr">continue:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="attr">team:</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">receiver:</span> <span class="string">&#x27;db-team&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match_re:</span></span><br><span class="line">        <span class="attr">service:</span> <span class="string">web.*</span></span><br><span class="line">      <span class="attr">receiver:</span> <span class="string">&#x27;web-team&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收器</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;default-receiver&#x27;</span></span><br><span class="line">    <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;ops-team@example.com&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;critical-receiver&#x27;</span></span><br><span class="line">    <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;oncall@example.com&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://localhost:5001/webhook&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;db-team&#x27;</span></span><br><span class="line">    <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;db-team@example.com&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;web-team&#x27;</span></span><br><span class="line">    <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;web-team@example.com&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抑制规则</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    <span class="attr">equal:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;cluster&#x27;</span>, <span class="string">&#x27;service&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="4-3-通知渠道"><a href="#4-3-通知渠道" class="headerlink" title="4.3 通知渠道"></a>4.3 通知渠道</h3><p><strong>邮件通知</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;email-receiver&#x27;</span></span><br><span class="line">    <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;team@example.com&#x27;</span></span><br><span class="line">        <span class="attr">from:</span> <span class="string">&#x27;alertmanager@example.com&#x27;</span></span><br><span class="line">        <span class="attr">smarthost:</span> <span class="string">&#x27;smtp.example.com:587&#x27;</span></span><br><span class="line">        <span class="attr">auth_username:</span> <span class="string">&#x27;alertmanager@example.com&#x27;</span></span><br><span class="line">        <span class="attr">auth_password:</span> <span class="string">&#x27;password&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">headers:</span></span><br><span class="line">          <span class="attr">Subject:</span> <span class="string">&#x27;[&#123;&#123; .Status | toUpper &#125;&#125;] &#123;&#123; .GroupLabels.alertname &#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>钉钉通知</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;dingtalk&#x27;</span></span><br><span class="line">    <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>企业微信通知</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;wechat&#x27;</span></span><br><span class="line">    <span class="attr">wechat_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">corp_id:</span> <span class="string">&#x27;YOUR_CORP_ID&#x27;</span></span><br><span class="line">        <span class="attr">api_secret:</span> <span class="string">&#x27;YOUR_API_SECRET&#x27;</span></span><br><span class="line">        <span class="attr">agent_id:</span> <span class="string">&#x27;YOUR_AGENT_ID&#x27;</span></span><br><span class="line">        <span class="attr">to_user:</span> <span class="string">&#x27;@all&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>Slack 通知</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;slack&#x27;</span></span><br><span class="line">    <span class="attr">slack_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">api_url:</span> <span class="string">&#x27;https://hooks.slack.com/services/YOUR/WEBHOOK/URL&#x27;</span></span><br><span class="line">        <span class="attr">channel:</span> <span class="string">&#x27;#alerts&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">title:</span> <span class="string">&#x27;&#123;&#123; .Status | toUpper &#125;&#125;: &#123;&#123; .GroupLabels.alertname &#125;&#125;&#x27;</span></span><br><span class="line">        <span class="attr">text:</span> <span class="string">&#x27;&#123;&#123; range .Alerts &#125;&#125;&#123;&#123; .Annotations.description &#125;&#125;&#123;&#123; end &#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-告警规则编写"><a href="#5-告警规则编写" class="headerlink" title="5. 告警规则编写"></a>5. 告警规则编写</h2><h3 id="5-1-规则文件结构"><a href="#5-1-规则文件结构" class="headerlink" title="5.1 规则文件结构"></a>5.1 规则文件结构</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/prometheus/rules/alerts.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example-alerts</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">InstanceDown</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 已宕机&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 已经宕机超过 5 分钟&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighCPUUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">(avg</span> <span class="string">by(instance)</span> <span class="string">(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]))</span> <span class="string">*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> CPU 使用率过高&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;CPU 使用率：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-常用告警规则"><a href="#5-2-常用告警规则" class="headerlink" title="5.2 常用告警规则"></a>5.2 常用告警规则</h3><p><strong>主机监控</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-alerts</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">NodeDown</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">up&#123;job=&quot;node&quot;&#125;</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;主机 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 已宕机&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighCPUUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">(avg</span> <span class="string">by(instance)</span> <span class="string">(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]))</span> <span class="string">*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;主机 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> CPU 使用率过高&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;CPU 使用率：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighMemoryUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">(1</span> <span class="bullet">-</span> <span class="string">(node_memory_MemAvailable_bytes</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes))</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt;</span> <span class="number">85</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;主机 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 内存使用率过高&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;内存使用率：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighDiskUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">(1</span> <span class="bullet">-</span> <span class="string">(node_filesystem_avail_bytes</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes))</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt;</span> <span class="number">85</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;主机 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 磁盘使用率过高&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;磁盘使用率：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighLoadAverage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">node_load1</span> <span class="string">&gt;</span> <span class="string">(count</span> <span class="string">by(instance)</span> <span class="string">(count</span> <span class="string">by(instance,</span> <span class="string">cpu)</span> <span class="string">(node_cpu_seconds_total)))</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;主机 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 负载过高&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;1 分钟负载：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>服务监控</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service-alerts</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">ServiceDown</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;服务 <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> 不可用&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighErrorRate</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum(rate(http_requests_total&#123;status=~&quot;5..&quot;&#125;[5m]))</span> <span class="string">by</span> <span class="string">(service)</span> <span class="string">/</span> <span class="string">sum(rate(http_requests_total[5m]))</span> <span class="string">by</span> <span class="string">(service)</span> <span class="string">&gt;</span> <span class="number">0.05</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;服务 <span class="template-variable">&#123;&#123; $labels.service &#125;&#125;</span> 错误率过高&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;错误率：<span class="template-variable">&#123;&#123; $value | humanizePercentage &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighLatency</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">histogram_quantile(0.95,</span> <span class="string">sum(rate(http_request_duration_seconds_bucket[5m]))</span> <span class="string">by</span> <span class="string">(le,</span> <span class="string">service))</span> <span class="string">&gt;</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;服务 <span class="template-variable">&#123;&#123; $labels.service &#125;&#125;</span> 延迟过高&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;P95 延迟：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>s&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>数据库监控</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database-alerts</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">MySQLDown</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">mysql_up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;MySQL <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 不可用&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">MySQLHighConnections</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">mysql_global_status_threads_connected</span> <span class="string">/</span> <span class="string">mysql_global_variables_max_connections</span> <span class="string">&gt;</span> <span class="number">0.8</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;MySQL <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 连接数过高&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;连接数使用率：<span class="template-variable">&#123;&#123; $value | humanizePercentage &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">RedisDown</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">redis_up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;Redis <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 不可用&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">RedisHighMemory</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">redis_memory_used_bytes</span> <span class="string">/</span> <span class="string">redis_memory_max_bytes</span> <span class="string">&gt;</span> <span class="number">0.8</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;Redis <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 内存使用率过高&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;内存使用率：<span class="template-variable">&#123;&#123; $value | humanizePercentage &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-验证告警规则"><a href="#5-3-验证告警规则" class="headerlink" title="5.3 验证告警规则"></a>5.3 验证告警规则</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查配置文件</span></span><br><span class="line">promtool check config /etc/prometheus/prometheus.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查规则文件</span></span><br><span class="line">promtool check rules /etc/prometheus/rules/alerts.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试告警规则</span></span><br><span class="line">promtool <span class="built_in">test</span> rules test.yml</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-Grafana-可视化"><a href="#6-Grafana-可视化" class="headerlink" title="6. Grafana 可视化"></a>6. Grafana 可视化</h2><h3 id="6-1-安装-Grafana"><a href="#6-1-安装-Grafana" class="headerlink" title="6.1 安装 Grafana"></a>6.1 安装 Grafana</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt-get install -y apt-transport-https software-properties-common</span><br><span class="line">wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://packages.grafana.com/oss/deb stable main&quot;</span> &gt;&gt; /etc/apt/sources.list.d/grafana.list</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y grafana</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/grafana.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[grafana]</span></span><br><span class="line"><span class="string">name=grafana</span></span><br><span class="line"><span class="string">baseurl=https://packages.grafana.com/oss/rpm</span></span><br><span class="line"><span class="string">repo_gpgcheck=1</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://packages.grafana.com/gpg.key</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">yum install -y grafana</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start grafana-server</span><br><span class="line">systemctl <span class="built_in">enable</span> grafana-server</span><br></pre></td></tr></table></figure>

<h3 id="6-2-配置数据源"><a href="#6-2-配置数据源" class="headerlink" title="6.2 配置数据源"></a>6.2 配置数据源</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/grafana/provisioning/datasources/prometheus.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">datasources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prometheus</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">access:</span> <span class="string">proxy</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://localhost:9090</span></span><br><span class="line">    <span class="attr">isDefault:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">editable:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-常用仪表盘"><a href="#6-3-常用仪表盘" class="headerlink" title="6.3 常用仪表盘"></a>6.3 常用仪表盘</h3><ul>
<li><strong>Node Exporter Full</strong>: ID 1860</li>
<li><strong>Prometheus Stats</strong>: ID 2</li>
<li><strong>MySQL Overview</strong>: ID 7362</li>
<li><strong>Redis Dashboard</strong>: ID 11835</li>
<li><strong>Docker and System Metrics</strong>: ID 893</li>
</ul>
<hr>
<h2 id="7-常用-Exporter"><a href="#7-常用-Exporter" class="headerlink" title="7. 常用 Exporter"></a>7. 常用 Exporter</h2><h3 id="7-1-Node-Exporter（主机监控）"><a href="#7-1-Node-Exporter（主机监控）" class="headerlink" title="7.1 Node Exporter（主机监控）"></a>7.1 Node Exporter（主机监控）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.5.0/node_exporter-1.5.0.linux-amd64.tar.gz</span><br><span class="line">tar xzf node_exporter-1.5.0.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cp</span> node_exporter-1.5.0.linux-amd64/node_exporter /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Systemd 配置</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/node_exporter.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Node Exporter</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">User=prometheus</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/node_exporter</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl start node_exporter</span><br><span class="line">systemctl <span class="built_in">enable</span> node_exporter</span><br></pre></td></tr></table></figure>

<h3 id="7-2-其他常用-Exporter"><a href="#7-2-其他常用-Exporter" class="headerlink" title="7.2 其他常用 Exporter"></a>7.2 其他常用 Exporter</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># MySQL Exporter</span></span><br><span class="line">https://github.com/prometheus/mysqld_exporter</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis Exporter</span></span><br><span class="line">https://github.com/oliver006/redis_exporter</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nginx Exporter</span></span><br><span class="line">https://github.com/nginxinc/nginx-prometheus-exporter</span><br><span class="line"></span><br><span class="line"><span class="comment"># Blackbox Exporter（黑盒监控）</span></span><br><span class="line">https://github.com/prometheus/blackbox_exporter</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kafka Exporter</span></span><br><span class="line">https://github.com/danielqsj/kafka_exporter</span><br><span class="line"></span><br><span class="line"><span class="comment"># Elasticsearch Exporter</span></span><br><span class="line">https://github.com/prometheus-community/elasticsearch_exporter</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-服务发现"><a href="#8-服务发现" class="headerlink" title="8. 服务发现"></a>8. 服务发现</h2><h3 id="8-1-Kubernetes-服务发现"><a href="#8-1-Kubernetes-服务发现" class="headerlink" title="8.1 Kubernetes 服务发现"></a>8.1 Kubernetes 服务发现</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-pods&#x27;</span></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-Consul-服务发现"><a href="#8-2-Consul-服务发现" class="headerlink" title="8.2 Consul 服务发现"></a>8.2 Consul 服务发现</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;consul&#x27;</span></span><br><span class="line">    <span class="attr">consul_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">&#x27;consul:8500&#x27;</span></span><br><span class="line">        <span class="attr">services:</span> []</span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_consul_service</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">job</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-Docker-服务发现"><a href="#8-3-Docker-服务发现" class="headerlink" title="8.3 Docker 服务发现"></a>8.3 Docker 服务发现</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;docker&#x27;</span></span><br><span class="line">    <span class="attr">docker_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">unix:///var/run/docker.sock</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_docker_container_label_prometheus_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-高可用配置"><a href="#9-高可用配置" class="headerlink" title="9. 高可用配置"></a>9. 高可用配置</h2><h3 id="9-1-多副本-Prometheus"><a href="#9-1-多副本-Prometheus" class="headerlink" title="9.1 多副本 Prometheus"></a>9.1 多副本 Prometheus</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 运行多个 Prometheus 实例</span></span><br><span class="line"><span class="comment"># 使用相同的配置，独立存储数据</span></span><br><span class="line"><span class="comment"># 通过负载均衡器分发查询请求</span></span><br></pre></td></tr></table></figure>

<h3 id="9-2-Thanos-架构"><a href="#9-2-Thanos-架构" class="headerlink" title="9.2 Thanos 架构"></a>9.2 Thanos 架构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Thanos Sidecar → Prometheus</span><br><span class="line">     ↓</span><br><span class="line">Thanos Store → 对象存储（S3/GCS）</span><br><span class="line">     ↓</span><br><span class="line">Thanos Query → 统一查询入口</span><br><span class="line">     ↓</span><br><span class="line">Grafana → 可视化</span><br></pre></td></tr></table></figure>

<h3 id="9-3-VictoriaMetrics"><a href="#9-3-VictoriaMetrics" class="headerlink" title="9.3 VictoriaMetrics"></a>9.3 VictoriaMetrics</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 作为 Prometheus 的长期存储替代</span></span><br><span class="line"><span class="comment"># 更高的性能和压缩率</span></span><br><span class="line"><span class="comment"># 兼容 PromQL</span></span><br><span class="line"></span><br><span class="line">docker run -it --<span class="built_in">rm</span> \</span><br><span class="line">  -p 8428:8428 \</span><br><span class="line">  -v /data:/storage \</span><br><span class="line">  victoriametrics/victoria-metrics</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用版本</strong>: Prometheus 2.40+, Alertmanager 0.25+, Grafana 9.x</p>
]]></content>
      <categories>
        <category>监控与告警</category>
      </categories>
  </entry>
  <entry>
    <title>Ansible 自动化运维手册</title>
    <url>/2026/02/28/08-Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h1 id="Ansible-自动化运维手册"><a href="#Ansible-自动化运维手册" class="headerlink" title="Ansible 自动化运维手册"></a>Ansible 自动化运维手册</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-ansible-%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0">Ansible 架构概述</a></li>
<li><a href="#2-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE">安装与配置</a></li>
<li><a href="#3-inventory-%E7%AE%A1%E7%90%86">Inventory 管理</a></li>
<li><a href="#4-ad-hoc-%E5%91%BD%E4%BB%A4">Ad-Hoc 命令</a></li>
<li><a href="#5-playbook-%E7%BC%96%E5%86%99">Playbook 编写</a></li>
<li><a href="#6-roles">角色（Roles）</a></li>
<li><a href="#7-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%A8%A1%E6%9D%BF">变量与模板</a></li>
<li><a href="#8-%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97">常用模块</a></li>
<li><a href="#9-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
</ol>
<hr>
<h2 id="1-Ansible-架构概述"><a href="#1-Ansible-架构概述" class="headerlink" title="1. Ansible 架构概述"></a>1. Ansible 架构概述</h2><h3 id="1-1-核心概念"><a href="#1-1-核心概念" class="headerlink" title="1.1 核心概念"></a>1.1 核心概念</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ansible Controller（控制节点）</span><br><span class="line">├── Inventory（主机清单）</span><br><span class="line">├── Playbooks（剧本）</span><br><span class="line">├── Modules（模块）</span><br><span class="line">├── Plugins（插件）</span><br><span class="line">└── Roles（角色）</span><br><span class="line"></span><br><span class="line">Managed Nodes（被管节点）</span><br><span class="line">├── SSH（Linux/Unix）</span><br><span class="line">└── WinRM（Windows）</span><br></pre></td></tr></table></figure>

<h3 id="1-2-工作原理"><a href="#1-2-工作原理" class="headerlink" title="1.2 工作原理"></a>1.2 工作原理</h3><ol>
<li>读取 Inventory 获取目标主机</li>
<li>加载 Playbook 定义的任务</li>
<li>通过 SSH 推送模块到目标主机</li>
<li>执行模块并返回结果</li>
<li>清理临时文件</li>
</ol>
<hr>
<h2 id="2-安装与配置"><a href="#2-安装与配置" class="headerlink" title="2. 安装与配置"></a>2. 安装与配置</h2><h3 id="2-1-安装-Ansible"><a href="#2-1-安装-Ansible" class="headerlink" title="2.1 安装 Ansible"></a>2.1 安装 Ansible</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y software-properties-common</span><br><span class="line">apt-add-repository --<span class="built_in">yes</span> --update ppa:ansible/ansible</span><br><span class="line">apt-get install -y ansible</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">yum install -y epel-release</span><br><span class="line">yum install -y ansible</span><br><span class="line"></span><br><span class="line"><span class="comment"># pip 安装</span></span><br><span class="line">pip3 install ansible</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">ansible --version</span><br><span class="line">ansible --version</span><br></pre></td></tr></table></figure>

<h3 id="2-2-配置文件"><a href="#2-2-配置文件" class="headerlink" title="2.2 配置文件"></a>2.2 配置文件</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/ansible/ansible.cfg 或 ~/.ansible.cfg</span></span><br><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="comment"># Inventory 文件位置</span></span><br><span class="line"><span class="attr">inventory</span> = /etc/ansible/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 私钥文件</span></span><br><span class="line"><span class="attr">private_key_file</span> = ~/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 并发数</span></span><br><span class="line"><span class="attr">forks</span> = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 超时时间</span></span><br><span class="line"><span class="attr">timeout</span> = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件</span></span><br><span class="line"><span class="attr">log_path</span> = /var/log/ansible.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主机密钥检查</span></span><br><span class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重试次数</span></span><br><span class="line"><span class="attr">retries</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提升权限方式</span></span><br><span class="line"><span class="attr">become_method</span> = sudo</span><br><span class="line"><span class="attr">become_user</span> = root</span><br><span class="line"><span class="attr">become_ask_pass</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 事实缓存</span></span><br><span class="line"><span class="attr">fact_caching</span> = jsonfile</span><br><span class="line"><span class="attr">fact_caching_connection</span> = /tmp/ansible_facts</span><br><span class="line"><span class="attr">fact_caching_timeout</span> = <span class="number">86400</span></span><br><span class="line"></span><br><span class="line"><span class="section">[privilege_escalation]</span></span><br><span class="line"><span class="attr">become</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">become_method</span> = sudo</span><br><span class="line"><span class="attr">become_user</span> = root</span><br><span class="line"><span class="attr">become_ask_pass</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ssh_connection]</span></span><br><span class="line"><span class="comment"># SSH 参数</span></span><br><span class="line"><span class="attr">ssh_args</span> = -o ControlMaster=auto -o ControlPersist=<span class="number">60</span>s</span><br><span class="line"><span class="attr">pipelining</span> = <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-SSH-密钥配置"><a href="#2-3-SSH-密钥配置" class="headerlink" title="2.3 SSH 密钥配置"></a>2.3 SSH 密钥配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成密钥</span></span><br><span class="line">ssh-keygen -t rsa -b 4096 -f ~/.ssh/ansible_rsa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发公钥</span></span><br><span class="line">ssh-copy-id -i ~/.ssh/ansible_rsa.pub user@target-host</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试连接</span></span><br><span class="line">ssh -i ~/.ssh/ansible_rsa user@target-host</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-Inventory-管理"><a href="#3-Inventory-管理" class="headerlink" title="3. Inventory 管理"></a>3. Inventory 管理</h2><h3 id="3-1-静态-Inventory"><a href="#3-1-静态-Inventory" class="headerlink" title="3.1 静态 Inventory"></a>3.1 静态 Inventory</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/ansible/hosts</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单个主机</span></span><br><span class="line">web1.example.com</span><br><span class="line">192.168.1.100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主机组</span></span><br><span class="line"><span class="section">[webservers]</span></span><br><span class="line">web1.example.com</span><br><span class="line">web2.example.com</span><br><span class="line">web3.example.com</span><br><span class="line"></span><br><span class="line"><span class="section">[dbservers]</span></span><br><span class="line">db1.example.com</span><br><span class="line">db2.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带变量的主机</span></span><br><span class="line"><span class="section">[webservers]</span></span><br><span class="line">web1.example.com <span class="attr">http_port</span>=<span class="number">80</span> max_clients=<span class="number">200</span></span><br><span class="line">web2.example.com <span class="attr">http_port</span>=<span class="number">8080</span> max_clients=<span class="number">150</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 嵌套组</span></span><br><span class="line"><span class="section">[webgroup:children]</span></span><br><span class="line">webservers</span><br><span class="line">appservers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 变量定义</span></span><br><span class="line"><span class="section">[all:vars]</span></span><br><span class="line"><span class="attr">ansible_user</span>=deploy</span><br><span class="line"><span class="attr">ansible_ssh_private_key_file</span>=~/.ssh/ansible_rsa</span><br><span class="line"><span class="attr">ansible_python_interpreter</span>=/usr/bin/python3</span><br><span class="line"></span><br><span class="line"><span class="section">[webservers:vars]</span></span><br><span class="line"><span class="attr">nginx_version</span>=<span class="number">1.21</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-动态-Inventory"><a href="#3-2-动态-Inventory" class="headerlink" title="3.2 动态 Inventory"></a>3.2 动态 Inventory</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># inventory.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_inventory</span>():</span><br><span class="line">    inventory = &#123;</span><br><span class="line">        <span class="string">&#x27;_meta&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;hostvars&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;web1.example.com&#x27;</span>: &#123;<span class="string">&#x27;http_port&#x27;</span>: <span class="number">80</span>&#125;,</span><br><span class="line">                <span class="string">&#x27;web2.example.com&#x27;</span>: &#123;<span class="string">&#x27;http_port&#x27;</span>: <span class="number">8080</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;webservers&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;hosts&#x27;</span>: [<span class="string">&#x27;web1.example.com&#x27;</span>, <span class="string">&#x27;web2.example.com&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;vars&#x27;</span>: &#123;<span class="string">&#x27;ansible_user&#x27;</span>: <span class="string">&#x27;deploy&#x27;</span>&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;dbservers&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;hosts&#x27;</span>: [<span class="string">&#x27;db1.example.com&#x27;</span>, <span class="string">&#x27;db2.example.com&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> inventory</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--list&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--host&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> args.<span class="built_in">list</span>:</span><br><span class="line">        <span class="built_in">print</span>(json.dumps(get_inventory()))</span><br><span class="line">    <span class="keyword">elif</span> args.host:</span><br><span class="line">        <span class="built_in">print</span>(json.dumps(&#123;&#125;))</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用动态 Inventory</span></span><br><span class="line">ansible -i inventory.py --list-hosts all</span><br><span class="line">ansible-playbook -i inventory.py playbook.yml</span><br></pre></td></tr></table></figure>

<h3 id="3-3-常用命令"><a href="#3-3-常用命令" class="headerlink" title="3.3 常用命令"></a>3.3 常用命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 列出所有主机</span></span><br><span class="line">ansible-inventory --list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看特定主机变量</span></span><br><span class="line">ansible-inventory --host web1.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 图形化显示</span></span><br><span class="line">ansible-inventory --graph</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证 Inventory</span></span><br><span class="line">ansible-inventory --list -i hosts</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-Ad-Hoc-命令"><a href="#4-Ad-Hoc-命令" class="headerlink" title="4. Ad-Hoc 命令"></a>4. Ad-Hoc 命令</h2><h3 id="4-1-基础命令"><a href="#4-1-基础命令" class="headerlink" title="4.1 基础命令"></a>4.1 基础命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ping 所有主机</span></span><br><span class="line">ansible all -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># ping 特定组</span></span><br><span class="line">ansible webservers -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行 shell 命令</span></span><br><span class="line">ansible all -m shell -a <span class="string">&quot;uptime&quot;</span></span><br><span class="line">ansible all -m <span class="built_in">command</span> -a <span class="string">&quot;df -h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件</span></span><br><span class="line">ansible all -m copy -a <span class="string">&quot;src=/local/file dest=/remote/file&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改文件权限</span></span><br><span class="line">ansible all -m file -a <span class="string">&quot;path=/tmp/test mode=755&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装软件包</span></span><br><span class="line">ansible webservers -m apt -a <span class="string">&quot;name=nginx state=present&quot;</span></span><br><span class="line">ansible webservers -m yum -a <span class="string">&quot;name=httpd state=present&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 管理服务</span></span><br><span class="line">ansible webservers -m service -a <span class="string">&quot;name=nginx state=started enabled=yes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">ansible all -m user -a <span class="string">&quot;name=testuser state=present&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看事实信息</span></span><br><span class="line">ansible all -m setup</span><br><span class="line">ansible all -m setup -a <span class="string">&quot;filter=ansible_distribution*&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-提权执行"><a href="#4-2-提权执行" class="headerlink" title="4.2 提权执行"></a>4.2 提权执行</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 sudo</span></span><br><span class="line">ansible all -m shell -a <span class="string">&quot;whoami&quot;</span> --become</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定提权用户</span></span><br><span class="line">ansible all -m shell -a <span class="string">&quot;whoami&quot;</span> --become --become-user=root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入提权密码</span></span><br><span class="line">ansible all -m shell -a <span class="string">&quot;whoami&quot;</span> --become -K</span><br></pre></td></tr></table></figure>

<h3 id="4-3-并行控制"><a href="#4-3-并行控制" class="headerlink" title="4.3 并行控制"></a>4.3 并行控制</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 指定并发数</span></span><br><span class="line">ansible all -m ping -f 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐个执行</span></span><br><span class="line">ansible all -m ping -f 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按组滚动执行</span></span><br><span class="line">ansible all -m shell -a <span class="string">&quot;uptime&quot;</span> --<span class="built_in">limit</span> webservers</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-Playbook-编写"><a href="#5-Playbook-编写" class="headerlink" title="5. Playbook 编写"></a>5. Playbook 编写</h2><h3 id="5-1-基础结构"><a href="#5-1-基础结构" class="headerlink" title="5.1 基础结构"></a>5.1 基础结构</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署</span> <span class="string">Web</span> <span class="string">服务器</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">http_port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">max_clients:</span> <span class="number">200</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">pre_tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">更新</span> <span class="string">apt</span> <span class="string">缓存</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">update_cache:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">&quot;Debian&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">install</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">启动</span> <span class="string">Nginx</span> <span class="string">服务</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">service</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">创建网站目录</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/var/www/html</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www-data</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www-data</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&#x27;0755&#x27;</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">post_tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">验证</span> <span class="string">Nginx</span> <span class="string">运行</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">is-active</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">nginx_status</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">重启</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-条件判断"><a href="#5-2-条件判断" class="headerlink" title="5.2 条件判断"></a>5.2 条件判断</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装</span> <span class="string">Apache（CentOS）</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">&quot;RedHat&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装</span> <span class="string">Nginx（Ubuntu）</span></span><br><span class="line">    <span class="attr">apt:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">&quot;Debian&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">配置大内存服务器</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">mysql_large.cnf.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/mysql/my.cnf</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_memtotal_mb</span> <span class="string">&gt;</span> <span class="number">8192</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-循环迭代"><a href="#5-3-循环迭代" class="headerlink" title="5.3 循环迭代"></a>5.3 循环迭代</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">创建多个用户</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">user1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">user2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">user3</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装多个软件包</span></span><br><span class="line">    <span class="attr">apt:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql-server</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">php-fpm</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">配置多个端口</span></span><br><span class="line">    <span class="attr">ufw:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">allow</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">22</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">字典循环</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.key &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">groups:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.value &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users | dict2items &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-错误处理"><a href="#5-4-错误处理" class="headerlink" title="5.4 错误处理"></a>5.4 错误处理</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">执行可能失败的命令</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/opt/app/start.sh</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">重试任务</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/opt/app/check.sh</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">delay:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">until:</span> <span class="string">result.stdout</span> <span class="string">==</span> <span class="string">&quot;ready&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">失败时通知</span></span><br><span class="line">    <span class="attr">mail:</span></span><br><span class="line">      <span class="attr">to:</span> <span class="string">admin@example.com</span></span><br><span class="line">      <span class="attr">subject:</span> <span class="string">&quot;部署失败&quot;</span></span><br><span class="line">      <span class="attr">body:</span> <span class="string">&quot;服务器 <span class="template-variable">&#123;&#123; inventory_hostname &#125;&#125;</span> 部署失败&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">result.failed</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-角色（Roles）"><a href="#6-角色（Roles）" class="headerlink" title="6. 角色（Roles）"></a>6. 角色（Roles）</h2><h3 id="6-1-角色结构"><a href="#6-1-角色结构" class="headerlink" title="6.1 角色结构"></a>6.1 角色结构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">roles/</span><br><span class="line">├── common/</span><br><span class="line">│   ├── tasks/</span><br><span class="line">│   │   └── main.yml</span><br><span class="line">│   ├── handlers/</span><br><span class="line">│   │   └── main.yml</span><br><span class="line">│   ├── templates/</span><br><span class="line">│   ├── files/</span><br><span class="line">│   ├── vars/</span><br><span class="line">│   │   └── main.yml</span><br><span class="line">│   ├── defaults/</span><br><span class="line">│   │   └── main.yml</span><br><span class="line">│   └── meta/</span><br><span class="line">│       └── main.yml</span><br><span class="line">├── nginx/</span><br><span class="line">├── mysql/</span><br><span class="line">└── app/</span><br></pre></td></tr></table></figure>

<h3 id="6-2-创建角色"><a href="#6-2-创建角色" class="headerlink" title="6.2 创建角色"></a>6.2 创建角色</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 ansible-galaxy 创建</span></span><br><span class="line">ansible-galaxy init roles/nginx</span><br><span class="line">ansible-galaxy init roles/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 角色目录结构</span></span><br><span class="line">tree roles/nginx/</span><br></pre></td></tr></table></figure>

<h3 id="6-3-使用角色"><a href="#6-3-使用角色" class="headerlink" title="6.3 使用角色"></a>6.3 使用角色</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署服务器</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">common</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">nginx_port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">&quot;&#x27;dbservers&#x27; in group_names&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署应用</span></span><br><span class="line">      <span class="attr">import_tasks:</span> <span class="string">tasks/deploy_app.yml</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-角色依赖"><a href="#6-4-角色依赖" class="headerlink" title="6.4 角色依赖"></a>6.4 角色依赖</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># roles/app/meta/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">nginx_port:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">mysql_port:</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>

<h3 id="6-5-使用-Galaxy-角色"><a href="#6-5-使用-Galaxy-角色" class="headerlink" title="6.5 使用 Galaxy 角色"></a>6.5 使用 Galaxy 角色</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 搜索角色</span></span><br><span class="line">ansible-galaxy search nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载角色</span></span><br><span class="line">ansible-galaxy install geerlingguy.nginx</span><br><span class="line">ansible-galaxy install geerlingguy.mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量安装（requirements.yml）</span></span><br><span class="line"><span class="comment"># requirements.yml</span></span><br><span class="line">- src: geerlingguy.nginx</span><br><span class="line">  version: 3.1.0</span><br><span class="line">- src: geerlingguy.mysql</span><br><span class="line">  version: 4.0.0</span><br><span class="line"></span><br><span class="line">ansible-galaxy install -r requirements.yml</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-变量与模板"><a href="#7-变量与模板" class="headerlink" title="7. 变量与模板"></a>7. 变量与模板</h2><h3 id="7-1-变量优先级"><a href="#7-1-变量优先级" class="headerlink" title="7.1 变量优先级"></a>7.1 变量优先级</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 命令行变量 (-e)</span><br><span class="line">2. Play 中的 vars</span><br><span class="line">3. 角色中的 vars</span><br><span class="line">4. set_facts / register</span><br><span class="line">5. 主机 facts</span><br><span class="line">6. Inventory 变量</span><br><span class="line">7. 角色中的 defaults</span><br><span class="line">8. 额外变量</span><br></pre></td></tr></table></figure>

<h3 id="7-2-变量定义"><a href="#7-2-变量定义" class="headerlink" title="7.2 变量定义"></a>7.2 变量定义</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在 Playbook 中定义</span></span><br><span class="line"><span class="attr">vars:</span></span><br><span class="line">  <span class="attr">app_name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">app_port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Inventory 中定义</span></span><br><span class="line">[<span class="string">webservers:vars</span>]</span><br><span class="line"><span class="string">http_port=80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在文件中定义（vars_files）</span></span><br><span class="line"><span class="attr">vars_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vars/common.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vars/secrets.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含变量文件</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include_vars:</span> <span class="string">vars/production.yml</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-Jinja2-模板"><a href="#7-3-Jinja2-模板" class="headerlink" title="7.3 Jinja2 模板"></a>7.3 Jinja2 模板</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># templates/nginx.conf.j2</span><br><span class="line">server &#123;</span><br><span class="line">    listen &#123;&#123; nginx_port | default(80) &#125;&#125;;</span><br><span class="line">    server_name &#123;&#123; server_name &#125;&#125;;</span><br><span class="line">    </span><br><span class="line">    root &#123;&#123; web_root &#125;&#125;;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">    </span><br><span class="line">    &#123;% if enable_ssl %&#125;</span><br><span class="line">    ssl_certificate &#123;&#123; ssl_cert_path &#125;&#125;;</span><br><span class="line">    ssl_certificate_key &#123;&#123; ssl_key_path &#125;&#125;;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ =404;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#123;% for location in custom_locations %&#125;</span><br><span class="line">    location &#123;&#123; location.path &#125;&#125; &#123;</span><br><span class="line">        &#123;&#123; location.config &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用模板</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署</span> <span class="string">Nginx</span> <span class="string">配置</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">&#x27;0644&#x27;</span></span><br><span class="line">      <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">validate:</span> <span class="string">&#x27;nginx -t -c %s&#x27;</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="7-4-内置变量"><a href="#7-4-内置变量" class="headerlink" title="7.4 内置变量"></a>7.4 内置变量</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">显示主机信息</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        主机名：&#123;&#123; ansible_hostname &#125;&#125;</span></span><br><span class="line"><span class="string">        IP 地址：&#123;&#123; ansible_default_ipv4.address &#125;&#125;</span></span><br><span class="line"><span class="string">        内存：&#123;&#123; ansible_memtotal_mb &#125;&#125; MB</span></span><br><span class="line"><span class="string">        CPU 核心：&#123;&#123; ansible_processor_vcpus &#125;&#125;</span></span><br><span class="line"><span class="string">        操作系统：&#123;&#123; ansible_distribution &#125;&#125; &#123;&#123; ansible_distribution_version &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-常用模块"><a href="#8-常用模块" class="headerlink" title="8. 常用模块"></a>8. 常用模块</h2><h3 id="8-1-系统模块"><a href="#8-1-系统模块" class="headerlink" title="8.1 系统模块"></a>8.1 系统模块</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">管理用户</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">deploy</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">groups:</span> <span class="string">sudo</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">/bin/bash</span></span><br><span class="line">      <span class="attr">create_home:</span> <span class="literal">yes</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">管理组</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">appgroup</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">管理文件</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/log/app</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">owner:</span> <span class="string">app</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">app</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">&#x27;0755&#x27;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">复制文件</span></span><br><span class="line">    <span class="attr">copy:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">/local/config.yml</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/app/config.yml</span></span><br><span class="line">      <span class="attr">owner:</span> <span class="string">app</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">&#x27;0644&#x27;</span></span><br><span class="line">      <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">下载文件</span></span><br><span class="line">    <span class="attr">get_url:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">https://example.com/file.tar.gz</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/tmp/file.tar.gz</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">&#x27;0644&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-包管理模块"><a href="#8-2-包管理模块" class="headerlink" title="8.2 包管理模块"></a>8.2 包管理模块</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装软件包（Debian）</span></span><br><span class="line">    <span class="attr">apt:</span></span><br><span class="line">      <span class="attr">name:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mysql-server</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">php-fpm</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">update_cache:</span> <span class="literal">yes</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装软件包（RedHat）</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mariadb-server</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">使用</span> <span class="string">pip</span> <span class="string">安装</span></span><br><span class="line">    <span class="attr">pip:</span></span><br><span class="line">      <span class="attr">name:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">requests</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">flask</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-服务管理模块"><a href="#8-3-服务管理模块" class="headerlink" title="8.3 服务管理模块"></a>8.3 服务管理模块</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">管理服务</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">使用</span> <span class="string">systemd</span></span><br><span class="line">    <span class="attr">systemd:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">docker</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">daemon_reload:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="8-4-网络模块"><a href="#8-4-网络模块" class="headerlink" title="8.4 网络模块"></a>8.4 网络模块</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">打开防火墙端口</span></span><br><span class="line">    <span class="attr">ufw:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">allow</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">&#x27;80&#x27;</span></span><br><span class="line">      <span class="attr">proto:</span> <span class="string">tcp</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">配置网络接口</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">interfaces.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/network/interfaces</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">networking</span></span><br></pre></td></tr></table></figure>

<h3 id="8-5-Docker-模块"><a href="#8-5-Docker-模块" class="headerlink" title="8.5 Docker 模块"></a>8.5 Docker 模块</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">运行</span> <span class="string">Docker</span> <span class="string">容器</span></span><br><span class="line">    <span class="attr">docker_container:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/data/nginx:/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">ENVIRONMENT:</span> <span class="string">production</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">构建</span> <span class="string">Docker</span> <span class="string">镜像</span></span><br><span class="line">    <span class="attr">docker_image:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">source:</span></span><br><span class="line">        <span class="attr">build:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/path/to/context</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-最佳实践"><a href="#9-最佳实践" class="headerlink" title="9. 最佳实践"></a>9. 最佳实践</h2><h3 id="9-1-目录结构"><a href="#9-1-目录结构" class="headerlink" title="9.1 目录结构"></a>9.1 目录结构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">project/</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── inventory/</span><br><span class="line">│   ├── production</span><br><span class="line">│   ├── staging</span><br><span class="line">│   └── development</span><br><span class="line">├── group_vars/</span><br><span class="line">│   ├── all.yml</span><br><span class="line">│   ├── production.yml</span><br><span class="line">│   └── staging.yml</span><br><span class="line">├── host_vars/</span><br><span class="line">│   └── server1.yml</span><br><span class="line">├── roles/</span><br><span class="line">│   ├── common/</span><br><span class="line">│   ├── nginx/</span><br><span class="line">│   └── app/</span><br><span class="line">├── playbooks/</span><br><span class="line">│   ├── site.yml</span><br><span class="line">│   ├── deploy.yml</span><br><span class="line">│   └── backup.yml</span><br><span class="line">└── scripts/</span><br><span class="line">    └── validate.sh</span><br></pre></td></tr></table></figure>

<h3 id="9-2-标签使用"><a href="#9-2-标签使用" class="headerlink" title="9.2 标签使用"></a>9.2 标签使用</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装</span> <span class="string">Nginx</span></span><br><span class="line">    <span class="attr">apt:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">配置</span> <span class="string">Nginx</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">config</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 运行特定标签</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">site.yml</span> <span class="string">--tags</span> <span class="string">&quot;nginx,install&quot;</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">site.yml</span> <span class="string">--skip-tags</span> <span class="string">&quot;config&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="9-3-Vault-加密"><a href="#9-3-Vault-加密" class="headerlink" title="9.3 Vault 加密"></a>9.3 Vault 加密</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建加密文件</span></span><br><span class="line">ansible-vault create secrets.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密现有文件</span></span><br><span class="line">ansible-vault encrypt secrets.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密文件</span></span><br><span class="line">ansible-vault decrypt secrets.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看加密文件</span></span><br><span class="line">ansible-vault view secrets.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑加密文件</span></span><br><span class="line">ansible-vault edit secrets.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 Playbook</span></span><br><span class="line">ansible-playbook site.yml --ask-vault-pass</span><br><span class="line">ansible-playbook site.yml --vault-password-file ~/.vault_pass</span><br></pre></td></tr></table></figure>

<h3 id="9-4-测试与验证"><a href="#9-4-测试与验证" class="headerlink" title="9.4 测试与验证"></a>9.4 测试与验证</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 语法检查</span></span><br><span class="line">ansible-playbook --syntax-check playbook.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预演执行（dry run）</span></span><br><span class="line">ansible-playbook --check playbook.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐步执行</span></span><br><span class="line">ansible-playbook --step playbook.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制主机</span></span><br><span class="line">ansible-playbook --<span class="built_in">limit</span> webservers playbook.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定用户</span></span><br><span class="line">ansible-playbook -u deploy playbook.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细输出</span></span><br><span class="line">ansible-playbook -v playbook.yml</span><br><span class="line">ansible-playbook -vvv playbook.yml</span><br></pre></td></tr></table></figure>

<h3 id="9-5-CI-CD-集成"><a href="#9-5-CI-CD-集成" class="headerlink" title="9.5 CI&#x2F;CD 集成"></a>9.5 CI&#x2F;CD 集成</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># .gitlab-ci.yml</span></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lint</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ansible-lint:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">lint</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ansible-lint</span> <span class="string">playbooks/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ansible-test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ansible-playbook</span> <span class="string">--syntax-check</span> <span class="string">playbooks/site.yml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ansible-playbook</span> <span class="string">--check</span> <span class="string">playbooks/site.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">inventory/production</span> <span class="string">playbooks/site.yml</span></span><br><span class="line">  <span class="attr">when:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">$CI_COMMIT_BRANCH</span> <span class="string">==</span> <span class="string">&quot;main&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用版本</strong>: Ansible 2.12+</p>
]]></content>
      <categories>
        <category>软件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>网络运维与故障排查</title>
    <url>/2026/02/28/09-%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/</url>
    <content><![CDATA[<h1 id="网络运维与故障排查"><a href="#网络运维与故障排查" class="headerlink" title="网络运维与故障排查"></a>网络运维与故障排查</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE">网络基础配置</a></li>
<li><a href="#2-%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7">网络监控工具</a></li>
<li><a href="#3-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95">性能测试</a></li>
<li><a href="#4-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95">故障排查方法</a></li>
<li><a href="#5-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3">常见问题解决</a></li>
<li><a href="#6-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8">网络安全</a></li>
<li><a href="#7-%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96">网络优化</a></li>
</ol>
<hr>
<h2 id="1-网络基础配置"><a href="#1-网络基础配置" class="headerlink" title="1. 网络基础配置"></a>1. 网络基础配置</h2><h3 id="1-1-IP-地址配置"><a href="#1-1-IP-地址配置" class="headerlink" title="1.1 IP 地址配置"></a>1.1 IP 地址配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看网络接口</span></span><br><span class="line">ip addr show</span><br><span class="line">ip -brief addr show</span><br><span class="line">ifconfig -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 IP 地址（临时）</span></span><br><span class="line">ip addr add 192.168.1.100/24 dev eth0</span><br><span class="line">ip addr del 192.168.1.100/24 dev eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 IP 地址（永久 - Ubuntu/Netplan）</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/netplan/01-netcfg.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">network:</span></span><br><span class="line"><span class="string">  version: 2</span></span><br><span class="line"><span class="string">  ethernets:</span></span><br><span class="line"><span class="string">    eth0:</span></span><br><span class="line"><span class="string">      addresses:</span></span><br><span class="line"><span class="string">        - 192.168.1.100/24</span></span><br><span class="line"><span class="string">      gateway4: 192.168.1.1</span></span><br><span class="line"><span class="string">      nameservers:</span></span><br><span class="line"><span class="string">        addresses: [8.8.8.8, 8.8.4.4]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">netplan apply</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 IP 地址（永久 - CentOS/NetworkManager）</span></span><br><span class="line">nmcli con mod eth0 ipv4.addresses 192.168.1.100/24</span><br><span class="line">nmcli con mod eth0 ipv4.gateway 192.168.1.1</span><br><span class="line">nmcli con mod eth0 ipv4.dns <span class="string">&quot;8.8.8.8 8.8.4.4&quot;</span></span><br><span class="line">nmcli con up eth0</span><br></pre></td></tr></table></figure>

<h3 id="1-2-路由配置"><a href="#1-2-路由配置" class="headerlink" title="1.2 路由配置"></a>1.2 路由配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看路由表</span></span><br><span class="line">ip route show</span><br><span class="line">route -n</span><br><span class="line">netstat -rn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加默认网关</span></span><br><span class="line">ip route add default via 192.168.1.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加静态路由</span></span><br><span class="line">ip route add 10.0.0.0/8 via 192.168.1.254</span><br><span class="line">ip route add 172.16.0.0/16 dev eth1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除路由</span></span><br><span class="line">ip route del 10.0.0.0/8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久路由（CentOS）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;GATEWAY=192.168.1.1&quot;</span> &gt;&gt; /etc/sysconfig/network</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;10.0.0.0/8 via 192.168.1.254&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/route-eth0</span><br></pre></td></tr></table></figure>

<h3 id="1-3-DNS-配置"><a href="#1-3-DNS-配置" class="headerlink" title="1.3 DNS 配置"></a>1.3 DNS 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 DNS</span></span><br><span class="line"><span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line">nmcli dev show | grep DNS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 DNS（临时）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> &gt; /etc/resolv.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.4.4&quot;</span> &gt;&gt; /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 DNS（永久 - Ubuntu）</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/netplan/01-netcfg.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">network:</span></span><br><span class="line"><span class="string">  version: 2</span></span><br><span class="line"><span class="string">  ethernets:</span></span><br><span class="line"><span class="string">    eth0:</span></span><br><span class="line"><span class="string">      nameservers:</span></span><br><span class="line"><span class="string">        addresses: [8.8.8.8, 1.1.1.1]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">netplan apply</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 DNS（永久 - CentOS）</span></span><br><span class="line">nmcli con mod eth0 ipv4.dns <span class="string">&quot;8.8.8.8 1.1.1.1&quot;</span></span><br><span class="line">nmcli con up eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 DNS 解析</span></span><br><span class="line">nslookup example.com</span><br><span class="line">dig example.com</span><br><span class="line">host example.com</span><br></pre></td></tr></table></figure>

<h3 id="1-4-网络接口管理"><a href="#1-4-网络接口管理" class="headerlink" title="1.4 网络接口管理"></a>1.4 网络接口管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用/禁用接口</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 up</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 down</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看接口状态</span></span><br><span class="line">ip <span class="built_in">link</span> show</span><br><span class="line">ethtool eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看接口统计</span></span><br><span class="line">ip -s <span class="built_in">link</span> show eth0</span><br><span class="line">ethtool -S eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 MTU</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 mtu 9000</span><br><span class="line">ethtool -K eth0 gro on tso on gso on</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-网络监控工具"><a href="#2-网络监控工具" class="headerlink" title="2. 网络监控工具"></a>2. 网络监控工具</h2><h3 id="2-1-流量监控"><a href="#2-1-流量监控" class="headerlink" title="2.1 流量监控"></a>2.1 流量监控</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># iftop - 实时流量监控</span></span><br><span class="line">iftop -i eth0</span><br><span class="line">iftop -n -N  <span class="comment"># 不解析端口和服务名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nethogs - 按进程监控</span></span><br><span class="line">nethogs eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptraf - 交互式流量监控</span></span><br><span class="line">iptraf-ng</span><br><span class="line"></span><br><span class="line"><span class="comment"># vnstat - 流量统计</span></span><br><span class="line">vnstat -i eth0</span><br><span class="line">vnstat -h      <span class="comment"># 小时统计</span></span><br><span class="line">vnstat -d      <span class="comment"># 天统计</span></span><br><span class="line">vnstat -m      <span class="comment"># 月统计</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-连接监控"><a href="#2-2-连接监控" class="headerlink" title="2.2 连接监控"></a>2.2 连接监控</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看网络连接</span></span><br><span class="line">ss -tulpn</span><br><span class="line">netstat -tulpn</span><br><span class="line">lsof -i</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 TCP 连接</span></span><br><span class="line">ss -tan</span><br><span class="line">netstat -tan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看监听端口</span></span><br><span class="line">ss -tlnp</span><br><span class="line">netstat -tlnp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控连接变化</span></span><br><span class="line">watch -n1 <span class="string">&#x27;ss -tan | wc -l&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-带宽测试"><a href="#2-3-带宽测试" class="headerlink" title="2.3 带宽测试"></a>2.3 带宽测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># iperf3 - 网络性能测试</span></span><br><span class="line"><span class="comment"># 服务端</span></span><br><span class="line">iperf3 -s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端</span></span><br><span class="line">iperf3 -c server_ip</span><br><span class="line">iperf3 -c server_ip -P 4  <span class="comment"># 4 个并行连接</span></span><br><span class="line">iperf3 -c server_ip -R    <span class="comment"># 反向测试（下载）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># speedtest-cli - 网速测试</span></span><br><span class="line">speedtest-cli</span><br><span class="line">speedtest-cli --share</span><br></pre></td></tr></table></figure>

<h3 id="2-4-数据包捕获"><a href="#2-4-数据包捕获" class="headerlink" title="2.4 数据包捕获"></a>2.4 数据包捕获</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tcpdump - 抓包工具</span></span><br><span class="line">tcpdump -i eth0</span><br><span class="line">tcpdump -i eth0 -n port 80</span><br><span class="line">tcpdump -i eth0 -n host 192.168.1.100</span><br><span class="line">tcpdump -i eth0 -w capture.pcap</span><br><span class="line">tcpdump -r capture.pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># tshark - Wireshark 命令行版</span></span><br><span class="line">tshark -i eth0</span><br><span class="line">tshark -i eth0 -f <span class="string">&quot;port 80&quot;</span></span><br><span class="line">tshark -r capture.pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># wireshark - 图形界面</span></span><br><span class="line">wireshark capture.pcap</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-性能测试"><a href="#3-性能测试" class="headerlink" title="3. 性能测试"></a>3. 性能测试</h2><h3 id="3-1-延迟测试"><a href="#3-1-延迟测试" class="headerlink" title="3.1 延迟测试"></a>3.1 延迟测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ping - 基础延迟测试</span></span><br><span class="line">ping example.com</span><br><span class="line">ping -c 10 example.com</span><br><span class="line">ping -i 0.2 example.com  <span class="comment"># 快速 ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mtr - 路由追踪 + ping</span></span><br><span class="line">mtr example.com</span><br><span class="line">mtr -rwc 10 example.com  <span class="comment"># 报告模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 延迟监控</span></span><br><span class="line">ping -D example.com | awk <span class="string">&#x27;&#123;print strftime(&quot;%Y-%m-%d %H:%M:%S&quot;), $7&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-路由追踪"><a href="#3-2-路由追踪" class="headerlink" title="3.2 路由追踪"></a>3.2 路由追踪</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># traceroute - 路由追踪</span></span><br><span class="line">traceroute example.com</span><br><span class="line">traceroute -I example.com  <span class="comment"># 使用 ICMP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tracepath - 无需 root</span></span><br><span class="line">tracepath example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># mtr - 动态路由追踪</span></span><br><span class="line">mtr example.com</span><br><span class="line">mtr --report example.com</span><br></pre></td></tr></table></figure>

<h3 id="3-3-DNS-性能测试"><a href="#3-3-DNS-性能测试" class="headerlink" title="3.3 DNS 性能测试"></a>3.3 DNS 性能测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dig 测试</span></span><br><span class="line">dig @8.8.8.8 example.com</span><br><span class="line">dig +stats example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># DNS 查询时间</span></span><br><span class="line"><span class="keyword">time</span> dig example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量 DNS 测试</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;; <span class="keyword">do</span> dig example.com | grep <span class="string">&quot;Query time&quot;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-HTTP-性能测试"><a href="#3-4-HTTP-性能测试" class="headerlink" title="3.4 HTTP 性能测试"></a>3.4 HTTP 性能测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl 测试</span></span><br><span class="line">curl -o /dev/null -s -w <span class="string">&quot;DNS: %&#123;time_namelookup&#125;s\nConnect: %&#123;time_connect&#125;s\nTTFB: %&#123;time_starttransfer&#125;s\nTotal: %&#123;time_total&#125;s\n&quot;</span> https://example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># ab - Apache Benchmark</span></span><br><span class="line">ab -n 1000 -c 100 https://example.com/</span><br><span class="line"></span><br><span class="line"><span class="comment"># wrk - 现代 HTTP 基准测试</span></span><br><span class="line">wrk -t12 -c400 -d30s https://example.com/</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-故障排查方法"><a href="#4-故障排查方法" class="headerlink" title="4. 故障排查方法"></a>4. 故障排查方法</h2><h3 id="4-1-排查流程"><a href="#4-1-排查流程" class="headerlink" title="4.1 排查流程"></a>4.1 排查流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 确认问题范围</span><br><span class="line">   - 单台主机还是多台？</span><br><span class="line">   - 特定服务还是所有服务？</span><br><span class="line">   - 内网还是外网？</span><br><span class="line"></span><br><span class="line">2. 检查物理层</span><br><span class="line">   - 网线连接</span><br><span class="line">   - 接口状态</span><br><span class="line">   - LED 指示灯</span><br><span class="line"></span><br><span class="line">3. 检查网络层</span><br><span class="line">   - IP 配置</span><br><span class="line">   - 路由表</span><br><span class="line">   - DNS 解析</span><br><span class="line"></span><br><span class="line">4. 检查传输层</span><br><span class="line">   - 防火墙规则</span><br><span class="line">   - 端口监听</span><br><span class="line">   - 连接状态</span><br><span class="line"></span><br><span class="line">5. 检查应用层</span><br><span class="line">   - 服务配置</span><br><span class="line">   - 日志信息</span><br><span class="line">   - 资源使用</span><br></pre></td></tr></table></figure>

<h3 id="4-2-诊断命令"><a href="#4-2-诊断命令" class="headerlink" title="4.2 诊断命令"></a>4.2 诊断命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 检查网络接口</span></span><br><span class="line">ip addr show</span><br><span class="line">ip <span class="built_in">link</span> show</span><br><span class="line">ethtool eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查路由</span></span><br><span class="line">ip route show</span><br><span class="line">traceroute 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查 DNS</span></span><br><span class="line"><span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line">nslookup example.com</span><br><span class="line">dig example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 检查连接</span></span><br><span class="line">ss -tulpn</span><br><span class="line">netstat -tan | grep ESTABLISHED | <span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 检查防火墙</span></span><br><span class="line">iptables -L -n</span><br><span class="line">firewall-cmd --list-all</span><br><span class="line">ufw status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 检查服务</span></span><br><span class="line">systemctl status service</span><br><span class="line">journalctl -u service -f</span><br></pre></td></tr></table></figure>

<h3 id="4-3-日志分析"><a href="#4-3-日志分析" class="headerlink" title="4.3 日志分析"></a>4.3 日志分析</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/syslog</span><br><span class="line"><span class="built_in">tail</span> -f /var/log/messages</span><br><span class="line">journalctl -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络相关日志</span></span><br><span class="line">journalctl -u NetworkManager -f</span><br><span class="line">journalctl -u systemd-networkd -f</span><br><span class="line">dmesg | grep -i eth</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/nginx/error.log</span><br><span class="line"><span class="built_in">tail</span> -f /var/log/apache2/error.log</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-常见问题解决"><a href="#5-常见问题解决" class="headerlink" title="5. 常见问题解决"></a>5. 常见问题解决</h2><h3 id="5-1-无法访问外网"><a href="#5-1-无法访问外网" class="headerlink" title="5.1 无法访问外网"></a>5.1 无法访问外网</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 检查网关</span></span><br><span class="line">ip route show</span><br><span class="line">ping 192.168.1.1  <span class="comment"># 网关</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查 DNS</span></span><br><span class="line">nslookup www.baidu.com</span><br><span class="line">dig www.baidu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查防火墙</span></span><br><span class="line">iptables -L -n</span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 检查 NAT</span></span><br><span class="line">iptables -t nat -L -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 临时解决方案</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> &gt; /etc/resolv.conf</span><br><span class="line">ip route add default via 192.168.1.1</span><br></pre></td></tr></table></figure>

<h3 id="5-2-DNS-解析失败"><a href="#5-2-DNS-解析失败" class="headerlink" title="5.2 DNS 解析失败"></a>5.2 DNS 解析失败</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 检查 resolv.conf</span></span><br><span class="line"><span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 测试 DNS 服务器</span></span><br><span class="line">nslookup example.com 8.8.8.8</span><br><span class="line">nslookup example.com 114.114.114.114</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查 systemd-resolved</span></span><br><span class="line">systemctl status systemd-resolved</span><br><span class="line">resolvectl status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 修复方案</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/resolv.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">nameserver 8.8.8.8</span></span><br><span class="line"><span class="string">nameserver 114.114.114.114</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 清除 DNS 缓存</span></span><br><span class="line">systemctl restart systemd-resolved</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">/etc/init.d/nscd restart</span><br></pre></td></tr></table></figure>

<h3 id="5-3-端口无法访问"><a href="#5-3-端口无法访问" class="headerlink" title="5.3 端口无法访问"></a>5.3 端口无法访问</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 检查服务是否监听</span></span><br><span class="line">ss -tlnp | grep :80</span><br><span class="line">netstat -tlnp | grep :80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查防火墙</span></span><br><span class="line">iptables -L -n | grep 80</span><br><span class="line">firewall-cmd --list-ports</span><br><span class="line">ufw status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 开放端口</span></span><br><span class="line"><span class="comment"># firewall-cmd</span></span><br><span class="line">firewall-cmd --add-port=80/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># ufw</span></span><br><span class="line">ufw allow 80/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 检查 SELinux</span></span><br><span class="line">getenforce</span><br><span class="line">setenforce 0  <span class="comment"># 临时禁用测试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 检查云服务商安全组</span></span><br><span class="line"><span class="comment"># 需要在云平台控制台配置</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-网络连接数过多"><a href="#5-4-网络连接数过多" class="headerlink" title="5.4 网络连接数过多"></a>5.4 网络连接数过多</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 查看连接数</span></span><br><span class="line">ss -tan | <span class="built_in">wc</span> -l</span><br><span class="line">netstat -tan | <span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看各状态连接数</span></span><br><span class="line">netstat -tan | awk <span class="string">&#x27;&#123;print $6&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看 TIME_WAIT 连接</span></span><br><span class="line">netstat -tan | grep TIME_WAIT | <span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 优化内核参数</span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/sysctl.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># 允许重用 TIME_WAIT socket</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 缩短 FIN-WAIT-2 超时时间</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 增加本地端口范围</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 1024 65535</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 增加最大文件描述符</span></span><br><span class="line"><span class="string">fs.file-max = 2097152</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 增加连接队列</span></span><br><span class="line"><span class="string">net.core.somaxconn = 65535</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 65535</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="5-5-网络延迟高"><a href="#5-5-网络延迟高" class="headerlink" title="5.5 网络延迟高"></a>5.5 网络延迟高</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 测试延迟</span></span><br><span class="line">ping -c 100 example.com</span><br><span class="line">mtr --report example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查路由</span></span><br><span class="line">traceroute example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查带宽</span></span><br><span class="line">iftop -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 优化 TCP 参数</span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/sysctl.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># 启用 BBR 拥塞控制</span></span><br><span class="line"><span class="string">net.core.default_qdisc=fq</span></span><br><span class="line"><span class="string">net.ipv4.tcp_congestion_control=bbr</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 增加缓冲区</span></span><br><span class="line"><span class="string">net.core.rmem_max = 16777216</span></span><br><span class="line"><span class="string">net.core.wmem_max = 16777216</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 4096 87380 16777216</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 4096 65536 16777216</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 启用 BBR</span></span><br><span class="line">modprobe tcp_bbr</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.ipv4.tcp_congestion_control=bbr&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-网络安全"><a href="#6-网络安全" class="headerlink" title="6. 网络安全"></a>6. 网络安全</h2><h3 id="6-1-防火墙配置"><a href="#6-1-防火墙配置" class="headerlink" title="6.1 防火墙配置"></a>6.1 防火墙配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># iptables 基础配置</span></span><br><span class="line"><span class="comment"># 默认策略</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许回环</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许已建立的连接</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许 SSH</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许 HTTP/HTTPS</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 443 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许 ICMP</span></span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存规则</span></span><br><span class="line">iptables-save &gt; /etc/iptables/rules.v4</span><br><span class="line"></span><br><span class="line"><span class="comment"># firewalld 配置</span></span><br><span class="line">firewall-cmd --permanent --add-service=ssh</span><br><span class="line">firewall-cmd --permanent --add-service=http</span><br><span class="line">firewall-cmd --permanent --add-service=https</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># ufw 配置</span></span><br><span class="line">ufw default deny incoming</span><br><span class="line">ufw default allow outgoing</span><br><span class="line">ufw allow ssh</span><br><span class="line">ufw allow http</span><br><span class="line">ufw allow https</span><br><span class="line">ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-SSH-安全加固"><a href="#6-2-SSH-安全加固" class="headerlink" title="6.2 SSH 安全加固"></a>6.2 SSH 安全加固</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/ssh/sshd_config</span></span><br><span class="line">Port 2222</span><br><span class="line">Protocol 2</span><br><span class="line">PermitRootLogin no</span><br><span class="line">PasswordAuthentication no</span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span></span><br><span class="line">MaxAuthTries 3</span><br><span class="line">ClientAliveInterval 300</span><br><span class="line">ClientAliveCountMax 2</span><br><span class="line">AllowUsers admin deploy</span><br><span class="line">DenyUsers root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 SSH</span></span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure>

<h3 id="6-3-DDoS-防护"><a href="#6-3-DDoS-防护" class="headerlink" title="6.3 DDoS 防护"></a>6.3 DDoS 防护</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 限制连接速率</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 25/minute --limit-burst 100 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止 SYN 洪水</span></span><br><span class="line">iptables -A INPUT -p tcp --syn -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s --limit-burst 3 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止 Ping 洪水</span></span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s --limit-burst 4 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 fail2ban</span></span><br><span class="line">apt-get install fail2ban</span><br><span class="line">systemctl <span class="built_in">enable</span> fail2ban</span><br><span class="line">systemctl start fail2ban</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-网络优化"><a href="#7-网络优化" class="headerlink" title="7. 网络优化"></a>7. 网络优化</h2><h3 id="7-1-内核参数优化"><a href="#7-1-内核参数优化" class="headerlink" title="7.1 内核参数优化"></a>7.1 内核参数优化</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># 网络性能优化</span></span><br><span class="line">net.core.default_qdisc = fq</span><br><span class="line">net.ipv4.tcp_congestion_control = bbr</span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line">net.core.wmem_max = 16777216</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 16777216</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 16777216</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接优化</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65535</span><br><span class="line">net.core.somaxconn = 65535</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 65535</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用优化</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="7-2-网卡优化"><a href="#7-2-网卡优化" class="headerlink" title="7.2 网卡优化"></a>7.2 网卡优化</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看网卡设置</span></span><br><span class="line">ethtool eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用卸载功能</span></span><br><span class="line">ethtool -K eth0 gro on tso on gso on lro on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整环缓冲区</span></span><br><span class="line">ethtool -G eth0 rx 4096 tx 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置中断亲和性</span></span><br><span class="line"><span class="built_in">cat</span> /proc/irq/*/smp_affinity_list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多队列优化</span></span><br><span class="line">ethtool -l eth0</span><br></pre></td></tr></table></figure>

<h3 id="7-3-负载均衡"><a href="#7-3-负载均衡" class="headerlink" title="7.3 负载均衡"></a>7.3 负载均衡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># HAProxy 配置</span></span><br><span class="line">global</span><br><span class="line">    maxconn 4096</span><br><span class="line">    nbthread 4</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode http</span><br><span class="line">    <span class="built_in">timeout</span> connect 5s</span><br><span class="line">    <span class="built_in">timeout</span> client 50s</span><br><span class="line">    <span class="built_in">timeout</span> server 50s</span><br><span class="line"></span><br><span class="line">frontend http_front</span><br><span class="line">    <span class="built_in">bind</span> *:80</span><br><span class="line">    default_backend http_back</span><br><span class="line"></span><br><span class="line">backend http_back</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server web1 192.168.1.10:80 check</span><br><span class="line">    server web2 192.168.1.11:80 check</span><br><span class="line">    server web3 192.168.1.12:80 check</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nginx 负载均衡</span></span><br><span class="line">upstream backend &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    server 192.168.1.10:8080;</span><br><span class="line">    server 192.168.1.11:8080;</span><br><span class="line">    server 192.168.1.12:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用系统</strong>: Linux (CentOS&#x2F;RHEL, Ubuntu&#x2F;Debian)</p>
]]></content>
      <categories>
        <category>故障处理与问题排查</category>
      </categories>
  </entry>
  <entry>
    <title>GitLab CI/CD 运维指南</title>
    <url>/2026/02/28/10-GitLab-CICD%E8%BF%90%E7%BB%B4%E6%8C%87%E5%8D%97/</url>
    <content><![CDATA[<h1 id="GitLab-CI-CD-运维指南"><a href="#GitLab-CI-CD-运维指南" class="headerlink" title="GitLab CI&#x2F;CD 运维指南"></a>GitLab CI&#x2F;CD 运维指南</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-gitlab-%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0">GitLab 架构概述</a></li>
<li><a href="#2-gitlab-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE">GitLab 安装与配置</a></li>
<li><a href="#3-gitlab-runner-%E9%85%8D%E7%BD%AE">GitLab Runner 配置</a></li>
<li><a href="#4-cicd-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">CI&#x2F;CD 配置文件</a></li>
<li><a href="#5-%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AE%BE%E8%AE%A1">流水线设计</a></li>
<li><a href="#6-docker-%E9%9B%86%E6%88%90">Docker 集成</a></li>
<li><a href="#7-kubernetes-%E9%9B%86%E6%88%90">Kubernetes 集成</a></li>
<li><a href="#8-%E5%AE%89%E5%85%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">安全最佳实践</a></li>
<li><a href="#9-%E7%9B%91%E6%8E%A7%E4%B8%8E%E7%BB%B4%E6%8A%A4">监控与维护</a></li>
</ol>
<hr>
<h2 id="1-GitLab-架构概述"><a href="#1-GitLab-架构概述" class="headerlink" title="1. GitLab 架构概述"></a>1. GitLab 架构概述</h2><h3 id="1-1-核心组件"><a href="#1-1-核心组件" class="headerlink" title="1.1 核心组件"></a>1.1 核心组件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GitLab Server</span><br><span class="line">├── GitLab Rails (应用层)</span><br><span class="line">├── GitLab Shell (SSH/Git)</span><br><span class="line">├── GitLab Workhorse (反向代理)</span><br><span class="line">├── PostgreSQL (数据库)</span><br><span class="line">├── Redis (缓存)</span><br><span class="line">└── Gitaly (Git RPC)</span><br><span class="line"></span><br><span class="line">GitLab Runner</span><br><span class="line">├── Executor (Docker/Shell/Kubernetes)</span><br><span class="line">├── Cache (缓存管理)</span><br><span class="line">└── Artifacts (构建产物)</span><br><span class="line"></span><br><span class="line">Registry</span><br><span class="line">├── Docker Registry</span><br><span class="line">└── Package Registry</span><br></pre></td></tr></table></figure>

<h3 id="1-2-CI-CD-流程"><a href="#1-2-CI-CD-流程" class="headerlink" title="1.2 CI&#x2F;CD 流程"></a>1.2 CI&#x2F;CD 流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">代码提交 → Webhook 触发 → 创建 Pipeline</span><br><span class="line">    ↓</span><br><span class="line">Stage 1: Build (编译构建)</span><br><span class="line">    ↓</span><br><span class="line">Stage 2: Test (测试)</span><br><span class="line">    ↓</span><br><span class="line">Stage 3: Deploy (部署)</span><br><span class="line">    ↓</span><br><span class="line">Stage 4: Review (审查)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-GitLab-安装与配置"><a href="#2-GitLab-安装与配置" class="headerlink" title="2. GitLab 安装与配置"></a>2. GitLab 安装与配置</h2><h3 id="2-1-Omnibus-安装"><a href="#2-1-Omnibus-安装" class="headerlink" title="2.1 Omnibus 安装"></a>2.1 Omnibus 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加 GitLab 仓库</span></span><br><span class="line">curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 GitLab CE</span></span><br><span class="line">apt-get install -y gitlab-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或安装 GitLab EE</span></span><br><span class="line">apt-get install -y gitlab-ee</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 GitLab</span></span><br><span class="line">vi /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础配置</span></span><br><span class="line">external_url <span class="string">&#x27;https://gitlab.example.com&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 2222</span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_https_certificate&#x27;</span>] = <span class="string">&#x27;/etc/ssl/certs/gitlab.crt&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_https_key&#x27;</span>] = <span class="string">&#x27;/etc/ssl/private/gitlab.key&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用配置</span></span><br><span class="line">gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">gitlab-ctl status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取初始密码</span></span><br><span class="line"><span class="built_in">cat</span> /etc/gitlab/initial_root_password</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Docker-安装"><a href="#2-2-Docker-安装" class="headerlink" title="2.2 Docker 安装"></a>2.2 Docker 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --hostname gitlab.example.com \</span><br><span class="line">  -p 443:443 \</span><br><span class="line">  -p 80:80 \</span><br><span class="line">  -p 2222:22 \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  --restart always \</span><br><span class="line">  --volume <span class="variable">$GITLAB_HOME</span>/config:/etc/gitlab \</span><br><span class="line">  --volume <span class="variable">$GITLAB_HOME</span>/logs:/var/log/gitlab \</span><br><span class="line">  --volume <span class="variable">$GITLAB_HOME</span>/data:/var/opt/gitlab \</span><br><span class="line">  --shm-size 256m \</span><br><span class="line">  gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>

<h3 id="2-3-备份与恢复"><a href="#2-3-备份与恢复" class="headerlink" title="2.3 备份与恢复"></a>2.3 备份与恢复</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备份</span></span><br><span class="line">gitlab-backup create</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份文件位置</span></span><br><span class="line"><span class="built_in">ls</span> /var/opt/gitlab/backups/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复（停止相关服务）</span></span><br><span class="line">gitlab-ctl stop unicorn</span><br><span class="line">gitlab-ctl stop sidekiq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复备份</span></span><br><span class="line">gitlab-backup restore BACKUP=1234567890_2024_01_01_1.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">gitlab-ctl start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定时备份</span></span><br><span class="line">crontab -e</span><br><span class="line">0 2 * * * /opt/gitlab/bin/gitlab-backup create CRON=1</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-GitLab-Runner-配置"><a href="#3-GitLab-Runner-配置" class="headerlink" title="3. GitLab Runner 配置"></a>3. GitLab Runner 配置</h2><h3 id="3-1-安装-Runner"><a href="#3-1-安装-Runner" class="headerlink" title="3.1 安装 Runner"></a>3.1 安装 Runner</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | bash</span><br><span class="line">apt-get install -y gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | bash</span><br><span class="line">yum install -y gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker 安装</span></span><br><span class="line">docker run -d --name gitlab-runner --restart always \</span><br><span class="line">  -v /srv/gitlab-runner/config:/etc/gitlab-runner \</span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  gitlab/gitlab-runner:latest</span><br></pre></td></tr></table></figure>

<h3 id="3-2-注册-Runner"><a href="#3-2-注册-Runner" class="headerlink" title="3.2 注册 Runner"></a>3.2 注册 Runner</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 交互式注册</span></span><br><span class="line">gitlab-runner register</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入信息：</span></span><br><span class="line"><span class="comment"># GitLab URL: https://gitlab.example.com</span></span><br><span class="line"><span class="comment"># Registration token: &lt;从 GitLab 获取&gt;</span></span><br><span class="line"><span class="comment"># Description: my-runner</span></span><br><span class="line"><span class="comment"># Tags: docker,production</span></span><br><span class="line"><span class="comment"># Executor: docker</span></span><br><span class="line"><span class="comment"># Docker image: alpine:latest</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 非交互式注册</span></span><br><span class="line">gitlab-runner register \</span><br><span class="line">  --non-interactive \</span><br><span class="line">  --url <span class="string">&quot;https://gitlab.example.com/&quot;</span> \</span><br><span class="line">  --registration-token <span class="string">&quot;YOUR_TOKEN&quot;</span> \</span><br><span class="line">  --executor <span class="string">&quot;docker&quot;</span> \</span><br><span class="line">  --description <span class="string">&quot;docker-runner&quot;</span> \</span><br><span class="line">  --docker-image <span class="string">&quot;alpine:latest&quot;</span> \</span><br><span class="line">  --tag-list <span class="string">&quot;docker,production&quot;</span> \</span><br><span class="line">  --run-untagged=<span class="string">&quot;true&quot;</span> \</span><br><span class="line">  --locked=<span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-Runner-配置"><a href="#3-3-Runner-配置" class="headerlink" title="3.3 Runner 配置"></a>3.3 Runner 配置</h3><figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/gitlab-runner/config.toml</span></span><br><span class="line"><span class="attr">concurrent</span> = <span class="number">10</span></span><br><span class="line"><span class="attr">check_interval</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[runners]]</span></span><br><span class="line">  <span class="attr">name</span> = <span class="string">&quot;docker-runner&quot;</span></span><br><span class="line">  <span class="attr">url</span> = <span class="string">&quot;https://gitlab.example.com/&quot;</span></span><br><span class="line">  <span class="attr">token</span> = <span class="string">&quot;RUNNER_TOKEN&quot;</span></span><br><span class="line">  <span class="attr">executor</span> = <span class="string">&quot;docker&quot;</span></span><br><span class="line">  <span class="attr">limit</span> = <span class="number">10</span></span><br><span class="line">  </span><br><span class="line">  <span class="section">[runners.docker]</span></span><br><span class="line">    <span class="attr">tls_verify</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">image</span> = <span class="string">&quot;alpine:latest&quot;</span></span><br><span class="line">    <span class="attr">privileged</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">disable_cache</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">volumes</span> = [<span class="string">&quot;/cache&quot;</span>, <span class="string">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span>]</span><br><span class="line">    <span class="attr">shm_size</span> = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="section">[runners.cache]</span></span><br><span class="line">    <span class="attr">Type</span> = <span class="string">&quot;s3&quot;</span></span><br><span class="line">    <span class="attr">Shared</span> = <span class="literal">true</span></span><br><span class="line">    <span class="section">[runners.cache.s3]</span></span><br><span class="line">      <span class="attr">ServerAddress</span> = <span class="string">&quot;s3.amazonaws.com&quot;</span></span><br><span class="line">      <span class="attr">AccessKey</span> = <span class="string">&quot;ACCESS_KEY&quot;</span></span><br><span class="line">      <span class="attr">SecretKey</span> = <span class="string">&quot;SECRET_KEY&quot;</span></span><br><span class="line">      <span class="attr">BucketName</span> = <span class="string">&quot;gitlab-runner-cache&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-Runner-管理"><a href="#3-4-Runner-管理" class="headerlink" title="3.4 Runner 管理"></a>3.4 Runner 管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 Runner</span></span><br><span class="line">gitlab-runner list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证 Runner</span></span><br><span class="line">gitlab-runner verify</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 Runner</span></span><br><span class="line">gitlab-runner unregister --name runner-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 Runner</span></span><br><span class="line">systemctl restart gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">journalctl -u gitlab-runner -f</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-CI-CD-配置文件"><a href="#4-CI-CD-配置文件" class="headerlink" title="4. CI&#x2F;CD 配置文件"></a>4. CI&#x2F;CD 配置文件</h2><h3 id="4-1-基础配置"><a href="#4-1-基础配置" class="headerlink" title="4.1 基础配置"></a>4.1 基础配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># .gitlab-ci.yml</span></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">APP_NAME:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">DOCKER_DRIVER:</span> <span class="string">overlay2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Before each job&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">after_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;After each job&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build_job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Building...&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dist/</span></span><br><span class="line">    <span class="attr">expire_in:</span> <span class="number">1</span> <span class="string">week</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test_job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Testing...&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">dependencies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build_job</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy_job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Deploying...&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./deploy.sh</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-关键字说明"><a href="#4-2-关键字说明" class="headerlink" title="4.2 关键字说明"></a>4.2 关键字说明</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 常用关键字</span></span><br><span class="line"><span class="attr">stages:</span>          <span class="comment"># 定义阶段</span></span><br><span class="line"><span class="attr">variables:</span>       <span class="comment"># 定义变量</span></span><br><span class="line"><span class="attr">before_script:</span>   <span class="comment"># 每个 job 之前执行</span></span><br><span class="line"><span class="attr">after_script:</span>    <span class="comment"># 每个 job 之后执行</span></span><br><span class="line"><span class="attr">script:</span>          <span class="comment"># 执行命令</span></span><br><span class="line"><span class="attr">image:</span>           <span class="comment"># Docker 镜像</span></span><br><span class="line"><span class="attr">services:</span>        <span class="comment"># Docker 服务</span></span><br><span class="line"><span class="attr">cache:</span>           <span class="comment"># 缓存配置</span></span><br><span class="line"><span class="attr">artifacts:</span>       <span class="comment"># 构建产物</span></span><br><span class="line"><span class="attr">dependencies:</span>    <span class="comment"># 依赖关系</span></span><br><span class="line"><span class="attr">tags:</span>            <span class="comment"># Runner 标签</span></span><br><span class="line"><span class="attr">only/except:</span>     <span class="comment"># 分支过滤</span></span><br><span class="line"><span class="attr">rules:</span>           <span class="comment"># 条件规则</span></span><br><span class="line"><span class="attr">when:</span>            <span class="comment"># 执行时机</span></span><br><span class="line"><span class="attr">allow_failure:</span>   <span class="comment"># 允许失败</span></span><br><span class="line"><span class="attr">timeout:</span>         <span class="comment"># 超时时间</span></span><br><span class="line"><span class="attr">retry:</span>           <span class="comment"># 重试次数</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-变量使用"><a href="#4-3-变量使用" class="headerlink" title="4.3 变量使用"></a>4.3 变量使用</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 预定义变量</span></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">CI_COMMIT_SHA:</span> <span class="string">$CI_COMMIT_SHA</span></span><br><span class="line">  <span class="attr">CI_COMMIT_BRANCH:</span> <span class="string">$CI_COMMIT_BRANCH</span></span><br><span class="line">  <span class="attr">CI_PROJECT_NAME:</span> <span class="string">$CI_PROJECT_NAME</span></span><br><span class="line">  <span class="attr">CI_REGISTRY_IMAGE:</span> <span class="string">$CI_REGISTRY_IMAGE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义变量</span></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DATABASE_URL:</span> <span class="string">&quot;postgresql://user:pass@db:5432/mydb&quot;</span></span><br><span class="line">  <span class="attr">NODE_ENV:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件变量</span></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">TLS_CERT:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">certs/tls.crt</span></span><br><span class="line">  <span class="attr">TLS_KEY:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">certs/tls.key</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 受保护变量（在 GitLab UI 中设置）</span></span><br><span class="line"><span class="comment"># Settings → CI/CD → Variables</span></span><br><span class="line"><span class="comment"># 勾选 Protected 和 Masked</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-流水线设计"><a href="#5-流水线设计" class="headerlink" title="5. 流水线设计"></a>5. 流水线设计</h2><h3 id="5-1-多阶段流水线"><a href="#5-1-多阶段流水线" class="headerlink" title="5.1 多阶段流水线"></a>5.1 多阶段流水线</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lint</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">security</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">lint:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">lint</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">lint</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dist/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">unit_test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">test:unit</span></span><br><span class="line"></span><br><span class="line"><span class="attr">integration_test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">test:integration</span></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">postgres:13</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security_scan:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">security</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">audit</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">snyk</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">allow_failure:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy_staging:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./deploy.sh</span> <span class="string">staging</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">staging</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">develop</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy_production:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./deploy.sh</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-并行与矩阵"><a href="#5-2-并行与矩阵" class="headerlink" title="5.2 并行与矩阵"></a>5.2 并行与矩阵</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 并行执行</span></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">parallel:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">test</span> <span class="string">--</span> <span class="string">--shard=$CI_NODE_INDEX/$CI_NODE_TOTAL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 矩阵构建</span></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">parallel:</span></span><br><span class="line">    <span class="attr">matrix:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NODE_VERSION:</span> [<span class="number">14</span>, <span class="number">16</span>, <span class="number">18</span>]</span><br><span class="line">        <span class="attr">OS:</span> [<span class="string">ubuntu-latest</span>, <span class="string">macos-latest</span>]</span><br><span class="line">  <span class="attr">image:</span> <span class="string">node:$NODE_VERSION</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-条件执行"><a href="#5-3-条件执行" class="headerlink" title="5.3 条件执行"></a>5.3 条件执行</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rules 语法</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./deploy.sh</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">$CI_COMMIT_BRANCH</span> <span class="string">==</span> <span class="string">&quot;main&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">always</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">$CI_COMMIT_BRANCH</span> <span class="string">==</span> <span class="string">&quot;develop&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">$CI_PIPELINE_SOURCE</span> <span class="string">==</span> <span class="string">&quot;schedule&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">always</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">when:</span> <span class="string">never</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># only/except 语法</span></span><br><span class="line"><span class="attr">deploy_prod:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./deploy.sh</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">except:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">schedules</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-子流水线"><a href="#5-4-子流水线" class="headerlink" title="5.4 子流水线"></a>5.4 子流水线</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 触发子流水线</span></span><br><span class="line"><span class="attr">trigger_downstream:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">trigger:</span></span><br><span class="line">    <span class="attr">project:</span> <span class="string">group/sub-project</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">strategy:</span> <span class="string">depend</span>  <span class="comment"># 或 finish</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含其他配置文件</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">local:</span> <span class="string">&#x27;.gitlab-ci-template.yml&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">remote:</span> <span class="string">&#x27;https://example.com/.gitlab-ci.yml&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">template:</span> <span class="string">Auto-DevOps.gitlab-ci.yml</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-Docker-集成"><a href="#6-Docker-集成" class="headerlink" title="6. Docker 集成"></a>6. Docker 集成</h2><h3 id="6-1-Docker-in-Docker"><a href="#6-1-Docker-in-Docker" class="headerlink" title="6.1 Docker in Docker"></a>6.1 Docker in Docker</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 dind 服务</span></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DOCKER_HOST:</span> <span class="string">tcp://docker:2375</span></span><br><span class="line">  <span class="attr">DOCKER_DRIVER:</span> <span class="string">overlay2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker:20.10.16-dind</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">docker:20.10.16</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">myapp:$CI_COMMIT_SHA</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">myapp:$CI_COMMIT_SHA</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-Docker-构建与推送"><a href="#6-2-Docker-构建与推送" class="headerlink" title="6.2 Docker 构建与推送"></a>6.2 Docker 构建与推送</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DOCKER_REGISTRY:</span> <span class="string">registry.gitlab.example.com</span></span><br><span class="line">  <span class="attr">DOCKER_IMAGE:</span> <span class="string">$DOCKER_REGISTRY/$CI_PROJECT_PATH</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build_image:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">docker:latest</span></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker:dind</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">$CI_REGISTRY_PASSWORD</span> <span class="string">|</span> <span class="string">docker</span> <span class="string">login</span> <span class="string">-u</span> <span class="string">$CI_REGISTRY_USER</span> <span class="string">--password-stdin</span> <span class="string">$CI_REGISTRY</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">$DOCKER_IMAGE:$CI_COMMIT_SHA</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">$DOCKER_IMAGE:latest</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$DOCKER_IMAGE:$CI_COMMIT_SHA</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$DOCKER_IMAGE:latest</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">develop</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">bitnami/kubectl:latest</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">set</span> <span class="string">image</span> <span class="string">deployment/myapp</span> <span class="string">myapp=$DOCKER_IMAGE:$CI_COMMIT_SHA</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-多阶段构建"><a href="#6-3-多阶段构建" class="headerlink" title="6.3 多阶段构建"></a>6.3 多阶段构建</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">docker:latest</span></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker:dind</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">--target</span> <span class="string">production</span> <span class="string">-t</span> <span class="string">myapp:$CI_COMMIT_SHA</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">myapp:$CI_COMMIT_SHA</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dockerfile 示例</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">node:16</span> <span class="string">AS</span> <span class="string">builder</span></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/app</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">package*.json</span> <span class="string">./</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="string">FROM</span> <span class="string">node:16-alpine</span> <span class="string">AS</span> <span class="string">production</span></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/app</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=builder</span> <span class="string">/app/dist</span> <span class="string">./dist</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=builder</span> <span class="string">/app/node_modules</span> <span class="string">./node_modules</span></span><br><span class="line"><span class="string">CMD</span> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;dist/server.js&quot;</span>]</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-Kubernetes-集成"><a href="#7-Kubernetes-集成" class="headerlink" title="7. Kubernetes 集成"></a>7. Kubernetes 集成</h2><h3 id="7-1-配置-Kubernetes-访问"><a href="#7-1-配置-Kubernetes-访问" class="headerlink" title="7.1 配置 Kubernetes 访问"></a>7.1 配置 Kubernetes 访问</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 Service Account</span></span><br><span class="line">kubectl create namespace gitlab</span><br><span class="line">kubectl create serviceaccount gitlab-deployer -n gitlab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定权限</span></span><br><span class="line">kubectl create clusterrolebinding gitlab-deployer \</span><br><span class="line">  --clusterrole=cluster-admin \</span><br><span class="line">  --serviceaccount=gitlab:gitlab-deployer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 Token</span></span><br><span class="line">kubectl get secret $(kubectl get serviceaccount gitlab-deployer -n gitlab -o jsonpath=<span class="string">&#x27;&#123;.secrets[0].name&#125;&#x27;</span>) -n gitlab -o jsonpath=<span class="string">&#x27;&#123;.data.token&#125;&#x27;</span> | <span class="built_in">base64</span> -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 GitLab 中设置变量</span></span><br><span class="line"><span class="comment"># Settings → CI/CD → Variables</span></span><br><span class="line"><span class="comment"># KUBE_CONTEXT: production</span></span><br><span class="line"><span class="comment"># KUBE_NAMESPACE: myapp</span></span><br><span class="line"><span class="comment"># KUBE_TOKEN: &lt;上面获取的 token&gt;</span></span><br><span class="line"><span class="comment"># KUBE_CA_CERT: &lt;k8s CA 证书&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-部署到-Kubernetes"><a href="#7-2-部署到-Kubernetes" class="headerlink" title="7.2 部署到 Kubernetes"></a>7.2 部署到 Kubernetes</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">bitnami/kubectl:latest</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">config</span> <span class="string">set-cluster</span> <span class="string">k8s</span> <span class="string">--server=$KUBE_SERVER</span> <span class="string">--certificate-authority=$KUBE_CA_CERT</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">config</span> <span class="string">set-credentials</span> <span class="string">deployer</span> <span class="string">--token=$KUBE_TOKEN</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">config</span> <span class="string">set-context</span> <span class="string">default</span> <span class="string">--cluster=k8s</span> <span class="string">--user=deployer</span> <span class="string">--namespace=$KUBE_NAMESPACE</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">config</span> <span class="string">use-context</span> <span class="string">default</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">set</span> <span class="string">image</span> <span class="string">deployment/$APP_NAME</span> <span class="string">$APP_NAME=$DOCKER_IMAGE:$CI_COMMIT_SHA</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">status</span> <span class="string">deployment/$APP_NAME</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-Helm-部署"><a href="#7-3-Helm-部署" class="headerlink" title="7.3 Helm 部署"></a>7.3 Helm 部署</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy_helm:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">alpine/helm:latest</span></span><br><span class="line">  <span class="attr">before_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">apk</span> <span class="string">add</span> <span class="string">--no-cache</span> <span class="string">curl</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curl</span> <span class="string">-LO</span> <span class="string">https://get.kubectl.io/$(curl</span> <span class="string">-s</span> <span class="string">https://get.kubectl.io)/bin/linux/$(curl</span> <span class="string">-s</span> <span class="string">https://get.kubectl.io)/kubectl</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">./kubectl</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mv</span> <span class="string">./kubectl</span> <span class="string">/usr/local/bin/kubectl</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">helm</span> <span class="string">repo</span> <span class="string">add</span> <span class="string">myrepo</span> <span class="string">https://charts.example.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">helm</span> <span class="string">upgrade</span> <span class="string">--install</span> <span class="string">myapp</span> <span class="string">myrepo/myapp</span> <span class="string">\</span></span><br><span class="line">        <span class="string">--set</span> <span class="string">image.tag=$CI_COMMIT_SHA</span> <span class="string">\</span></span><br><span class="line">        <span class="string">--set</span> <span class="string">replicaCount=3</span> <span class="string">\</span></span><br><span class="line">        <span class="string">--namespace</span> <span class="string">$KUBE_NAMESPACE</span> <span class="string">\</span></span><br><span class="line">        <span class="string">--wait</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-安全最佳实践"><a href="#8-安全最佳实践" class="headerlink" title="8. 安全最佳实践"></a>8. 安全最佳实践</h2><h3 id="8-1-凭证管理"><a href="#8-1-凭证管理" class="headerlink" title="8.1 凭证管理"></a>8.1 凭证管理</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 GitLab Variables（加密存储）</span></span><br><span class="line"><span class="comment"># Settings → CI/CD → Variables</span></span><br><span class="line"><span class="comment"># 勾选：Protected, Masked</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">$DATABASE_PASSWORD</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">aws</span> <span class="string">deploy</span> <span class="string">--token</span> <span class="string">$AWS_TOKEN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用外部密钥管理</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curl</span> <span class="string">-H</span> <span class="string">&quot;X-Vault-Token: $VAULT_TOKEN&quot;</span> <span class="string">$VAULT_ADDR/v1/secret/data/app</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">&#x27;.data.data&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-权限控制"><a href="#8-2-权限控制" class="headerlink" title="8.2 权限控制"></a>8.2 权限控制</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 限制 Runner 权限</span></span><br><span class="line">[[<span class="string">runners</span>]]</span><br><span class="line">  <span class="string">executor</span> <span class="string">=</span> <span class="string">&quot;docker&quot;</span></span><br><span class="line">  [<span class="string">runners.docker</span>]</span><br><span class="line">    <span class="string">privileged</span> <span class="string">=</span> <span class="literal">false</span></span><br><span class="line">    <span class="string">disable_cache</span> <span class="string">=</span> <span class="literal">false</span></span><br><span class="line">    <span class="string">cap_drop</span> <span class="string">=</span> [<span class="string">&quot;ALL&quot;</span>]</span><br><span class="line">    <span class="string">cap_add</span> <span class="string">=</span> [<span class="string">&quot;NET_BIND_SERVICE&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用受保护的分支</span></span><br><span class="line"><span class="comment"># Settings → Repository → Protected Branches</span></span><br><span class="line"><span class="comment"># main: Maintainers + Allowed to merge</span></span><br><span class="line"><span class="comment"># develop: Developers + Maintainers</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用受保护的标签</span></span><br><span class="line"><span class="comment"># Settings → Repository → Protected Tags</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-安全扫描"><a href="#8-3-安全扫描" class="headerlink" title="8.3 安全扫描"></a>8.3 安全扫描</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 包含 GitLab 安全模板</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">template:</span> <span class="string">Security/SAST.gitlab-ci.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">template:</span> <span class="string">Security/Dependency-Scanning.gitlab-ci.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">template:</span> <span class="string">Security/Container-Scanning.gitlab-ci.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">template:</span> <span class="string">Security/DAST.gitlab-ci.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义安全扫描</span></span><br><span class="line"><span class="attr">security_scan:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">audit</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">snyk</span> <span class="string">test</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">trivy</span> <span class="string">image</span> <span class="string">myapp:$CI_COMMIT_SHA</span></span><br><span class="line">  <span class="attr">allow_failure:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-监控与维护"><a href="#9-监控与维护" class="headerlink" title="9. 监控与维护"></a>9. 监控与维护</h2><h3 id="9-1-监控指标"><a href="#9-1-监控指标" class="headerlink" title="9.1 监控指标"></a>9.1 监控指标</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GitLab 内置监控</span></span><br><span class="line"><span class="comment"># Admin → Monitoring → Metrics</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prometheus 端点</span></span><br><span class="line">curl https://gitlab.example.com/-/metrics</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关键指标</span></span><br><span class="line">- gitlab_ci_pipelines_total</span><br><span class="line">- gitlab_ci_builds_total</span><br><span class="line">- gitlab_runner_jobs_total</span><br><span class="line">- gitlab_http_requests_total</span><br></pre></td></tr></table></figure>

<h3 id="9-2-日志管理"><a href="#9-2-日志管理" class="headerlink" title="9.2 日志管理"></a>9.2 日志管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">gitlab-ctl <span class="built_in">tail</span></span><br><span class="line">gitlab-ctl <span class="built_in">tail</span> nginx</span><br><span class="line">gitlab-ctl <span class="built_in">tail</span> sidekiq</span><br><span class="line">gitlab-ctl <span class="built_in">tail</span> gitlab-rails</span><br><span class="line"></span><br><span class="line"><span class="comment"># Runner 日志</span></span><br><span class="line">journalctl -u gitlab-runner -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志轮转</span></span><br><span class="line"><span class="comment"># /etc/gitlab/gitlab.rb</span></span><br><span class="line">logrotate[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">logrotate[<span class="string">&#x27;max_size&#x27;</span>] = <span class="string">&quot;100M&quot;</span></span><br><span class="line">logrotate[<span class="string">&#x27;rotate&#x27;</span>] = 30</span><br></pre></td></tr></table></figure>

<h3 id="9-3-性能优化"><a href="#9-3-性能优化" class="headerlink" title="9.3 性能优化"></a>9.3 性能优化</h3><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/gitlab/gitlab.rb</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Puma 配置</span></span><br><span class="line">puma[<span class="string">&#x27;worker_processes&#x27;</span>] = <span class="number">4</span></span><br><span class="line">puma[<span class="string">&#x27;worker_timeout&#x27;</span>] = <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sidekiq 配置</span></span><br><span class="line">sidekiq[<span class="string">&#x27;max_concurrency&#x27;</span>] = <span class="number">20</span></span><br><span class="line">sidekiq[<span class="string">&#x27;job_timeout&#x27;</span>] = <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL 配置</span></span><br><span class="line">postgresql[<span class="string">&#x27;shared_buffers&#x27;</span>] = <span class="string">&quot;256MB&quot;</span></span><br><span class="line">postgresql[<span class="string">&#x27;max_connections&#x27;</span>] = <span class="number">400</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis 配置</span></span><br><span class="line">redis[<span class="string">&#x27;maxclients&#x27;</span>] = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用配置</span></span><br><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>

<h3 id="9-4-备份策略"><a href="#9-4-备份策略" class="headerlink" title="9.4 备份策略"></a>9.4 备份策略</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># /opt/gitlab-backup.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份</span></span><br><span class="line">/opt/gitlab/bin/gitlab-backup create</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理 7 天前的备份</span></span><br><span class="line">find /var/opt/gitlab/backups -name <span class="string">&quot;*.tar&quot;</span> -mtime +7 -delete</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步到远程存储</span></span><br><span class="line">rsync -avz /var/opt/gitlab/backups/ backup-server:/backup/gitlab/</span><br><span class="line"></span><br><span class="line"><span class="comment"># crontab</span></span><br><span class="line">0 2 * * * /opt/gitlab-backup.sh</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用版本</strong>: GitLab 15.x+, GitLab Runner 15.x+</p>
]]></content>
      <categories>
        <category>软件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>华为交换机经典组网配置案例</title>
    <url>/2026/02/28/12-%E5%8D%8E%E4%B8%BA%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%BB%8F%E5%85%B8%E7%BB%84%E7%BD%91%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B/</url>
    <content><![CDATA[<h1 id="华为交换机经典组网配置案例"><a href="#华为交换机经典组网配置案例" class="headerlink" title="华为交换机经典组网配置案例"></a>华为交换机经典组网配置案例</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-%E5%B0%8F%E5%9E%8B%E4%BC%81%E4%B8%9A%E7%BD%91%E7%BB%9C%E7%BB%84%E7%BD%91">小型企业网络组网</a></li>
<li><a href="#2-%E4%B8%AD%E5%9E%8B%E5%9B%AD%E5%8C%BA%E7%BD%91%E7%BB%9C%E7%BB%84%E7%BD%91">中型园区网络组网</a></li>
<li><a href="#3-%E5%A4%A7%E5%9E%8B%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83%E7%BD%91%E7%BB%9C%E7%BB%84%E7%BD%91">大型数据中心网络组网</a></li>
<li><a href="#4-mstp+vrrp-%E9%AB%98%E5%8F%AF%E7%94%A8%E7%BB%84%E7%BD%91">MSTP+VRRP 高可用组网</a></li>
<li><a href="#5-%E5%A0%86%E5%8F%A0%E7%BB%84%E7%BD%91%E9%85%8D%E7%BD%AE">堆叠组网配置</a></li>
<li><a href="#6-%E6%97%A0%E7%BA%BF-acap-%E7%BB%84%E7%BD%91">无线 AC+AP 组网</a></li>
<li><a href="#7-qinq-%E7%BB%84%E7%BD%91%E9%85%8D%E7%BD%AE">QinQ 组网配置</a></li>
</ol>
<hr>
<h2 id="1-小型企业网络组网"><a href="#1-小型企业网络组网" class="headerlink" title="1. 小型企业网络组网"></a>1. 小型企业网络组网</h2><h3 id="1-1-组网拓扑"><a href="#1-1-组网拓扑" class="headerlink" title="1.1 组网拓扑"></a>1.1 组网拓扑</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">             Internet</span><br><span class="line">                |</span><br><span class="line">            [防火墙]</span><br><span class="line">                |</span><br><span class="line">            [核心交换机]</span><br><span class="line">             /       \</span><br><span class="line">            /         \</span><br><span class="line"> [接入交换机 1]    [接入交换机 2]</span><br><span class="line">    /    \            /    \</span><br><span class="line">  PC1   PC2        PC3   PC4</span><br><span class="line">VLAN10 VLAN20    VLAN10 VLAN20</span><br></pre></td></tr></table></figure>

<h3 id="1-2-需求分析"><a href="#1-2-需求分析" class="headerlink" title="1.2 需求分析"></a>1.2 需求分析</h3><ul>
<li>2 个部门：行政部（VLAN10）、技术部（VLAN20）</li>
<li>核心交换机提供 VLAN 间路由</li>
<li>接入交换机二层接入</li>
<li>统一出口上网</li>
</ul>
<h3 id="1-3-核心交换机配置"><a href="#1-3-核心交换机配置" class="headerlink" title="1.3 核心交换机配置"></a>1.3 核心交换机配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设备名称</span></span><br><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Core-SW</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 VLAN</span></span><br><span class="line">[Core-SW] vlan batch 10 20 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置连接接入交换机的接口</span></span><br><span class="line">[Core-SW] interface GigabitEthernet 0/0/1</span><br><span class="line">[Core-SW-GigabitEthernet0/0/1] description To_Access_SW1</span><br><span class="line">[Core-SW-GigabitEthernet0/0/1] port link-type trunk</span><br><span class="line">[Core-SW-GigabitEthernet0/0/1] port trunk allow-pass vlan 10 20</span><br><span class="line">[Core-SW-GigabitEthernet0/0/1] quit</span><br><span class="line"></span><br><span class="line">[Core-SW] interface GigabitEthernet 0/0/2</span><br><span class="line">[Core-SW-GigabitEthernet0/0/2] description To_Access_SW2</span><br><span class="line">[Core-SW-GigabitEthernet0/0/2] port link-type trunk</span><br><span class="line">[Core-SW-GigabitEthernet0/0/2] port trunk allow-pass vlan 10 20</span><br><span class="line">[Core-SW-GigabitEthernet0/0/2] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置连接防火墙的接口</span></span><br><span class="line">[Core-SW] interface GigabitEthernet 0/0/24</span><br><span class="line">[Core-SW-GigabitEthernet0/0/24] description To_Firewall</span><br><span class="line">[Core-SW-GigabitEthernet0/0/24] port link-type access</span><br><span class="line">[Core-SW-GigabitEthernet0/0/24] port default vlan 100</span><br><span class="line">[Core-SW-GigabitEthernet0/0/24] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 VLANIF 接口（VLAN 间路由）</span></span><br><span class="line">[Core-SW] interface Vlanif 10</span><br><span class="line">[Core-SW-Vlanif10] description HR_Department</span><br><span class="line">[Core-SW-Vlanif10] ip address 192.168.10.1 255.255.255.0</span><br><span class="line">[Core-SW-Vlanif10] quit</span><br><span class="line"></span><br><span class="line">[Core-SW] interface Vlanif 20</span><br><span class="line">[Core-SW-Vlanif20] description IT_Department</span><br><span class="line">[Core-SW-Vlanif20] ip address 192.168.20.1 255.255.255.0</span><br><span class="line">[Core-SW-Vlanif20] quit</span><br><span class="line"></span><br><span class="line">[Core-SW] interface Vlanif 100</span><br><span class="line">[Core-SW-Vlanif100] description To_Internet</span><br><span class="line">[Core-SW-Vlanif100] ip address 192.168.100.2 255.255.255.0</span><br><span class="line">[Core-SW-Vlanif100] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用 IP 路由</span></span><br><span class="line">[Core-SW] ip routing</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置默认路由指向防火墙</span></span><br><span class="line">[Core-SW] ip route-static 0.0.0.0 0.0.0.0 192.168.100.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 DHCP 服务</span></span><br><span class="line">[Core-SW] dhcp <span class="built_in">enable</span></span><br><span class="line">[Core-SW] ip pool vlan10</span><br><span class="line">[Core-SW-ip-pool-vlan10] network 192.168.10.0 mask 255.255.255.0</span><br><span class="line">[Core-SW-ip-pool-vlan10] gateway-list 192.168.10.1</span><br><span class="line">[Core-SW-ip-pool-vlan10] dns-list 114.114.114.114 8.8.8.8</span><br><span class="line">[Core-SW-ip-pool-vlan10] quit</span><br><span class="line"></span><br><span class="line">[Core-SW] ip pool vlan20</span><br><span class="line">[Core-SW-ip-pool-vlan20] network 192.168.20.0 mask 255.255.255.0</span><br><span class="line">[Core-SW-ip-pool-vlan20] gateway-list 192.168.20.1</span><br><span class="line">[Core-SW-ip-pool-vlan20] dns-list 114.114.114.114 8.8.8.8</span><br><span class="line">[Core-SW-ip-pool-vlan20] quit</span><br><span class="line"></span><br><span class="line">[Core-SW] interface Vlanif 10</span><br><span class="line">[Core-SW-Vlanif10] dhcp <span class="keyword">select</span> global</span><br><span class="line">[Core-SW-Vlanif10] quit</span><br><span class="line"></span><br><span class="line">[Core-SW] interface Vlanif 20</span><br><span class="line">[Core-SW-Vlanif20] dhcp <span class="keyword">select</span> global</span><br><span class="line">[Core-SW-Vlanif20] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存配置</span></span><br><span class="line">&lt;Core-SW&gt; save</span><br></pre></td></tr></table></figure>

<h3 id="1-4-接入交换机配置"><a href="#1-4-接入交换机配置" class="headerlink" title="1.4 接入交换机配置"></a>1.4 接入交换机配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 接入交换机 1 配置</span></span><br><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Access-SW1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 VLAN</span></span><br><span class="line">[Access-SW1] vlan batch 10 20</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置连接 PC 的接口</span></span><br><span class="line">[Access-SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/1] description To_PC1_HR</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/1] port link-type access</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/1] port default vlan 10</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/1] quit</span><br><span class="line"></span><br><span class="line">[Access-SW1] interface GigabitEthernet 0/0/2</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/2] description To_PC2_IT</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/2] port link-type access</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/2] port default vlan 20</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/2] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置上行接口</span></span><br><span class="line">[Access-SW1] interface GigabitEthernet 0/0/24</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/24] description To_Core_SW</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/24] port link-type trunk</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/24] port trunk allow-pass vlan 10 20</span><br><span class="line">[Access-SW1-GigabitEthernet0/0/24] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存配置</span></span><br><span class="line">&lt;Access-SW1&gt; save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接入交换机 2 配置（类似）</span></span><br><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Access-SW2</span><br><span class="line">[Access-SW2] vlan batch 10 20</span><br><span class="line">[Access-SW2] interface GigabitEthernet 0/0/1</span><br><span class="line">[Access-SW2-GigabitEthernet0/0/1] port link-type access</span><br><span class="line">[Access-SW2-GigabitEthernet0/0/1] port default vlan 10</span><br><span class="line">[Access-SW2] interface GigabitEthernet 0/0/2</span><br><span class="line">[Access-SW2-GigabitEthernet0/0/2] port link-type access</span><br><span class="line">[Access-SW2-GigabitEthernet0/0/2] port default vlan 20</span><br><span class="line">[Access-SW2] interface GigabitEthernet 0/0/24</span><br><span class="line">[Access-SW2-GigabitEthernet0/0/24] port link-type trunk</span><br><span class="line">[Access-SW2-GigabitEthernet0/0/24] port trunk allow-pass vlan 10 20</span><br><span class="line">&lt;Access-SW2&gt; save</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-中型园区网络组网"><a href="#2-中型园区网络组网" class="headerlink" title="2. 中型园区网络组网"></a>2. 中型园区网络组网</h2><h3 id="2-1-组网拓扑"><a href="#2-1-组网拓扑" class="headerlink" title="2.1 组网拓扑"></a>2.1 组网拓扑</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">             Internet</span><br><span class="line">                |</span><br><span class="line">            [防火墙]</span><br><span class="line">                |</span><br><span class="line">         [核心交换机 1] &lt;====&gt; [核心交换机 2]</span><br><span class="line">         /    |    \          /    |    \</span><br><span class="line">        /     |     \        /     |     \</span><br><span class="line">[汇聚 1]  [汇聚 2]  [汇聚 3]  [汇聚 1]  [汇聚 2]  [汇聚 3]</span><br><span class="line">  /  \     /  \     /  \      /  \     /  \     /  \</span><br><span class="line">接入  接入 接入  接入 接入  接入  接入  接入 接入  接入 接入</span><br></pre></td></tr></table></figure>

<h3 id="2-2-需求分析"><a href="#2-2-需求分析" class="headerlink" title="2.2 需求分析"></a>2.2 需求分析</h3><ul>
<li>核心层双机冗余</li>
<li>汇聚层链路聚合</li>
<li>多 VLAN 隔离</li>
<li>生成树防环</li>
<li>无线覆盖</li>
</ul>
<h3 id="2-3-核心交换机配置（MSTP-VRRP）"><a href="#2-3-核心交换机配置（MSTP-VRRP）" class="headerlink" title="2.3 核心交换机配置（MSTP+VRRP）"></a>2.3 核心交换机配置（MSTP+VRRP）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 核心交换机 1</span></span><br><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Core-SW1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 VLAN</span></span><br><span class="line">[Core-SW1] vlan batch 10 20 30 40 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 MSTP</span></span><br><span class="line">[Core-SW1] stp mode mstp</span><br><span class="line">[Core-SW1] stp region-configuration</span><br><span class="line">[Core-SW1-mst-region] region-name CAMPUS</span><br><span class="line">[Core-SW1-mst-region] instance 1 vlan 10 20</span><br><span class="line">[Core-SW1-mst-region] instance 2 vlan 30 40</span><br><span class="line">[Core-SW1-mst-region] revision-level 1</span><br><span class="line">[Core-SW1-mst-region] active region-configuration</span><br><span class="line">[Core-SW1-mst-region] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 MSTP 实例优先级（Core-SW1 为实例 1 的主根）</span></span><br><span class="line">[Core-SW1] stp instance 1 priority 0</span><br><span class="line">[Core-SW1] stp instance 2 priority 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 VRRP</span></span><br><span class="line">[Core-SW1] interface Vlanif 10</span><br><span class="line">[Core-SW1-Vlanif10] ip address 192.168.10.2 255.255.255.0</span><br><span class="line">[Core-SW1-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.1</span><br><span class="line">[Core-SW1-Vlanif10] vrrp vrid 1 priority 120</span><br><span class="line">[Core-SW1-Vlanif10] vrrp vrid 1 preempt-mode timer delay 20</span><br><span class="line">[Core-SW1-Vlanif10] quit</span><br><span class="line"></span><br><span class="line">[Core-SW1] interface Vlanif 20</span><br><span class="line">[Core-SW1-Vlanif20] ip address 192.168.20.2 255.255.255.0</span><br><span class="line">[Core-SW1-Vlanif20] vrrp vrid 2 virtual-ip 192.168.20.1</span><br><span class="line">[Core-SW1-Vlanif20] vrrp vrid 2 priority 120</span><br><span class="line">[Core-SW1-Vlanif20] quit</span><br><span class="line"></span><br><span class="line">[Core-SW1] interface Vlanif 30</span><br><span class="line">[Core-SW1-Vlanif30] ip address 192.168.30.2 255.255.255.0</span><br><span class="line">[Core-SW1-Vlanif30] vrrp vrid 3 virtual-ip 192.168.30.1</span><br><span class="line">[Core-SW1-Vlanif30] vrrp vrid 3 priority 100</span><br><span class="line">[Core-SW1-Vlanif30] quit</span><br><span class="line"></span><br><span class="line">[Core-SW1] interface Vlanif 40</span><br><span class="line">[Core-SW1-Vlanif40] ip address 192.168.40.2 255.255.255.0</span><br><span class="line">[Core-SW1-Vlanif40] vrrp vrid 4 virtual-ip 192.168.40.1</span><br><span class="line">[Core-SW1-Vlanif40] vrrp vrid 4 priority 100</span><br><span class="line">[Core-SW1-Vlanif40] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置与 Core-SW2 的互联</span></span><br><span class="line">[Core-SW1] interface Eth-Trunk 1</span><br><span class="line">[Core-SW1-Eth-Trunk1] description To_Core-SW2</span><br><span class="line">[Core-SW1-Eth-Trunk1] port link-type trunk</span><br><span class="line">[Core-SW1-Eth-Trunk1] port trunk allow-pass vlan 10 20 30 40 100</span><br><span class="line">[Core-SW1-Eth-Trunk1] mode lacp</span><br><span class="line">[Core-SW1-Eth-Trunk1] quit</span><br><span class="line"></span><br><span class="line">[Core-SW1] interface GigabitEthernet 1/0/1</span><br><span class="line">[Core-SW1-GigabitEthernet1/0/1] eth-trunk 1</span><br><span class="line">[Core-SW1] interface GigabitEthernet 1/0/2</span><br><span class="line">[Core-SW1-GigabitEthernet1/0/2] eth-trunk 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置与汇聚交换机互联</span></span><br><span class="line">[Core-SW1] interface Eth-Trunk 10</span><br><span class="line">[Core-SW1-Eth-Trunk10] description To_Aggregation-SW1</span><br><span class="line">[Core-SW1-Eth-Trunk10] port link-type trunk</span><br><span class="line">[Core-SW1-Eth-Trunk10] port trunk allow-pass vlan 10 20 30 40</span><br><span class="line">[Core-SW1-Eth-Trunk10] quit</span><br><span class="line"></span><br><span class="line">[Core-SW1] interface GigabitEthernet 1/0/10</span><br><span class="line">[Core-SW1-GigabitEthernet1/0/10] eth-trunk 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 OSPF</span></span><br><span class="line">[Core-SW1] ospf 1 router-id 1.1.1.1</span><br><span class="line">[Core-SW1-ospf-1] area 0</span><br><span class="line">[Core-SW1-ospf-1-area-0.0.0.0] network 192.168.10.0 0.0.0.255</span><br><span class="line">[Core-SW1-ospf-1-area-0.0.0.0] network 192.168.20.0 0.0.0.255</span><br><span class="line">[Core-SW1-ospf-1-area-0.0.0.0] network 192.168.30.0 0.0.0.255</span><br><span class="line">[Core-SW1-ospf-1-area-0.0.0.0] network 192.168.40.0 0.0.0.255</span><br><span class="line">[Core-SW1-ospf-1-area-0.0.0.0] network 192.168.100.0 0.0.0.255</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置默认路由</span></span><br><span class="line">[Core-SW1] ip route-static 0.0.0.0 0.0.0.0 192.168.100.254</span><br><span class="line"></span><br><span class="line">&lt;Core-SW1&gt; save</span><br></pre></td></tr></table></figure>

<h3 id="2-4-核心交换机-2-配置"><a href="#2-4-核心交换机-2-配置" class="headerlink" title="2.4 核心交换机 2 配置"></a>2.4 核心交换机 2 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Core-SW2</span><br><span class="line"></span><br><span class="line"><span class="comment"># VLAN 和 MSTP 配置与 Core-SW1 相同</span></span><br><span class="line">[Core-SW2] vlan batch 10 20 30 40 100</span><br><span class="line">[Core-SW2] stp mode mstp</span><br><span class="line">[Core-SW2] stp region-configuration</span><br><span class="line">[Core-SW2-mst-region] region-name CAMPUS</span><br><span class="line">[Core-SW2-mst-region] instance 1 vlan 10 20</span><br><span class="line">[Core-SW2-mst-region] instance 2 vlan 30 40</span><br><span class="line">[Core-SW2-mst-region] revision-level 1</span><br><span class="line">[Core-SW2-mst-region] active region-configuration</span><br><span class="line"></span><br><span class="line"><span class="comment"># MSTP 实例优先级（Core-SW2 为实例 2 的主根）</span></span><br><span class="line">[Core-SW2] stp instance 1 priority 4096</span><br><span class="line">[Core-SW2] stp instance 2 priority 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># VRRP 配置（优先级相反）</span></span><br><span class="line">[Core-SW2] interface Vlanif 10</span><br><span class="line">[Core-SW2-Vlanif10] ip address 192.168.10.3 255.255.255.0</span><br><span class="line">[Core-SW2-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.1</span><br><span class="line">[Core-SW2-Vlanif10] vrrp vrid 1 priority 100</span><br><span class="line">[Core-SW2-Vlanif10] quit</span><br><span class="line"></span><br><span class="line">[Core-SW2] interface Vlanif 20</span><br><span class="line">[Core-SW2-Vlanif20] ip address 192.168.20.3 255.255.255.0</span><br><span class="line">[Core-SW2-Vlanif20] vrrp vrid 2 virtual-ip 192.168.20.1</span><br><span class="line">[Core-SW2-Vlanif20] vrrp vrid 2 priority 100</span><br><span class="line">[Core-SW2-Vlanif20] quit</span><br><span class="line"></span><br><span class="line">[Core-SW2] interface Vlanif 30</span><br><span class="line">[Core-SW2-Vlanif30] ip address 192.168.30.3 255.255.255.0</span><br><span class="line">[Core-SW2-Vlanif30] vrrp vrid 3 virtual-ip 192.168.30.1</span><br><span class="line">[Core-SW2-Vlanif30] vrrp vrid 3 priority 120</span><br><span class="line">[Core-SW2-Vlanif30] quit</span><br><span class="line"></span><br><span class="line">[Core-SW2] interface Vlanif 40</span><br><span class="line">[Core-SW2-Vlanif40] ip address 192.168.40.3 255.255.255.0</span><br><span class="line">[Core-SW2-Vlanif40] vrrp vrid 4 virtual-ip 192.168.40.1</span><br><span class="line">[Core-SW2-Vlanif40] vrrp vrid 4 priority 120</span><br><span class="line">[Core-SW2-Vlanif40] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他配置与 Core-SW1 类似...</span></span><br><span class="line">&lt;Core-SW2&gt; save</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-大型数据中心网络组网"><a href="#3-大型数据中心网络组网" class="headerlink" title="3. 大型数据中心网络组网"></a>3. 大型数据中心网络组网</h2><h3 id="3-1-组网拓扑（Spine-Leaf-架构）"><a href="#3-1-组网拓扑（Spine-Leaf-架构）" class="headerlink" title="3.1 组网拓扑（Spine-Leaf 架构）"></a>3.1 组网拓扑（Spine-Leaf 架构）</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">      [核心路由器]</span><br><span class="line">           |</span><br><span class="line">      [Spine 1] &lt;====&gt; [Spine 2]</span><br><span class="line">        /    \          /    \</span><br><span class="line">       /      \        /      \</span><br><span class="line"> [Leaf 1]    [Leaf 2]    [Leaf 3]    [Leaf 4]</span><br><span class="line">   /  \       /  \       /  \       /  \</span><br><span class="line">[服务器集群] [服务器集群] [服务器集群] [服务器集群]</span><br></pre></td></tr></table></figure>

<h3 id="3-2-需求分析"><a href="#3-2-需求分析" class="headerlink" title="3.2 需求分析"></a>3.2 需求分析</h3><ul>
<li>高带宽、低延迟</li>
<li>无阻塞转发</li>
<li>横向扩展能力</li>
<li>VXLAN  overlay 网络</li>
</ul>
<h3 id="3-3-Spine-交换机配置"><a href="#3-3-Spine-交换机配置" class="headerlink" title="3.3 Spine 交换机配置"></a>3.3 Spine 交换机配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Spine-1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础配置</span></span><br><span class="line">[Spine-1] vlan batch 100</span><br><span class="line">[Spine-1] interface Eth-Trunk 1</span><br><span class="line">[Spine-1-Eth-Trunk1] description To_Spine-2</span><br><span class="line">[Spine-1-Eth-Trunk1] port link-type trunk</span><br><span class="line">[Spine-1-Eth-Trunk1] port trunk allow-pass vlan 100</span><br><span class="line">[Spine-1-Eth-Trunk1] mode lacp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置与 Leaf 的互联</span></span><br><span class="line">[Spine-1] interface 100GE 1/0/1</span><br><span class="line">[Spine-1-100GE1/0/1] description To_Leaf-1</span><br><span class="line">[Spine-1-100GE1/0/1] port link-type trunk</span><br><span class="line">[Spine-1-100GE1/0/1] port trunk allow-pass vlan 100</span><br><span class="line"></span><br><span class="line">[Spine-1] interface 100GE 1/0/2</span><br><span class="line">[Spine-1-100GE1/0/2] description To_Leaf-2</span><br><span class="line">[Spine-1-100GE1/0/2] port link-type trunk</span><br><span class="line">[Spine-1-100GE1/0/2] port trunk allow-pass vlan 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 OSPF（Underlay）</span></span><br><span class="line">[Spine-1] ospf 1 router-id 1.1.1.1</span><br><span class="line">[Spine-1-ospf-1] area 0</span><br><span class="line">[Spine-1-ospf-1-area-0.0.0.0] network 10.0.0.0 0.255.255.255</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 BGP（Overlay）</span></span><br><span class="line">[Spine-1] bgp 65001</span><br><span class="line">[Spine-1-bgp] router-id 1.1.1.1</span><br><span class="line">[Spine-1-bgp] peer 10.0.0.2 as-number 65001</span><br><span class="line">[Spine-1-bgp] peer 10.0.0.4 as-number 65001</span><br><span class="line">[Spine-1-bgp] peer 10.0.0.6 as-number 65001</span><br><span class="line">[Spine-1-bgp] peer 10.0.0.8 as-number 65001</span><br><span class="line">[Spine-1-bgp] ipv4-family unicast</span><br><span class="line">[Spine-1-bgp-af-ipv4] peer 10.0.0.2 <span class="built_in">enable</span></span><br><span class="line">[Spine-1-bgp-af-ipv4] peer 10.0.0.4 <span class="built_in">enable</span></span><br><span class="line">[Spine-1-bgp-af-ipv4] peer 10.0.0.6 <span class="built_in">enable</span></span><br><span class="line">[Spine-1-bgp-af-ipv4] peer 10.0.0.8 <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line">&lt;Spine-1&gt; save</span><br></pre></td></tr></table></figure>

<h3 id="3-4-Leaf-交换机配置（VXLAN）"><a href="#3-4-Leaf-交换机配置（VXLAN）" class="headerlink" title="3.4 Leaf 交换机配置（VXLAN）"></a>3.4 Leaf 交换机配置（VXLAN）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Leaf-1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用 VXLAN</span></span><br><span class="line">[Leaf-1] vxlan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 VNI</span></span><br><span class="line">[Leaf-1] vxlan 10</span><br><span class="line">[Leaf-1-vxlan-10] vni 5010</span><br><span class="line">[Leaf-1-vxlan-10] quit</span><br><span class="line"></span><br><span class="line">[Leaf-1] vxlan 20</span><br><span class="line">[Leaf-1-vxlan-20] vni 5020</span><br><span class="line">[Leaf-1-vxlan-20] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 VBDIF 接口</span></span><br><span class="line">[Leaf-1] interface Vbdif 10</span><br><span class="line">[Leaf-1-Vbdif10] ip address 192.168.10.1 255.255.255.0</span><br><span class="line">[Leaf-1-Vbdif10] arp collect host <span class="built_in">enable</span></span><br><span class="line">[Leaf-1-Vbdif10] quit</span><br><span class="line"></span><br><span class="line">[Leaf-1] interface Vbdif 20</span><br><span class="line">[Leaf-1-Vbdif20] ip address 192.168.20.1 255.255.255.0</span><br><span class="line">[Leaf-1-Vbdif20] arp collect host <span class="built_in">enable</span></span><br><span class="line">[Leaf-1-Vbdif20] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 VXLAN 隧道</span></span><br><span class="line">[Leaf-1] interface Nve 1</span><br><span class="line">[Leaf-1-Nve1] <span class="built_in">source</span> 10.0.0.1</span><br><span class="line">[Leaf-1-Nve1] vni 5010 head-end peer-list 10.0.0.2</span><br><span class="line">[Leaf-1-Nve1] vni 5020 head-end peer-list 10.0.0.2</span><br><span class="line">[Leaf-1-Nve1] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置与服务器连接</span></span><br><span class="line">[Leaf-1] interface 10GE 1/0/1</span><br><span class="line">[Leaf-1-10GE1/0/1] port link-type access</span><br><span class="line">[Leaf-1-10GE1/0/1] port default vlan 10</span><br><span class="line">[Leaf-1-10GE1/0/1] quit</span><br><span class="line"></span><br><span class="line">[Leaf-1] interface 10GE 1/0/2</span><br><span class="line">[Leaf-1-10GE1/0/2] port link-type access</span><br><span class="line">[Leaf-1-10GE1/0/2] port default vlan 20</span><br><span class="line">[Leaf-1-10GE1/0/2] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置与 Spine 连接</span></span><br><span class="line">[Leaf-1] interface 100GE 1/0/49</span><br><span class="line">[Leaf-1-100GE1/0/49] port link-type trunk</span><br><span class="line">[Leaf-1-100GE1/0/49] port trunk allow-pass vlan 100</span><br><span class="line">[Leaf-1-100GE1/0/49] quit</span><br><span class="line"></span><br><span class="line">[Leaf-1] interface 100GE 1/0/50</span><br><span class="line">[Leaf-1-100GE1/0/50] port link-type trunk</span><br><span class="line">[Leaf-1-100GE1/0/50] port trunk allow-pass vlan 100</span><br><span class="line">[Leaf-1-100GE1/0/50] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 OSPF</span></span><br><span class="line">[Leaf-1] ospf 1 router-id 10.0.0.1</span><br><span class="line">[Leaf-1-ospf-1] area 0</span><br><span class="line">[Leaf-1-ospf-1-area-0.0.0.0] network 10.0.0.0 0.255.255.255</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 BGP EVPN</span></span><br><span class="line">[Leaf-1] bgp 65001</span><br><span class="line">[Leaf-1-bgp] router-id 10.0.0.1</span><br><span class="line">[Leaf-1-bgp] peer 10.0.0.100 as-number 65001</span><br><span class="line">[Leaf-1-bgp] ipv4-family unicast</span><br><span class="line">[Leaf-1-bgp-af-ipv4] peer 10.0.0.100 <span class="built_in">enable</span></span><br><span class="line">[Leaf-1-bgp] l2vpn-family evpn</span><br><span class="line">[Leaf-1-bgp-af-evpn] peer 10.0.0.100 <span class="built_in">enable</span></span><br><span class="line">[Leaf-1-bgp-af-evpn] peer 10.0.0.100 advertise-all-vni</span><br><span class="line"></span><br><span class="line">&lt;Leaf-1&gt; save</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-MSTP-VRRP-高可用组网"><a href="#4-MSTP-VRRP-高可用组网" class="headerlink" title="4. MSTP+VRRP 高可用组网"></a>4. MSTP+VRRP 高可用组网</h2><h3 id="4-1-组网拓扑"><a href="#4-1-组网拓扑" class="headerlink" title="4.1 组网拓扑"></a>4.1 组网拓扑</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  [核心交换机 A] &lt;====&gt; [核心交换机 B]</span><br><span class="line">       ||                     ||</span><br><span class="line">       ||                     ||</span><br><span class="line">  [汇聚交换机 A] &lt;====&gt; [汇聚交换机 B]</span><br><span class="line">      /   \                 /   \</span><br><span class="line">     /     \               /     \</span><br><span class="line">[接入 A1] [接入 A2]   [接入 B1] [接入 B2]</span><br></pre></td></tr></table></figure>

<h3 id="4-2-配置要点"><a href="#4-2-配置要点" class="headerlink" title="4.2 配置要点"></a>4.2 配置要点</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 核心交换机 A - MSTP 配置</span></span><br><span class="line">[Core-A] stp mode mstp</span><br><span class="line">[Core-A] stp region-configuration</span><br><span class="line">[Core-A-mst-region] region-name DC</span><br><span class="line">[Core-A-mst-region] instance 1 vlan 10 30</span><br><span class="line">[Core-A-mst-region] instance 2 vlan 20 40</span><br><span class="line">[Core-A-mst-region] active region-configuration</span><br><span class="line"></span><br><span class="line"><span class="comment"># 核心交换机 A 为实例 1 的主根，实例 2 的备根</span></span><br><span class="line">[Core-A] stp instance 1 priority 0</span><br><span class="line">[Core-A] stp instance 2 priority 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># 核心交换机 A - VRRP 配置</span></span><br><span class="line">[Core-A] interface Vlanif 10</span><br><span class="line">[Core-A-Vlanif10] ip address 192.168.10.2 24</span><br><span class="line">[Core-A-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.1</span><br><span class="line">[Core-A-Vlanif10] vrrp vrid 1 priority 120</span><br><span class="line">[Core-A-Vlanif10] vrrp vrid 1 preempt-mode timer delay 20</span><br><span class="line"></span><br><span class="line">[Core-A] interface Vlanif 20</span><br><span class="line">[Core-A-Vlanif20] ip address 192.168.20.2 24</span><br><span class="line">[Core-A-Vlanif20] vrrp vrid 2 virtual-ip 192.168.20.1</span><br><span class="line">[Core-A-Vlanif20] vrrp vrid 2 priority 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 核心交换机 B - MSTP 配置</span></span><br><span class="line">[Core-B] stp mode mstp</span><br><span class="line">[Core-B] stp region-configuration</span><br><span class="line">[Core-B-mst-region] region-name DC</span><br><span class="line">[Core-B-mst-region] instance 1 vlan 10 30</span><br><span class="line">[Core-B-mst-region] instance 2 vlan 20 40</span><br><span class="line">[Core-B-mst-region] active region-configuration</span><br><span class="line"></span><br><span class="line"><span class="comment"># 核心交换机 B 为实例 2 的主根，实例 1 的备根</span></span><br><span class="line">[Core-B] stp instance 1 priority 4096</span><br><span class="line">[Core-B] stp instance 2 priority 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 核心交换机 B - VRRP 配置</span></span><br><span class="line">[Core-B] interface Vlanif 10</span><br><span class="line">[Core-B-Vlanif10] ip address 192.168.10.3 24</span><br><span class="line">[Core-B-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.1</span><br><span class="line">[Core-B-Vlanif10] vrrp vrid 1 priority 100</span><br><span class="line"></span><br><span class="line">[Core-B] interface Vlanif 20</span><br><span class="line">[Core-B-Vlanif20] ip address 192.168.20.3 24</span><br><span class="line">[Core-B-Vlanif20] vrrp vrid 2 virtual-ip 192.168.20.1</span><br><span class="line">[Core-B-Vlanif20] vrrp vrid 2 priority 120</span><br><span class="line">[Core-B-Vlanif20] vrrp vrid 2 preempt-mode timer delay 20</span><br></pre></td></tr></table></figure>

<h3 id="4-3-配置验证"><a href="#4-3-配置验证" class="headerlink" title="4.3 配置验证"></a>4.3 配置验证</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 验证 MSTP</span></span><br><span class="line">display stp brief</span><br><span class="line">display stp instance 1</span><br><span class="line">display stp instance 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证 VRRP</span></span><br><span class="line">display vrrp brief</span><br><span class="line">display vrrp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预期结果：</span></span><br><span class="line"><span class="comment"># - VLAN10/30: Core-A 为 Master，Core-B 为 Backup</span></span><br><span class="line"><span class="comment"># - VLAN20/40: Core-B 为 Master，Core-A 为 Backup</span></span><br><span class="line"><span class="comment"># - 流量负载分担在两条路径上</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-堆叠组网配置"><a href="#5-堆叠组网配置" class="headerlink" title="5. 堆叠组网配置"></a>5. 堆叠组网配置</h2><h3 id="5-1-组网拓扑"><a href="#5-1-组网拓扑" class="headerlink" title="5.1 组网拓扑"></a>5.1 组网拓扑</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[堆叠交换机 1] &lt;==== 堆叠电缆 ====&gt; [堆叠交换机 2]</span><br><span class="line">     /    \                          /    \</span><br><span class="line">    /      \                        /      \</span><br><span class="line">[服务器]  [服务器]              [服务器]  [服务器]</span><br></pre></td></tr></table></figure>

<h3 id="5-2-堆叠配置（以-S5700-为例）"><a href="#5-2-堆叠配置（以-S5700-为例）" class="headerlink" title="5.2 堆叠配置（以 S5700 为例）"></a>5.2 堆叠配置（以 S5700 为例）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 交换机 1 配置（主交换机）</span></span><br><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Stack-Member1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置堆叠 ID 和优先级</span></span><br><span class="line">[Stack-Member1] stack</span><br><span class="line">[Stack-Member1-stack] stack member 1 priority 150</span><br><span class="line">[Stack-Member1-stack] stack member 1 renumber 1</span><br><span class="line">[Stack-Member1-stack] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置堆叠端口</span></span><br><span class="line">[Stack-Member1] interface 10GE 1/0/25</span><br><span class="line">[Stack-Member1-10GE1/0/25] stack port 1</span><br><span class="line">[Stack-Member1] interface 10GE 1/0/26</span><br><span class="line">[Stack-Member1-10GE1/0/26] stack port 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存并重启</span></span><br><span class="line">&lt;Stack-Member1&gt; save</span><br><span class="line">&lt;Stack-Member1&gt; reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 交换机 2 配置（备交换机）</span></span><br><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Stack-Member2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置堆叠 ID 和优先级</span></span><br><span class="line">[Stack-Member2] stack</span><br><span class="line">[Stack-Member2-stack] stack member 1 priority 100</span><br><span class="line">[Stack-Member2-stack] stack member 1 renumber 2</span><br><span class="line">[Stack-Member2-stack] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置堆叠端口</span></span><br><span class="line">[Stack-Member2] interface 10GE 1/0/25</span><br><span class="line">[Stack-Member2-10GE1/0/25] stack port 1</span><br><span class="line">[Stack-Member2] interface 10GE 1/0/26</span><br><span class="line">[Stack-Member2-10GE1/0/26] stack port 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存并重启</span></span><br><span class="line">&lt;Stack-Member2&gt; save</span><br><span class="line">&lt;Stack-Member2&gt; reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用堆叠电缆连接两台交换机的堆叠端口</span></span><br><span class="line"><span class="comment"># 先启动主交换机，再启动备交换机</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-堆叠验证"><a href="#5-3-堆叠验证" class="headerlink" title="5.3 堆叠验证"></a>5.3 堆叠验证</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看堆叠状态</span></span><br><span class="line">&lt;Stack&gt; display stack</span><br><span class="line">&lt;Stack&gt; display stack topology</span><br><span class="line">&lt;Stack&gt; display stack configuration</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看成员交换机</span></span><br><span class="line">&lt;Stack&gt; display device</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预期输出：</span></span><br><span class="line"><span class="comment"># Slot  Sub  Type         Online    Register      Status</span></span><br><span class="line"><span class="comment"># 1     1    S5720-28X    Present   Registered    Master</span></span><br><span class="line"><span class="comment"># 2     2    S5720-28X    Present   Registered    Standby</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-堆叠分裂检测（MAD）"><a href="#5-4-堆叠分裂检测（MAD）" class="headerlink" title="5.4 堆叠分裂检测（MAD）"></a>5.4 堆叠分裂检测（MAD）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置直连检测</span></span><br><span class="line">[Stack] mad <span class="built_in">enable</span></span><br><span class="line">[Stack] interface Eth-Trunk 10</span><br><span class="line">[Stack-Eth-Trunk10] mad detect mode direct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置代理检测</span></span><br><span class="line">[Stack] interface GigabitEthernet 1/0/1</span><br><span class="line">[Stack-GigabitEthernet1/0/1] mad detect mode agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 MAD 状态</span></span><br><span class="line">&lt;Stack&gt; display mad</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-无线-AC-AP-组网"><a href="#6-无线-AC-AP-组网" class="headerlink" title="6. 无线 AC+AP 组网"></a>6. 无线 AC+AP 组网</h2><h3 id="6-1-组网拓扑"><a href="#6-1-组网拓扑" class="headerlink" title="6.1 组网拓扑"></a>6.1 组网拓扑</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">     [核心交换机]</span><br><span class="line">          |</span><br><span class="line">     [AC 控制器]</span><br><span class="line">          |</span><br><span class="line">     [PoE 交换机]</span><br><span class="line">     /    |    \</span><br><span class="line">    /     |     \</span><br><span class="line">[AP1]   [AP2]   [AP3]</span><br></pre></td></tr></table></figure>

<h3 id="6-2-核心交换机配置"><a href="#6-2-核心交换机配置" class="headerlink" title="6.2 核心交换机配置"></a>6.2 核心交换机配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname Core-SW</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 VLAN</span></span><br><span class="line">[Core-SW] vlan batch 10 100 200</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置管理 VLAN</span></span><br><span class="line">[Core-SW] interface Vlanif 100</span><br><span class="line">[Core-SW-Vlanif100] ip address 192.168.100.1 255.255.255.0</span><br><span class="line">[Core-SW-Vlanif100] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置业务 VLAN</span></span><br><span class="line">[Core-SW] interface Vlanif 200</span><br><span class="line">[Core-SW-Vlanif200] ip address 192.168.200.1 255.255.255.0</span><br><span class="line">[Core-SW-Vlanif200] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 DHCP</span></span><br><span class="line">[Core-SW] dhcp <span class="built_in">enable</span></span><br><span class="line">[Core-SW] ip pool ap-management</span><br><span class="line">[Core-SW-ip-pool-ap-management] network 192.168.100.0 mask 255.255.255.0</span><br><span class="line">[Core-SW-ip-pool-ap-management] gateway-list 192.168.100.1</span><br><span class="line">[Core-SW-ip-pool-ap-management] option 43 sub-option 3 ascii 192.168.100.254</span><br><span class="line">[Core-SW-ip-pool-ap-management] quit</span><br><span class="line"></span><br><span class="line">[Core-SW] ip pool station</span><br><span class="line">[Core-SW-ip-pool-station] network 192.168.200.0 mask 255.255.255.0</span><br><span class="line">[Core-SW-ip-pool-station] gateway-list 192.168.200.1</span><br><span class="line">[Core-SW-ip-pool-station] dns-list 114.114.114.114</span><br><span class="line">[Core-SW-ip-pool-station] quit</span><br><span class="line"></span><br><span class="line">[Core-SW] interface Vlanif 100</span><br><span class="line">[Core-SW-Vlanif100] dhcp <span class="keyword">select</span> global</span><br><span class="line">[Core-SW-Vlanif100] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置连接 AC 的接口</span></span><br><span class="line">[Core-SW] interface GigabitEthernet 0/0/24</span><br><span class="line">[Core-SW-GigabitEthernet0/0/24] port link-type trunk</span><br><span class="line">[Core-SW-GigabitEthernet0/0/24] port trunk allow-pass vlan 100 200</span><br><span class="line">[Core-SW-GigabitEthernet0/0/24] port trunk pvid vlan 100</span><br></pre></td></tr></table></figure>

<h3 id="6-3-AC-控制器配置"><a href="#6-3-AC-控制器配置" class="headerlink" title="6.3 AC 控制器配置"></a>6.3 AC 控制器配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname AC</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 WLAN 基本参数</span></span><br><span class="line">[AC] wlan</span><br><span class="line">[AC-wlan-view] ap auth-mode no-auth  <span class="comment"># 或 mac-auth / sn-auth</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 AP 组</span></span><br><span class="line">[AC-wlan-view] ap-group name default</span><br><span class="line">[AC-wlan-ap-group-default] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置射频模板</span></span><br><span class="line">[AC-wlan-view] radio-2g-profile name default</span><br><span class="line">[AC-wlan-radio-2g-prof-default] channel 20mhz</span><br><span class="line">[AC-wlan-radio-2g-prof-default] eirp 27</span><br><span class="line">[AC-wlan-radio-2g-prof-default] quit</span><br><span class="line"></span><br><span class="line">[AC-wlan-view] radio-5g-profile name default</span><br><span class="line">[AC-wlan-radio-5g-prof-default] channel 80mhz</span><br><span class="line">[AC-wlan-radio-5g-prof-default] eirp 30</span><br><span class="line">[AC-wlan-radio-5g-prof-default] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 VAP 模板</span></span><br><span class="line">[AC-wlan-view] vap-profile name default</span><br><span class="line">[AC-wlan-vap-prof-default] forward-mode tunnel</span><br><span class="line">[AC-wlan-vap-prof-default] service-vlan vlan 200</span><br><span class="line">[AC-wlan-vap-prof-default] ssid-profile name default</span><br><span class="line">[AC-wlan-vap-prof-default] security-profile name default</span><br><span class="line">[AC-wlan-vap-prof-default] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 SSID 模板</span></span><br><span class="line">[AC-wlan-view] ssid-profile name default</span><br><span class="line">[AC-wlan-ssid-prof-default] ssid Huawei-WLAN</span><br><span class="line">[AC-wlan-ssid-prof-default] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置安全模板</span></span><br><span class="line">[AC-wlan-view] security-profile name default</span><br><span class="line">[AC-wlan-sec-prof-default] security wpa2 psk pass-phrase Huawei@123 aes</span><br><span class="line">[AC-wlan-sec-prof-default] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将配置应用到 AP 组</span></span><br><span class="line">[AC-wlan-view] ap-group name default</span><br><span class="line">[AC-wlan-ap-group-default] radio 0</span><br><span class="line">[AC-wlan-ap-group-default-radio-0] vap-profile default wlan 1</span><br><span class="line">[AC-wlan-ap-group-default-radio-0] radio-2g-profile default</span><br><span class="line">[AC-wlan-ap-group-default-radio-0] quit</span><br><span class="line">[AC-wlan-ap-group-default] radio 1</span><br><span class="line">[AC-wlan-ap-group-default-radio-1] vap-profile default wlan 1</span><br><span class="line">[AC-wlan-ap-group-default-radio-1] radio-5g-profile default</span><br><span class="line">[AC-wlan-ap-group-default-radio-1] quit</span><br><span class="line">[AC-wlan-ap-group-default] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 AP 状态</span></span><br><span class="line">[AC] display ap all</span><br><span class="line">[AC] display station all</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-QinQ-组网配置"><a href="#7-QinQ-组网配置" class="headerlink" title="7. QinQ 组网配置"></a>7. QinQ 组网配置</h2><h3 id="7-1-组网拓扑"><a href="#7-1-组网拓扑" class="headerlink" title="7.1 组网拓扑"></a>7.1 组网拓扑</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[用户 Site A]                    [用户 Site B]</span><br><span class="line">     |                                |</span><br><span class="line">[CE-A]                            [CE-B]</span><br><span class="line">     |                                |</span><br><span class="line">[PE-A] ======= 运营商网络 ======= [PE-B]</span><br></pre></td></tr></table></figure>

<h3 id="7-2-PE-交换机配置"><a href="#7-2-PE-交换机配置" class="headerlink" title="7.2 PE 交换机配置"></a>7.2 PE 交换机配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname PE-A</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 VLAN</span></span><br><span class="line">[PE-A] vlan batch 10 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置连接用户的接口（添加外层 VLAN）</span></span><br><span class="line">[PE-A] interface GigabitEthernet 0/0/1</span><br><span class="line">[PE-A-GigabitEthernet0/0/1] description To_CE-A</span><br><span class="line">[PE-A-GigabitEthernet0/0/1] port link-type hybrid</span><br><span class="line">[PE-A-GigabitEthernet0/0/1] port hybrid tagged vlan 100</span><br><span class="line">[PE-A-GigabitEthernet0/0/1] qinq vlan-translation <span class="built_in">enable</span></span><br><span class="line">[PE-A-GigabitEthernet0/0/1] port vlan-stacking vlan 10 stack-vlan 100</span><br><span class="line">[PE-A-GigabitEthernet0/0/1] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置连接运营商网络的接口</span></span><br><span class="line">[PE-A] interface GigabitEthernet 0/0/24</span><br><span class="line">[PE-A-GigabitEthernet0/0/24] description To_P-Network</span><br><span class="line">[PE-A-GigabitEthernet0/0/24] port link-type trunk</span><br><span class="line">[PE-A-GigabitEthernet0/0/24] port trunk allow-pass vlan 100</span><br><span class="line">[PE-A-GigabitEthernet0/0/24] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 QinQ 配置</span></span><br><span class="line">[PE-A] display qinq vlan-translation</span><br><span class="line">[PE-A] display port vlan-stacking</span><br></pre></td></tr></table></figure>

<h3 id="7-3-灵活-QinQ-配置"><a href="#7-3-灵活-QinQ-配置" class="headerlink" title="7.3 灵活 QinQ 配置"></a>7.3 灵活 QinQ 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基于内层 VLAN ID 添加不同外层 VLAN</span></span><br><span class="line">[PE-A] interface GigabitEthernet 0/0/1</span><br><span class="line">[PE-A-GigabitEthernet0/0/1] port vlan-stacking vlan 10 to 20 stack-vlan 100</span><br><span class="line">[PE-A-GigabitEthernet0/0/1] port vlan-stacking vlan 30 to 40 stack-vlan 200</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于 802.1p 优先级添加外层 VLAN</span></span><br><span class="line">[PE-A] interface GigabitEthernet 0/0/1</span><br><span class="line">[PE-A-GigabitEthernet0/0/1] port vlan-stacking 8021p 5 stack-vlan 100</span><br><span class="line">[PE-A-GigabitEthernet0/0/1] port vlan-stacking 8021p 6 stack-vlan 200</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用设备</strong>: 华为 S5700&#x2F;S6700&#x2F;S7700&#x2F;S9700&#x2F;CE 系列交换机</p>
]]></content>
      <categories>
        <category>硬件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>华为交换机故障排查分析案例</title>
    <url>/2026/02/28/13-%E5%8D%8E%E4%B8%BA%E4%BA%A4%E6%8D%A2%E6%9C%BA%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E5%88%86%E6%9E%90%E6%A1%88%E4%BE%8B/</url>
    <content><![CDATA[<h1 id="华为交换机故障排查分析案例"><a href="#华为交换机故障排查分析案例" class="headerlink" title="华为交换机故障排查分析案例"></a>华为交换机故障排查分析案例</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-%E7%BD%91%E7%BB%9C%E8%BF%9E%E9%80%9A%E6%80%A7%E6%95%85%E9%9A%9C">网络连通性故障</a></li>
<li><a href="#2-vlan-%E6%95%85%E9%9A%9C">VLAN 故障</a></li>
<li><a href="#3-%E7%94%9F%E6%88%90%E6%A0%91%E6%95%85%E9%9A%9C">生成树故障</a></li>
<li><a href="#4-%E9%93%BE%E8%B7%AF%E8%81%9A%E5%90%88%E6%95%85%E9%9A%9C">链路聚合故障</a></li>
<li><a href="#5-%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE%E6%95%85%E9%9A%9C">路由协议故障</a></li>
<li><a href="#6-dhcp-%E6%95%85%E9%9A%9C">DHCP 故障</a></li>
<li><a href="#7-%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%E6%95%85%E9%9A%9C">安全特性故障</a></li>
<li><a href="#8-%E6%80%A7%E8%83%BD%E6%95%85%E9%9A%9C">性能故障</a></li>
<li><a href="#9-%E7%A1%AC%E4%BB%B6%E6%95%85%E9%9A%9C">硬件故障</a></li>
<li><a href="#10-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95%E8%AE%BA">故障排查方法论</a></li>
</ol>
<hr>
<h2 id="1-网络连通性故障"><a href="#1-网络连通性故障" class="headerlink" title="1. 网络连通性故障"></a>1. 网络连通性故障</h2><h3 id="1-1-故障现象"><a href="#1-1-故障现象" class="headerlink" title="1.1 故障现象"></a>1.1 故障现象</h3><ul>
<li>PC 无法访问网络</li>
<li>Ping 不通网关</li>
<li>部分 VLAN 无法通信</li>
</ul>
<h3 id="1-2-排查步骤"><a href="#1-2-排查步骤" class="headerlink" title="1.2 排查步骤"></a>1.2 排查步骤</h3><h4 id="步骤-1：检查物理连接"><a href="#步骤-1：检查物理连接" class="headerlink" title="步骤 1：检查物理连接"></a>步骤 1：检查物理连接</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看接口状态</span></span><br><span class="line">&lt;SW1&gt; display interface GigabitEthernet 0/0/1</span><br><span class="line"><span class="comment"># 检查项：</span></span><br><span class="line"><span class="comment"># - Current state: UP/DOWN</span></span><br><span class="line"><span class="comment"># - Line protocol current state: UP/DOWN</span></span><br><span class="line"><span class="comment"># - Input/Output errors</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量查看接口状态</span></span><br><span class="line">&lt;SW1&gt; display interface brief</span><br><span class="line"><span class="comment"># 快速定位 DOWN 的接口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看接口统计</span></span><br><span class="line">&lt;SW1&gt; display interface GigabitEthernet 0/0/1 | include error|discard</span><br></pre></td></tr></table></figure>

<h4 id="步骤-2：检查-VLAN-配置"><a href="#步骤-2：检查-VLAN-配置" class="headerlink" title="步骤 2：检查 VLAN 配置"></a>步骤 2：检查 VLAN 配置</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 VLAN 信息</span></span><br><span class="line">&lt;SW1&gt; display vlan</span><br><span class="line">&lt;SW1&gt; display vlan 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看接口 VLAN 配置</span></span><br><span class="line">&lt;SW1&gt; display port vlan GigabitEthernet 0/0/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 MAC 地址表</span></span><br><span class="line">&lt;SW1&gt; display mac-address</span><br><span class="line">&lt;SW1&gt; display mac-address vlan 10</span><br><span class="line">&lt;SW1&gt; display mac-address interface GigabitEthernet 0/0/1</span><br></pre></td></tr></table></figure>

<h4 id="步骤-3：检查-IP-配置"><a href="#步骤-3：检查-IP-配置" class="headerlink" title="步骤 3：检查 IP 配置"></a>步骤 3：检查 IP 配置</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 VLANIF 接口</span></span><br><span class="line">&lt;SW1&gt; display ip interface brief</span><br><span class="line">&lt;SW1&gt; display interface Vlanif 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 ARP 表</span></span><br><span class="line">&lt;SW1&gt; display arp</span><br><span class="line">&lt;SW1&gt; display arp vlan 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试连通性</span></span><br><span class="line">&lt;SW1&gt; ping 192.168.10.1</span><br><span class="line">&lt;SW1&gt; ping -a 192.168.10.1 192.168.20.1  <span class="comment"># 指定源地址</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-典型案例"><a href="#1-3-典型案例" class="headerlink" title="1.3 典型案例"></a>1.3 典型案例</h3><h4 id="案例-1：Access-端口-VLAN-配置错误"><a href="#案例-1：Access-端口-VLAN-配置错误" class="headerlink" title="案例 1：Access 端口 VLAN 配置错误"></a>案例 1：Access 端口 VLAN 配置错误</h4><p><strong>现象</strong>: PC 无法获取 IP，无法上网</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display current-configuration interface GigabitEthernet 0/0/1</span><br><span class="line"><span class="comment"># 发现配置：</span></span><br><span class="line"><span class="comment"># port link-type trunk</span></span><br><span class="line"><span class="comment"># port trunk allow-pass vlan 10</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display port vlan GigabitEthernet 0/0/1</span><br><span class="line"><span class="comment"># Port link-type: trunk</span></span><br><span class="line"><span class="comment"># PVID: 1</span></span><br><span class="line"><span class="comment"># Trunk VLAN pass: 10</span></span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>: Access 设备连接了 Trunk 端口，且 PVID 不匹配</p>
<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; system-view</span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] port link-type access</span><br><span class="line">[SW1-GigabitEthernet0/0/1] port default vlan 10</span><br></pre></td></tr></table></figure>

<h4 id="案例-2：VLANIF-接口-DOWN"><a href="#案例-2：VLANIF-接口-DOWN" class="headerlink" title="案例 2：VLANIF 接口 DOWN"></a>案例 2：VLANIF 接口 DOWN</h4><p><strong>现象</strong>: 同 VLAN 内可以通信，无法跨 VLAN 通信</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display ip interface brief</span><br><span class="line"><span class="comment"># Vlanif10    192.168.10.1/24    DOWN</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display interface Vlanif 10</span><br><span class="line"><span class="comment"># Current state: DOWN</span></span><br><span class="line"><span class="comment"># Line protocol current state: DOWN</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display vlan 10</span><br><span class="line"><span class="comment"># VLAN 10 没有活动的物理端口</span></span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>: VLAN 10 没有 UP 的物理端口，VLANIF 自动 DOWN</p>
<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法 1：确保 VLAN 内有 UP 的物理端口</span></span><br><span class="line"><span class="comment"># 方法 2：配置 VLANIF 强制 UP（某些版本支持）</span></span><br><span class="line">[SW1] interface Vlanif 10</span><br><span class="line">[SW1-Vlanif10] undo shutdown</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-VLAN-故障"><a href="#2-VLAN-故障" class="headerlink" title="2. VLAN 故障"></a>2. VLAN 故障</h2><h3 id="2-1-故障现象"><a href="#2-1-故障现象" class="headerlink" title="2.1 故障现象"></a>2.1 故障现象</h3><ul>
<li>VLAN 间无法通信</li>
<li>部分端口无法加入 VLAN</li>
<li>VLAN 配置不生效</li>
</ul>
<h3 id="2-2-排查命令"><a href="#2-2-排查命令" class="headerlink" title="2.2 排查命令"></a>2.2 排查命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 VLAN 配置</span></span><br><span class="line">display vlan</span><br><span class="line">display vlan summary</span><br><span class="line">display vlan 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看接口 VLAN 成员</span></span><br><span class="line">display port vlan</span><br><span class="line">display port vlan interface GigabitEthernet 0/0/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 VLAN MAC 地址</span></span><br><span class="line">display mac-address vlan 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 VLAN 路由</span></span><br><span class="line">display ip routing-table vlan 10</span><br></pre></td></tr></table></figure>

<h3 id="2-3-典型案例"><a href="#2-3-典型案例" class="headerlink" title="2.3 典型案例"></a>2.3 典型案例</h3><h4 id="案例-1：Trunk-端口未放行-VLAN"><a href="#案例-1：Trunk-端口未放行-VLAN" class="headerlink" title="案例 1：Trunk 端口未放行 VLAN"></a>案例 1：Trunk 端口未放行 VLAN</h4><p><strong>现象</strong>: 跨交换机同 VLAN 无法通信</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># SW1 配置</span></span><br><span class="line">&lt;SW1&gt; display interface GigabitEthernet 0/0/24</span><br><span class="line"><span class="comment"># Port link-type: trunk</span></span><br><span class="line"><span class="comment"># Trunk VLAN pass: 10 20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SW2 配置</span></span><br><span class="line">&lt;SW2&gt; display interface GigabitEthernet 0/0/24</span><br><span class="line"><span class="comment"># Port link-type: trunk</span></span><br><span class="line"><span class="comment"># Trunk VLAN pass: 10</span></span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>: SW2 的 Trunk 端口未放行 VLAN 20</p>
<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[SW2] interface GigabitEthernet 0/0/24</span><br><span class="line">[SW2-GigabitEthernet0/0/24] port trunk allow-pass vlan 10 20</span><br></pre></td></tr></table></figure>

<h4 id="案例-2：VLAN-接口-IP-配置错误"><a href="#案例-2：VLAN-接口-IP-配置错误" class="headerlink" title="案例 2：VLAN 接口 IP 配置错误"></a>案例 2：VLAN 接口 IP 配置错误</h4><p><strong>现象</strong>: VLAN 间路由不通</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display ip interface brief</span><br><span class="line"><span class="comment"># Vlanif10    192.168.10.1/24    UP</span></span><br><span class="line"><span class="comment"># Vlanif20    192.168.20.1/24    UP</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display current-configuration | include ip routing</span><br><span class="line"><span class="comment"># 没有 ip routing 配置</span></span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>: 未启用 IP 路由功能</p>
<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[SW1] ip routing</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-生成树故障"><a href="#3-生成树故障" class="headerlink" title="3. 生成树故障"></a>3. 生成树故障</h2><h3 id="3-1-故障现象"><a href="#3-1-故障现象" class="headerlink" title="3.1 故障现象"></a>3.1 故障现象</h3><ul>
<li>网络环路</li>
<li>部分端口被阻塞</li>
<li>网络收敛慢</li>
</ul>
<h3 id="3-2-排查命令"><a href="#3-2-排查命令" class="headerlink" title="3.2 排查命令"></a>3.2 排查命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 STP 状态</span></span><br><span class="line">display stp</span><br><span class="line">display stp brief</span><br><span class="line">display stp interface GigabitEthernet 0/0/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 MSTP</span></span><br><span class="line">display stp region-configuration</span><br><span class="line">display stp instance 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 STP 统计</span></span><br><span class="line">display stp statistics</span><br><span class="line">display stp tc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 BPDU 信息</span></span><br><span class="line">debugging stp bpdu</span><br></pre></td></tr></table></figure>

<h3 id="3-3-典型案例"><a href="#3-3-典型案例" class="headerlink" title="3.3 典型案例"></a>3.3 典型案例</h3><h4 id="案例-1：网络环路导致广播风暴"><a href="#案例-1：网络环路导致广播风暴" class="headerlink" title="案例 1：网络环路导致广播风暴"></a>案例 1：网络环路导致广播风暴</h4><p><strong>现象</strong>: 网络缓慢，CPU 利用率高，接口流量异常</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display cpu-usage</span><br><span class="line"><span class="comment"># CPU utilization: 95%</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display interface brief | include up</span><br><span class="line"><span class="comment"># 多个接口流量接近 100%</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display stp brief</span><br><span class="line"><span class="comment"># 发现多个端口处于 FORWARDING 状态，存在潜在环路</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 启用 STP</span></span><br><span class="line">[SW1] stp <span class="built_in">enable</span></span><br><span class="line">[SW1] stp mode rstp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 配置边缘端口</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] stp edged-port <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启用 BPDU 保护</span></span><br><span class="line">[SW1] stp bpdu-protection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 排查物理环路</span></span><br><span class="line"><span class="comment"># 检查是否有两根网线连接同一交换机</span></span><br></pre></td></tr></table></figure>

<h4 id="案例-2：根桥位置不当"><a href="#案例-2：根桥位置不当" class="headerlink" title="案例 2：根桥位置不当"></a>案例 2：根桥位置不当</h4><p><strong>现象</strong>: 次优路径，部分链路带宽浪费</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display stp brief</span><br><span class="line"><span class="comment"># 发现接入交换机成为了根桥</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display stp | include Root</span><br><span class="line"><span class="comment"># Root ID Priority: 32768</span></span><br><span class="line"><span class="comment"># 所有交换机优先级相同，比较 MAC 地址</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在核心交换机配置</span></span><br><span class="line">[Core-SW] stp priority 0</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">[Core-SW] stp root primary</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在汇聚交换机配置</span></span><br><span class="line">[Agg-SW] stp priority 4096</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">[Agg-SW] stp root secondary</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-链路聚合故障"><a href="#4-链路聚合故障" class="headerlink" title="4. 链路聚合故障"></a>4. 链路聚合故障</h2><h3 id="4-1-故障现象"><a href="#4-1-故障现象" class="headerlink" title="4.1 故障现象"></a>4.1 故障现象</h3><ul>
<li>Eth-Trunk 接口 DOWN</li>
<li>成员接口未加入成功</li>
<li>负载分担不均</li>
</ul>
<h3 id="4-2-排查命令"><a href="#4-2-排查命令" class="headerlink" title="4.2 排查命令"></a>4.2 排查命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 Eth-Trunk 状态</span></span><br><span class="line">display eth-trunk</span><br><span class="line">display eth-trunk 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 LACP 信息</span></span><br><span class="line">display lacp statistics eth-trunk 1</span><br><span class="line">display lacp peer eth-trunk 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看负载分担</span></span><br><span class="line">display load-balance</span><br><span class="line">display interface Eth-Trunk 1 | include rate</span><br></pre></td></tr></table></figure>

<h3 id="4-3-典型案例"><a href="#4-3-典型案例" class="headerlink" title="4.3 典型案例"></a>4.3 典型案例</h3><h4 id="案例-1：LACP-模式不匹配"><a href="#案例-1：LACP-模式不匹配" class="headerlink" title="案例 1：LACP 模式不匹配"></a>案例 1：LACP 模式不匹配</h4><p><strong>现象</strong>: Eth-Trunk 无法 UP</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display eth-trunk 1</span><br><span class="line"><span class="comment"># Eth-Trunk1&#x27;s state information is:</span></span><br><span class="line"><span class="comment"># Local:</span></span><br><span class="line"><span class="comment">#   Mode: LACP</span></span><br><span class="line"><span class="comment"># Peer:</span></span><br><span class="line"><span class="comment">#   Mode: - (无信息)</span></span><br><span class="line"></span><br><span class="line">&lt;SW2&gt; display eth-trunk 1</span><br><span class="line"><span class="comment"># Local:</span></span><br><span class="line"><span class="comment">#   Mode: Manual Load Balance</span></span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>: 两端模式不匹配（一端 LACP，一端手工）</p>
<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 统一配置为 LACP 模式</span></span><br><span class="line">[SW2] interface Eth-Trunk 1</span><br><span class="line">[SW2-Eth-Trunk1] mode lacp</span><br></pre></td></tr></table></figure>

<h4 id="案例-2：成员接口配置不一致"><a href="#案例-2：成员接口配置不一致" class="headerlink" title="案例 2：成员接口配置不一致"></a>案例 2：成员接口配置不一致</h4><p><strong>现象</strong>: 部分成员接口无法加入 Eth-Trunk</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display eth-trunk 1</span><br><span class="line"><span class="comment"># 发现部分成员接口状态为 UNSELECT</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display interface GigabitEthernet 0/0/2</span><br><span class="line"><span class="comment"># 发现该接口有独立配置</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 清除成员接口独立配置</span></span><br><span class="line">[SW1] clear configuration interface GigabitEthernet 0/0/2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加入 Eth-Trunk</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/2</span><br><span class="line">[SW1-GigabitEthernet0/0/2] eth-trunk 1</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-路由协议故障"><a href="#5-路由协议故障" class="headerlink" title="5. 路由协议故障"></a>5. 路由协议故障</h2><h3 id="5-1-故障现象"><a href="#5-1-故障现象" class="headerlink" title="5.1 故障现象"></a>5.1 故障现象</h3><ul>
<li>OSPF 邻居无法建立</li>
<li>路由学习不到</li>
<li>路由震荡</li>
</ul>
<h3 id="5-2-排查命令"><a href="#5-2-排查命令" class="headerlink" title="5.2 排查命令"></a>5.2 排查命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># OSPF 排查</span></span><br><span class="line">display ospf brief</span><br><span class="line">display ospf peer</span><br><span class="line">display ospf interface</span><br><span class="line">display ospf routing</span><br><span class="line">display ospf error</span><br><span class="line"></span><br><span class="line"><span class="comment"># 静态路由排查</span></span><br><span class="line">display ip routing-table</span><br><span class="line">display ip routing-table protocol static</span><br><span class="line">display ip routing-table protocol ospf</span><br><span class="line"></span><br><span class="line"><span class="comment"># BGP 排查</span></span><br><span class="line">display bgp peer</span><br><span class="line">display bgp routing-table</span><br></pre></td></tr></table></figure>

<h3 id="5-3-典型案例"><a href="#5-3-典型案例" class="headerlink" title="5.3 典型案例"></a>5.3 典型案例</h3><h4 id="案例-1：OSPF-邻居无法建立"><a href="#案例-1：OSPF-邻居无法建立" class="headerlink" title="案例 1：OSPF 邻居无法建立"></a>案例 1：OSPF 邻居无法建立</h4><p><strong>现象</strong>: OSPF 邻居状态停留在 INIT 或 2-WAY</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display ospf peer</span><br><span class="line"><span class="comment"># Neighbor brief information</span></span><br><span class="line"><span class="comment"># Area 0.0.0.0</span></span><br><span class="line"><span class="comment"># Router ID: 2.2.2.2    Address: 192.168.1.2    State: Init</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display ospf interface Vlanif 10</span><br><span class="line"><span class="comment"># 检查 Hello/Dead 间隔</span></span><br><span class="line"><span class="comment"># 检查认证配置</span></span><br></pre></td></tr></table></figure>

<p><strong>常见问题及解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 区域 ID 不匹配</span></span><br><span class="line">[SW1] ospf 1</span><br><span class="line">[SW1-ospf-1] area 0  <span class="comment"># 确保两端区域 ID 一致</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hello/Dead 间隔不匹配</span></span><br><span class="line">[SW1] interface Vlanif 10</span><br><span class="line">[SW1-Vlanif10] ospf timer hello 10</span><br><span class="line">[SW1-Vlanif10] ospf timer dead 40</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 认证不匹配</span></span><br><span class="line">[SW1-ospf-1-area-0.0.0.0] authentication-mode md5 1 cipher Huawei@123</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 网络类型不匹配</span></span><br><span class="line">[SW1-Vlanif10] ospf network-type broadcast</span><br></pre></td></tr></table></figure>

<h4 id="案例-2：路由震荡"><a href="#案例-2：路由震荡" class="headerlink" title="案例 2：路由震荡"></a>案例 2：路由震荡</h4><p><strong>现象</strong>: 路由频繁变化，网络不稳定</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display ospf statistics</span><br><span class="line"><span class="comment"># 发现大量 SPF 计算</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display logbuffer | include OSPF</span><br><span class="line"><span class="comment"># 查看 OSPF 日志</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 配置 SPF 延迟计算</span></span><br><span class="line">[SW1] ospf 1</span><br><span class="line">[SW1-ospf-1] spf-schedule-interval 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 配置接口开销</span></span><br><span class="line">[SW1] interface Vlanif 10</span><br><span class="line">[SW1-Vlanif10] ospf cost 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 配置路由聚合</span></span><br><span class="line">[SW1-ospf-1-area-0.0.0.0] abr-summary 192.168.0.0 255.255.0.0</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-DHCP-故障"><a href="#6-DHCP-故障" class="headerlink" title="6. DHCP 故障"></a>6. DHCP 故障</h2><h3 id="6-1-故障现象"><a href="#6-1-故障现象" class="headerlink" title="6.1 故障现象"></a>6.1 故障现象</h3><ul>
<li>客户端无法获取 IP</li>
<li>获取到错误网段 IP</li>
<li>IP 地址冲突</li>
</ul>
<h3 id="6-2-排查命令"><a href="#6-2-排查命令" class="headerlink" title="6.2 排查命令"></a>6.2 排查命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 DHCP 配置</span></span><br><span class="line">display dhcp server tree</span><br><span class="line">display dhcp server conflict</span><br><span class="line">display dhcp server free-ip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 DHCP 统计</span></span><br><span class="line">display dhcp server statistics</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 DHCP Snooping</span></span><br><span class="line">display dhcp snooping</span><br><span class="line">display dhcp snooping binding</span><br></pre></td></tr></table></figure>

<h3 id="6-3-典型案例"><a href="#6-3-典型案例" class="headerlink" title="6.3 典型案例"></a>6.3 典型案例</h3><h4 id="案例-1：DHCP-客户端无法获取-IP"><a href="#案例-1：DHCP-客户端无法获取-IP" class="headerlink" title="案例 1：DHCP 客户端无法获取 IP"></a>案例 1：DHCP 客户端无法获取 IP</h4><p><strong>现象</strong>: PC 获取到 169.254.x.x 地址</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display dhcp server statistics</span><br><span class="line"><span class="comment"># 发现没有 DHCP Discover 消息</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display current-configuration | include dhcp</span><br><span class="line"><span class="comment"># 检查 DHCP 是否启用</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 启用 DHCP</span></span><br><span class="line">[SW1] dhcp <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 配置 IP 池</span></span><br><span class="line">[SW1] ip pool vlan10</span><br><span class="line">[SW1-ip-pool-vlan10] network 192.168.10.0 mask 255.255.255.0</span><br><span class="line">[SW1-ip-pool-vlan10] gateway-list 192.168.10.1</span><br><span class="line">[SW1-ip-pool-vlan10] dns-list 114.114.114.114</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 接口启用 DHCP</span></span><br><span class="line">[SW1] interface Vlanif 10</span><br><span class="line">[SW1-Vlanif10] dhcp <span class="keyword">select</span> global</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 检查 DHCP Snooping 信任接口</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/24</span><br><span class="line">[SW1-GigabitEthernet0/0/24] dhcp snooping trusted</span><br></pre></td></tr></table></figure>

<h4 id="案例-2：DHCP-地址耗尽"><a href="#案例-2：DHCP-地址耗尽" class="headerlink" title="案例 2：DHCP 地址耗尽"></a>案例 2：DHCP 地址耗尽</h4><p><strong>现象</strong>: 新客户端无法获取 IP</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display dhcp server tree vlan 10</span><br><span class="line"><span class="comment"># 查看已分配地址</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display dhcp server free-ip</span><br><span class="line"><span class="comment"># 查看剩余地址</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 扩大地址池</span></span><br><span class="line">[SW1] ip pool vlan10</span><br><span class="line">[SW1-ip-pool-vlan10] network 192.168.10.0 mask 255.255.255.0</span><br><span class="line">[SW1-ip-pool-vlan10] gateway-list 192.168.10.1</span><br><span class="line">[SW1-ip-pool-vlan10] excluded-ip-address 192.168.10.1 192.168.10.10</span><br><span class="line">[SW1-ip-pool-vlan10] lease day 1  <span class="comment"># 缩短租期</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 清理过期租约</span></span><br><span class="line">&lt;SW1&gt; reset dhcp server tree all</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-安全特性故障"><a href="#7-安全特性故障" class="headerlink" title="7. 安全特性故障"></a>7. 安全特性故障</h2><h3 id="7-1-故障现象"><a href="#7-1-故障现象" class="headerlink" title="7.1 故障现象"></a>7.1 故障现象</h3><ul>
<li>合法用户无法接入</li>
<li>端口安全误拦截</li>
<li>802.1X 认证失败</li>
</ul>
<h3 id="7-2-排查命令"><a href="#7-2-排查命令" class="headerlink" title="7.2 排查命令"></a>7.2 排查命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 端口安全</span></span><br><span class="line">display port-security</span><br><span class="line">display mac-address</span><br><span class="line"></span><br><span class="line"><span class="comment"># 802.1X</span></span><br><span class="line">display dot1x</span><br><span class="line">display dot1x connections</span><br><span class="line"></span><br><span class="line"><span class="comment"># DHCP Snooping</span></span><br><span class="line">display dhcp snooping</span><br><span class="line">display dhcp snooping binding</span><br><span class="line"></span><br><span class="line"><span class="comment"># ACL</span></span><br><span class="line">display acl</span><br><span class="line">display traffic-filter applied-record</span><br></pre></td></tr></table></figure>

<h3 id="7-3-典型案例"><a href="#7-3-典型案例" class="headerlink" title="7.3 典型案例"></a>7.3 典型案例</h3><h4 id="案例-1：端口安全导致用户无法接入"><a href="#案例-1：端口安全导致用户无法接入" class="headerlink" title="案例 1：端口安全导致用户无法接入"></a>案例 1：端口安全导致用户无法接入</h4><p><strong>现象</strong>: 更换 PC 后无法上网</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display port-security interface GigabitEthernet 0/0/1</span><br><span class="line"><span class="comment"># Max MAC count: 1</span></span><br><span class="line"><span class="comment"># Current MAC count: 1</span></span><br><span class="line"><span class="comment"># Protect action: shutdown</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display mac-address interface GigabitEthernet 0/0/1</span><br><span class="line"><span class="comment"># 发现是旧 PC 的 MAC 地址</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法 1：清除旧 MAC</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] undo port-security mac-address sticky</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法 2：增加 MAC 数量</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] port-security max-mac-count 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法 3：修改保护动作</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] port-security protect-action restrict</span><br></pre></td></tr></table></figure>

<h4 id="案例-2：802-1X-认证失败"><a href="#案例-2：802-1X-认证失败" class="headerlink" title="案例 2：802.1X 认证失败"></a>案例 2：802.1X 认证失败</h4><p><strong>现象</strong>: 用户认证失败，无法接入网络</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display dot1x connections</span><br><span class="line"><span class="comment"># 无认证连接</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display dot1x statistics</span><br><span class="line"><span class="comment"># 查看认证失败统计</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display radius-configuration</span><br><span class="line"><span class="comment"># 检查 RADIUS 配置</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 检查 RADIUS 服务器连通性</span></span><br><span class="line">[SW1] test-aaa radius template radius1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查共享密钥</span></span><br><span class="line">[SW1] display current-configuration | include radius-server shared-key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查接口 802.1X 配置</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] dot1x <span class="built_in">enable</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-性能故障"><a href="#8-性能故障" class="headerlink" title="8. 性能故障"></a>8. 性能故障</h2><h3 id="8-1-故障现象"><a href="#8-1-故障现象" class="headerlink" title="8.1 故障现象"></a>8.1 故障现象</h3><ul>
<li>网络延迟高</li>
<li>吞吐量低</li>
<li>丢包严重</li>
</ul>
<h3 id="8-2-排查命令"><a href="#8-2-排查命令" class="headerlink" title="8.2 排查命令"></a>8.2 排查命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CPU 和内存</span></span><br><span class="line">display cpu-usage</span><br><span class="line">display memory-usage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接口统计</span></span><br><span class="line">display interface | include rate|error|discard</span><br><span class="line">display interface GigabitEthernet 0/0/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缓存和队列</span></span><br><span class="line">display qos queue statistics</span><br><span class="line">display qos queue interface</span><br><span class="line"></span><br><span class="line"><span class="comment"># 风暴控制</span></span><br><span class="line">display storm-control</span><br></pre></td></tr></table></figure>

<h3 id="8-3-典型案例"><a href="#8-3-典型案例" class="headerlink" title="8.3 典型案例"></a>8.3 典型案例</h3><h4 id="案例-1：广播风暴"><a href="#案例-1：广播风暴" class="headerlink" title="案例 1：广播风暴"></a>案例 1：广播风暴</h4><p><strong>现象</strong>: 网络缓慢，接口流量异常</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display interface brief</span><br><span class="line"><span class="comment"># 发现多个接口广播包计数很高</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display storm-control</span><br><span class="line"><span class="comment"># 查看风暴控制状态</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 启用风暴控制</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] storm-control broadcast min-rate 1000 max-rate 2000</span><br><span class="line">[SW1-GigabitEthernet0/0/1] storm-control multicast min-rate 1000 max-rate 2000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 排查环路</span></span><br><span class="line"><span class="comment"># 检查物理连接</span></span><br><span class="line"><span class="comment"># 检查 STP 配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 隔离问题端口</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] shutdown</span><br></pre></td></tr></table></figure>

<h4 id="案例-2：接口错包"><a href="#案例-2：接口错包" class="headerlink" title="案例 2：接口错包"></a>案例 2：接口错包</h4><p><strong>现象</strong>: 接口有大量 error&#x2F;discarded 包</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display interface GigabitEthernet 0/0/1</span><br><span class="line"><span class="comment"># Input: 1000 packets, 100 errors</span></span><br><span class="line"><span class="comment"># Output: 1000 packets, 50 errors</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 检查双工模式</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] duplex full</span><br><span class="line">[SW1-GigabitEthernet0/0/1] speed 1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查网线质量</span></span><br><span class="line"><span class="comment"># 更换网线测试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查光模块</span></span><br><span class="line">display transceiver interface GigabitEthernet 0/0/1</span><br><span class="line"><span class="comment"># 更换光模块测试</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-硬件故障"><a href="#9-硬件故障" class="headerlink" title="9. 硬件故障"></a>9. 硬件故障</h2><h3 id="9-1-故障现象"><a href="#9-1-故障现象" class="headerlink" title="9.1 故障现象"></a>9.1 故障现象</h3><ul>
<li>设备无法启动</li>
<li>接口频繁 UP&#x2F;DOWN</li>
<li>风扇&#x2F;电源告警</li>
</ul>
<h3 id="9-2-排查命令"><a href="#9-2-排查命令" class="headerlink" title="9.2 排查命令"></a>9.2 排查命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设备信息</span></span><br><span class="line">display device</span><br><span class="line">display version</span><br><span class="line">display elabel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境信息</span></span><br><span class="line">display environment</span><br><span class="line">display fan</span><br><span class="line">display power</span><br><span class="line"></span><br><span class="line"><span class="comment"># 光模块信息</span></span><br><span class="line">display transceiver interface</span><br></pre></td></tr></table></figure>

<h3 id="9-3-典型案例"><a href="#9-3-典型案例" class="headerlink" title="9.3 典型案例"></a>9.3 典型案例</h3><h4 id="案例-1：光模块故障"><a href="#案例-1：光模块故障" class="headerlink" title="案例 1：光模块故障"></a>案例 1：光模块故障</h4><p><strong>现象</strong>: 光口频繁 UP&#x2F;DOWN</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display transceiver interface GigabitEthernet 0/0/24</span><br><span class="line"><span class="comment"># Voltage: 3.3V (Normal: 3.1-3.5V)</span></span><br><span class="line"><span class="comment"># Temperature: 45C (Normal: 0-70C)</span></span><br><span class="line"><span class="comment"># Tx Power: -20dBm (Normal: -9 to -3dBm)  # 偏低</span></span><br><span class="line"><span class="comment"># Rx Power: -25dBm (Normal: -20 to -3dBm)  # 偏低</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 清洁光纤</span></span><br><span class="line"><span class="comment"># 2. 检查光纤长度</span></span><br><span class="line"><span class="comment"># 3. 更换光模块</span></span><br></pre></td></tr></table></figure>

<h4 id="案例-2：电源故障"><a href="#案例-2：电源故障" class="headerlink" title="案例 2：电源故障"></a>案例 2：电源故障</h4><p><strong>现象</strong>: 设备告警，部分模块不工作</p>
<p><strong>排查</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;SW1&gt; display power</span><br><span class="line"><span class="comment"># Power 1: OK</span></span><br><span class="line"><span class="comment"># Power 2: Fault</span></span><br><span class="line"></span><br><span class="line">&lt;SW1&gt; display environment</span><br><span class="line"><span class="comment"># Temperature: OK</span></span><br><span class="line"><span class="comment"># Voltage: Warning</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 检查电源连接</span></span><br><span class="line"><span class="comment"># 2. 更换电源模块</span></span><br><span class="line"><span class="comment"># 3. 检查供电环境</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-故障排查方法论"><a href="#10-故障排查方法论" class="headerlink" title="10. 故障排查方法论"></a>10. 故障排查方法论</h2><h3 id="10-1-分层排查法"><a href="#10-1-分层排查法" class="headerlink" title="10.1 分层排查法"></a>10.1 分层排查法</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">应用层  → 检查应用程序、服务配置</span><br><span class="line">传输层  → 检查端口、连接状态</span><br><span class="line">网络层  → 检查 IP、路由、ACL</span><br><span class="line">数据链路层 → 检查 VLAN、MAC、STP</span><br><span class="line">物理层  → 检查线缆、接口、硬件</span><br></pre></td></tr></table></figure>

<h3 id="10-2-对比法"><a href="#10-2-对比法" class="headerlink" title="10.2 对比法"></a>10.2 对比法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 与正常设备对比配置</span></span><br><span class="line">display current-configuration</span><br><span class="line">display saved-configuration</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与基线对比</span></span><br><span class="line">display baseline-configuration</span><br></pre></td></tr></table></figure>

<h3 id="10-3-分段法"><a href="#10-3-分段法" class="headerlink" title="10.3 分段法"></a>10.3 分段法</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">源端 → 接入 → 汇聚 → 核心 → 汇聚 → 接入 → 目的端</span><br><span class="line">逐段 Ping 测试，定位故障点</span><br></pre></td></tr></table></figure>

<h3 id="10-4-常用排查流程"><a href="#10-4-常用排查流程" class="headerlink" title="10.4 常用排查流程"></a>10.4 常用排查流程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 收集信息</span></span><br><span class="line">display current-configuration</span><br><span class="line">display logbuffer</span><br><span class="line">display trapbuffer</span><br><span class="line">display diagnostic-information  <span class="comment"># 收集诊断信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 分析问题</span></span><br><span class="line"><span class="comment"># 根据现象定位可能的故障点</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 制定方案</span></span><br><span class="line"><span class="comment"># 确定排查步骤和解决方案</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 实施解决</span></span><br><span class="line"><span class="comment"># 执行配置变更或硬件更换</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 验证结果</span></span><br><span class="line">ping <span class="built_in">test</span></span><br><span class="line">service <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 记录归档</span></span><br><span class="line"><span class="comment"># 记录故障现象、原因、解决方案</span></span><br></pre></td></tr></table></figure>

<h3 id="10-5-诊断信息收集"><a href="#10-5-诊断信息收集" class="headerlink" title="10.5 诊断信息收集"></a>10.5 诊断信息收集</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 收集完整诊断信息</span></span><br><span class="line">&lt;SW1&gt; display diagnostic-information</span><br><span class="line"><span class="comment"># 保存到文件</span></span><br><span class="line">&lt;SW1&gt; display diagnostic-information &gt; flash:/diag.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 收集特定模块信息</span></span><br><span class="line">&lt;SW1&gt; display logbuffer &gt; flash:/log.txt</span><br><span class="line">&lt;SW1&gt; display trapbuffer &gt; flash:/trap.txt</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="附录：常用故障排查命令速查"><a href="#附录：常用故障排查命令速查" class="headerlink" title="附录：常用故障排查命令速查"></a>附录：常用故障排查命令速查</h2><h3 id="连通性"><a href="#连通性" class="headerlink" title="连通性"></a>连通性</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ping &lt;ip&gt;</span><br><span class="line">tracert &lt;ip&gt;</span><br><span class="line">telnet &lt;ip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure>

<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">display interface brief</span><br><span class="line">display interface &lt;interface&gt;</span><br><span class="line">display mac-address</span><br><span class="line">display arp</span><br></pre></td></tr></table></figure>

<h3 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">display vlan</span><br><span class="line">display port vlan</span><br><span class="line">display interface Vlanif</span><br></pre></td></tr></table></figure>

<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">display ip routing-table</span><br><span class="line">display ospf peer</span><br><span class="line">display bgp peer</span><br></pre></td></tr></table></figure>

<h3 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">display acl</span><br><span class="line">display port-security</span><br><span class="line">display dhcp snooping</span><br></pre></td></tr></table></figure>

<h3 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">display device</span><br><span class="line">display cpu-usage</span><br><span class="line">display memory-usage</span><br><span class="line">display logbuffer</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用设备</strong>: 华为 S5700&#x2F;S6700&#x2F;S7700&#x2F;S9700&#x2F;CE 系列交换机</p>
]]></content>
      <categories>
        <category>硬件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>Ubuntu 24.04 LTS 安装指南</title>
    <url>/2026/02/28/Ubuntu-24.04-%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/</url>
    <content><![CDATA[<h1 id="Ubuntu-24-04-LTS-安装指南"><a href="#Ubuntu-24-04-LTS-安装指南" class="headerlink" title="Ubuntu 24.04 LTS 安装指南"></a>Ubuntu 24.04 LTS 安装指南</h1><blockquote>
<p>文档版本：1.0<br>更新日期：2026-02-28<br>适用版本：Ubuntu 24.04 LTS (Noble Numbat)</p>
</blockquote>
<hr>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">准备工作</a></li>
<li><a href="#2-%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E9%95%9C%E5%83%8F">下载安装镜像</a></li>
<li><a href="#3-%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E7%9B%98">创建启动盘</a></li>
<li><a href="#4-%E5%AE%89%E8%A3%85-ubuntu">安装 Ubuntu</a></li>
<li><a href="#5-%E9%A6%96%E6%AC%A1%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE">首次启动配置</a></li>
<li><a href="#6-%E7%B3%BB%E7%BB%9F%E6%9B%B4%E6%96%B0">系统更新</a></li>
<li><a href="#7-%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85">常用软件安装</a></li>
<li><a href="#8-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5">故障排查</a></li>
</ol>
<hr>
<h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h2><h3 id="1-1-系统要求"><a href="#1-1-系统要求" class="headerlink" title="1.1 系统要求"></a>1.1 系统要求</h3><table>
<thead>
<tr>
<th>项目</th>
<th>最低要求</th>
<th>推荐配置</th>
</tr>
</thead>
<tbody><tr>
<td>CPU</td>
<td>2 GHz 双核</td>
<td>4 GHz 四核或更高</td>
</tr>
<tr>
<td>内存</td>
<td>4 GB</td>
<td>8 GB 或更高</td>
</tr>
<tr>
<td>硬盘</td>
<td>25 GB</td>
<td>50 GB 或更高</td>
</tr>
<tr>
<td>显示器</td>
<td>1024×768</td>
<td>1920×1080 或更高</td>
</tr>
</tbody></table>
<h3 id="1-2-备份重要数据"><a href="#1-2-备份重要数据" class="headerlink" title="1.2 备份重要数据"></a>1.2 备份重要数据</h3><p>⚠️ <strong>安装前务必备份！</strong></p>
<ul>
<li>个人文件（文档、图片、视频等）</li>
<li>浏览器书签和密码</li>
<li>应用程序配置</li>
<li>系统许可证和激活码</li>
</ul>
<h3 id="1-3-准备工具"><a href="#1-3-准备工具" class="headerlink" title="1.3 准备工具"></a>1.3 准备工具</h3><ul>
<li>空白 U 盘（至少 8 GB）</li>
<li>稳定的网络连接</li>
<li>电源适配器（笔记本建议接通电源）</li>
</ul>
<hr>
<h2 id="2-下载安装镜像"><a href="#2-下载安装镜像" class="headerlink" title="2. 下载安装镜像"></a>2. 下载安装镜像</h2><h3 id="2-1-官方下载渠道"><a href="#2-1-官方下载渠道" class="headerlink" title="2.1 官方下载渠道"></a>2.1 官方下载渠道</h3><p>访问 Ubuntu 官方网站下载：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://ubuntu.com/download/desktop</span><br></pre></td></tr></table></figure>

<h3 id="2-2-选择版本"><a href="#2-2-选择版本" class="headerlink" title="2.2 选择版本"></a>2.2 选择版本</h3><ul>
<li><strong>Ubuntu 24.04 LTS</strong> - 长期支持版（推荐）</li>
<li>Ubuntu 24.10 - 最新版（短期支持）</li>
</ul>
<blockquote>
<p>LTS 版本提供 5 年安全更新，适合生产环境。</p>
</blockquote>
<h3 id="2-3-校验镜像完整性"><a href="#2-3-校验镜像完整性" class="headerlink" title="2.3 校验镜像完整性"></a>2.3 校验镜像完整性</h3><p>下载完成后，建议校验 SHA256 值：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Linux/macOS</span></span><br><span class="line"><span class="built_in">sha256sum</span> ubuntu-24.04-desktop-amd64.iso</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows (PowerShell)</span></span><br><span class="line">Get-FileHash ubuntu-24.04-desktop-amd64.iso -Algorithm SHA256</span><br></pre></td></tr></table></figure>

<p>与官网公布的哈希值对比，确保一致。</p>
<hr>
<h2 id="3-创建启动盘"><a href="#3-创建启动盘" class="headerlink" title="3. 创建启动盘"></a>3. 创建启动盘</h2><h3 id="3-1-使用-Rufus（Windows）"><a href="#3-1-使用-Rufus（Windows）" class="headerlink" title="3.1 使用 Rufus（Windows）"></a>3.1 使用 Rufus（Windows）</h3><ol>
<li>下载 Rufus：<a href="https://rufus.ie/">https://rufus.ie</a></li>
<li>插入 U 盘</li>
<li>打开 Rufus，选择：<ul>
<li><strong>设备</strong>: 你的 U 盘</li>
<li><strong>启动类型</strong>: 选择下载的 ISO 文件</li>
<li><strong>分区方案</strong>: GPT（UEFI 电脑）或 MBR（旧电脑）</li>
<li><strong>目标系统</strong>: UEFI 或 BIOS</li>
</ul>
</li>
<li>点击”开始”，等待完成</li>
</ol>
<h3 id="3-2-使用-BalenaEtcher（跨平台）"><a href="#3-2-使用-BalenaEtcher（跨平台）" class="headerlink" title="3.2 使用 BalenaEtcher（跨平台）"></a>3.2 使用 BalenaEtcher（跨平台）</h3><ol>
<li>下载 BalenaEtcher：<a href="https://www.balena.io/etcher">https://www.balena.io/etcher</a></li>
<li>打开软件，依次操作：<ul>
<li><strong>Flash from file</strong>: 选择 ISO 镜像</li>
<li><strong>Select target</strong>: 选择 U 盘</li>
<li><strong>Flash!</strong>: 开始写入</li>
</ul>
</li>
<li>等待完成，自动校验</li>
</ol>
<h3 id="3-3-使用-dd-命令（Linux-macOS）"><a href="#3-3-使用-dd-命令（Linux-macOS）" class="headerlink" title="3.3 使用 dd 命令（Linux&#x2F;macOS）"></a>3.3 使用 dd 命令（Linux&#x2F;macOS）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 U 盘设备名</span></span><br><span class="line">diskutil list          <span class="comment"># macOS</span></span><br><span class="line">lsblk                  <span class="comment"># Linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入镜像（替换 /dev/sdX 为实际设备）</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">dd</span> <span class="keyword">if</span>=ubuntu-24.04-desktop-amd64.iso of=/dev/sdX bs=4M status=progress</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安全弹出</span></span><br><span class="line"><span class="built_in">sync</span></span><br><span class="line"><span class="built_in">sudo</span> eject /dev/sdX</span><br></pre></td></tr></table></figure>

<p>⚠️ <strong>警告</strong>: <code>dd</code> 命令会覆盖目标设备全部数据，请确认设备名正确！</p>
<hr>
<h2 id="4-安装-Ubuntu"><a href="#4-安装-Ubuntu" class="headerlink" title="4. 安装 Ubuntu"></a>4. 安装 Ubuntu</h2><h3 id="4-1-从-U-盘启动"><a href="#4-1-从-U-盘启动" class="headerlink" title="4.1 从 U 盘启动"></a>4.1 从 U 盘启动</h3><ol>
<li>插入 U 盘，重启电脑</li>
<li>进入 BIOS&#x2F;UEFI 设置（通常按 F2、F12、Del 或 Esc）</li>
<li>设置 U 盘为第一启动设备</li>
<li>保存并退出，从 U 盘启动</li>
</ol>
<h3 id="4-2-启动菜单"><a href="#4-2-启动菜单" class="headerlink" title="4.2 启动菜单"></a>4.2 启动菜单</h3><p>选择以下选项之一：</p>
<ul>
<li><strong>Try or Install Ubuntu</strong> - 试用或安装（推荐）</li>
<li>Ubuntu (safe graphics) - 安全图形模式（显卡兼容性问题时使用）</li>
</ul>
<h3 id="4-3-选择语言"><a href="#4-3-选择语言" class="headerlink" title="4.3 选择语言"></a>4.3 选择语言</h3><ol>
<li>左侧列表选择 <strong>中文（简体）</strong></li>
<li>点击 <strong>安装 Ubuntu</strong></li>
</ol>
<h3 id="4-4-键盘布局"><a href="#4-4-键盘布局" class="headerlink" title="4.4 键盘布局"></a>4.4 键盘布局</h3><ul>
<li>选择：<strong>Chinese</strong> → <strong>Chinese</strong></li>
<li>测试键盘输入，确认无误</li>
<li>点击 <strong>继续</strong></li>
</ul>
<h3 id="4-5-更新和其他软件"><a href="#4-5-更新和其他软件" class="headerlink" title="4.5 更新和其他软件"></a>4.5 更新和其他软件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">☑ 下载 Ubuntu 时安装更新（推荐，需要网络）</span><br><span class="line">☑ 安装第三方软件（图形和 Wi-Fi 硬件、MP3 等媒体格式）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>建议都勾选，减少后续配置步骤。</p>
</blockquote>
<h3 id="4-6-安装类型（关键步骤）"><a href="#4-6-安装类型（关键步骤）" class="headerlink" title="4.6 安装类型（关键步骤）"></a>4.6 安装类型（关键步骤）</h3><h4 id="选项-A-清除整个磁盘并安装-Ubuntu（全新安装）"><a href="#选项-A-清除整个磁盘并安装-Ubuntu（全新安装）" class="headerlink" title="选项 A: 清除整个磁盘并安装 Ubuntu（全新安装）"></a>选项 A: 清除整个磁盘并安装 Ubuntu（全新安装）</h4><p>⚠️ <strong>会删除磁盘所有数据！</strong></p>
<p>适合：</p>
<ul>
<li>新电脑</li>
<li>已备份数据</li>
<li>不再需要原系统</li>
</ul>
<h4 id="选项-B-安装-Ubuntu-与现有系统共存（双系统）"><a href="#选项-B-安装-Ubuntu-与现有系统共存（双系统）" class="headerlink" title="选项 B: 安装 Ubuntu 与现有系统共存（双系统）"></a>选项 B: 安装 Ubuntu 与现有系统共存（双系统）</h4><p>适合：</p>
<ul>
<li>保留 Windows 或其他系统</li>
<li>需要多系统启动</li>
</ul>
<p>安装程序会自动调整分区大小。</p>
<h4 id="选项-C-其他选项（手动分区）"><a href="#选项-C-其他选项（手动分区）" class="headerlink" title="选项 C: 其他选项（手动分区）"></a>选项 C: 其他选项（手动分区）</h4><p>适合高级用户，可自定义：</p>
<table>
<thead>
<tr>
<th>挂载点</th>
<th>建议大小</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>/</code></td>
<td>30-50 GB</td>
<td>系统根目录</td>
</tr>
<tr>
<td><code>/home</code></td>
<td>剩余空间</td>
<td>用户数据</td>
</tr>
<tr>
<td><code>swap</code></td>
<td>等于内存大小</td>
<td>交换空间（可选）</td>
</tr>
<tr>
<td><code>/boot/efi</code></td>
<td>512 MB</td>
<td>EFI 引导分区（UEFI 必需）</td>
</tr>
</tbody></table>
<h3 id="4-7-选择时区"><a href="#4-7-选择时区" class="headerlink" title="4.7 选择时区"></a>4.7 选择时区</h3><ul>
<li>地图点击 <strong>Shanghai</strong> 或搜索 <strong>Asia&#x2F;Shanghai</strong></li>
<li>确认时间正确</li>
<li>点击 <strong>继续</strong></li>
</ul>
<h3 id="4-8-创建用户"><a href="#4-8-创建用户" class="headerlink" title="4.8 创建用户"></a>4.8 创建用户</h3><table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>你的名字</td>
<td>显示名称</td>
<td>Admin</td>
</tr>
<tr>
<td>计算机名</td>
<td>网络标识</td>
<td>admin-pc</td>
</tr>
<tr>
<td>用户名</td>
<td>登录名</td>
<td>admin</td>
</tr>
<tr>
<td>密码</td>
<td>登录密码</td>
<td>••••••••</td>
</tr>
</tbody></table>
<p>⚠️ <strong>密码建议</strong>:</p>
<ul>
<li>至少 8 位</li>
<li>包含大小写字母、数字、符号</li>
<li>妥善保存，重置较麻烦</li>
</ul>
<h3 id="4-9-开始安装"><a href="#4-9-开始安装" class="headerlink" title="4.9 开始安装"></a>4.9 开始安装</h3><ol>
<li>确认所有设置无误</li>
<li>点击 <strong>现在安装</strong></li>
<li>确认分区更改，点击 <strong>继续</strong></li>
<li>等待安装完成（约 15-30 分钟）</li>
</ol>
<hr>
<h2 id="5-首次启动配置"><a href="#5-首次启动配置" class="headerlink" title="5. 首次启动配置"></a>5. 首次启动配置</h2><h3 id="5-1-重启系统"><a href="#5-1-重启系统" class="headerlink" title="5.1 重启系统"></a>5.1 重启系统</h3><p>安装完成后，点击 <strong>立即重启</strong>，按提示拔出 U 盘。</p>
<h3 id="5-2-登录系统"><a href="#5-2-登录系统" class="headerlink" title="5.2 登录系统"></a>5.2 登录系统</h3><ol>
<li>选择用户</li>
<li>输入密码</li>
<li>首次登录可能需要等待系统初始化</li>
</ol>
<h3 id="5-3-欢迎向导"><a href="#5-3-欢迎向导" class="headerlink" title="5.3 欢迎向导"></a>5.3 欢迎向导</h3><p>Ubuntu 24.04 可能显示欢迎向导：</p>
<ul>
<li><strong>隐私设置</strong>: 选择是否启用位置服务、问题报告等</li>
<li><strong>在线账户</strong>: 可登录 Google、Microsoft 等账户（可选）</li>
<li><strong>Livepatch</strong>: 启用内核热补丁（推荐，需要 Ubuntu One 账户）</li>
</ul>
<h3 id="5-4-网络连接"><a href="#5-4-网络连接" class="headerlink" title="5.4 网络连接"></a>5.4 网络连接</h3><ol>
<li>点击右上角网络图标</li>
<li>选择 Wi-Fi 网络并输入密码</li>
<li>或连接有线网络（通常自动识别）</li>
</ol>
<h3 id="5-5-显示设置"><a href="#5-5-显示设置" class="headerlink" title="5.5 显示设置"></a>5.5 显示设置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">设置 → 显示</span><br></pre></td></tr></table></figure>

<ul>
<li>调整分辨率（推荐原生分辨率）</li>
<li>设置缩放比例（高 DPI 屏幕）</li>
<li>配置多显示器（如有）</li>
</ul>
<h3 id="5-6-输入法配置"><a href="#5-6-输入法配置" class="headerlink" title="5.6 输入法配置"></a>5.6 输入法配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">设置 → 区域和语言 → 管理已安装的语言</span><br></pre></td></tr></table></figure>

<ol>
<li>安装中文语言包（如未安装）</li>
<li>添加输入法：<strong>IBus</strong> 或 <strong>Fcitx5</strong></li>
<li>推荐安装 <strong>ibus-pinyin</strong> 或 <strong>fcitx5-pinyin</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装拼音输入法</span></span><br><span class="line"><span class="built_in">sudo</span> apt install ibus-pinyin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 Fcitx5（更现代）</span></span><br><span class="line"><span class="built_in">sudo</span> apt install fcitx5 fcitx5-pinyin fcitx5-chinese-addons</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-系统更新"><a href="#6-系统更新" class="headerlink" title="6. 系统更新"></a>6. 系统更新</h2><h3 id="6-1-图形界面更新"><a href="#6-1-图形界面更新" class="headerlink" title="6.1 图形界面更新"></a>6.1 图形界面更新</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">应用程序 → Ubuntu 软件 → 已安装 → 更新</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">设置 → 关于 → 系统更新</span><br></pre></td></tr></table></figure>

<h3 id="6-2-命令行更新"><a href="#6-2-命令行更新" class="headerlink" title="6.2 命令行更新"></a>6.2 命令行更新</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 更新软件包列表</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级已安装的软件包</span></span><br><span class="line"><span class="built_in">sudo</span> apt upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发行版升级（如有新版本）</span></span><br><span class="line"><span class="built_in">sudo</span> apt dist-upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理无用包</span></span><br><span class="line"><span class="built_in">sudo</span> apt autoremove -y</span><br><span class="line"><span class="built_in">sudo</span> apt autoclean</span><br></pre></td></tr></table></figure>

<h3 id="6-3-启用自动更新"><a href="#6-3-启用自动更新" class="headerlink" title="6.3 启用自动更新"></a>6.3 启用自动更新</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编辑自动更新配置</span></span><br><span class="line"><span class="built_in">sudo</span> nano /etc/apt/apt.conf.d/20auto-upgrades</span><br></pre></td></tr></table></figure>

<p>内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">APT::Periodic::Update-Package-Lists &quot;1&quot;;</span><br><span class="line">APT::Periodic::Unattended-Upgrade &quot;1&quot;;</span><br><span class="line">APT::Periodic::Download-Upgradeable-Packages &quot;1&quot;;</span><br><span class="line">APT::Periodic::AutocleanInterval &quot;7&quot;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-常用软件安装"><a href="#7-常用软件安装" class="headerlink" title="7. 常用软件安装"></a>7. 常用软件安装</h2><h3 id="7-1-系统工具"><a href="#7-1-系统工具" class="headerlink" title="7.1 系统工具"></a>7.1 系统工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 压缩工具</span></span><br><span class="line"><span class="built_in">sudo</span> apt install p7zip-full p7zip-rar unrar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络工具</span></span><br><span class="line"><span class="built_in">sudo</span> apt install net-tools curl wget git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统监控</span></span><br><span class="line"><span class="built_in">sudo</span> apt install htop neofetch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文本编辑器</span></span><br><span class="line"><span class="built_in">sudo</span> apt install vim gedit</span><br></pre></td></tr></table></figure>

<h3 id="7-2-办公软件"><a href="#7-2-办公软件" class="headerlink" title="7.2 办公软件"></a>7.2 办公软件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># LibreOffice（通常预装）</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libreoffice libreoffice-l10n-zh-cn</span><br><span class="line"></span><br><span class="line"><span class="comment"># PDF 阅读器</span></span><br><span class="line"><span class="built_in">sudo</span> apt install evince</span><br><span class="line"></span><br><span class="line"><span class="comment"># 邮件客户端</span></span><br><span class="line"><span class="built_in">sudo</span> apt install thunderbird</span><br></pre></td></tr></table></figure>

<h3 id="7-3-多媒体"><a href="#7-3-多媒体" class="headerlink" title="7.3 多媒体"></a>7.3 多媒体</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 视频播放器</span></span><br><span class="line"><span class="built_in">sudo</span> apt install vlc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 音频播放器</span></span><br><span class="line"><span class="built_in">sudo</span> apt install rhythmbox</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编解码器</span></span><br><span class="line"><span class="built_in">sudo</span> apt install ubuntu-restricted-extras</span><br></pre></td></tr></table></figure>

<h3 id="7-4-浏览器"><a href="#7-4-浏览器" class="headerlink" title="7.4 浏览器"></a>7.4 浏览器</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Firefox（预装）</span></span><br><span class="line"><span class="comment"># Chrome</span></span><br><span class="line">wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb</span><br><span class="line"><span class="built_in">sudo</span> dpkg -i google-chrome-stable_current_amd64.deb</span><br><span class="line"><span class="built_in">sudo</span> apt install -f -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Edge</span></span><br><span class="line">curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor &gt; microsoft.gpg</span><br><span class="line"><span class="built_in">sudo</span> install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/</span><br><span class="line"><span class="built_in">sudo</span> sh -c <span class="string">&#x27;echo &quot;deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main&quot; &gt; /etc/apt/sources.list.d/microsoft-edge-dev.list&#x27;</span></span><br><span class="line"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt install microsoft-edge-stable</span><br></pre></td></tr></table></figure>

<h3 id="7-5-开发工具"><a href="#7-5-开发工具" class="headerlink" title="7.5 开发工具"></a>7.5 开发工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基础开发环境</span></span><br><span class="line"><span class="built_in">sudo</span> apt install build-essential gcc g++ make cmake</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python</span></span><br><span class="line"><span class="built_in">sudo</span> apt install python3 python3-pip python3-venv</span><br><span class="line"></span><br><span class="line"><span class="comment"># Node.js（使用 NVM）</span></span><br><span class="line">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">nvm install --lts</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker</span></span><br><span class="line">curl -fsSL https://get.docker.com | sh</span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VS Code</span></span><br><span class="line">wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor &gt; packages.microsoft.gpg</span><br><span class="line"><span class="built_in">sudo</span> install -o root -g root -m 644 packages.microsoft.gpg /etc/apt/trusted.gpg.d/</span><br><span class="line"><span class="built_in">sudo</span> sh -c <span class="string">&#x27;echo &quot;deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main&quot; &gt; /etc/apt/sources.list.d/vscode.list&#x27;</span></span><br><span class="line"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt install code</span><br></pre></td></tr></table></figure>

<h3 id="7-6-中文支持"><a href="#7-6-中文支持" class="headerlink" title="7.6 中文支持"></a>7.6 中文支持</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 中文字体</span></span><br><span class="line"><span class="built_in">sudo</span> apt install fonts-wqy-zenhei fonts-wqy-microhei</span><br><span class="line"></span><br><span class="line"><span class="comment"># 中文输入法</span></span><br><span class="line"><span class="built_in">sudo</span> apt install ibus-pinyin ibus-table-wubi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 IBus 为默认输入法</span></span><br><span class="line">im-config -n ibus</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-故障排查"><a href="#8-故障排查" class="headerlink" title="8. 故障排查"></a>8. 故障排查</h2><h3 id="8-1-无法从-U-盘启动"><a href="#8-1-无法从-U-盘启动" class="headerlink" title="8.1 无法从 U 盘启动"></a>8.1 无法从 U 盘启动</h3><p><strong>解决方法</strong>:</p>
<ol>
<li>检查 BIOS&#x2F;UEFI 启动顺序</li>
<li>禁用 Secure Boot（安全启动）</li>
<li>重新制作启动盘（尝试不同工具）</li>
<li>更换 U 盘或 USB 接口</li>
</ol>
<h3 id="8-2-安装过程中黑屏-花屏"><a href="#8-2-安装过程中黑屏-花屏" class="headerlink" title="8.2 安装过程中黑屏&#x2F;花屏"></a>8.2 安装过程中黑屏&#x2F;花屏</h3><p><strong>解决方法</strong>:</p>
<ol>
<li>启动时按 <code>e</code> 编辑启动参数</li>
<li>在 <code>quiet splash</code> 后添加 <code>nomodeset</code></li>
<li>按 F10 启动</li>
<li>安装后更新显卡驱动</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># NVIDIA 显卡</span></span><br><span class="line"><span class="built_in">sudo</span> ubuntu-drivers autoinstall</span><br><span class="line"><span class="built_in">sudo</span> reboot</span><br></pre></td></tr></table></figure>

<h3 id="8-3-Wi-Fi-无法使用"><a href="#8-3-Wi-Fi-无法使用" class="headerlink" title="8.3 Wi-Fi 无法使用"></a>8.3 Wi-Fi 无法使用</h3><p><strong>解决方法</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看无线网卡</span></span><br><span class="line">lspci | grep -i network</span><br><span class="line">lsusb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装驱动（根据网卡型号）</span></span><br><span class="line"><span class="built_in">sudo</span> apt install firmware-b43-installer    <span class="comment"># Broadcom</span></span><br><span class="line"><span class="built_in">sudo</span> apt install firmware-realtek          <span class="comment"># Realtek</span></span><br><span class="line"><span class="built_in">sudo</span> apt install firmware-misc-nonfree     <span class="comment"># 其他</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启网络服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart NetworkManager</span><br></pre></td></tr></table></figure>

<h3 id="8-4-双系统无法引导-Windows"><a href="#8-4-双系统无法引导-Windows" class="headerlink" title="8.4 双系统无法引导 Windows"></a>8.4 双系统无法引导 Windows</h3><p><strong>解决方法</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 更新 GRUB</span></span><br><span class="line"><span class="built_in">sudo</span> update-grub</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复 GRUB</span></span><br><span class="line"><span class="built_in">sudo</span> grub-install /dev/sdX  <span class="comment"># 替换为实际磁盘</span></span><br><span class="line"><span class="built_in">sudo</span> update-grub</span><br></pre></td></tr></table></figure>

<h3 id="8-5-系统运行缓慢"><a href="#8-5-系统运行缓慢" class="headerlink" title="8.5 系统运行缓慢"></a>8.5 系统运行缓慢</h3><p><strong>优化建议</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 清理系统</span></span><br><span class="line"><span class="built_in">sudo</span> apt autoremove -y</span><br><span class="line"><span class="built_in">sudo</span> apt autoclean</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查磁盘空间</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看资源占用</span></span><br><span class="line">htop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用启动项</span></span><br><span class="line">gnome-session-properties</span><br></pre></td></tr></table></figure>

<h3 id="8-6-常见问题速查"><a href="#8-6-常见问题速查" class="headerlink" title="8.6 常见问题速查"></a>8.6 常见问题速查</h3><table>
<thead>
<tr>
<th>问题</th>
<th>可能原因</th>
<th>解决方法</th>
</tr>
</thead>
<tbody><tr>
<td>无法联网</td>
<td>驱动缺失</td>
<td>安装对应固件包</td>
</tr>
<tr>
<td>声音无声</td>
<td>输出设备错误</td>
<td>设置 → 声音 → 切换输出</td>
</tr>
<tr>
<td>触摸板失灵</td>
<td>驱动问题</td>
<td><code>sudo modprobe -r psmouse &amp;&amp; sudo modprobe psmouse</code></td>
</tr>
<tr>
<td>分辨率异常</td>
<td>显卡驱动</td>
<td>更新或重装显卡驱动</td>
</tr>
<tr>
<td>中文乱码</td>
<td>字体缺失</td>
<td>安装中文字体包</td>
</tr>
</tbody></table>
<hr>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="A-常用命令速查"><a href="#A-常用命令速查" class="headerlink" title="A. 常用命令速查"></a>A. 常用命令速查</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息</span></span><br><span class="line"><span class="built_in">uname</span> -a              <span class="comment"># 内核版本</span></span><br><span class="line">lsb_release -a        <span class="comment"># 发行版信息</span></span><br><span class="line">neofetch              <span class="comment"># 系统概览（需安装）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件操作</span></span><br><span class="line"><span class="built_in">ls</span> -la               <span class="comment"># 列出文件</span></span><br><span class="line"><span class="built_in">cp</span> -r src/ dst/      <span class="comment"># 复制</span></span><br><span class="line"><span class="built_in">rm</span> -rf folder/       <span class="comment"># 删除</span></span><br><span class="line"><span class="built_in">chmod</span> +x file        <span class="comment"># 添加执行权限</span></span><br><span class="line"><span class="built_in">chown</span> user:group file <span class="comment"># 修改所有者</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进程管理</span></span><br><span class="line">ps aux               <span class="comment"># 查看进程</span></span><br><span class="line"><span class="built_in">kill</span> PID             <span class="comment"># 终止进程</span></span><br><span class="line">systemctl status svc <span class="comment"># 服务状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络</span></span><br><span class="line">ip addr              <span class="comment"># IP 地址</span></span><br><span class="line">ping host            <span class="comment"># 测试连通性</span></span><br><span class="line">netstat -tulpn       <span class="comment"># 端口占用</span></span><br></pre></td></tr></table></figure>

<h3 id="B-有用资源"><a href="#B-有用资源" class="headerlink" title="B. 有用资源"></a>B. 有用资源</h3><ul>
<li><strong>Ubuntu 官网</strong>: <a href="https://ubuntu.com/">https://ubuntu.com</a></li>
<li><strong>Ubuntu 中文论坛</strong>: <a href="https://forum.ubuntu.org.cn/">https://forum.ubuntu.org.cn</a></li>
<li><strong>Ask Ubuntu</strong>: <a href="https://askubuntu.com/">https://askubuntu.com</a></li>
<li><strong>Ubuntu 文档</strong>: <a href="https://help.ubuntu.com/">https://help.ubuntu.com</a></li>
</ul>
<h3 id="C-版本信息"><a href="#C-版本信息" class="headerlink" title="C. 版本信息"></a>C. 版本信息</h3><table>
<thead>
<tr>
<th>版本代号</th>
<th>版本号</th>
<th>发布日期</th>
<th>支持截止</th>
</tr>
</thead>
<tbody><tr>
<td>Noble Numbat</td>
<td>24.04 LTS</td>
<td>2024-04</td>
<td>2029-04</td>
</tr>
</tbody></table>
<hr>
]]></content>
      <categories>
        <category>系统部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>华为交换机典型配置命令手册</title>
    <url>/2026/02/28/11-%E5%8D%8E%E4%B8%BA%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%85%B8%E5%9E%8B%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h1 id="华为交换机典型配置命令手册"><a href="#华为交换机典型配置命令手册" class="headerlink" title="华为交换机典型配置命令手册"></a>华为交换机典型配置命令手册</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4">基础配置命令</a></li>
<li><a href="#2-vlan-%E9%85%8D%E7%BD%AE">VLAN 配置</a></li>
<li><a href="#3-%E9%93%BE%E8%B7%AF%E8%81%9A%E5%90%88">链路聚合</a></li>
<li><a href="#4-%E7%94%9F%E6%88%90%E6%A0%91%E5%8D%8F%E8%AE%AE">生成树协议</a></li>
<li><a href="#5-%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE">路由配置</a></li>
<li><a href="#6-acl-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6">ACL 访问控制</a></li>
<li><a href="#7-qos-%E9%85%8D%E7%BD%AE">QoS 配置</a></li>
<li><a href="#8-%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE">安全配置</a></li>
<li><a href="#9-%E7%AE%A1%E7%90%86%E4%B8%8E%E7%BB%B4%E6%8A%A4">管理与维护</a></li>
</ol>
<hr>
<h2 id="1-基础配置命令"><a href="#1-基础配置命令" class="headerlink" title="1. 基础配置命令"></a>1. 基础配置命令</h2><h3 id="1-1-登录与视图切换"><a href="#1-1-登录与视图切换" class="headerlink" title="1.1 登录与视图切换"></a>1.1 登录与视图切换</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 通过 Console 口登录</span></span><br><span class="line">&lt;Huawei&gt; system-view                    <span class="comment"># 进入系统视图</span></span><br><span class="line">[Huawei] sysname SW1                    <span class="comment"># 修改设备名称</span></span><br><span class="line">[SW1] quit                              <span class="comment"># 退出当前视图</span></span><br><span class="line">[SW1] <span class="built_in">return</span>                            <span class="comment"># 直接返回用户视图</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 视图层级</span></span><br><span class="line">用户视图      &lt;Huawei&gt;                  <span class="comment"># 查看状态，不能配置</span></span><br><span class="line">系统视图      [Huawei]                  <span class="comment"># 全局配置</span></span><br><span class="line">接口视图      [Huawei-GigabitEthernet0/0/1]</span><br><span class="line">VLAN 视图      [Huawei-vlan10]</span><br><span class="line">协议视图      [Huawei-stp]</span><br></pre></td></tr></table></figure>

<h3 id="1-2-接口基础配置"><a href="#1-2-接口基础配置" class="headerlink" title="1.2 接口基础配置"></a>1.2 接口基础配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入接口视图</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] </span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置接口描述</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] description To_PC1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置接口速率和双工模式</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] speed 1000   <span class="comment"># 10/100/1000/auto</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] duplex full  <span class="comment"># full/half/auto</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启/关闭接口</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] undo shutdown</span><br><span class="line">[SW1-GigabitEthernet0/0/1] shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看接口状态</span></span><br><span class="line">[SW1] display interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1] display interface brief           <span class="comment"># 查看简要信息</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-接口类型配置"><a href="#1-3-接口类型配置" class="headerlink" title="1.3 接口类型配置"></a>1.3 接口类型配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Access 端口（连接终端）</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] port link-type access</span><br><span class="line">[SW1-GigabitEthernet0/0/1] port default vlan 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Trunk 端口（连接交换机）</span></span><br><span class="line">[SW1-GigabitEthernet0/0/2] port link-type trunk</span><br><span class="line">[SW1-GigabitEthernet0/0/2] port trunk allow-pass vlan 10 20 30</span><br><span class="line">[SW1-GigabitEthernet0/0/2] port trunk pvid vlan 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hybrid 端口（灵活 tagging）</span></span><br><span class="line">[SW1-GigabitEthernet0/0/3] port link-type hybrid</span><br><span class="line">[SW1-GigabitEthernet0/0/3] port hybrid pvid vlan 10</span><br><span class="line">[SW1-GigabitEthernet0/0/3] port hybrid untagged vlan 10 20</span><br><span class="line">[SW1-GigabitEthernet0/0/3] port hybrid tagged vlan 30 40</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复接口默认配置</span></span><br><span class="line">[SW1] clear configuration interface GigabitEthernet 0/0/1</span><br></pre></td></tr></table></figure>

<h3 id="1-4-设备管理配置"><a href="#1-4-设备管理配置" class="headerlink" title="1.4 设备管理配置"></a>1.4 设备管理配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置系统时间</span></span><br><span class="line">[SW1] clock timezone Beijing add 08:00:00</span><br><span class="line">[SW1] clock datetime 14:30:00 2024-01-15</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置设备名称和描述</span></span><br><span class="line">[SW1] sysname Core-SW1</span><br><span class="line">[SW1] info-center <span class="built_in">enable</span>                <span class="comment"># 开启信息中心</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存配置</span></span><br><span class="line">&lt;SW1&gt; save</span><br><span class="line">&lt;SW1&gt; save config.cfg                   <span class="comment"># 指定文件名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看配置</span></span><br><span class="line">&lt;SW1&gt; display current-configuration     <span class="comment"># 查看当前配置</span></span><br><span class="line">&lt;SW1&gt; display saved-configuration       <span class="comment"># 查看保存的配置</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-VLAN-配置"><a href="#2-VLAN-配置" class="headerlink" title="2. VLAN 配置"></a>2. VLAN 配置</h2><h3 id="2-1-创建-VLAN"><a href="#2-1-创建-VLAN" class="headerlink" title="2.1 创建 VLAN"></a>2.1 创建 VLAN</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建单个 VLAN</span></span><br><span class="line">[SW1] vlan 10</span><br><span class="line">[SW1-vlan10] description HR_Department</span><br><span class="line">[SW1-vlan10] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量创建 VLAN</span></span><br><span class="line">[SW1] vlan batch 10 20 30               <span class="comment"># 创建多个不连续 VLAN</span></span><br><span class="line">[SW1] vlan batch 10 to 50               <span class="comment"># 创建连续 VLAN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 VLAN 信息</span></span><br><span class="line">[SW1] display vlan                      <span class="comment"># 查看所有 VLAN</span></span><br><span class="line">[SW1] display vlan 10                   <span class="comment"># 查看特定 VLAN</span></span><br><span class="line">[SW1] display vlan summary              <span class="comment"># 查看 VLAN 摘要</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-将端口加入-VLAN"><a href="#2-2-将端口加入-VLAN" class="headerlink" title="2.2 将端口加入 VLAN"></a>2.2 将端口加入 VLAN</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Access 端口加入 VLAN</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] port link-type access</span><br><span class="line">[SW1-GigabitEthernet0/0/1] port default vlan 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Trunk 端口允许 VLAN 通过</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/24</span><br><span class="line">[SW1-GigabitEthernet0/0/24] port link-type trunk</span><br><span class="line">[SW1-GigabitEthernet0/0/24] port trunk allow-pass vlan 10 20 30</span><br><span class="line">[SW1-GigabitEthernet0/0/24] port trunk pvid vlan 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量配置端口 VLAN</span></span><br><span class="line">[SW1] port-group 1</span><br><span class="line">[SW1-port-group-1] group-member GigabitEthernet 0/0/1 to 0/0/10</span><br><span class="line">[SW1-port-group-1] port link-type access</span><br><span class="line">[SW1-port-group-1] port default vlan 10</span><br></pre></td></tr></table></figure>

<h3 id="2-3-VLAN-间路由（三层交换）"><a href="#2-3-VLAN-间路由（三层交换）" class="headerlink" title="2.3 VLAN 间路由（三层交换）"></a>2.3 VLAN 间路由（三层交换）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 VLANIF 接口</span></span><br><span class="line">[SW1] interface Vlanif 10</span><br><span class="line">[SW1-Vlanif10] ip address 192.168.10.1 255.255.255.0</span><br><span class="line">[SW1-Vlanif10] quit</span><br><span class="line"></span><br><span class="line">[SW1] interface Vlanif 20</span><br><span class="line">[SW1-Vlanif20] ip address 192.168.20.1 255.255.255.0</span><br><span class="line">[SW1-Vlanif20] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用 IP 路由</span></span><br><span class="line">[SW1] ip routing</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看路由表</span></span><br><span class="line">[SW1] display ip routing-table</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Super-VLAN-配置"><a href="#2-4-Super-VLAN-配置" class="headerlink" title="2.4 Super VLAN 配置"></a>2.4 Super VLAN 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 Super VLAN</span></span><br><span class="line">[SW1] vlan 100</span><br><span class="line">[SW1-vlan100] description Super_VLAN</span><br><span class="line">[SW1-vlan100] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Sub VLAN</span></span><br><span class="line">[SW1] vlan batch 101 102 103</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Sub VLAN</span></span><br><span class="line">[SW1] vlan 101</span><br><span class="line">[SW1-vlan101] subvlan</span><br><span class="line">[SW1-vlan101] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关联 Super VLAN 和 Sub VLAN</span></span><br><span class="line">[SW1] vlan 100</span><br><span class="line">[SW1-vlan100] aggregate-vlan</span><br><span class="line">[SW1-vlan100] access-vlan 101 to 103</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 VLANIF</span></span><br><span class="line">[SW1] interface Vlanif 100</span><br><span class="line">[SW1-Vlanif100] ip address 192.168.100.1 255.255.255.0</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-链路聚合"><a href="#3-链路聚合" class="headerlink" title="3. 链路聚合"></a>3. 链路聚合</h2><h3 id="3-1-手工负载分担模式"><a href="#3-1-手工负载分担模式" class="headerlink" title="3.1 手工负载分担模式"></a>3.1 手工负载分担模式</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 Eth-Trunk 接口</span></span><br><span class="line">[SW1] interface Eth-Trunk 1</span><br><span class="line">[SW1-Eth-Trunk1] description To_SW2</span><br><span class="line">[SW1-Eth-Trunk1] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将物理接口加入 Eth-Trunk</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] eth-trunk 1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] quit</span><br><span class="line"></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/2</span><br><span class="line">[SW1-GigabitEthernet0/0/2] eth-trunk 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Eth-Trunk 为 Trunk</span></span><br><span class="line">[SW1] interface Eth-Trunk 1</span><br><span class="line">[SW1-Eth-Trunk1] port link-type trunk</span><br><span class="line">[SW1-Eth-Trunk1] port trunk allow-pass vlan 10 20 30</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Eth-Trunk 状态</span></span><br><span class="line">[SW1] display eth-trunk 1</span><br><span class="line">[SW1] display interface Eth-Trunk 1</span><br></pre></td></tr></table></figure>

<h3 id="3-2-LACP-模式"><a href="#3-2-LACP-模式" class="headerlink" title="3.2 LACP 模式"></a>3.2 LACP 模式</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 LACP 模式 Eth-Trunk</span></span><br><span class="line">[SW1] interface Eth-Trunk 1</span><br><span class="line">[SW1-Eth-Trunk1] mode lacp</span><br><span class="line">[SW1-Eth-Trunk1] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置系统优先级（可选，越小优先级越高）</span></span><br><span class="line">[SW1] lacp priority 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将接口加入 Eth-Trunk</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] eth-trunk 1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] lacp priority 100  <span class="comment"># 接口优先级</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置活动接口数上限</span></span><br><span class="line">[SW1] interface Eth-Trunk 1</span><br><span class="line">[SW1-Eth-Trunk1] max active-linknumber 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 LACP 信息</span></span><br><span class="line">[SW1] display eth-trunk 1</span><br><span class="line">[SW1] display lacp statistics eth-trunk 1</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Eth-Trunk-负载分担方式"><a href="#3-3-Eth-Trunk-负载分担方式" class="headerlink" title="3.3 Eth-Trunk 负载分担方式"></a>3.3 Eth-Trunk 负载分担方式</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置负载分担模式</span></span><br><span class="line">[SW1] load-balance ?</span><br><span class="line">  dst-ip          目的 IP</span><br><span class="line">  dst-mac         目的 MAC</span><br><span class="line">  src-ip          源 IP</span><br><span class="line">  src-mac         源 MAC</span><br><span class="line">  src-dst-ip      源 + 目的 IP</span><br><span class="line">  src-dst-mac     源 + 目的 MAC</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置全局负载分担</span></span><br><span class="line">[SW1] load-balance src-dst-ip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看负载分担配置</span></span><br><span class="line">[SW1] display load-balance</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-生成树协议"><a href="#4-生成树协议" class="headerlink" title="4. 生成树协议"></a>4. 生成树协议</h2><h3 id="4-1-STP-基础配置"><a href="#4-1-STP-基础配置" class="headerlink" title="4.1 STP 基础配置"></a>4.1 STP 基础配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 STP</span></span><br><span class="line">[SW1] stp <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 STP 模式</span></span><br><span class="line">[SW1] stp mode stp          <span class="comment"># 标准 STP</span></span><br><span class="line">[SW1] stp mode rstp         <span class="comment"># 快速 STP（推荐）</span></span><br><span class="line">[SW1] stp mode mstp         <span class="comment"># 多实例 STP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置交换机优先级（越小越优先成为根桥）</span></span><br><span class="line">[SW1] stp priority 0        <span class="comment"># 0, 4096, 8192... 61440</span></span><br><span class="line">[SW1] stp root primary      <span class="comment"># 设为根桥</span></span><br><span class="line">[SW1] stp root secondary    <span class="comment"># 设为备份根桥</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 STP 状态</span></span><br><span class="line">[SW1] display stp</span><br><span class="line">[SW1] display stp brief</span><br></pre></td></tr></table></figure>

<h3 id="4-2-RSTP-配置"><a href="#4-2-RSTP-配置" class="headerlink" title="4.2 RSTP 配置"></a>4.2 RSTP 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 RSTP</span></span><br><span class="line">[SW1] stp mode rstp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置边缘端口（连接终端）</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] stp edged-port <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置防 BPDU 攻击</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] stp bpdu-protection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置根保护</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/24</span><br><span class="line">[SW1-GigabitEthernet0/0/24] stp root-protection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 RSTP 状态</span></span><br><span class="line">[SW1] display stp</span><br></pre></td></tr></table></figure>

<h3 id="4-3-MSTP-配置"><a href="#4-3-MSTP-配置" class="headerlink" title="4.3 MSTP 配置"></a>4.3 MSTP 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 MSTP</span></span><br><span class="line">[SW1] stp mode mstp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入 MST 域配置</span></span><br><span class="line">[SW1] stp region-configuration</span><br><span class="line">[SW1-mst-region] region-name RG1</span><br><span class="line">[SW1-mst-region] instance 1 vlan 10 20</span><br><span class="line">[SW1-mst-region] instance 2 vlan 30 40</span><br><span class="line">[SW1-mst-region] revision-level 1</span><br><span class="line">[SW1-mst-region] active region-configuration</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置实例优先级</span></span><br><span class="line">[SW1] stp instance 1 priority 0</span><br><span class="line">[SW1] stp instance 2 priority 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 MSTP 配置</span></span><br><span class="line">[SW1] display stp region-configuration</span><br><span class="line">[SW1] display stp instance 1</span><br></pre></td></tr></table></figure>

<h3 id="4-4-STP-保护功能"><a href="#4-4-STP-保护功能" class="headerlink" title="4.4 STP 保护功能"></a>4.4 STP 保护功能</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># BPDU 保护（全局）</span></span><br><span class="line">[SW1] stp bpdu-protection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根保护（接口）</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/24</span><br><span class="line">[SW1-GigabitEthernet0/0/24] stp root-protection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环路保护</span></span><br><span class="line">[SW1-GigabitEthernet0/0/24] stp loop-protection</span><br><span class="line"></span><br><span class="line"><span class="comment"># TC 保护</span></span><br><span class="line">[SW1] stp tc-protection <span class="built_in">enable</span></span><br><span class="line">[SW1] stp tc-protection threshold 10</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-路由配置"><a href="#5-路由配置" class="headerlink" title="5. 路由配置"></a>5. 路由配置</h2><h3 id="5-1-静态路由"><a href="#5-1-静态路由" class="headerlink" title="5.1 静态路由"></a>5.1 静态路由</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 IP 路由</span></span><br><span class="line">[SW1] ip routing</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置静态路由</span></span><br><span class="line">[SW1] ip route-static 192.168.100.0 255.255.255.0 10.1.1.2</span><br><span class="line">[SW1] ip route-static 0.0.0.0 0.0.0.0 10.1.1.1    <span class="comment"># 默认路由</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置浮动静态路由（通过优先级实现备份）</span></span><br><span class="line">[SW1] ip route-static 192.168.100.0 255.255.255.0 10.1.1.2 preference 60</span><br><span class="line">[SW1] ip route-static 192.168.100.0 255.255.255.0 10.1.2.2 preference 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看路由表</span></span><br><span class="line">[SW1] display ip routing-table</span><br><span class="line">[SW1] display ip routing-table protocol static</span><br></pre></td></tr></table></figure>

<h3 id="5-2-OSPF-配置"><a href="#5-2-OSPF-配置" class="headerlink" title="5.2 OSPF 配置"></a>5.2 OSPF 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 OSPF</span></span><br><span class="line">[SW1] ospf 1 router-id 1.1.1.1</span><br><span class="line">[SW1-ospf-1] area 0</span><br><span class="line">[SW1-ospf-1-area-0.0.0.0] network 192.168.10.0 0.0.0.255</span><br><span class="line">[SW1-ospf-1-area-0.0.0.0] network 192.168.20.0 0.0.0.255</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 OSPF 接口参数</span></span><br><span class="line">[SW1] interface Vlanif 10</span><br><span class="line">[SW1-Vlanif10] ospf cost 10</span><br><span class="line">[SW1-Vlanif10] ospf priority 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 OSPF 认证</span></span><br><span class="line">[SW1-ospf-1-area-0.0.0.0] authentication-mode md5 1 cipher Huawei@123</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 OSPF 信息</span></span><br><span class="line">[SW1] display ospf brief</span><br><span class="line">[SW1] display ospf peer</span><br><span class="line">[SW1] display ospf routing</span><br></pre></td></tr></table></figure>

<h3 id="5-3-VRRP-配置"><a href="#5-3-VRRP-配置" class="headerlink" title="5.3 VRRP 配置"></a>5.3 VRRP 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 VRRP 组</span></span><br><span class="line">[SW1] interface Vlanif 10</span><br><span class="line">[SW1-Vlanif10] ip address 192.168.10.2 255.255.255.0</span><br><span class="line">[SW1-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.1</span><br><span class="line">[SW1-Vlanif10] vrrp vrid 1 priority 120      <span class="comment"># 优先级（默认 100）</span></span><br><span class="line">[SW1-Vlanif10] vrrp vrid 1 preempt-mode timer delay 20</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 VRRP 认证</span></span><br><span class="line">[SW1-Vlanif10] vrrp vrid 1 authentication-mode md5 Huawei@123</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 VRRP 跟踪接口</span></span><br><span class="line">[SW1-Vlanif10] vrrp vrid 1 track interface GigabitEthernet 0/0/24 reduced 30</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 VRRP 状态</span></span><br><span class="line">[SW1] display vrrp brief</span><br><span class="line">[SW1] display vrrp</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-ACL-访问控制"><a href="#6-ACL-访问控制" class="headerlink" title="6. ACL 访问控制"></a>6. ACL 访问控制</h2><h3 id="6-1-基本-ACL（2000-2999）"><a href="#6-1-基本-ACL（2000-2999）" class="headerlink" title="6.1 基本 ACL（2000-2999）"></a>6.1 基本 ACL（2000-2999）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建基本 ACL</span></span><br><span class="line">[SW1] acl 2000</span><br><span class="line">[SW1-acl-basic-2000] rule 5 permit <span class="built_in">source</span> 192.168.10.0 0.0.0.255</span><br><span class="line">[SW1-acl-basic-2000] rule 10 deny <span class="built_in">source</span> 192.168.20.0 0.0.0.255</span><br><span class="line">[SW1-acl-basic-2000] rule 15 permit <span class="built_in">source</span> any</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用 ACL 到接口（出方向）</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] traffic-filter outbound acl 2000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 ACL</span></span><br><span class="line">[SW1] display acl 2000</span><br><span class="line">[SW1] display acl all</span><br></pre></td></tr></table></figure>

<h3 id="6-2-高级-ACL（3000-3999）"><a href="#6-2-高级-ACL（3000-3999）" class="headerlink" title="6.2 高级 ACL（3000-3999）"></a>6.2 高级 ACL（3000-3999）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建高级 ACL</span></span><br><span class="line">[SW1] acl 3000</span><br><span class="line">[SW1-acl-adv-3000] rule 5 permit ip <span class="built_in">source</span> 192.168.10.0 0.0.0.255 destination 192.168.30.0 0.0.0.255</span><br><span class="line">[SW1-acl-adv-3000] rule 10 permit tcp <span class="built_in">source</span> 192.168.10.0 0.0.0.255 destination 192.168.30.0 0.0.0.255 destination-port eq 80</span><br><span class="line">[SW1-acl-adv-3000] rule 15 deny ip <span class="built_in">source</span> any destination any</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用 ACL</span></span><br><span class="line">[SW1] interface Vlanif 10</span><br><span class="line">[SW1-Vlanif10] traffic-filter inbound acl 3000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于时间的 ACL</span></span><br><span class="line">[SW1] time-range work-time 08:00 to 18:00 working-day</span><br><span class="line">[SW1] acl 3001</span><br><span class="line">[SW1-acl-adv-3001] rule 5 permit tcp <span class="built_in">source</span> any destination any destination-port eq 80 time-range work-time</span><br></pre></td></tr></table></figure>

<h3 id="6-3-二层-ACL（4000-4999）"><a href="#6-3-二层-ACL（4000-4999）" class="headerlink" title="6.3 二层 ACL（4000-4999）"></a>6.3 二层 ACL（4000-4999）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建二层 ACL</span></span><br><span class="line">[SW1] acl 4000</span><br><span class="line">[SW1-acl-link-4000] rule 5 permit vlan-id 10</span><br><span class="line">[SW1-acl-link-4000] rule 10 deny source-mac 00e0-fc00-0001 ffff-ffff-ffff</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用二层 ACL</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] traffic-filter inbound acl 4000</span><br></pre></td></tr></table></figure>

<h3 id="6-4-ACL-日志记录"><a href="#6-4-ACL-日志记录" class="headerlink" title="6.4 ACL 日志记录"></a>6.4 ACL 日志记录</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 ACL 日志</span></span><br><span class="line">[SW1] acl 3000</span><br><span class="line">[SW1-acl-adv-3000] rule 5 deny ip <span class="built_in">source</span> any destination any logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 ACL 匹配统计</span></span><br><span class="line">[SW1] display acl 3000</span><br><span class="line">[SW1] display traffic-filter applied-record</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-QoS-配置"><a href="#7-QoS-配置" class="headerlink" title="7. QoS 配置"></a>7. QoS 配置</h2><h3 id="7-1-流量分类"><a href="#7-1-流量分类" class="headerlink" title="7.1 流量分类"></a>7.1 流量分类</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 ACL 定义流量</span></span><br><span class="line">[SW1] acl 3000</span><br><span class="line">[SW1-acl-adv-3000] rule 5 permit tcp destination-port eq 80</span><br><span class="line">[SW1-acl-adv-3000] rule 10 permit tcp destination-port eq 443</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建流分类</span></span><br><span class="line">[SW1] traffic classifier WEB</span><br><span class="line">[SW1-classifier-WEB] if-match acl 3000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建流分类（基于 DSCP）</span></span><br><span class="line">[SW1] traffic classifier VOIP</span><br><span class="line">[SW1-classifier-VOIP] if-match dscp ef</span><br></pre></td></tr></table></figure>

<h3 id="7-2-流量行为"><a href="#7-2-流量行为" class="headerlink" title="7.2 流量行为"></a>7.2 流量行为</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建流行为（重标记）</span></span><br><span class="line">[SW1] traffic behavior WEB_MARK</span><br><span class="line">[SW1-behavior-WEB_MARK] remark dscp af21</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建流行为（限速）</span></span><br><span class="line">[SW1] traffic behavior LIMIT</span><br><span class="line">[SW1-behavior-LIMIT] car cir 10000 pir 20000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建流行为（队列）</span></span><br><span class="line">[SW1] traffic behavior VOICE</span><br><span class="line">[SW1-behavior-VOICE] queue ef bandwidth pct 30</span><br></pre></td></tr></table></figure>

<h3 id="7-3-流策略"><a href="#7-3-流策略" class="headerlink" title="7.3 流策略"></a>7.3 流策略</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建流策略并绑定分类和行为</span></span><br><span class="line">[SW1] traffic policy WEB_POLICY</span><br><span class="line">[SW1-trafficpolicy-WEB_POLICY] classifier WEB behavior WEB_MARK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用流策略到接口</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] traffic-policy WEB_POLICY inbound</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看流策略</span></span><br><span class="line">[SW1] display traffic-policy WEB_POLICY</span><br><span class="line">[SW1] display traffic-policy applied-record</span><br></pre></td></tr></table></figure>

<h3 id="7-4-端口限速"><a href="#7-4-端口限速" class="headerlink" title="7.4 端口限速"></a>7.4 端口限速</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置端口入方向限速</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] qos lr inbound cir 10000 pir 20000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置端口出方向限速</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] qos lr outbound cir 50000 pir 100000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置风暴抑制</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] storm-control broadcast min-rate 1000 max-rate 2000</span><br><span class="line">[SW1-GigabitEthernet0/0/1] storm-control multicast min-rate 1000 max-rate 2000</span><br><span class="line">[SW1-GigabitEthernet0/0/1] storm-control unicast min-rate 1000 max-rate 2000</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-安全配置"><a href="#8-安全配置" class="headerlink" title="8. 安全配置"></a>8. 安全配置</h2><h3 id="8-1-端口安全"><a href="#8-1-端口安全" class="headerlink" title="8.1 端口安全"></a>8.1 端口安全</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用端口安全</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] port-security <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置最大 MAC 地址数</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] port-security max-mac-count 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置保护动作</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] port-security protect-action restrict  <span class="comment"># protect/restrict/shutdown</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Sticky MAC</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] port-security mac-address sticky</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看端口安全</span></span><br><span class="line">[SW1] display port-security</span><br><span class="line">[SW1] display mac-address</span><br></pre></td></tr></table></figure>

<h3 id="8-2-802-1X-认证"><a href="#8-2-802-1X-认证" class="headerlink" title="8.2 802.1X 认证"></a>8.2 802.1X 认证</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 802.1X</span></span><br><span class="line">[SW1] dot1x <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置认证方案</span></span><br><span class="line">[SW1] aaa</span><br><span class="line">[SW1-aaa] authentication-scheme dot1x</span><br><span class="line">[SW1-aaa-authen-dot1x] authentication-mode radius</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 RADIUS 服务器</span></span><br><span class="line">[SW1] radius-server template radius1</span><br><span class="line">[SW1-radius-radius1] radius-server authentication 192.168.100.10 1812</span><br><span class="line">[SW1-radius-radius1] radius-server shared-key cipher Huawei@123</span><br><span class="line">[SW1-radius-radius1] quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在接口启用 802.1X</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] dot1x <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 802.1X 状态</span></span><br><span class="line">[SW1] display dot1x</span><br><span class="line">[SW1] display dot1x connections</span><br></pre></td></tr></table></figure>

<h3 id="8-3-DHCP-Snooping"><a href="#8-3-DHCP-Snooping" class="headerlink" title="8.3 DHCP Snooping"></a>8.3 DHCP Snooping</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 DHCP Snooping</span></span><br><span class="line">[SW1] dhcp <span class="built_in">enable</span></span><br><span class="line">[SW1] dhcp snooping <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置信任接口（连接 DHCP 服务器）</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/24</span><br><span class="line">[SW1-GigabitEthernet0/0/24] dhcp snooping trusted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置非信任接口限速</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/1</span><br><span class="line">[SW1-GigabitEthernet0/0/1] dhcp snooping check dhcp-request <span class="built_in">enable</span></span><br><span class="line">[SW1-GigabitEthernet0/0/1] dhcp snooping check dhcp-chaddr <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 DHCP Snooping</span></span><br><span class="line">[SW1] display dhcp snooping</span><br><span class="line">[SW1] display dhcp snooping binding</span><br></pre></td></tr></table></figure>

<h3 id="8-4-DAI（动态-ARP-检测）"><a href="#8-4-DAI（动态-ARP-检测）" class="headerlink" title="8.4 DAI（动态 ARP 检测）"></a>8.4 DAI（动态 ARP 检测）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 DAI</span></span><br><span class="line">[SW1] arp anti-attack check user-bind <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 VLAN 启用 DAI</span></span><br><span class="line">[SW1] vlan 10</span><br><span class="line">[SW1-vlan10] arp anti-attack dynamic-check <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置信任接口</span></span><br><span class="line">[SW1] interface GigabitEthernet 0/0/24</span><br><span class="line">[SW1-GigabitEthernet0/0/24] arp anti-attack trust <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 DAI</span></span><br><span class="line">[SW1] display arp anti-attack statistics</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-管理与维护"><a href="#9-管理与维护" class="headerlink" title="9. 管理与维护"></a>9. 管理与维护</h2><h3 id="9-1-SSH-配置"><a href="#9-1-SSH-配置" class="headerlink" title="9.1 SSH 配置"></a>9.1 SSH 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成本地密钥对</span></span><br><span class="line">[SW1] rsa local-key-pair create</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用 SSH 服务</span></span><br><span class="line">[SW1] stelnet server <span class="built_in">enable</span></span><br><span class="line">[SW1] sftp server <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建本地用户</span></span><br><span class="line">[SW1] aaa</span><br><span class="line">[SW1-aaa] local-user admin password irreversible-cipher Huawei@123</span><br><span class="line">[SW1-aaa] local-user admin privilege level 15</span><br><span class="line">[SW1-aaa] local-user admin service-type ssh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 SSH 用户认证</span></span><br><span class="line">[SW1] ssh user admin authentication-type password</span><br><span class="line">[SW1] ssh user admin service-type stelnet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 VTY 支持 SSH</span></span><br><span class="line">[SW1] user-interface vty 0 4</span><br><span class="line">[SW1-ui-vty0-4] authentication-mode aaa</span><br><span class="line">[SW1-ui-vty0-4] protocol inbound ssh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 SSH 信息</span></span><br><span class="line">[SW1] display ssh server status</span><br><span class="line">[SW1] display ssh user-information</span><br></pre></td></tr></table></figure>

<h3 id="9-2-SNMP-配置"><a href="#9-2-SNMP-配置" class="headerlink" title="9.2 SNMP 配置"></a>9.2 SNMP 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 SNMP</span></span><br><span class="line">[SW1] snmp-agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 SNMP 版本</span></span><br><span class="line">[SW1] snmp-agent sys-info version v3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置团体名（v2c）</span></span><br><span class="line">[SW1] snmp-agent community <span class="built_in">read</span> cipher public</span><br><span class="line">[SW1] snmp-agent community write cipher private</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 SNMPv3 用户</span></span><br><span class="line">[SW1] snmp-agent usm-user v3 admin</span><br><span class="line">[SW1] snmp-agent usm-user v3 admin authentication-mode sha</span><br><span class="line">[SW1] snmp-agent usm-user v3 admin privacy-mode aes128</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Trap 目标</span></span><br><span class="line">[SW1] snmp-agent target-host <span class="built_in">trap</span> address udp-domain 192.168.100.100 params securityname public v2c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 SNMP</span></span><br><span class="line">[SW1] display snmp-agent sys-info</span><br></pre></td></tr></table></figure>

<h3 id="9-3-NTP-配置"><a href="#9-3-NTP-配置" class="headerlink" title="9.3 NTP 配置"></a>9.3 NTP 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 NTP</span></span><br><span class="line">[SW1] ntp <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 NTP 服务器</span></span><br><span class="line">[SW1] ntp-server 192.168.100.10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 NTP 认证</span></span><br><span class="line">[SW1] ntp-service authentication <span class="built_in">enable</span></span><br><span class="line">[SW1] ntp-service authentication-keyid 1 authentication-mode md5 Huawei@123</span><br><span class="line">[SW1] ntp-service trusted authentication-keyid 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 NTP 状态</span></span><br><span class="line">[SW1] display ntp-service status</span><br><span class="line">[SW1] display ntp-service sessions</span><br></pre></td></tr></table></figure>

<h3 id="9-4-日志配置"><a href="#9-4-日志配置" class="headerlink" title="9.4 日志配置"></a>9.4 日志配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用日志中心</span></span><br><span class="line">[SW1] info-center <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志主机</span></span><br><span class="line">[SW1] info-center loghost 192.168.100.100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志级别</span></span><br><span class="line">[SW1] info-center <span class="built_in">source</span> DHCP <span class="built_in">log</span> level warning</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志缓冲区</span></span><br><span class="line">[SW1] info-center logbuffer size 1024</span><br><span class="line">[SW1] info-center logbuffer level informational</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">[SW1] display logbuffer</span><br><span class="line">[SW1] display trapbuffer</span><br><span class="line">[SW1] terminal monitor</span><br><span class="line">[SW1] terminal logging</span><br></pre></td></tr></table></figure>

<h3 id="9-5-设备维护命令"><a href="#9-5-设备维护命令" class="headerlink" title="9.5 设备维护命令"></a>9.5 设备维护命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看设备信息</span></span><br><span class="line">&lt;SW1&gt; display device                    <span class="comment"># 查看硬件信息</span></span><br><span class="line">&lt;SW1&gt; display version                   <span class="comment"># 查看版本信息</span></span><br><span class="line">&lt;SW1&gt; display elabel                    <span class="comment"># 查看电子标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 CPU 和内存</span></span><br><span class="line">&lt;SW1&gt; display cpu-usage                 <span class="comment"># CPU 使用率</span></span><br><span class="line">&lt;SW1&gt; display memory-usage              <span class="comment"># 内存使用率</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看温度和环境</span></span><br><span class="line">&lt;SW1&gt; display environment               <span class="comment"># 环境信息</span></span><br><span class="line">&lt;SW1&gt; display fan                       <span class="comment"># 风扇状态</span></span><br><span class="line">&lt;SW1&gt; display power                     <span class="comment"># 电源状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 诊断命令</span></span><br><span class="line">&lt;SW1&gt; ping 192.168.1.1                  <span class="comment"># Ping 测试</span></span><br><span class="line">&lt;SW1&gt; tracert 192.168.1.1               <span class="comment"># 路由追踪</span></span><br><span class="line">&lt;SW1&gt; telnet 192.168.1.1                <span class="comment"># Telnet 测试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启设备</span></span><br><span class="line">&lt;SW1&gt; reboot                            <span class="comment"># 重启</span></span><br><span class="line">&lt;SW1&gt; reset saved-configuration         <span class="comment"># 清除保存配置</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>文档版本</strong>: 1.0<br><strong>最后更新</strong>: 2026-02-27<br><strong>适用设备</strong>: 华为 S5700&#x2F;S6700&#x2F;S7700&#x2F;S9700 系列交换机</p>
]]></content>
      <categories>
        <category>硬件部署与运维管理</category>
      </categories>
  </entry>
  <entry>
    <title>dpdk占用导致网口消失问题排查</title>
    <url>/2026/02/26/dpdk%E5%8D%A0%E7%94%A8%E6%8E%92%E6%9F%A5/</url>
    <content><![CDATA[<p>当网卡“消失”且怀疑被 DPDK 程序占用时（如 <code>eth0</code> 在 <code>ip link</code> 中不可见，但 <code>lspci</code> 仍能识别硬件），核心原因是：<strong>DPDK 通过 UIO&#x2F;VFIO 驱动将网卡从内核解绑，移交至用户态程序控制</strong>。以下是精准排查与定位方法：</p>
<hr>
<h3 id="🔍-三步定位：是否被-DPDK-占用-谁在占用"><a href="#🔍-三步定位：是否被-DPDK-占用-谁在占用" class="headerlink" title="🔍 三步定位：是否被 DPDK 占用 + 谁在占用"></a>🔍 三步定位：是否被 DPDK 占用 + 谁在占用</h3><h4 id="✅-第一步：确认网卡是否被绑定到-DPDK-驱动"><a href="#✅-第一步：确认网卡是否被绑定到-DPDK-驱动" class="headerlink" title="✅ 第一步：确认网卡是否被绑定到 DPDK 驱动"></a>✅ 第一步：确认网卡是否被绑定到 DPDK 驱动</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 找到网卡 PCI 地址（示例）</span></span><br><span class="line">lspci -nn | grep -i ethernet</span><br><span class="line"><span class="comment"># 输出示例：01:00.0 Ethernet controller [0200]: Intel Corporation ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查当前绑定的驱动</span></span><br><span class="line">lspci -k -s 0000:01:00.0  <span class="comment"># 替换为实际 PCI 地址</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>关键判断</strong>：<br><code>Kernel driver in use: igb_uio</code> &#x2F; <code>vfio-pci</code> &#x2F; <code>uio_pci_generic</code> → <strong>已被 DPDK 占用</strong><br><code>Kernel driver in use: ixgbe</code> &#x2F; <code>e1000e</code> 等 → 未被 DPDK 占用（排查其他原因）</li>
</ul>
<h4 id="✅-第二步：定位占用进程（核心！）"><a href="#✅-第二步：定位占用进程（核心！）" class="headerlink" title="✅ 第二步：定位占用进程（核心！）"></a>✅ 第二步：定位占用进程（核心！）</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法1：检查打开的 UIO/VFIO 设备（最直接）</span></span><br><span class="line"><span class="built_in">sudo</span> lsof /dev/uio* /dev/vfio/* 2&gt;/dev/null | grep -v <span class="string">&quot;COMMAND&quot;</span></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="built_in">sudo</span> fuser -v /dev/uio* /dev/vfio/* 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2：扫描所有进程的 fd（需 root）</span></span><br><span class="line"><span class="built_in">sudo</span> find /proc/[0-9]*/fd -lname <span class="string">&quot;*uio*&quot;</span> -o -lname <span class="string">&quot;*vfio*&quot;</span> 2&gt;/dev/null | \</span><br><span class="line">  <span class="keyword">while</span> <span class="built_in">read</span> fd; <span class="keyword">do</span> </span><br><span class="line">    pid=$(<span class="built_in">echo</span> <span class="variable">$fd</span> | <span class="built_in">cut</span> -d/ -f3)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;PID: <span class="variable">$pid</span> | <span class="subst">$(ps -p $pid -o comm= 2&gt;/dev/null || echo &#x27;terminated&#x27;)</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法3：检查 DPDK 进程特征</span></span><br><span class="line">ps aux | grep -E <span class="string">&quot;testpmd|l2fwd|l3fwd|dpdk|ovs|vpp|fd.io&quot;</span> | grep -v grep</span><br><span class="line">pgrep -a -f <span class="string">&quot;dpdk|testpmd&quot;</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>输出示例</strong>：<br><code>testpmd 12345 root 5u CHR 241,0 ... /dev/uio0</code> → PID 12345 的 testpmd 占用</li>
</ul>
<h4 id="✅-第三步：辅助验证（增强可信度）"><a href="#✅-第三步：辅助验证（增强可信度）" class="headerlink" title="✅ 第三步：辅助验证（增强可信度）"></a>✅ 第三步：辅助验证（增强可信度）</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 DPDK 绑定工具状态（若已安装）</span></span><br><span class="line">dpdk-devbind.py --status 2&gt;/dev/null | grep -A 5 <span class="string">&quot;0000:01:00.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查内核日志（绑定时间点）</span></span><br><span class="line">dmesg | grep -i <span class="string">&quot;uio\|vfio\|bound to driver&quot;</span> | <span class="built_in">tail</span> -20</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 UIO 设备关联</span></span><br><span class="line"><span class="built_in">ls</span> -l /sys/class/uio/ 2&gt;/dev/null &amp;&amp; <span class="built_in">cat</span> /sys/class/uio/uio*/name</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="📌-关键特征总结（快速判断）"><a href="#📌-关键特征总结（快速判断）" class="headerlink" title="📌 关键特征总结（快速判断）"></a>📌 关键特征总结（快速判断）</h3><table>
<thead>
<tr>
<th>现象</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>lspci</code> 能看到网卡，但 <code>ip link</code> 无对应接口</td>
<td><strong>高度疑似 DPDK 占用</strong></td>
</tr>
<tr>
<td><code>lspci -k</code> 显示驱动为 <code>igb_uio</code>&#x2F;<code>vfio-pci</code></td>
<td><strong>确认被 DPDK 驱动接管</strong></td>
</tr>
<tr>
<td><code>/dev/uio*</code> 或 <code>/dev/vfio/*</code> 被进程打开</td>
<td><strong>直接定位占用程序</strong></td>
</tr>
<tr>
<td><code>dpdk-devbind.py --status</code> 标注 “drv&#x3D;igb_uio”</td>
<td><strong>DPDK 绑定状态明确</strong></td>
</tr>
</tbody></table>
<hr>
<h3 id="⚠️-注意事项"><a href="#⚠️-注意事项" class="headerlink" title="⚠️ 注意事项"></a>⚠️ 注意事项</h3><ol>
<li><strong>权限要求</strong>：<code>lsof</code>&#x2F;<code>fuser</code>&#x2F;<code>/proc</code> 扫描需 <code>root</code> 权限，否则可能漏检。</li>
<li><strong>进程已退出但驱动未解绑</strong>：  <ul>
<li>若 <code>lsof</code> 无输出但驱动仍为 <code>igb_uio</code>，说明进程已退出但未释放设备。  </li>
<li><strong>恢复方法</strong>：  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0000:01:00.0&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /sys/bus/pci/drivers/igb_uio/unbind</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0000:01:00.0&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /sys/bus/pci/drivers/ixgbe/bind  <span class="comment"># 替换为原驱动名</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><strong>云环境&#x2F;容器</strong>：  <ul>
<li>容器内运行的 DPDK 程序需在宿主机排查（检查宿主机 <code>/dev</code> 和进程）。</li>
<li>云平台（如阿里云）需确认是否启用 SR-IOV + VF 被 DPDK 占用。</li>
</ul>
</li>
<li><strong>安全操作</strong>：  <ul>
<li><strong>切勿直接 kill 进程</strong>！先确认业务影响（如 OVS-DPDK、VPP、自研转发程序）。  </li>
<li>恢复网卡前，确保 DPDK 程序已安全停止。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="💡-一句话总结"><a href="#💡-一句话总结" class="headerlink" title="💡 一句话总结"></a>💡 一句话总结</h3><blockquote>
<p><strong>“网卡硬件存在但内核看不见” + “驱动显示 igb_uio&#x2F;vfio-pci” &#x3D; DPDK 占用；用 <code>lsof /dev/uio*</code> 或扫描 <code>/proc/*/fd</code> 精准定位占用进程。</strong></p>
</blockquote>
<p>通过以上方法，可快速区分“命名规则变更”与“DPDK 占用”，避免误判。如需进一步分析，提供 <code>lspci -k -s &lt;PCI&gt;</code> 和 <code>lsof /dev/uio*</code> 输出即可精准定位。</p>
]]></content>
      <categories>
        <category>故障处理与问题排查</category>
      </categories>
  </entry>
  <entry>
    <title>Hexo + GitHub Pages 搭建个人博客全流程指南</title>
    <url>/2026/02/26/hexo_github%E9%83%A8%E7%BD%B2%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<h1 id="🌐-Hexo-GitHub-Pages-搭建个人博客全流程指南（2024-最新版）"><a href="#🌐-Hexo-GitHub-Pages-搭建个人博客全流程指南（2024-最新版）" class="headerlink" title="🌐 Hexo + GitHub Pages 搭建个人博客全流程指南（2024 最新版）"></a>🌐 Hexo + GitHub Pages 搭建个人博客全流程指南（2024 最新版）</h1><blockquote>
<p>💡 本指南适用于 Windows&#x2F;macOS&#x2F;Linux，全程约 30 分钟，附关键避坑提示</p>
</blockquote>
<hr>
<h2 id="🔑-一、前置准备"><a href="#🔑-一、前置准备" class="headerlink" title="🔑 一、前置准备"></a>🔑 一、前置准备</h2><table>
<thead>
<tr>
<th>项目</th>
<th>要求</th>
<th>验证命令</th>
</tr>
</thead>
<tbody><tr>
<td>GitHub 账号</td>
<td><a href="https://github.com/">注册地址</a></td>
<td>-</td>
</tr>
<tr>
<td>Node.js (LTS)</td>
<td>≥ 18.x</td>
<td><code>node -v</code> <code>npm -v</code></td>
</tr>
<tr>
<td>Git</td>
<td>≥ 2.30</td>
<td><code>git --version</code></td>
</tr>
<tr>
<td>编辑器</td>
<td>VS Code &#x2F; Typora 等</td>
<td>-</td>
</tr>
</tbody></table>
<p>✅ <strong>加速建议（国内用户）</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置 npm 淘宝镜像</span></span><br><span class="line">npm config <span class="built_in">set</span> registry https://registry.npmmirror.com</span><br><span class="line"><span class="comment"># 可选：安装 cnpm</span></span><br><span class="line">npm install -g cnpm --registry=https://registry.npmmirror.com</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📦-二、安装与初始化-Hexo"><a href="#📦-二、安装与初始化-Hexo" class="headerlink" title="📦 二、安装与初始化 Hexo"></a>📦 二、安装与初始化 Hexo</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 全局安装 Hexo CLI</span></span><br><span class="line">npm install -g hexo-cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建博客目录（my-blog 可自定义）</span></span><br><span class="line">hexo init my-blog</span><br><span class="line"><span class="built_in">cd</span> my-blog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 安装依赖（国内建议用 cnpm）</span></span><br><span class="line">npm install  <span class="comment"># 或 cnpm install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 本地预览（浏览器访问 http://localhost:4000）</span></span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</span><br></pre></td></tr></table></figure>
<p>✅ 出现 Hexo 默认欢迎页即成功！</p>
<hr>
<h2 id="🎨-三、个性化配置（关键步骤）"><a href="#🎨-三、个性化配置（关键步骤）" class="headerlink" title="🎨 三、个性化配置（关键步骤）"></a>🎨 三、个性化配置（关键步骤）</h2><h3 id="1️⃣-基础配置（-config-yml）"><a href="#1️⃣-基础配置（-config-yml）" class="headerlink" title="1️⃣ 基础配置（_config.yml）"></a>1️⃣ 基础配置（<code>_config.yml</code>）</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 站点信息</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">我的博客</span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">记录成长</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">你的名字</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-CN</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL（部署后修改为你的域名）</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://yourname.github.io</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成设置</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:title/</span></span><br><span class="line"><span class="attr">permalink_defaults:</span></span><br></pre></td></tr></table></figure>

<h3 id="2️⃣-安装主题（以-Butterfly-为例）"><a href="#2️⃣-安装主题（以-Butterfly-为例）" class="headerlink" title="2️⃣ 安装主题（以 Butterfly 为例）"></a>2️⃣ 安装主题（以 Butterfly 为例）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入 themes 目录</span></span><br><span class="line"><span class="built_in">cd</span> themes</span><br><span class="line">git <span class="built_in">clone</span> -b master https://github.com/jerryc127/hexo-theme-butterfly.git butterfly</span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 _config.yml</span></span><br><span class="line">theme: butterfly</span><br></pre></td></tr></table></figure>
<p>📌 <strong>主题配置</strong>：<br>复制 <code>themes/butterfly/_config.yml.example</code> 为 <code>_config.butterfly.yml</code>，按需修改（菜单、评论、SEO等）</p>
<h3 id="3️⃣-常用插件（按需安装）"><a href="#3️⃣-常用插件（按需安装）" class="headerlink" title="3️⃣ 常用插件（按需安装）"></a>3️⃣ 常用插件（按需安装）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-searchdb --save    <span class="comment"># 站内搜索</span></span><br><span class="line">npm install hexo-wordcount --save            <span class="comment"># 字数统计</span></span><br><span class="line">npm install hexo-abbrlink --save             <span class="comment"># 永久链接（避免中文路径问题）</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📝-四、撰写与预览"><a href="#📝-四、撰写与预览" class="headerlink" title="📝 四、撰写与预览"></a>📝 四、撰写与预览</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建新文章（自动在 source/_posts/ 生成 .md 文件）</span></span><br><span class="line">hexo new <span class="string">&quot;我的第一篇博客&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地实时预览（修改后自动刷新）</span></span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo s --debug</span><br></pre></td></tr></table></figure>
<p>✨ <strong>写作技巧</strong>：</p>
<ul>
<li>使用 Markdown 编辑（推荐 Typora&#x2F;VS Code + Markdown 插件）</li>
<li>图片建议存入 <code>source/images/</code>，引用相对路径</li>
<li>文章 Front-matter 添加分类&#x2F;标签：<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">示例</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2024-02-26</span></span><br><span class="line"><span class="attr">tags:</span> [<span class="string">Hexo</span>, <span class="string">教程</span>]</span><br><span class="line"><span class="attr">categories:</span> <span class="string">技术</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="🚀-五、部署到-GitHub-Pages（核心步骤）"><a href="#🚀-五、部署到-GitHub-Pages（核心步骤）" class="headerlink" title="🚀 五、部署到 GitHub Pages（核心步骤）"></a>🚀 五、部署到 GitHub Pages（核心步骤）</h2><h3 id="1️⃣-创建仓库"><a href="#1️⃣-创建仓库" class="headerlink" title="1️⃣ 创建仓库"></a>1️⃣ 创建仓库</h3><ul>
<li>仓库名必须为：<code>你的GitHub用户名.github.io</code>（如 <code>zhangsan.github.io</code>）</li>
<li>选择 <strong>Public</strong>（免费用户私有仓库无法启用 Pages）</li>
</ul>
<h3 id="2️⃣-配置-SSH-密钥（免密部署）"><a href="#2️⃣-配置-SSH-密钥（免密部署）" class="headerlink" title="2️⃣ 配置 SSH 密钥（免密部署）"></a>2️⃣ 配置 SSH 密钥（免密部署）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成密钥（一路回车）</span></span><br><span class="line">ssh-keygen -t ed25519 -C <span class="string">&quot;your_email@example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制公钥内容</span></span><br><span class="line"><span class="built_in">cat</span> ~/.ssh/id_ed25519.pub  <span class="comment"># Windows: type %USERPROFILE%\.ssh\id_ed25519.pub</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GitHub 操作：</span></span><br><span class="line"><span class="comment"># Settings → SSH and GPG keys → New SSH key → 粘贴公钥</span></span><br></pre></td></tr></table></figure>
<p>✅ 测试连接：<code>ssh -T git@github.com</code>（看到 “Hi xxx! You’ve successfully authenticated” 即成功）</p>
<h3 id="3️⃣-配置部署（-config-yml-末尾）"><a href="#3️⃣-配置部署（-config-yml-末尾）" class="headerlink" title="3️⃣ 配置部署（_config.yml 末尾）"></a>3️⃣ 配置部署（<code>_config.yml</code> 末尾）</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">git@github.com:你的用户名/你的用户名.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">main</span>  <span class="comment"># ⚠️ 重要：确认仓库默认分支名（新版 GitHub 为 main）</span></span><br></pre></td></tr></table></figure>

<h3 id="4️⃣-安装部署插件-部署"><a href="#4️⃣-安装部署插件-部署" class="headerlink" title="4️⃣ 安装部署插件 &amp; 部署"></a>4️⃣ 安装部署插件 &amp; 部署</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo deploy</span><br></pre></td></tr></table></figure>
<p>🌐 访问：<code>https://你的用户名.github.io</code>（首次部署需等待 2-5 分钟）</p>
<hr>
<h2 id="🌍-六、绑定自定义域名（可选但推荐）"><a href="#🌍-六、绑定自定义域名（可选但推荐）" class="headerlink" title="🌍 六、绑定自定义域名（可选但推荐）"></a>🌍 六、绑定自定义域名（可选但推荐）</h2><ol>
<li><strong>购买域名</strong>（阿里云&#x2F;腾讯云等）</li>
<li><strong>添加 CNAME 文件</strong>：<ul>
<li>在 <code>source/</code> 目录新建 <code>CNAME</code> 文件（无后缀），内容为：<code>www.yourdomain.com</code></li>
</ul>
</li>
<li><strong>DNS 解析设置</strong>：<ul>
<li>A 记录 → 指向 GitHub Pages IP（任选其一）：<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">185.199.108.153</span><br><span class="line">185.199.109.153</span><br><span class="line">185.199.110.153</span><br><span class="line">185.199.111.153</span><br></pre></td></tr></table></figure></li>
<li>或 CNAME 记录 → 指向 <code>你的用户名.github.io</code></li>
</ul>
</li>
<li><strong>GitHub 仓库设置</strong>：<ul>
<li>Settings → Pages → Custom domain 填写域名 → 勾选 ✅ Enforce HTTPS</li>
</ul>
</li>
</ol>
<hr>
<h2 id="🛠️-七、高频问题解决方案"><a href="#🛠️-七、高频问题解决方案" class="headerlink" title="🛠️ 七、高频问题解决方案"></a>🛠️ 七、高频问题解决方案</h2><table>
<thead>
<tr>
<th>问题</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td>部署失败&#x2F;权限错误</td>
<td>检查 SSH 密钥是否添加；<code>ssh -T git@github.com</code> 测试</td>
</tr>
<tr>
<td>页面空白&#x2F;样式丢失</td>
<td>检查 <code>_config.yml</code> 中 <code>url</code> 是否为部署后地址；清除浏览器缓存</td>
</tr>
<tr>
<td>中文路径 404</td>
<td>安装 <code>hexo-abbrlink</code> 插件，配置永久链接</td>
</tr>
<tr>
<td>图片不显示</td>
<td>使用相对路径；或设置 <code>_config.yml</code> 中 <code>post_asset_folder: true</code></td>
</tr>
<tr>
<td>部署后内容未更新</td>
<td><code>hexo clean</code> 清除缓存后重新部署</td>
</tr>
<tr>
<td>GitHub Pages 未生效</td>
<td>检查仓库 Settings → Pages → Branch 是否为 main&#x2F;gh-pages</td>
</tr>
</tbody></table>
<hr>
<h2 id="🔒-八、维护与进阶建议"><a href="#🔒-八、维护与进阶建议" class="headerlink" title="🔒 八、维护与进阶建议"></a>🔒 八、维护与进阶建议</h2><ul>
<li><strong>备份源码</strong>：将整个 <code>my-blog</code> 目录（含 <code>source/</code>, <code>themes/</code>, <code>_config.yml</code>）存至私有仓库或网盘</li>
<li><strong>自动化部署</strong>：配置 GitHub Actions 实现 push 后自动构建（适合高级用户）</li>
<li><strong>增强功能</strong>：<ul>
<li>评论系统：Valine &#x2F; Waline &#x2F; Gitalk</li>
<li>统计：Google Analytics &#x2F; 不蒜子</li>
<li>SEO：sitemap + robots.txt</li>
</ul>
</li>
<li><strong>更新组件</strong>：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm update hexo-cli -g      <span class="comment"># 更新 Hexo</span></span><br><span class="line"><span class="built_in">cd</span> themes/butterfly &amp;&amp; git pull  <span class="comment"># 更新主题</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="💡-最后提醒"><a href="#💡-最后提醒" class="headerlink" title="💡 最后提醒"></a>💡 最后提醒</h2><ol>
<li><strong>不要删除 <code>.deploy_git</code> 目录</strong>（部署缓存，但无需备份）</li>
<li><strong>所有修改均在本地完成</strong>，部署仅推送生成的静态文件</li>
<li>遇到问题优先查阅：<ul>
<li><a href="https://hexo.io/zh-cn/docs/">Hexo 官方文档</a></li>
<li>主题 GitHub Issues</li>
<li>搜索错误关键词 + “Hexo”</li>
</ul>
</li>
</ol>
<p>✨ 恭喜！你的专属技术博客已上线！坚持写作，让知识流动起来～<br>如有细节疑问，欢迎提供具体报错信息进一步分析！</p>
]]></content>
      <categories>
        <category>经验分享</category>
      </categories>
  </entry>
  <entry>
    <title>Linux系统中网口消失问题排查</title>
    <url>/2026/02/27/%E7%BD%91%E5%8F%A3%E4%B8%8D%E8%A7%81%E6%8E%92%E6%9F%A5/</url>
    <content><![CDATA[<p>在 Linux 运维中，“网口不见了”（如找不到 <code>eth0</code>）是高频问题，<strong>绝大多数情况并非硬件故障，而是命名规则变更或驱动&#x2F;配置问题</strong>。以下是系统性分析与排查指南：</p>
<hr>
<h3 id="🔍-核心原因分类（按发生频率排序）"><a href="#🔍-核心原因分类（按发生频率排序）" class="headerlink" title="🔍 核心原因分类（按发生频率排序）"></a>🔍 核心原因分类（按发生频率排序）</h3><h4 id="1️⃣-网络接口命名规则变更（最常见！）"><a href="#1️⃣-网络接口命名规则变更（最常见！）" class="headerlink" title="1️⃣ 网络接口命名规则变更（最常见！）"></a>1️⃣ <strong>网络接口命名规则变更（最常见！）</strong></h4><ul>
<li><strong>现象</strong>：系统实际存在网卡，但名称变为 <code>enp0s3</code>、<code>ens192</code>、<code>eno1</code> 等（systemd ≥ 197 的“可预测命名”）。</li>
<li><strong>原因</strong>：现代发行版（CentOS 7+&#x2F;RHEL 7+、Ubuntu 15.10+ 等）默认启用此规则，避免驱动加载顺序导致名称漂移。</li>
<li><strong>验证</strong>：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ip <span class="built_in">link</span> show          <span class="comment"># 查看所有接口（含 DOWN 状态）</span></span><br><span class="line"><span class="built_in">ls</span> /sys/class/net/    <span class="comment"># 直接列出内核识别的接口</span></span><br></pre></td></tr></table></figure>
若看到非 <code>eth*</code> 名称，即属此情况。</li>
</ul>
<h4 id="2️⃣-驱动未加载或加载失败"><a href="#2️⃣-驱动未加载或加载失败" class="headerlink" title="2️⃣ 驱动未加载或加载失败"></a>2️⃣ <strong>驱动未加载或加载失败</strong></h4><ul>
<li>驱动缺失&#x2F;未编译进内核、initramfs 未包含驱动（内核升级后常见）、驱动被黑名单禁用、硬件不兼容。</li>
<li><strong>排查</strong>：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lspci -k | grep -A 3 -i ethernet  <span class="comment"># 查看网卡及绑定驱动</span></span><br><span class="line">dmesg | grep -i <span class="string">&quot;eth\|error\|fail&quot;</span> <span class="comment"># 检查内核日志错误</span></span><br><span class="line">lsmod | grep &lt;驱动名&gt;              <span class="comment"># 确认模块是否加载</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3️⃣-硬件或虚拟化层问题"><a href="#3️⃣-硬件或虚拟化层问题" class="headerlink" title="3️⃣ 硬件或虚拟化层问题"></a>3️⃣ <strong>硬件或虚拟化层问题</strong></h4><ul>
<li>物理：网卡松动、BIOS&#x2F;UEFI 中禁用板载网卡、硬件故障。</li>
<li>虚拟化：VM 未添加虚拟网卡、快照恢复后 MAC 变化导致 udev 重命名、云平台（AWS&#x2F;Aliyun）ENI 未挂载。</li>
<li><strong>排查</strong>：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lspci | grep -i ethernet  <span class="comment"># 确认硬件是否被识别</span></span><br><span class="line"><span class="comment"># 虚拟机：检查 Hypervisor 配置；云平台：控制台确认网络接口状态</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="4️⃣-配置或环境干扰"><a href="#4️⃣-配置或环境干扰" class="headerlink" title="4️⃣ 配置或环境干扰"></a>4️⃣ <strong>配置或环境干扰</strong></h4><ul>
<li>udev 规则覆盖（<code>/etc/udev/rules.d/</code> 中自定义命名规则）</li>
<li>容器环境：未共享主机网络命名空间（如 Docker 默认桥接模式下容器内无 <code>eth0</code>）</li>
<li>命令误区：<code>ifconfig</code>（已弃用）可能不显示 DOWN 接口；应使用 <code>ip link</code></li>
<li>安全策略：SELinux&#x2F;AppArmor 限制（罕见）</li>
</ul>
<hr>
<h3 id="🛠️-高效排查流程（建议顺序执行）"><a href="#🛠️-高效排查流程（建议顺序执行）" class="headerlink" title="🛠️ 高效排查流程（建议顺序执行）"></a>🛠️ 高效排查流程（建议顺序执行）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 确认接口是否存在（关键第一步！）</span></span><br><span class="line">ip -br <span class="built_in">link</span> show        <span class="comment"># 简洁列出所有接口状态</span></span><br><span class="line"><span class="built_in">ls</span> /sys/class/net/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查硬件识别</span></span><br><span class="line">lspci | grep -i ether   <span class="comment"># 有线网卡</span></span><br><span class="line">lsusb | grep -i net     <span class="comment"># USB网卡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查驱动与内核日志</span></span><br><span class="line">dmesg | <span class="built_in">tail</span> -100 | grep -i <span class="string">&quot;net\|eth\|fail&quot;</span></span><br><span class="line">journalctl -b -u systemd-udevd --no-pager | grep -i net</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 检查命名规则干扰</span></span><br><span class="line"><span class="built_in">cat</span> /etc/udev/rules.d/*net*.rules 2&gt;/dev/null</span><br><span class="line"><span class="built_in">cat</span> /proc/cmdline | grep -E <span class="string">&quot;net.ifnames|biosdevname&quot;</span>  <span class="comment"># 查看启动参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 虚拟化/云环境专项</span></span><br><span class="line"><span class="comment"># - VM：检查虚拟机设置、快照历史</span></span><br><span class="line"><span class="comment"># - 云主机：控制台确认弹性网卡状态、实例元数据</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="💡-常见解决方案"><a href="#💡-常见解决方案" class="headerlink" title="💡 常见解决方案"></a>💡 常见解决方案</h3><table>
<thead>
<tr>
<th>场景</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td><strong>仅命名变化</strong></td>
<td>接受新名称（推荐）；或启动参数加 <code>net.ifnames=0 biosdevname=0</code> → <code>update-grub</code> → 重启</td>
</tr>
<tr>
<td><strong>驱动缺失</strong></td>
<td>安装驱动 → <code>update-initramfs -u</code> (Debian) &#x2F; <code>dracut -f</code> (RHEL) → 重启</td>
</tr>
<tr>
<td><strong>udev 规则干扰</strong></td>
<td>检查 <code>/etc/udev/rules.d/</code>，临时移除自定义规则测试</td>
</tr>
<tr>
<td><strong>虚拟机 MAC 变化</strong></td>
<td>清理 <code>/etc/udev/rules.d/70-persistent-net.rules</code>（旧系统）或重置 VM 网卡</td>
</tr>
<tr>
<td><strong>容器内无 eth0</strong></td>
<td>检查容器网络模式（<code>--network host</code> 可共享主机接口）</td>
</tr>
</tbody></table>
<hr>
<h3 id="✅-重要提醒"><a href="#✅-重要提醒" class="headerlink" title="✅ 重要提醒"></a>✅ 重要提醒</h3><ul>
<li><strong>优先使用 <code>ip</code> 命令</strong>：<code>ifconfig</code> 已过时且行为不一致（如某些版本隐藏 DOWN 接口）。</li>
<li><strong>“看不见” ≠ “不存在”</strong>：90% 以上是命名规则变化，先执行 <code>ip link</code> 确认。</li>
<li><strong>修改前备份</strong>：调整 GRUB 参数或 udev 规则前务必备份。</li>
<li><strong>云环境特殊性</strong>：阿里云&#x2F;腾讯云等需结合控制台操作（如重启实例、重置网络）。</li>
</ul>
<p>通过以上步骤，可快速定位问题根源。如仍无法解决，提供 <code>ip link</code>、<code>lspci -k</code>、<code>dmesg | grep -i eth</code> 的输出可进一步精准分析。</p>
]]></content>
      <categories>
        <category>故障处理与问题排查</category>
      </categories>
  </entry>
  <entry>
    <title>P4-vSwitch实验环境部署和实验操作简要手册</title>
    <url>/2026/02/27/p4-vswitch-install/</url>
    <content><![CDATA[<h1 id="目录-目录-TOC-Heading"><a href="#目录-目录-TOC-Heading" class="headerlink" title="目录 {#目录 .TOC-Heading}"></a>目录 {#目录 .TOC-Heading}</h1><p><a href="#%E6%A6%82%E8%BF%B0">1 概述 <a href="#%E6%A6%82%E8%BF%B0">5</a></a></p>
<p><a href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF">1.1 项目背景 <a href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF">5</a></a></p>
<p><a href="#%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF">1.2 环境信息 <a href="#%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF">5</a></a></p>
<p><a href="#%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2">2 环境部署 <a href="#%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2">6</a></a></p>
<p><a href="#%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85">2.1 系统安装 <a href="#%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85">6</a></a></p>
<p><a href="#switch%E8%8A%82%E7%82%B9">2.2 Switch节点 <a href="#switch%E8%8A%82%E7%82%B9">6</a></a></p>
<p><a href="#generator%E8%8A%82%E7%82%B9receiver%E8%8A%82%E7%82%B9">2.3 Generator节点&#x2F;Receiver节点<br><a href="#generator%E8%8A%82%E7%82%B9receiver%E8%8A%82%E7%82%B9">11</a></a></p>
<p><a href="#l2_switch%E5%AE%9E%E9%AA%8C">3 l2_switch实验 <a href="#l2_switch%E5%AE%9E%E9%AA%8C">14</a></a></p>
<p><a href="#%E5%AE%9E%E9%AA%8C%E5%87%86%E5%A4%87">3.1 实验准备 <a href="#%E5%AE%9E%E9%AA%8C%E5%87%86%E5%A4%87">14</a></a></p>
<p><a href="#%E5%AE%9E%E9%AA%8C%E6%93%8D%E4%BD%9C">3.2 实验操作 <a href="#%E5%AE%9E%E9%AA%8C%E6%93%8D%E4%BD%9C">16</a></a></p>
<p><a href="#switch%E8%8A%82%E7%82%B9-1">3.2.1 Switch节点 <a href="#switch%E8%8A%82%E7%82%B9-1">16</a></a></p>
<p><a href="#generator%E8%8A%82%E7%82%B9-receiver%E8%8A%82%E7%82%B9">3.2.2 Generator节点 &amp; Receiver节点<br><a href="#generator%E8%8A%82%E7%82%B9-receiver%E8%8A%82%E7%82%B9">19</a></a></p>
<p><a href="#simple_router%E5%AE%9E%E9%AA%8C">4 Simple_router实验 <a href="#simple_router%E5%AE%9E%E9%AA%8C">23</a></a></p>
<p><a href="#%E5%AE%9E%E9%AA%8C%E5%87%86%E5%A4%87-1">4.1 实验准备 <a href="#%E5%AE%9E%E9%AA%8C%E5%87%86%E5%A4%87-1">23</a></a></p>
<p><a href="#%E5%AE%9E%E9%AA%8C%E6%93%8D%E4%BD%9C-1">4.2 实验操作 <a href="#%E5%AE%9E%E9%AA%8C%E6%93%8D%E4%BD%9C-1">27</a></a></p>
<p><a href="#switch%E8%8A%82%E7%82%B9-2">4.2.1 Switch节点 <a href="#switch%E8%8A%82%E7%82%B9-2">27</a></a></p>
<p><a href="#generator%E8%8A%82%E7%82%B9-receiver%E8%8A%82%E7%82%B9-1">4.2.2 Generator节点 &amp; Receiver节点<br><a href="#generator%E8%8A%82%E7%82%B9-receiver%E8%8A%82%E7%82%B9-1">29</a></a></p>
<p><a href="#_Toc485390003">表1. 文档修改记录 <a href="#_Toc485390003">1</a></a></p>
<p><a href="#_Toc17707">表2. 服务器信息表 <a href="#_Toc17707">5</a></a></p>
<p><a href="#%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E8%BF%9E%E6%8E%A5%E5%9B%BE">图1. 网络拓扑连接图 <a href="#%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E8%BF%9E%E6%8E%A5%E5%9B%BE">6</a></a></p>
<p><a href="#dpdk%E7%AB%AF%E5%8F%A3%E7%BB%91%E5%AE%9A%E6%83%85%E5%86%B5">图2. dpdk端口绑定情况 <a href="#dpdk%E7%AB%AF%E5%8F%A3%E7%BB%91%E5%AE%9A%E6%83%85%E5%86%B5">9</a></a></p>
<p><a href="#%E5%A4%A7%E9%A1%B5%E5%86%85%E5%AD%98%E6%83%85%E5%86%B5">图3. 大页内存情况 <a href="#%E5%A4%A7%E9%A1%B5%E5%86%85%E5%AD%98%E6%83%85%E5%86%B5">10</a></a></p>
<p><a href="#dpdk%E7%AB%AF%E5%8F%A3%E7%BB%91%E5%AE%9A%E6%83%85%E5%86%B5-1">图4. dpdk端口绑定情况 <a href="#dpdk%E7%AB%AF%E5%8F%A3%E7%BB%91%E5%AE%9A%E6%83%85%E5%86%B5-1">13</a></a></p>
<p><a href="#%E5%A4%A7%E9%A1%B5%E5%86%85%E5%AD%98%E6%83%85%E5%86%B5-1">图5. 大页内存情况 <a href="#%E5%A4%A7%E9%A1%B5%E5%86%85%E5%AD%98%E6%83%85%E5%86%B5-1">13</a></a></p>
<p><a href="#l2_switch%E5%AE%9E%E9%AA%8C%E6%96%87%E4%BB%B6">图6. l2_switch实验文件 <a href="#l2_switch%E5%AE%9E%E9%AA%8C%E6%96%87%E4%BB%B6">14</a></a></p>
<p><a href="#ovs%E7%BD%91%E6%A1%A5%E6%83%85%E5%86%B5">图7. ovs网桥情况 <a href="#ovs%E7%BD%91%E6%A1%A5%E6%83%85%E5%86%B5">18</a></a></p>
<p><a href="#l2_switch%E5%AE%9E%E9%AA%8C%E6%B5%81%E8%A1%A8">图8. l2_switch实验流表 <a href="#l2_switch%E5%AE%9E%E9%AA%8C%E6%B5%81%E8%A1%A8">19</a></a></p>
<p><a href="#%E5%8F%91%E5%8C%85%E8%BD%AF%E4%BB%B6%E5%90%AF%E5%8A%A8">图9. 发包软件启动 <a href="#%E5%8F%91%E5%8C%85%E8%BD%AF%E4%BB%B6%E5%90%AF%E5%8A%A8">22</a></a></p>
<p><a href="#%E6%B5%81%E8%A1%A8%E5%8F%98%E5%8C%96">图10. 流表变化 <a href="#%E6%B5%81%E8%A1%A8%E5%8F%98%E5%8C%96">23</a></a></p>
<p><a href="#simple_router%E5%AE%9E%E9%AA%8C%E6%96%87%E4%BB%B6">图11. simple_router实验文件<br><a href="#simple_router%E5%AE%9E%E9%AA%8C%E6%96%87%E4%BB%B6">24</a></a></p>
<p><a href="#ovs%E7%BD%91%E6%A1%A5%E6%83%85%E5%86%B5-1">图12. ovs网桥情况 <a href="#ovs%E7%BD%91%E6%A1%A5%E6%83%85%E5%86%B5-1">28</a></a></p>
<p><a href="#simple_router%E5%AE%9E%E9%AA%8C%E6%B5%81%E8%A1%A8">图13. simple_router实验流表<br><a href="#simple_router%E5%AE%9E%E9%AA%8C%E6%B5%81%E8%A1%A8">29</a></a></p>
<p><a href="#%E6%B5%81%E8%A1%A8%E5%8F%98%E5%8C%96-1">图14. 流表变化 <a href="#%E6%B5%81%E8%A1%A8%E5%8F%98%E5%8C%96-1">30</a></a></p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h2><p>参考Github项目。</p>
<p><a href="https://github.com/P4-vSwitch">https://github.com/P4-vSwitch</a></p>
<h1 id="section-图名"><a href="#section-图名" class="headerlink" title="{#section .图名}"></a>{#section .图名}</h1><h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><p>项目部署环境为虚拟机，需将其中的脚本和代码迁移至物理机运行。</p>
<p>实验环境共3台服务器，基本信息如下，实验室网络可登录。</p>
<ol start="2">
<li>[]{#_Toc17707 .anchor}服务器信息表</li>
</ol>
<p>+:———-:+:————–:+:———–:+:———–:+:—————-:+<br>| 服务器名称 | IP地址         | 用户名      | 密码        | 备注             |<br>+————+—————-+————-+————-+——————+<br>| p4switch   | 192.168.61.133 | root&#x2F;ubuntu | abcd@1234   | system           |<br>|            |                |             |             |                  |<br>|            |                |             |             | Ubuntu 14.04.4   |<br>|            |                |             |             |                  |<br>|            |                |             |             | kernel           |<br>|            |                |             |             |                  |<br>|            |                |             |             | 4.2.0-27-generic |<br>+————+—————-+             |             |                  |<br>| p4recv     | 192.168.61.135 |             |             |                  |<br>+————+—————-+             |             |                  |<br>| p4gen      | 192.168.61.134 |             |             |                  |<br>+————+—————-+————-+————-+——————+</p>
<p>拓扑连接图如下。</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image1.png">{width&#x3D;”5.758333333333334in”<br>height&#x3D;”3.122916666666667in”}</p>
<h1 id="网络拓扑连接图-网络拓扑连接图-图名"><a href="#网络拓扑连接图-网络拓扑连接图-图名" class="headerlink" title="网络拓扑连接图 {#网络拓扑连接图 .图名}"></a>网络拓扑连接图 {#网络拓扑连接图 .图名}</h1><h1 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h1><h2 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h2><p>Ubuntu 14.04.4，内核版本4.2.0-27-generic。</p>
<h2 id="Switch节点"><a href="#Switch节点" class="headerlink" title="Switch节点"></a>Switch节点</h2><p>使用root用户登录Switch节点，更新apt源，下载必要的软件依赖,建议将自带源替换为国内源。</p>
<p>apt-get update</p>
<p>#apt-get upgrade</p>
<p>apt-get -y install git python-pip fuse libfuse-dev dh-autoreconf openssl<br>libssl-dev cmake libpcap-dev python-yaml</p>
<p>安装ply，且要求版本&lt;3.10，建议使用国内pip源。</p>
<p>pip install -i <a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a> ply&#x3D;&#x3D;3.9</p>
<p>创建工作目录，并下载项目代码。</p>
<p>cd &#x2F;home</p>
<p>git clone <a href="https://github.com/P4-vSwitch/vagrant.git">https://github.com/P4-vSwitch/vagrant.git</a></p>
<p>下载安装p4-hlir模块</p>
<p>cd &#x2F;home&#x2F;vagrant</p>
<p>git clone <a href="https://github.com/p4lang/p4-hlir.git">https://github.com/p4lang/p4-hlir.git</a></p>
<p>cd p4-hlir&#x2F;</p>
<p>python setup.py install</p>
<p>下载安装p4c-behavioral模块</p>
<p>cd &#x2F;home&#x2F;vagrant</p>
<p>git clone <a href="https://github.com/P4-vSwitch/p4c-behavioral.git">https://github.com/P4-vSwitch/p4c-behavioral.git</a></p>
<p>cd p4c-behavioral&#x2F;</p>
<p>git checkout ovs</p>
<p>python setup.py install</p>
<p>下载OVS模块</p>
<p>cd &#x2F;home&#x2F;vagrant</p>
<p>git clone <a href="https://github.com/P4-vSwitch/ovs.git">https://github.com/P4-vSwitch/ovs.git</a></p>
<p>cd ovs&#x2F;</p>
<p>git checkout p4</p>
<p>git submodule update --init</p>
<p>Build DPDK模块</p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;deps&#x2F;dpdk</p>
<p>patch -p1 -N &lt; ..&#x2F;..&#x2F;setup-scripts&#x2F;patches&#x2F;dpdk.patch</p>
<p>make -j 2 install T&#x3D;x86_64-native-linuxapp-gcc</p>
<p>导入环境变量，建议填入~&#x2F;.bashrc，避免每次新开窗口都需要手动导入。</p>
<p>export RTE_SDK&#x3D;&#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;deps&#x2F;dpdk</p>
<p>export RTE_TARGET&#x3D;x86_64-native-linuxapp-gcc</p>
<p>export DPDK_DIR&#x3D;$RTE_SDK</p>
<p>export DPDK_BUILD&#x3D;$DPDK_DIR&#x2F;$RTE_TARGET&#x2F;</p>
<p>配置DPDK内核模块</p>
<p>cd &#x2F;home&#x2F;vagrant</p>
<p>modprobe uio</p>
<p>insmod $RTE_SDK&#x2F;$RTE_TARGET&#x2F;kmod&#x2F;igb_uio.ko</p>
<p>insmod $RTE_SDK&#x2F;$RTE_TARGET&#x2F;kmod&#x2F;rte_kni.ko &quot;lo_mode&#x3D;lo_mode_ring&quot;</p>
<p>将服务器端口绑定至DPDK</p>
<p>ifconfig eth0 down</p>
<p>$RTE_SDK&#x2F;tools&#x2F;dpdk_nic_bind.py -b igb_uio eth0</p>
<p>ifconfig eth1 down</p>
<p>$RTE_SDK&#x2F;tools&#x2F;dpdk_nic_bind.py -b igb_uio eth1</p>
<p>查看绑定情况</p>
<p>$RTE_SDK&#x2F;tools&#x2F;dpdk_nic_bind.py --status</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image2.png">{width&#x3D;”5.758333333333334in”<br>height&#x3D;”1.7638888888888888in”}</p>
<h1 id="dpdk端口绑定情况-dpdk端口绑定情况-图名"><a href="#dpdk端口绑定情况-dpdk端口绑定情况-图名" class="headerlink" title="dpdk端口绑定情况 {#dpdk端口绑定情况 .图名}"></a>dpdk端口绑定情况 {#dpdk端口绑定情况 .图名}</h1><p>配置大页内存</p>
<p>cd &#x2F;home&#x2F;vagrant</p>
<p>mkdir -p &#x2F;mnt&#x2F;huge</p>
<p>(mount | grep hugetlbfs) &gt; &#x2F;dev&#x2F;null || sudo mount -t hugetlbfs<br>nodev &#x2F;mnt&#x2F;huge</p>
<p>echo 1024 &gt;<br>&#x2F;sys&#x2F;devices&#x2F;system&#x2F;node&#x2F;node0&#x2F;hugepages&#x2F;hugepages-2048kB&#x2F;nr_hugepages</p>
<p>查看大页内存</p>
<p>grep -i huge &#x2F;proc&#x2F;meminfo</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image3.png">{width&#x3D;”5.763888888888889in”<br>height&#x3D;”1.1131944444444444in”}</p>
<h1 id="大页内存情况-大页内存情况-图名"><a href="#大页内存情况-大页内存情况-图名" class="headerlink" title="大页内存情况 {#大页内存情况 .图名}"></a>大页内存情况 {#大页内存情况 .图名}</h1><p>Build OVS</p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;</p>
<p>.&#x2F;boot.sh</p>
<p>.&#x2F;configure --with-dpdk&#x3D;$DPDK_BUILD CFLAGS&#x3D;&quot;-g -O2 -Wno-cast-align&quot;<br>\</p>
<p>p4inputfile&#x3D;.&#x2F;include&#x2F;p4&#x2F;examples&#x2F;l2_switch&#x2F;l2_switch.p4 \</p>
<p>p4outputdir&#x3D;.&#x2F;include&#x2F;p4&#x2F;src</p>
<p>make -j 2</p>
<p>创建OVS数据库文件和文件路径</p>
<p>mkdir -p &#x2F;usr&#x2F;local&#x2F;etc&#x2F;openvswitch</p>
<p>mkdir -p &#x2F;usr&#x2F;local&#x2F;var&#x2F;run&#x2F;openvswitch</p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;ovsdb&#x2F;</p>
<p>.&#x2F;ovsdb-tool create &#x2F;usr&#x2F;local&#x2F;etc&#x2F;openvswitch&#x2F;conf.db<br>..&#x2F;vswitchd&#x2F;vswitch.ovsschema</p>
<h2 id="Generator节点-Receiver节点"><a href="#Generator节点-Receiver节点" class="headerlink" title="Generator节点&#x2F;Receiver节点"></a>Generator节点&#x2F;Receiver节点</h2><p>两节点安装步骤一致，合并描述。</p>
<p>使用root用户登录Generator或Receiver节点，更新apt源，下载必要的软件依赖,建议将自带源替换为国内源。</p>
<p>apt-get update</p>
<p>apt-get upgrade</p>
<p>apt-get -y install git python-pip fuse libfuse-dev dh-autoreconf openssl<br>libssl-dev cmake libpcap-dev python-yaml</p>
<p>创建工作目录，并下载项目代码。</p>
<p>cd &#x2F;home</p>
<p>git clone <a href="https://github.com/P4-vSwitch/vagrant.git">https://github.com/P4-vSwitch/vagrant.git</a></p>
<p>下载Pktgen项目代码</p>
<p>cd &#x2F;home&#x2F;vagrant</p>
<p>git clone <a href="https://github.com/P4-vSwitch/pktgen.git">https://github.com/P4-vSwitch/pktgen.git</a></p>
<p>cd pktgen&#x2F;</p>
<p>git submodule update --init</p>
<p>Build DPDK模块</p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;pktgen&#x2F;deps&#x2F;dpdk</p>
<p>make -j 2 install T&#x3D;x86_64-native-linuxapp-gcc</p>
<p>导入环境变量，建议填入~&#x2F;.bashrc，避免每次新开窗口都需要手动导入。</p>
<p>export RTE_SDK&#x3D;&#x2F;home&#x2F;vagrant&#x2F;pktgen&#x2F;deps&#x2F;dpdk</p>
<p>export RTE_TARGET&#x3D;x86_64-native-linuxapp-gcc</p>
<p>export DPDK_DIR&#x3D;$RTE_SDK</p>
<p>export DPDK_BUILD&#x3D;$DPDK_DIR&#x2F;$RTE_TARGET&#x2F;</p>
<p>配置DPDK内核模块</p>
<p>cd &#x2F;home&#x2F;vagrant</p>
<p>modprobe uio</p>
<p>insmod $RTE_SDK&#x2F;$RTE_TARGET&#x2F;kmod&#x2F;igb_uio.ko</p>
<p>insmod $RTE_SDK&#x2F;$RTE_TARGET&#x2F;kmod&#x2F;rte_kni.ko &quot;lo_mode&#x3D;lo_mode_ring&quot;</p>
<p>将服务器端口绑定至DPDK</p>
<p>ifconfig eth0 down</p>
<p>$RTE_SDK&#x2F;tools&#x2F;dpdk_nic_bind.py -b igb_uio eth0</p>
<p>ifconfig eth1 down</p>
<p>$RTE_SDK&#x2F;tools&#x2F;dpdk_nic_bind.py -b igb_uio eth1</p>
<p>查看绑定情况</p>
<p>$RTE_SDK&#x2F;tools&#x2F;dpdk_nic_bind.py --status</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image4.png">{width&#x3D;”5.763888888888889in”<br>height&#x3D;”1.7833333333333334in”}</p>
<h1 id="dpdk端口绑定情况-dpdk端口绑定情况-1-图名"><a href="#dpdk端口绑定情况-dpdk端口绑定情况-1-图名" class="headerlink" title="dpdk端口绑定情况 {#dpdk端口绑定情况-1 .图名}"></a>dpdk端口绑定情况 {#dpdk端口绑定情况-1 .图名}</h1><p>配置大页内存</p>
<p>cd &#x2F;home&#x2F;vagrant</p>
<p>mkdir -p &#x2F;mnt&#x2F;huge</p>
<p>(mount | grep hugetlbfs) &gt; &#x2F;dev&#x2F;null || sudo mount -t hugetlbfs<br>nodev &#x2F;mnt&#x2F;huge</p>
<p>echo 512 &gt;<br>&#x2F;sys&#x2F;devices&#x2F;system&#x2F;node&#x2F;node0&#x2F;hugepages&#x2F;hugepages-2048kB&#x2F;nr_hugepages</p>
<p>查看大页内存</p>
<p>grep -i huge &#x2F;proc&#x2F;meminfo</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image5.png">{width&#x3D;”5.764583333333333in”<br>height&#x3D;”1.332638888888889in”}</p>
<h1 id="大页内存情况-大页内存情况-1-图名"><a href="#大页内存情况-大页内存情况-1-图名" class="headerlink" title="大页内存情况 {#大页内存情况-1 .图名}"></a>大页内存情况 {#大页内存情况-1 .图名}</h1><p>Build Pktgen模块</p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;pktgen</p>
<p>make</p>
<h1 id="l2-switch实验"><a href="#l2-switch实验" class="headerlink" title="l2_switch实验"></a>l2_switch实验</h1><h2 id="实验准备"><a href="#实验准备" class="headerlink" title="实验准备"></a>实验准备</h2><p>实验脚本文件和配置文件中的参数需根据服务器网口实际情况进行修改，实验路径如下图所示。不同节点需要修改的位置不同，以下分别描述。</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image6.png">{width&#x3D;”5.761805555555555in”<br>height&#x3D;”1.2694444444444444in”}</p>
<h1 id="l2-switch实验文件-l2-switch实验文件-图名"><a href="#l2-switch实验文件-l2-switch实验文件-图名" class="headerlink" title="l2_switch实验文件 {#l2_switch实验文件 .图名}"></a>l2_switch实验文件 {#l2_switch实验文件 .图名}</h1><p><strong>Switch节点：</strong></p>
<p>l2_switch.p4&#x2F;generator.pkt&#x2F;receiver.pkt：保持不变</p>
<p>l2_switch.sh：将流表中的mac地址，更换为Generator和Receiver服务器分别连接Switch的网口的mac地址，如下标红位置所示。</p>
<p>#! &#x2F;bin&#x2F;sh -ve</p>
<p># Please make sure that you update the path to the current OVS<br>directory.</p>
<p>DIR&#x3D;&#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;utilities</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 del-flows br0</p>
<p># SMAC Table 0</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;0,priority&#x3D;32768,ethernet__srcAddr&#x3D;0x74a4b500eee4<br>actions&#x3D;resubmit(,1)&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;0,priority&#x3D;32768,ethernet__srcAddr&#x3D;0x74a4b500ef02<br>actions&#x3D;resubmit(,1)&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;0,priority&#x3D;0 actions&#x3D;controller&quot;</p>
<p># DMAC Table 1</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;1,priority&#x3D;32768,ethernet__dstAddr&#x3D;0x74a4b500eee4<br>actions&#x3D;set_field:1-&gt;reg0,resubmit(,2)&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;1,priority&#x3D;32768,ethernet__dstAddr&#x3D;0x74a4b500ef02<br>actions&#x3D;set_field:2-&gt;reg0,resubmit(,2)&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;1,priority&#x3D;0 actions&#x3D;flood&quot;</p>
<p># SRC Pruning Table 2</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;2,priority&#x3D;32768,in_port&#x3D;1,reg0&#x3D;1 actions&#x3D;&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;2,priority&#x3D;32768,in_port&#x3D;2,reg0&#x3D;2 actions&#x3D;&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;2,priority&#x3D;32768,in_port&#x3D;3,reg0&#x3D;3 actions&#x3D;&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;2,priority&#x3D;32768,in_port&#x3D;4,reg0&#x3D;4 actions&#x3D;&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;2,priority&#x3D;32768,in_port&#x3D;5,reg0&#x3D;5 actions&#x3D;&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;2,priority&#x3D;32768,in_port&#x3D;6,reg0&#x3D;6 actions&#x3D;&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;2,priority&#x3D;0 actions&#x3D;deparse,output:NXM_NX_REG0[]&quot;</p>
<p><strong>generator节点：</strong></p>
<p>只修改generator.pkt文件，将generator与switch连接的网口mac地址填入，如下所示。</p>
<p>set mac 0 74:a4:b5:00:ee:e4</p>
<p><strong>receiver节点：</strong></p>
<p>只修改receiver.pkt文件，将receiver与switch连接的网口mac地址填入，如下所示。</p>
<p>set mac 0 74:a4:b5:00:ef:02</p>
<h2 id="实验操作"><a href="#实验操作" class="headerlink" title="实验操作"></a>实验操作</h2><h3 id="Switch节点-1"><a href="#Switch节点-1" class="headerlink" title="Switch节点"></a>Switch节点</h3><p>使用root用户，登录switch节点。</p>
<h4 id="编译l2-switch-p4"><a href="#编译l2-switch-p4" class="headerlink" title="编译l2_switch.p4"></a>编译l2_switch.p4</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs</p>
<p>.&#x2F;configure --with-dpdk&#x3D;$DPDK_BUILD CFLAGS&#x3D;&quot;-g -O2 -Wno-cast-align&quot;<br>p4inputfile&#x3D;&#x2F;home&#x2F;vagrant&#x2F;examples&#x2F;l2_switch&#x2F;l2_switch.p4<br>p4outputdir&#x3D;.&#x2F;include&#x2F;p4&#x2F;src</p>
<p>make clean</p>
<p>make -j 2</p>
<h4 id="启动ovsdb-server-保持后台运行"><a href="#启动ovsdb-server-保持后台运行" class="headerlink" title="启动ovsdb-server(保持后台运行)"></a>启动ovsdb-server(保持后台运行)</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;ovsdb</p>
<p>nohup .&#x2F;ovsdb-server<br>--remote&#x3D;punix:&#x2F;usr&#x2F;local&#x2F;var&#x2F;run&#x2F;openvswitch&#x2F;db.sock \</p>
<p>--remote&#x3D;db:Open_vSwitch,Open_vSwitch,manager_options --pidfile &amp;</p>
<h4 id="启动ovs-vswitchd-保持后台运行"><a href="#启动ovs-vswitchd-保持后台运行" class="headerlink" title="启动ovs-vswitchd(保持后台运行)"></a>启动ovs-vswitchd(保持后台运行)</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;vswitchd</p>
<p>nohup .&#x2F;ovs-vswitchd --dpdk -c 0x1 -n 4 --<br>unix:&#x2F;usr&#x2F;local&#x2F;var&#x2F;run&#x2F;openvswitch&#x2F;db.sock --pidfile &amp;</p>
<h4 id="创建OVS网桥"><a href="#创建OVS网桥" class="headerlink" title="创建OVS网桥"></a>创建OVS网桥</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;utilities</p>
<p>.&#x2F;ovs-vsctl --no-wait init</p>
<p>.&#x2F;ovs-vsctl add-br br0 -- set bridge br0 datapath_type&#x3D;netdev</p>
<p>.&#x2F;ovs-vsctl set bridge br0 protocols&#x3D;OpenFlow15</p>
<p>.&#x2F;ovs-vsctl add-port br0 dpdk0 -- set Interface dpdk0 type&#x3D;dpdk</p>
<p>.&#x2F;ovs-vsctl add-port br0 dpdk1 -- set Interface dpdk1 type&#x3D;dpdk</p>
<p><em>如果需要删除，则执行.&#x2F;ovs-vsctl del-br br0</em></p>
<p><em>查看网桥执行.&#x2F;ovs-vsctl show</em></p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image7.png">{width&#x3D;”5.7659722222222225in”<br>height&#x3D;”2.2305555555555556in”}</p>
<h1 id="ovs网桥情况-ovs网桥情况-图名"><a href="#ovs网桥情况-ovs网桥情况-图名" class="headerlink" title="ovs网桥情况 {#ovs网桥情况 .图名}"></a>ovs网桥情况 {#ovs网桥情况 .图名}</h1><h4 id="加载流表"><a href="#加载流表" class="headerlink" title="加载流表"></a>加载流表</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;examples&#x2F;l2_switch&#x2F;</p>
<p>.&#x2F;l2_switch.sh</p>
<p>加载完成后，可执行如下命令查看。</p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;utilities</p>
<p>.&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 dump-flows br0</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image8.png">{width&#x3D;”5.752777777777778in”<br>height&#x3D;”1.0763888888888888in”}</p>
<h1 id="l2-switch实验流表-l2-switch实验流表-图名"><a href="#l2-switch实验流表-l2-switch实验流表-图名" class="headerlink" title="l2_switch实验流表 {#l2_switch实验流表 .图名}"></a>l2_switch实验流表 {#l2_switch实验流表 .图名}</h1><h3 id="Generator节点-Receiver节点-1"><a href="#Generator节点-Receiver节点-1" class="headerlink" title="Generator节点 &amp; Receiver节点"></a>Generator节点 &amp; Receiver节点</h3><p>使用root用户，分别从不同终端窗口登录generator节点和receiver节点。</p>
<h4 id="启动发包程序"><a href="#启动发包程序" class="headerlink" title="启动发包程序"></a>启动发包程序</h4><p><strong>Generator节点：</strong></p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;pktgen</p>
<p>.&#x2F;app&#x2F;app&#x2F;x86_64-native-linuxapp-gcc&#x2F;app&#x2F;pktgen -c 0x3 -n 4 -- -P -m<br>&quot;1.0&quot; -f &#x2F;home&#x2F;vagrant&#x2F;examples&#x2F;l2_switch&#x2F;generator.pkt</p>
<p><strong>Receiver节点：</strong></p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;pktgen</p>
<p>.&#x2F;app&#x2F;app&#x2F;x86_64-native-linuxapp-gcc&#x2F;app&#x2F;pktgen -c 0x3 -n 4 -- -P -m<br>&quot;1.0&quot; -f &#x2F;home&#x2F;vagrant&#x2F;examples&#x2F;l2_switch&#x2F;receiver.pkt</p>
<p>启动后出现如下图所示回显。</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image9.png">{width&#x3D;”5.759722222222222in”<br>height&#x3D;”5.345833333333333in”}</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image10.png">{width&#x3D;”5.7625in”<br>height&#x3D;”4.083333333333333in”}</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image11.png">{width&#x3D;”5.759722222222222in”<br>height&#x3D;”3.6256944444444446in”}</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image12.png">{width&#x3D;”5.7659722222222225in”<br>height&#x3D;”3.7909722222222224in”}</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image13.png">{width&#x3D;”5.7625in”<br>height&#x3D;”3.9631944444444445in”}</p>
<h1 id="发包软件启动-发包软件启动-图名"><a href="#发包软件启动-发包软件启动-图名" class="headerlink" title="发包软件启动 {#发包软件启动 .图名}"></a>发包软件启动 {#发包软件启动 .图名}</h1><h4 id="开始发包"><a href="#开始发包" class="headerlink" title="开始发包"></a>开始发包</h4><p>回到generator节点的界面，输入并执行start 0，开始发包。</p>
<p>此时，在switch节点可查看流表，若数据包数量随时间出现增长，则说明发报成功，如下图所示。</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image14.png">{width&#x3D;”5.763888888888889in”<br>height&#x3D;”1.1402777777777777in”}</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image15.png">{width&#x3D;”5.764583333333333in”<br>height&#x3D;”1.1694444444444445in”}</p>
<h1 id="流表变化-流表变化-图名"><a href="#流表变化-流表变化-图名" class="headerlink" title="流表变化 {#流表变化 .图名}"></a>流表变化 {#流表变化 .图名}</h1><p>实验结束后，回到genarator节点，输入并执行stop 0，停止发包。</p>
<h1 id="Simple-router实验"><a href="#Simple-router实验" class="headerlink" title="Simple_router实验"></a>Simple_router实验</h1><h2 id="实验准备-1"><a href="#实验准备-1" class="headerlink" title="实验准备"></a>实验准备</h2><p>若接着上述l2_switch实验继续，则需要先将环境清理。</p>
<p>停止generator节点和receiver节点的发包程序，并退出。</p>
<p>stop 0</p>
<p>quit</p>
<p>删除switch节点的ovsdb和ovs主进程。</p>
<p>ps -ef | grep ovs</p>
<p>kill -9 xxxxx</p>
<p>kill -9 xxxxx</p>
<p>实验脚本文件和配置文件中的参数需根据服务器网口实际情况进行修改，实验路径如下图所示。不同节点需要修改的位置不同，以下分别描述。</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image16.png">{width&#x3D;”5.759722222222222in”<br>height&#x3D;”0.8493055555555555in”}</p>
<h1 id="simple-router实验文件-simple-router实验文件-图名"><a href="#simple-router实验文件-simple-router实验文件-图名" class="headerlink" title="simple_router实验文件 {#simple_router实验文件 .图名}"></a>simple_router实验文件 {#simple_router实验文件 .图名}</h1><p><strong>Switch节点：</strong></p>
<p>simple_router.p4&#x2F;generator.pkt&#x2F;receiver.pkt：保持不变</p>
<p>simple_router.sh：将流表中的mac地址，更换为Generator和Receiver服务器分别连接Switch的网口的mac地址，如下标红位置所示。</p>
<p>#! &#x2F;bin&#x2F;sh -ve</p>
<p># Please make sure that you update the path to the current OVS<br>directory.</p>
<p>DIR&#x3D;&#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;utilities</p>
<p># For this test we will pre-populate ARP caches at the end-hosts</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 del-flows br0</p>
<p># Verify Checksum (Table 0)</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;0,priority&#x3D;32768,ethernet__etherType&#x3D;0x800 \</p>
<p>actions&#x3D;calc_fields_verify(ipv4__hdrChecksum,csum16,fields:ipv4__version_ihl,ipv4__diffserv,ipv4__totalLen,ipv4__identification,ipv4__flags_fragOffset,ipv4__ttl,ipv4__protocol,ipv4__srcAddr,ipv4__dstAddr),<br>\</p>
<p>resubmit(,1)&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;0,priority&#x3D;0 actions&#x3D;&quot;</p>
<p># IPv4 LPM (Table 1)</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;1,priority&#x3D;32768,ipv4__dstAddr&#x3D;0x0A00000F&#x2F;0xFFFFFF00 \</p>
<p>actions&#x3D;set_field:0x0B00000F-&gt;routing_metadata_nhop_ipv4, \</p>
<p>set_field:2-&gt;reg0, \</p>
<p>set_field:63-&gt;ipv4__ttl, \</p>
<p>resubmit(,2)&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;1,priority&#x3D;0 actions&#x3D;&quot;</p>
<p># Forward (Table 2)</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;2,priority&#x3D;32768,routing_metadata_nhop_ipv4&#x3D;0x0B00000F \</p>
<p>actions&#x3D;set_field:0x74a4b500eee4-&gt;ethernet__dstAddr, \</p>
<p>resubmit(,3)&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;2,priority&#x3D;0 actions&#x3D;&quot;</p>
<p># Send Frame (Table 3)</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;3,priority&#x3D;32768,reg0&#x3D;2 \</p>
<p>actions&#x3D;set_field:0x74a4b500ef02-&gt;ethernet__srcAddr, \</p>
<p>calc_fields_update(ipv4__hdrChecksum,csum16,fields:ipv4__version_ihl,ipv4__diffserv,ipv4__totalLen,ipv4__identification,ipv4__flags_fragOffset,ipv4__ttl,ipv4__protocol,ipv4__srcAddr,ipv4__dstAddr),<br>\</p>
<p>deparse, \</p>
<p>output:NXM_NX_REG0[]&quot;</p>
<p>$DIR&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 add-flow br0<br>&quot;table&#x3D;3,priority&#x3D;0 actions&#x3D;&quot;</p>
<p><strong>generator节点：</strong></p>
<p>只修改generator.pkt文件，将generator与switch连接的网口mac地址填入，如下所示。</p>
<p>set mac 0 74:a4:b5:00:ee:e4</p>
<p>set ip src 0 10.0.0.14&#x2F;24</p>
<p>set ip dst 0 10.0.0.15</p>
<p><strong>receiver节点：</strong></p>
<p>只修改receiver.pkt文件，将receiver与switch连接的网口mac地址填入，如下所示。</p>
<p>set mac 0 74:a4:b5:00:ef:02</p>
<p>set ip src 0 10.0.0.15&#x2F;24</p>
<p>set ip dst 0 10.0.0.14</p>
<h2 id="实验操作-1"><a href="#实验操作-1" class="headerlink" title="实验操作"></a>实验操作</h2><h3 id="Switch节点-2"><a href="#Switch节点-2" class="headerlink" title="Switch节点"></a>Switch节点</h3><p>使用root用户，登录switch节点。</p>
<h4 id="编译simple-router-p4"><a href="#编译simple-router-p4" class="headerlink" title="编译simple_router.p4"></a>编译simple_router.p4</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs</p>
<p>.&#x2F;configure --with-dpdk&#x3D;$DPDK_BUILD CFLAGS&#x3D;&quot;-g -O2 -Wno-cast-align&quot;<br>p4inputfile&#x3D;&#x2F;home&#x2F;vagrant&#x2F;examples&#x2F;simple_router&#x2F;simple_router.p4<br>p4outputdir&#x3D;.&#x2F;include&#x2F;p4&#x2F;src</p>
<p>make clean</p>
<p>make -j 2</p>
<h4 id="启动ovsdb-server-保持后台运行-1"><a href="#启动ovsdb-server-保持后台运行-1" class="headerlink" title="启动ovsdb-server(保持后台运行)"></a>启动ovsdb-server(保持后台运行)</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;ovsdb</p>
<p>nohup .&#x2F;ovsdb-server<br>--remote&#x3D;punix:&#x2F;usr&#x2F;local&#x2F;var&#x2F;run&#x2F;openvswitch&#x2F;db.sock \</p>
<p>--remote&#x3D;db:Open_vSwitch,Open_vSwitch,manager_options --pidfile &amp;</p>
<h4 id="启动ovs-vswitchd-保持后台运行-1"><a href="#启动ovs-vswitchd-保持后台运行-1" class="headerlink" title="启动ovs-vswitchd(保持后台运行)"></a>启动ovs-vswitchd(保持后台运行)</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;vswitchd</p>
<p>nohup .&#x2F;ovs-vswitchd --dpdk -c 0x1 -n 4 --<br>unix:&#x2F;usr&#x2F;local&#x2F;var&#x2F;run&#x2F;openvswitch&#x2F;db.sock --pidfile &amp;</p>
<h4 id="创建OVS网桥-1"><a href="#创建OVS网桥-1" class="headerlink" title="创建OVS网桥"></a>创建OVS网桥</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;utilities</p>
<p>.&#x2F;ovs-vsctl --no-wait init</p>
<p>.&#x2F;ovs-vsctl add-br br0 -- set bridge br0 datapath_type&#x3D;netdev</p>
<p>.&#x2F;ovs-vsctl set bridge br0 protocols&#x3D;OpenFlow15</p>
<p>.&#x2F;ovs-vsctl add-port br0 dpdk0 -- set Interface dpdk0 type&#x3D;dpdk</p>
<p>.&#x2F;ovs-vsctl add-port br0 dpdk1 -- set Interface dpdk1 type&#x3D;dpdk</p>
<p><em>如果需要删除，则执行.&#x2F;ovs-vsctl del-br br0</em></p>
<p><em>查看网桥执行.&#x2F;ovs-vsctl show</em></p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image7.png">{width&#x3D;”5.7659722222222225in”<br>height&#x3D;”2.2305555555555556in”}</p>
<h1 id="ovs网桥情况-ovs网桥情况-1-图名"><a href="#ovs网桥情况-ovs网桥情况-1-图名" class="headerlink" title="ovs网桥情况 {#ovs网桥情况-1 .图名}"></a>ovs网桥情况 {#ovs网桥情况-1 .图名}</h1><h4 id="加载流表-1"><a href="#加载流表-1" class="headerlink" title="加载流表"></a>加载流表</h4><p>cd &#x2F;home&#x2F;vagrant&#x2F;examples&#x2F;simple_router&#x2F;</p>
<p>.&#x2F;simple_router.sh</p>
<p>加载完成后，可执行如下命令查看。</p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;ovs&#x2F;utilities</p>
<p>.&#x2F;ovs-ofctl --protocols&#x3D;OpenFlow15 dump-flows br0</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image17.png">{width&#x3D;”5.767361111111111in”<br>height&#x3D;”1.229861111111111in”}</p>
<h1 id="simple-router实验流表-simple-router实验流表-图名"><a href="#simple-router实验流表-simple-router实验流表-图名" class="headerlink" title="simple_router实验流表 {#simple_router实验流表 .图名}"></a>simple_router实验流表 {#simple_router实验流表 .图名}</h1><h3 id="Generator节点-Receiver节点-2"><a href="#Generator节点-Receiver节点-2" class="headerlink" title="Generator节点 &amp; Receiver节点"></a>Generator节点 &amp; Receiver节点</h3><p>使用root用户，分别从不同终端窗口登录generator节点和receiver节点。</p>
<h4 id="启动发包程序-1"><a href="#启动发包程序-1" class="headerlink" title="启动发包程序"></a>启动发包程序</h4><p><strong>Generator节点：</strong></p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;pktgen</p>
<p>.&#x2F;app&#x2F;app&#x2F;x86_64-native-linuxapp-gcc&#x2F;app&#x2F;pktgen -c 0x3 -n 4 -- -P -m<br>&quot;1.0&quot; -f &#x2F;home&#x2F;vagrant&#x2F;examples&#x2F;simple_router&#x2F;generator.pkt</p>
<p><strong>Receiver节点：</strong></p>
<p>cd &#x2F;home&#x2F;vagrant&#x2F;pktgen</p>
<p>.&#x2F;app&#x2F;app&#x2F;x86_64-native-linuxapp-gcc&#x2F;app&#x2F;pktgen -c 0x3 -n 4 -- -P -m<br>&quot;1.0&quot; -f &#x2F;home&#x2F;vagrant&#x2F;examples&#x2F;simple_router&#x2F;receiver.pkt</p>
<p>启动后出现回显与l2_switch实验一致。</p>
<h4 id="开始发包-1"><a href="#开始发包-1" class="headerlink" title="开始发包"></a>开始发包</h4><p>回到generator节点的界面，输入并执行start 0，开始发包。</p>
<p>此时，在switch节点可查看流表，若数据包数量随时间出现增长，则说明发报成功，如下图所示。</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image18.png">{width&#x3D;”5.763888888888889in”<br>height&#x3D;”1.1472222222222221in”}</p>
<p><img src="/./2026/02/27/p4-vswitch-install/media/image19.png">{width&#x3D;”5.759722222222222in”<br>height&#x3D;”1.1659722222222222in”}</p>
<h1 id="流表变化-流表变化-1-图名"><a href="#流表变化-流表变化-1-图名" class="headerlink" title="流表变化 {#流表变化-1 .图名}"></a>流表变化 {#流表变化-1 .图名}</h1><p>实验结束后，回到genarator节点，输入并执行stop 0，停止发包。</p>
]]></content>
      <categories>
        <category>软件部署与运维管理</category>
      </categories>
  </entry>
</search>
